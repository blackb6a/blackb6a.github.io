<!DOCTYPE html>


    

<html lang="en-us" data-theme="dark">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>TetCTF 2021: unevaluated - Black Bauhinia</title>
<meta name="description" content="">

<link rel="icon" type="image/x-icon" href="https://b6a.black/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="https://b6a.black/favicon.png">



    





    
    
    

    
        <link rel="stylesheet" href="https://b6a.black/css/style.09c94e06b3ec0503263ea0297febd3b62f3d6b2dafd8e813aa92a479e82bc955.css" integrity="sha256-CclOBrPsBQMmPqApf&#43;vTti89ay2v2OgTqpKkeegryVU=">
    





<meta property="og:title" content="TetCTF 2021: unevaluated" />
<meta property="og:description" content="TetCTF is the first CTF I have played in 2021. I recalled from last year that they have cool challenges. This year, there are three crypto challenges. In particular, unevaluated is the hardest among them. Although I did not solve them, I dug into rabbit holes and had a lot of struggle, uh, fun.
Challenge Summary There is a 128-bit prime $p$. Define $\cdot: \mathbb{Z}_{p^2}^2\times\mathbb{Z}_{p^2}^2\rightarrow\mathbb{Z}_{p^2}^2$ by
\[(x_1, y_1)\cdot(x_2, y_2) := \left(\left(x_1x_2-y_1y_2\right)\ \text{mod}\ p^2, \left(x_1y_2&#43;y_1x_2\right)\ \text{mod}\ p^2\right),\]" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://b6a.black/posts/2021-01-03-tetctf-unevaluated/" />
<meta property="article:published_time" content="2021-01-03T13:39:00+08:00" />
<meta property="article:modified_time" content="2021-01-03T13:39:00+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="TetCTF 2021: unevaluated"/>
<meta name="twitter:description" content="TetCTF is the first CTF I have played in 2021. I recalled from last year that they have cool challenges. This year, there are three crypto challenges. In particular, unevaluated is the hardest among them. Although I did not solve them, I dug into rabbit holes and had a lot of struggle, uh, fun.
Challenge Summary There is a 128-bit prime $p$. Define $\cdot: \mathbb{Z}_{p^2}^2\times\mathbb{Z}_{p^2}^2\rightarrow\mathbb{Z}_{p^2}^2$ by
\[(x_1, y_1)\cdot(x_2, y_2) := \left(\left(x_1x_2-y_1y_2\right)\ \text{mod}\ p^2, \left(x_1y_2&#43;y_1x_2\right)\ \text{mod}\ p^2\right),\]"/>












    
</head>
<body>
    <a class="skip-main" href="#main">Skip to main content</a>
    <div class="container">
        <header class="common-header"> 
            
                <h1 class="site-title">
    <a href="/">Black Bauhinia</a>
</h1>

    <nav>
        
        
        <a class="" href="https://b6a.black/about-us/" title="">About Us</a>
        
    </nav>



            
        </header>
        <main id="main" tabindex="-1"> 
            
    
    
    <article class="post h-entry">
        <header class="post-header">
            <h1 class="p-name post-title">TetCTF 2021: unevaluated</h1>
        </header>
        <div class="content e-content">
            <p>TetCTF is the first CTF I have played in 2021. I recalled from last year that they have cool challenges. This year, there are three crypto challenges. In particular, <em>unevaluated</em> is the hardest among them. Although I did not solve them, I dug into rabbit holes and had a lot of struggle, uh, fun.</p>

<h2 id="challenge-summary">Challenge Summary</h2>

<p>There is a 128-bit prime $p$. Define $\cdot: \mathbb{Z}_{p^2}^2\times\mathbb{Z}_{p^2}^2\rightarrow\mathbb{Z}_{p^2}^2$ by</p>

<p><span  class="math">\[(x_1, y_1)\cdot(x_2, y_2) := \left(\left(x_1x_2-y_1y_2\right)\ \text{mod}\ p^2, \left(x_1y_2+y_1x_2\right)\ \text{mod}\ p^2\right),\]</span></p>

<p>where $(x_1, y_1), (x_2, y_2) \in \mathbb{Z}_{p^2}^2$. Also, define for $k\in\mathbb{N}$ and $G \in \mathbb{Z}_{p^2}^2$, $G^k = G \cdot G \cdot ... \cdot G$. Given that $G, H \in \mathbb{Z}_{p^2}^2$, the objective is to find $k\in\mathbb{N}\cap\left[0, 2^{256}\right)$ such that $H = G^k$.</p>

<h2 id="solution">Solution</h2>

<div class="alert warning">
  <strong>Clickbaited!</strong> This writeup is not original and has referred (or stolen) to several sources (Thanks rkm0959 and CryptoHack!). I would like to write this up for my own reference. Anyway, this is more like a story than a solution.
</div>
  

<h3 id="part-i-what-is-the-order-composed-of">Part I: What is the order composed of?</h3>

<p>Since $p$ and $k$ are respectively 128 and 256 bits long, it is expected to recover two out of $k\ \text{mod}\ p$, $k\ \text{mod}\ q$ and $k\ \text{mod}\ r$ to compute $k$. It is interesting to see the order being a product of three primes $p, q, r$, with $q | (p-1)$ and $r | (p+1)$.</p>

<p>I have defined $\text{norm}: \mathbb{Z}_{p^2}^2 \rightarrow \mathbb{Z}_{p^2}$ by $\text{norm}(x, y) = (x^2 + y^2)\ \text{mod}\ p^2$ and experimented a bit and discovered some of the properties:</p>

<ul>
<li>The imaginary part of $G^{pr}$ is zero.</li>
<li>$\text{norm}(G^{pq}) = 1$, and</li>
</ul>

<p>If we are working on $\mathbb{Z}_p$ instead of $\mathbb{Z}_{p^2}^2$, then</p>

<ul>
<li>The imaginary part of $G^r$ is zero.</li>
<li>$\text{norm}(G^q) = 1$, and</li>
</ul>

<p>The following code snipped is used to verify the above properties.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Under mod n</span>
P <span style="color:#f92672">=</span> complex_pow(G, p<span style="color:#f92672">*</span>r, n)           <span style="color:#75715e"># P.im == 0</span>
dQ <span style="color:#f92672">=</span> norm(complex_pow(G, p<span style="color:#f92672">*</span>q, n), n) <span style="color:#75715e"># dQ == 1</span>

<span style="color:#75715e"># Under mod p</span>
P <span style="color:#f92672">=</span> complex_pow(G, r, p)             <span style="color:#75715e"># P.im == 0</span>
dQ <span style="color:#f92672">=</span> norm(complex_pow(G, q, p), p)   <span style="color:#75715e"># dQ == 1</span></code></pre></div>
<p>This make me think: If we consider a <em>polar coordinate representation</em> where $G = \rho e^{i\theta}$, with $\rho\in R$ and $\theta\in A$, then $R \cong \mathbb{Z}_{pq}$ and $A \cong \mathbb{Z}_{pr}$. Hence, we can imagine that the subgroup that $G$ generates is isomorphic to $\mathbb{Z}_{pq}\times\mathbb{Z}_{pr}$.</p>

<div class="alert warning">
  Well, they are not important though. This is interesting however.
</div>
  

<h3 id="part-ii-stealing-the-ideas-from-an-existing-cryptosystem">Part II: Stealing the ideas from an existing cryptosystem</h3>

<p>Solving discrete log under modulo $n^2$ does not seem difficult. For example, we can see from Paillier cryptosystem that discrete logarithms under modulo $n^2$ can be computed easily. In this way, we can compute $x\ \text{mod}\ p$ with:</p>

<p><span  class="math">\[x \equiv \frac{\mathcal{L}(h^{p-1}\ \text{mod}\ p^2)}{\mathcal{L}(g^{p-1}\ \text{mod}\ p^2)}\ (\text{mod}\ p),\]</span></p>

<p>where $\mathcal{L}(x) = \frac{x-1}{p}$, like how a ciphertext is decrypted with the Paillier cryptosystem. Hence we have $x\ \text{mod}\ p$.</p>

<div class="alert info">
  <strong>Mini Checklist</strong></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> $x\ \text{mod}\ p$</li>
<li><input disabled="" type="checkbox"> $x\ \text{mod}\ q$</li>
<li><input disabled="" type="checkbox"> $x\ \text{mod}\ r$</li>
</ul>
</div>
  

<h3 id="part-iii-solving-128bit-discrete-logarithm">Part III: Solving 128-bit discrete logarithm</h3>

<p>Let's try to work on $\mathbb{Z}_{p}^2$ instead of $\mathbb{Z}_{p^2}^2$. This reminded me the challenge <em>galiver</em> in ASIS CTF Finals 2020. I searched the discussion on CryptoHack's Discord server, and found...</p>

<figure>
    <img src="/images/2021-01-03-tetctf/hellman-on-galiver.png"
         alt="hellman&amp;rsquo;s comment on galiver back then."/> <figcaption>
            <p>hellman&rsquo;s comment on galiver back then.</p>
        </figcaption>
</figure>


<p>Okay, <em>works for 128-bit $p$ rather fast</em>. So this must be discrete logarithm. Let's try it? Since the imaginary part for $G^r, H^r$ are zero, I tried <code>discrete_log(H^r, G^r, q)</code> on Sage. After five minutes, my PC crashed. I could not solve it during the CTF. After the game, rkm0959 publishes the <a href="https://rkm0959.tistory.com/192">writeup</a> on the CTF and he used <code>h.log(g)</code> and have got it working. In his writeup, he uses a <em>norm map</em> which is isomorphic to the subgroup that $G^r$ generates.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">p <span style="color:#f92672">=</span> <span style="color:#ae81ff">206109322179011817882783419945552366363</span>
q <span style="color:#f92672">=</span> <span style="color:#ae81ff">103054661089505908941391709972776183181</span>
r <span style="color:#f92672">=</span> <span style="color:#ae81ff">17175776848250984823565284995462697197</span>
G <span style="color:#f92672">=</span> (<span style="color:#ae81ff">20878314020629522511110696411629430299663617500650083274468525283663940214962</span>,
     <span style="color:#ae81ff">16739915489749335460111660035712237713219278122190661324570170645550234520364</span>)
H <span style="color:#f92672">=</span> (<span style="color:#ae81ff">11048898386036746197306883207419421777457078734258168057000593553461884996107</span>,
     <span style="color:#ae81ff">34230477038891719323025391618998268890391645779869016241994899690290519616973</span>)

Zp <span style="color:#f92672">=</span> GF(p)

g <span style="color:#f92672">=</span> Zp(G[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> G[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>) <span style="color:#75715e"># equivalently, g = Zp(complex_pow(G, r, p).re)</span>
h <span style="color:#f92672">=</span> Zp(H[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> H[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>) <span style="color:#75715e"># and           h = Zp(complex_pow(H, r, p).re)</span>

<span style="color:#66d9ef">assert</span> g<span style="color:#f92672">^</span>q <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>
x_mod_q <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>log(g)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;x % q =&#39;</span>, x_mod_q) <span style="color:#75715e"># 26176203815975575469683683780455489251</span></code></pre></div>
<div class="alert success">
  <strong>Takeaway.</strong> Sage is powerful. It tooks 3 minutes for my PC to compute the discrete log, where the time complexity should be $\mathcal{O}(\sqrt{q})$. Also, <em>do not use</em> <code>discrete_log(h, g)</code>. Use <code>h.log(g)</code> instead.
</div>
  

<div class="alert info">
  <strong>Mini Checklist</strong></p>
<ul>
<li><input checked="" disabled="" type="checkbox"> $x\ \text{mod}\ p$</li>
<li><input checked="" disabled="" type="checkbox"> $x\ \text{mod}\ q$</li>
<li><input disabled="" type="checkbox"> $x\ \text{mod}\ r$</li>
</ul>
</div>
  

<h3 id="part-iv-combining-the-building-blocks">Part IV: Combining the building blocks</h3>

<p>With Chinese remainder theorem, we are able to recover $x_0 := x\ \text{mod}\ pq$. It may not equal to $x$, but they are differ from a small multiple of $pq$. We can simply compute $x_0 + kpq$ for some small $k\in\mathbb{N}$ until $k$ is obtained. After that we have the flag - <code>TetCTF{h0m0m0rph1sm_1s_0ur_fr13nd-mobi:*100*231199111007#}</code>. This challenge makes me think more about discrete logarithm, and I am amazed by the capability of Sage. I am still wondering why discrete logarithm of a 128-bit prime can be computed in just a few minutes...</p>

        </div>
        


<div class="post-info">
    
        <div class="post-date dt-published">2021-01-03</div>
    
    
    <a class="post-hidden-url u-url" href="https://b6a.black/posts/2021-01-03-tetctf-unevaluated/">https://b6a.black/posts/2021-01-03-tetctf-unevaluated/</a>
    <a href=https://b6a.black/ class="p-name p-author post-hidden-author h-card" rel="me">[Mystiz]</a>


    <div class="post-taxonomies">
        
            
                <ul class="post-tags">
                    
                        <li><a href="https://b6a.black/tags/ctf">#ctf</a></li>
                    
                        <li><a href="https://b6a.black/tags/tetctf">#tetctf</a></li>
                    
                        <li><a href="https://b6a.black/tags/crypto">#crypto</a></li>
                    
                        <li><a href="https://b6a.black/tags/discrete-logarithm">#discrete-logarithm</a></li>
                    
                </ul>
        
    </div>
</div>

    </article>

    

    

    


        </main>
        
            <footer class="common-footer">
    
    

    <div class="common-footer-bottom">
        
        <div class="copyright">
            <p>© 2021<br>
            Powered by <a target="_blank" rel="noopener noreferrer" href="https://gohugo.io/">Hugo</a>, theme <a target="_blank" rel="noopener noreferrer" href="https://github.com/mitrichius/hugo-theme-anubis">Anubis</a>.<br>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"
  integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"
  integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"
  integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
  onload="renderMathInElement(document.body, { delimiters: [{ left: '$$', right: '$$', display: true }, { left: '\\[', right: '\\]', display: true }, { left: '$', right: '$', display: false }, { left: '\\(', right: '\\)', display: false }]})"></script>

            </p>  
        </div> 

        

    


   
    </div>

    <p class="h-card vcard">

    <a href=https://b6a.black/ class="p-name u-url url fn" rel="me"></a> 

    

    
</p> 
</footer>

        
    </div>
</body>
</html>
